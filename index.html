<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
      // --- –ù–ê–°–¢–†–û–ô–ö–ò –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
    const CLIENT_ID = '1007801132466-7n900gd7copmsp5b3k87kqt0cbu62sth.apps.googleusercontent.com';
    const WHITELIST = [
        "richsulpak@gmail.com",
        "aptdayana@gmail.com", 
        "socanastasiya@gmail.com"
    ];
  
    // –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞: —á—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å —Ç–∞–±–ª–∏—Ü + –¥–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–∞–º + email + –ø—Ä–æ—Ñ–∏–ª—å
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile';

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    // –ü—ã—Ç–∞–µ–º—Å—è —Å—Ä–∞–∑—É –≤—Å–ø–æ–º–Ω–∏—Ç—å –ø–æ—á—Ç—É
    let CURRENT_USER_EMAIL = localStorage.getItem('user_email') || "";
    let USER_DB_ID = localStorage.getItem('cake_db_id');
      let shape3DState = {
    currentImg: null,
    layersCreated: false
};
      let currentStockShelf = 'all'; // 'all', 'food', 'pack'
      

    // 1. –ó–∞–≥—Ä—É–∑–∫–∞ GAPI (Google API)
    function gapiLoaded() {
        gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
        await gapi.client.init({
            // –ó–ê–ì–†–£–ñ–ê–ï–ú –°–†–ê–ó–£ –î–í–ï –ë–ò–ë–õ–ò–û–¢–ï–ö–ò: Sheets –∏ Drive
            discoveryDocs: [
                "https://sheets.googleapis.com/$discovery/rest?version=v4",
                "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"
            ],
        });
        gapiInited = true;
        checkAuth();
    }

    // 2. –ó–∞–≥—Ä—É–∑–∫–∞ GIS (Google Identity Services)
    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: '', // –ë—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏
        });
        gisInited = true;
        checkAuth();
    }

    // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∏ –ê–í–¢–û-–í–•–û–î
    function checkAuth() {
        if (gapiInited && gisInited) {
            document.getElementById('loadingOverlay').style.display = 'none';

            // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω
            const storedToken = localStorage.getItem('google_access_token');
            
            if (storedToken) {
                try {
                    const token = JSON.parse(storedToken);
                    gapi.client.setToken(token); // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∂–∏–≤ –ª–∏ —Ç–æ–∫–µ–Ω (–∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å)
                    console.log("üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Å—Å–∏—é...");
                    fetchUserProfile(token.access_token).catch(() => {
                        // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –ø—Ä–æ—Ç—É—Ö ‚Äî —É–¥–∞–ª—è–µ–º –∏ –ø—Ä–æ—Å–∏–º –≤–æ–π—Ç–∏
                        console.log("–¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫, –Ω—É–∂–µ–Ω –≤—Ö–æ–¥.");
                        localStorage.removeItem('google_access_token');
                        showLoginButton();
                    });
                } catch (e) {
                    showLoginButton();
                }
            } else {
                // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                showLoginButton();
            }
        }
    }

  
   // –§—É–Ω–∫—Ü–∏—è –í—Ö–æ–¥–∞ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–æ–π)
  function handleAuthClick() {
    tokenClient.callback = async (resp) => {
      if (resp.error) {
        throw (resp);
      }
      // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –¢–æ–∫–µ–Ω –≤ –ø–∞–º—è—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞
      localStorage.setItem('google_access_token', JSON.stringify(resp));
      
      // 2. –ò–¥–µ–º –∑–∞ –ø—Ä–æ—Ñ–∏–ª–µ–º
      await fetchUserProfile(resp.access_token);
    };

    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨:
    // –ú—ã —É–±—Ä–∞–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ null –∏ prompt: 'consent'.
    // prompt: '' –æ–∑–Ω–∞—á–∞–µ—Ç "–Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–π —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–∏ —É–∂–µ –µ—Å—Ç—å".
    tokenClient.requestAccessToken({prompt: ''});
  }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  // –ü–æ–ª—É—á–µ–Ω–∏–µ Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)
    async function fetchUserProfile(token) {
        try {
            const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –ø—Ä–æ—Ç—É—Ö (–æ—à–∏–±–∫–∞ 401 –∏–ª–∏ 403)
            if (!response.ok) {
                throw new Error("–¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω (Status: " + response.status + ")");
            }

            const userInfo = await response.json();
            const email = userInfo.email;

            // –ï—Å–ª–∏ Google –≤–µ—Ä–Ω—É–ª –æ—Ç–≤–µ—Ç, –Ω–æ –≤ –Ω–µ–º –Ω–µ—Ç Email
            if (!email) {
                console.error("–û—Ç–≤–µ—Ç Google –±–µ–∑ email:", userInfo);
                alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: Google –Ω–µ –ø–µ—Ä–µ–¥–∞–ª Email. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ.");
                localStorage.removeItem('google_access_token');
                showLoginButton();
                return;
            }

            // –ü–†–û–í–ï–†–ö–ê –î–û–°–¢–£–ü–ê (WHITELIST)
            // .trim() –∏ .toLowerCase() —É–±–∏—Ä–∞—é—Ç —Å–ª—É—á–∞–π–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞
            if (WHITELIST.map(e => e.toLowerCase()).includes(email.toLowerCase().trim())) {
                CURRENT_USER_EMAIL = email;
                localStorage.setItem('user_email', email);
                
                removeLoginButton();
                console.log(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${userInfo.name}!`);
                
                initializeApp(); 
            } else {
                alert("‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω –¥–ª—è: " + email + "\n–í–∞—à–µ–π –ø–æ—á—Ç—ã –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö.");
                // –°–±—Ä–æ—Å
                const tok = gapi.client.getToken();
                if (tok !== null) {
                    google.accounts.oauth2.revoke(tok.access_token);
                    gapi.client.setToken('');
                }
                localStorage.removeItem('google_access_token');
                showLoginButton();
            }
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:", err);
            // –ï—Å–ª–∏ –ª—é–±–∞—è –æ—à–∏–±–∫–∞ - —á–∏—Å—Ç–∏–º —Ç–æ–∫–µ–Ω –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤—Ö–æ–¥–∞
            localStorage.removeItem('google_access_token');
            showLoginButton();
        }
    }
    // --- UI –§–£–ù–ö–¶–ò–ò –í–•–û–î–ê ---
    function showLoginButton() {
        if (document.getElementById('googleLoginBtn')) return;
        
        const btn = document.createElement('button');
        btn.id = 'googleLoginBtn';
        btn.innerText = 'üîë –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google';
        btn.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:10000; padding:15px 30px; font-size:18px; background:#4285F4; color:white; border:none; border-radius:5px; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,0.3);';
        btn.onclick = handleAuthClick;
        document.body.appendChild(btn);
        
        const overlay = document.createElement('div');
        overlay.id = 'loginOverlay';
        overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999;';
        document.body.appendChild(overlay);
    }

    function removeLoginButton() {
        const btn = document.getElementById('googleLoginBtn');
        const ovr = document.getElementById('loginOverlay');
        if (btn) btn.remove();
        if (ovr) ovr.remove();
    }

    // –ó–∞–ø—É—Å–∫ –∑–∞–≥—Ä—É–∑—á–∏–∫–æ–≤ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    window.onload = function() {
        gapiLoaded();
        gisLoaded();
    };

    // ============================================
    // –î–í–ò–ñ–û–ö –ë–ê–ó–´ –î–ê–ù–ù–´–• (GOOGLE SHEETS API)
    // ============================================

    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–ü–æ–∏—Å–∫ –∏–ª–∏ –°–æ–∑–¥–∞–Ω–∏–µ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –ë–î)
    async function apiInitDatabaseImpl() {
        try {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ Email
            if (!CURRENT_USER_EMAIL) {
                return { success: false, error: "Email –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ." };
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Drive (–î–∏—Å–∫)
            if (!gapi.client.drive) {
                return { success: false, error: "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Google Drive API –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É." };
            }

            // –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞
            const targetName = `CakePro_DB_${CURRENT_USER_EMAIL}`;

            // –ò—â–µ–º —Ñ–∞–π–ª
            const response = await gapi.client.drive.files.list({
                q: `name = '${targetName}' and mimeType = 'application/vnd.google-apps.spreadsheet' and trashed = false`,
                fields: 'files(id, name)',
                spaces: 'drive'
            });

            const files = response.result.files;
            if (files && files.length > 0) {
                // –§–∞–π–ª –Ω–∞–π–¥–µ–Ω
                USER_DB_ID = files[0].id;
                localStorage.setItem('cake_db_id', USER_DB_ID);
                console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–∞ –ë–î: ${targetName}`, USER_DB_ID);
                return { success: true, id: USER_DB_ID, status: 'connected' };
            } else {
                // –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω - —Å–æ–∑–¥–∞–µ–º
                console.log(`‚ö†Ô∏è –ë–î –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Å–æ–∑–¥–∞–µ–º: ${targetName}...`);
                const createResp = await gapi.client.sheets.spreadsheets.create({
                    properties: { title: targetName },
                    sheets: [
                        { properties: { title: "ingredients" } },
                        { properties: { title: "recipes" } },
                        { properties: { title: "labor" } },
                        { properties: { title: "queue" } },
                        { properties: { title: "clients" } },
                        { properties: { title: "archive" } },
                        { properties: { title: "settings" } },
                        { properties: { title: "history_stock" } }
                    ]
                });
                USER_DB_ID = createResp.result.spreadsheetId;
                localStorage.setItem('cake_db_id', USER_DB_ID);
                console.log('‚úÖ –ë–î —Å–æ–∑–¥–∞–Ω–∞:', USER_DB_ID);
                return { success: true, id: USER_DB_ID, status: 'created' };
            }
        } catch (e) {
            console.error("–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞ API:", e);
            let msg = e.message || (e.result && e.result.error && e.result.error.message) || JSON.stringify(e);
            return { success: false, error: msg };
        }
    }

    // 2. –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
    async function apiLoadAllDataImpl() {
        if (!USER_DB_ID) return {};
        const sheets = ['ingredients', 'recipes', 'labor', 'queue', 'settings', 'clients', 'archive', 'history_stock'];
        const ranges = sheets.map(s => `${s}!A1`);
        
        try {
            const response = await gapi.client.sheets.spreadsheets.values.batchGet({
                spreadsheetId: USER_DB_ID,
                ranges: ranges
            });
            
            const result = {};
            const valueRanges = response.result.valueRanges;
            
            valueRanges.forEach((range, index) => {
                const sheetName = sheets[index];
                if (range.values && range.values[0] && range.values[0][0]) {
                    try {
                        result[sheetName] = JSON.parse(range.values[0][0]);
                    } catch(parseErr) {
                        console.warn("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ª–∏—Å—Ç–∞:", sheetName);
                    }
                }
            });
            return result;
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", e);
            return {};
        }
    }

    // 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    // 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–° —Ä–∞–∑–±–∏–µ–Ω–∏–µ–º –Ω–∞ —á–∞–Ω–∫–∏ –ø–æ 50–∫ —Å–∏–º–≤–æ–ª–æ–≤)
async function apiSaveDataImpl(sheetName, data) {
    if (!USER_DB_ID) return false;
    
    try {
        // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å—Ç—Ä–æ–∫—É
        const jsonString = JSON.stringify(data);
        
        // –õ–∏–º–∏—Ç Google Sheets –Ω–∞ —è—á–µ–π–∫—É ~50000 —Å–∏–º–≤–æ–ª–æ–≤
        const CHUNK_SIZE = 49000; 
        const chunks = [];
        
        // –†–µ–∂–µ–º —Å—Ç—Ä–æ–∫—É –Ω–∞ –∫—É—Å–∫–∏
        for (let i = 0; i < jsonString.length; i += CHUNK_SIZE) {
            chunks.push([jsonString.substring(i, i + CHUNK_SIZE)]);
        }

        // –û—á–∏—â–∞–µ–º –∫–æ–ª–æ–Ω–∫—É A –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é (—á—Ç–æ–±—ã –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å —Ö–≤–æ—Å—Ç–æ–≤ –æ—Ç —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
        await gapi.client.sheets.spreadsheets.values.clear({
            spreadsheetId: USER_DB_ID,
            range: `${sheetName}!A:A`
        });

        // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∫—É—Å–∫–∏ –≤ —Å—Ç–æ–ª–±–∏–∫ (A1, A2, A3...)
        await gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId: USER_DB_ID,
            range: `${sheetName}!A1`,
            valueInputOption: "RAW",
            resource: { values: chunks }
        });

        console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${sheetName} (${chunks.length} —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤)`);
        return true;
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", e);
        return false;
    }
}

      // --- 5. –†–ê–ë–û–¢–ê –° –§–û–¢–û–ì–†–ê–§–ò–Ø–ú–ò (GOOGLE DRIVE) ---

// –ê. –ù–∞–π—Ç–∏ –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É –¥–ª—è —Ñ–æ—Ç–æ
async function apiGetPhotoFolderId() {
    try {
        // –ò—â–µ–º –ø–∞–ø–∫—É
        const q = "mimeType = 'application/vnd.google-apps.folder' and name = 'CakePro_Photos' and trashed = false";
        const response = await gapi.client.drive.files.list({ q: q, fields: 'files(id)', spaces: 'drive' });
        
        if (response.result.files && response.result.files.length > 0) {
            return response.result.files[0].id; // –ü–∞–ø–∫–∞ —É–∂–µ –µ—Å—Ç—å
        } else {
            // –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É
            const fileMetadata = {
                'name': 'CakePro_Photos',
                'mimeType': 'application/vnd.google-apps.folder'
            };
            const folder = await gapi.client.drive.files.create({
                resource: fileMetadata,
                fields: 'id'
            });
            console.log('üìÅ –°–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞ –¥–ª—è —Ñ–æ—Ç–æ:', folder.result.id);
            return folder.result.id;
        }
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ø–∞–ø–∫–∏ —Ñ–æ—Ç–æ:", e);
        return null;
    }
}

      // –ì. –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª —Å –î–∏—Å–∫–∞ (–ù–∞–≤—Å–µ–≥–¥–∞)
async function apiDeleteFileFromDrive(fileId) {
    try {
        await gapi.client.drive.files.delete({
            fileId: fileId
        });
        console.log('üóëÔ∏è –§–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ —Å –î–∏—Å–∫–∞:', fileId);
        return true;
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ —Å –î–∏—Å–∫–∞:", e);
        return false;
    }
}

// –ë. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ (Base64 -> Drive)
async function apiUploadPhotoToDrive(base64Data, filename) {
    try {
        const folderId = await apiGetPhotoFolderId();
        if (!folderId) return null;

        // 1. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Base64 –≤ BLOB
        // (Base64 –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ "data:image/jpeg;base64,/9j/4AAQSk...")
        const boundary = '-------314159265358979323846';
        const delimiter = "\r\n--" + boundary + "\r\n";
        const close_delim = "\r\n--" + boundary + "--";

        // –û—á–∏—â–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ data:image/...
        const contentType = 'image/jpeg';
        const base64Content = base64Data.split(',')[1];

        // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–∞
        const metadata = {
            'name': filename,
            'mimeType': contentType,
            'parents': [folderId]
        };

        // –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ (Multipart)
        const multipartRequestBody =
            delimiter +
            'Content-Type: application/json\r\n\r\n' +
            JSON.stringify(metadata) +
            delimiter +
            'Content-Type: ' + contentType + '\r\n' +
            'Content-Transfer-Encoding: base64\r\n' +
            '\r\n' +
            base64Content +
            close_delim;

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
        const request = gapi.client.request({
            'path': '/upload/drive/v3/files',
            'method': 'POST',
            'params': {'uploadType': 'multipart'},
            'headers': {
                'Content-Type': 'multipart/related; boundary="' + boundary + '"'
            },
            'body': multipartRequestBody
        });

        const response = await request;
        console.log('‚òÅÔ∏è –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –Ω–∞ –î–∏—Å–∫:', response.result.id);
        return response.result.id; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º ID —Ñ–∞–π–ª–∞ –Ω–∞ –î–∏—Å–∫–µ

    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ:", e);
        return null;
    }
}

// –í. –°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ (Drive ID -> Base64 –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
async function apiDownloadPhotoFromDrive(fileId) {
    try {
        const response = await gapi.client.drive.files.get({
            fileId: fileId,
            alt: 'media'
        });
        // Google –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ. –ù—É–∂–Ω–æ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –∏—Ö –≤ Base64.
        // GAPI –∫–ª–∏–µ–Ω—Ç –∏–Ω–æ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç body, –∏–Ω–æ–≥–¥–∞ result.
        // –°–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ –≤ –±—Ä–∞—É–∑–µ—Ä–µ - —á–µ—Ä–µ–∑ fetch —Å —Ç–æ–∫–µ–Ω–æ–º, 
        // –Ω–æ –ø–æ–ø—Ä–æ–±—É–µ–º —à—Ç–∞—Ç–Ω—ã–π, –µ—Å–ª–∏ –æ–Ω –≤–µ—Ä–Ω–µ—Ç —Ç–µ–∫—Å—Ç.
        
        // –í–ê–†–ò–ê–ù–¢ –ß–ï–†–ï–ó FETCH (–ù–∞–¥–µ–∂–Ω–µ–µ –¥–ª—è –±–∏–Ω–∞—Ä–Ω–∏–∫–æ–≤)
        const token = gapi.client.getToken().access_token;
        const fetchResp = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const blob = await fetchResp.blob();
        
        // Blob -> Base64
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });

    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ:", e);
        return null;
    }
}

    // 4. –†–∞—Å—á–µ—Ç —Ç–æ—Ä—Ç–∞ (–õ–æ–∫–∞–ª—å–Ω–æ)
    function apiCalculateOrderImpl(data) {
        try {
            if (!data.tiers || data.tiers.length === 0) {
               data.tiers = [{
                 id: 1,
                 weight: data.targetWeight,
                 recipeId: data.standardId,
                 fixedDiameter: data.fixedDiameter,
                 fixedHeight: data.fixedHeight
               }];
            }
            
            const calc = new CakeCalculator(data);
            const result = calc.calculate();
        
            return {
              success: true,
              svg: result.svg,
              data: result.data
            };
        
        } catch (e) {
            return { success: false, error: e.message, stack: e.stack };
        }
    }

   
class CakeCalculator {
  constructor(data) {
    this.data = data;
    this.ingredients = data.ingredients || [];
    this.recipes = data.recipes || [];
    this.tiersData = data.tiers || [];
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    this.shape = data.shape || 'cylinder';
    this.polySides = data.polySides || 6;
    
    // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
    this.shoppingList = [];
    this.detailedBlocks = [];
    this.calculatedTiers = [];
    this.totalCost = 0;
    this.totalWeight = 0;
    this.totalFillingWeight = 0;
    this.totalCoatingWeight = 0;
  }

  calculate() {
    // 1. –†–∞—Å—á–µ—Ç –∫–∞–∂–¥–æ–≥–æ —è—Ä—É—Å–∞
    this.tiersData.forEach((tierInput, index) => {
      const isBottom = (index === 0);
      const tierResult = this._calculateSingleTier(tierInput, isBottom);
      this.calculatedTiers.push(tierResult);
      
      this.totalWeight += tierResult.weight;
    });

    // 2. –†—É—á–Ω—ã–µ –¥–æ–±–∞–≤–∫–∏ (Extras)
    if (this.data.extras && this.data.extras.length > 0) {
      this._processExtras(this.data.extras);
    }

    // 3. –§–∏–Ω–∞–Ω—Å—ã
    const rate = this.data.hourlyRate || 0;
    let laborCost = 0;
    if (this.data.laborList && this.data.laborList.length > 0) {
      this.data.laborList.forEach(task => {
        laborCost += (task.realHours || 0) * (task.coeff || 1) * rate;
      });
    } else {
      laborCost = (this.data.hoursSpent || 0) * rate;
    }

    const finalPrice = Math.ceil((this.totalCost + laborCost) * (1 + (this.data.urgencyPercent || 0) / 100));
    
    // 4. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è (SVG)
    const viz = new CakeVisualizer();
    const svgHtml = viz.renderStack(this.calculatedTiers, this.shape, this.polySides);

    // 5. –°–±–æ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞
    const totalH = this.calculatedTiers.reduce((acc, t) => acc + t.h, 0);
    
    // –ù—É—Ç—Ä–∏–µ–Ω—Ç—ã (–ö–ë–ñ–£)
    const sumP = this.shoppingList.reduce((s, i) => s + (i.p_tot || 0), 0);
    const sumF = this.shoppingList.reduce((s, i) => s + (i.f_tot || 0), 0);
    const sumC = this.shoppingList.reduce((s, i) => s + (i.c_tot || 0), 0);
    const sumK = this.shoppingList.reduce((s, i) => s + (i.k_tot || 0), 0);
    const totalWeightG = this.totalWeight;

    const kbju100 = {
        p: totalWeightG > 0 ? ((sumP / totalWeightG) * 100).toFixed(1) : "0.0",
        f: totalWeightG > 0 ? ((sumF / totalWeightG) * 100).toFixed(1) : "0.0",
        c: totalWeightG > 0 ? ((sumC / totalWeightG) * 100).toFixed(1) : "0.0",
        k: totalWeightG > 0 ? Math.round((sumK / totalWeightG) * 100) : 0
    };

    return {
      svg: svgHtml,
      data: {
        tiers: this.calculatedTiers, 
        kbju100: kbju100,
        geometry: { 
            d: Math.round(this.calculatedTiers[0].d), 
            h: parseFloat(totalH.toFixed(1)), 
            shape: this.shape
        },
        weights: { 
            total: Math.round(this.totalWeight),
            filling: Math.round(this.totalFillingWeight),
            coating: Math.round(this.totalCoatingWeight)
        },
        costs: { 
            totalProductionCost: Math.ceil(this.totalCost),
            laborCost: laborCost,
            finalPrice: finalPrice,
            urgency: this.data.urgencyPercent
        },
        shoppingList: this.shoppingList.map(item => {
            // –ë–´–õ–û: item.amount.toFixed(1)
            // –°–¢–ê–õ–û: toFixed(2) - —Ç–æ—á–Ω–æ—Å—Ç—å –¥–æ 0.01 –≥
            item.amount = parseFloat(item.amount.toFixed(2)); 
            item.cost = Math.ceil(item.cost); 
            return item;
        }).sort((a, b) => b.cost - a.cost),
        detailedBlocks: this.detailedBlocks
      }
    };
  }

_calculateSingleTier(tierInput, isBottom) {
    const recipe = this.recipes.find(r => r.id === tierInput.recipeId);
    if (!recipe) throw new Error(`–†–µ—Ü–µ–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω (ID: ${tierInput.recipeId})`);

    // 1. –ê–ù–ê–õ–ò–ó –ù–ê–ß–ò–ù–ö–ò (–ü–ª–æ—Ç–Ω–æ—Å—Ç—å)
    const fillStats = this._analyzeRecipe(recipe);
    let refVolume = fillStats.geom.volume; 
    let fillingDensity = fillStats.netWeight / refVolume;
    
    // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è —Å—Ñ–µ—Ä (–µ—Å–ª–∏ –≤ —Ä–µ—Ü–µ–ø—Ç–µ —É–∫–∞–∑–∞–Ω–æ –Ω–µ–ø–æ–ª–Ω–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ)
    // –í–ê–ñ–ù–û: –ï—Å–ª–∏ —Ä–µ—Ü–µ–ø—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –Ω–∞ 70% –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è, —Ç–æ –µ–≥–æ "–ø–ª–æ—Ç–Ω–æ—Å—Ç—å" –≤ –∫–æ–¥–µ —É–∂–µ —ç—Ç–æ —É—á–∏—Ç—ã–≤–∞–µ—Ç,
    // –Ω–æ –µ—Å–ª–∏ –º—ã —Ö–æ—Ç–∏–º –∑–∞–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ 100% (full), –Ω–∞–º –Ω—É–∂–Ω–æ "—Ä–∞–∑–±–∞–≤–∏—Ç—å" –ø–ª–æ—Ç–Ω–æ—Å—Ç—å.
    if (this.shape === 'sphere') {
        const recipeFillPercent = parseFloat(recipe.fillPercent) || 100;
        if (this.data.sphereFillMode === 'full' && recipeFillPercent < 100) {
            const ratio = 100 / recipeFillPercent;
            fillingDensity = fillingDensity * ratio;
        }
        // –ï—Å–ª–∏ —Ä–µ–∂–∏–º 'recipe' (–∫–∞–∫ –≤ —Ä–µ—Ü–µ–ø—Ç–µ), —Ç–æ fillingDensity –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å,
        // –æ–Ω–∞ —É–∂–µ –æ—Ç—Ä–∞–∂–∞–µ—Ç –≤–µ—Å 1100–≥ –≤ –æ–±—ä–µ–º–µ —Å—Ñ–µ—Ä—ã D18.
    }

    // 2. –ê–ù–ê–õ–ò–ó –ü–û–ö–†–´–¢–ò–Ø (–ö–†–ï–ú / –®–û–ö–û–õ–ê–î)
    let coatingRec = null;
    let coatingConsumption = 0; // —Ä–∞—Å—Ö–æ–¥ –≥/—Å–º2
    let coatingProportionRatio = 0; // –î–æ–ª—è –∫—Ä–µ–º–∞ –æ—Ç –æ–±—â–µ–≥–æ –≤–µ—Å–∞

    if (this.data.coatingId) {
        coatingRec = this.recipes.find(r => r.id === this.data.coatingId);
        if (coatingRec) {
           const cStats = this._analyzeRecipe(coatingRec);
           
           // –°—á–∏—Ç–∞–µ–º –ø–ª–æ—â–∞–¥—å —ç—Ç–∞–ª–æ–Ω–∞ –ø–æ–∫—Ä—ã—Ç–∏—è
           const refArea = this._calculateSurfaceArea(cStats.geom.shape, cStats.geom.d, cStats.geom.h, false, cStats.geom.d, 6); 
           const margin = 1 + ((this.data.coatingMarginPercent || 0) / 100);
           coatingConsumption = (cStats.netWeight / refArea) * margin;

           // –î–ª—è —Ä–µ–∂–∏–º–∞ –ü—Ä–æ–ø–æ—Ä—Ü–∏–∏
           const targetFin = parseFloat(coatingRec.targetFinishedWeight);
           if (targetFin && targetFin > 0) {
                coatingProportionRatio = (cStats.netWeight / targetFin) * margin;
           } else {
                coatingProportionRatio = cStats.netWeight / (fillStats.netWeight + cStats.netWeight);
           }
        }
    }

    // --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–ê ---
    let neededFillWeight = 0;
    let neededCoatWeight = 0;
    let geom = {};

    // ==========================================
    // –°–ü–ï–¶-–†–ï–ñ–ò–ú: –ë–û–ú–ë–ê (–°–§–ï–†–ê)
    // –£ –Ω–µ–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ –≤—Å–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–º.
    // ==========================================
    if (this.shape === 'sphere') {
        // 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –î–∏–∞–º–µ—Ç—Ä
        // –ï—Å–ª–∏ –∑–∞–¥–∞–Ω —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π D (–Ω–∞–ø—Ä–∏–º–µ—Ä 18 –∏–ª–∏ 20), –±–µ—Ä–µ–º –µ–≥–æ.
        // –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–æ–±—Ä–∞—Ç—å D –ø–æ–¥ –æ–±—â–∏–π –≤–µ—Å (—Å–ª–æ–∂–Ω–æ –¥–ª—è –±–æ–º–±—ã, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ).
        // –î–ª—è –±–æ–º–± –æ–±—ã—á–Ω–æ –∑–∞–¥–∞—é—Ç D –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "–ì–µ–æ–º–µ—Ç—Ä–∏—è".
        
        let d = tierInput.fixedDiameter || 18; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 18, –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω–æ
        
        // –ï—Å–ª–∏ —Ä–µ–∂–∏–º "–ü–æ –≤–µ—Å—É" –∏ –¥–∏–∞–º–µ—Ç—Ä –ù–ï –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω - –ø—Ä–æ–±—É–µ–º –ø–æ–¥–æ–±—Ä–∞—Ç—å D
        if (!tierInput.isGeometryMode && (!tierInput.fixedDiameter || tierInput.fixedDiameter <= 0) && tierInput.weight > 0) {
             // –ì—Ä—É–±—ã–π –ø–æ–¥–±–æ—Ä: –í–µ—Å = (V * P_fill) + (Area * P_coat)
             // –¢—É—Ç —Å–ª–æ–∂–Ω–æ —Ä–µ—à–∏—Ç—å —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫—É–±–∞, —É–ø—Ä–æ—Å—Ç–∏–º: —Å—á–∏—Ç–∞–µ–º –∫–∞–∫ –≥–µ–æ–º–µ—Ç—Ä–∏—é, –ø–æ–¥–≥–æ–Ω—è—è D –∏—Ç–µ—Ä–∞—Ü–∏—è–º–∏ (—á–µ—Ä–µ–∑ _solveGeometry)
             geom = this._solveGeometry({
                targetWeight: tierInput.weight, 
                shape: 'sphere',
                fixedHeight: null, // –¥–ª—è —Å—Ñ–µ—Ä—ã h=d
                fillingDensity: fillingDensity,
                coatingConsumption: coatingConsumption, 
                coatingMethod: 'geometry' // –ë–æ–º–±–∞ –≤—Å–µ–≥–¥–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ –≥–µ–æ–º–µ—Ç—Ä–∏–∏!
            });
            d = geom.d;
        } else {
            // –ï—Å–ª–∏ –¥–∏–∞–º–µ—Ç—Ä —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω (–æ–±—ã—á–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è –±–æ–º–±)
            geom = { d: d, h: d, w: d };
            geom.volInner = this._calcVolume('sphere', d, d, d);
            geom.area = this._calculateSurfaceArea('sphere', d, d, false);
        }

        // 2. –†–∞—Å—á–µ—Ç –≤–µ—Å–∞
        // –í–µ—Å –∫–æ—Ä–ø—É—Å–∞ (—à–æ–∫–æ–ª–∞–¥–∞) –∑–∞–≤–∏—Å–∏—Ç –¢–û–õ–¨–ö–û –æ—Ç –ø–ª–æ—â–∞–¥–∏ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏
        neededCoatWeight = geom.area * coatingConsumption;
        
        // –í–µ—Å –Ω–∞—á–∏–Ω–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –≤–µ—Å—å –æ–±—ä–µ–º (—Å —É—á–µ—Ç–æ–º –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä–∞—è —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç % –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è)
        neededFillWeight = geom.volInner * fillingDensity;

        // –ï—Å–ª–∏ –º—ã —à–ª–∏ "–æ—Ç –≤–µ—Å–∞", —Ç–æ –≤–µ—Å–∞ —É–∂–µ –ø–æ—Å—á–∏—Ç–∞–Ω—ã. –ï—Å–ª–∏ "–æ—Ç —Ä–∞–∑–º–µ—Ä–∞" ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π –≤–µ—Å
        if (tierInput.isGeometryMode || tierInput.fixedDiameter) {
             tierInput.weight = neededFillWeight + neededCoatWeight;
        }
    }
    
    // ==========================================
    // –û–ë–´–ß–ù–´–ï –¢–û–†–¢–´ (–¶–∏–ª–∏–Ω–¥—Ä, –ö–≤–∞–¥—Ä–∞—Ç...)
    // ==========================================
    else if (tierInput.isGeometryMode || (tierInput.fixedDiameter && tierInput.fixedHeight && (!tierInput.weight || tierInput.weight <= 0))) {
        // ... (–°—Ç–∞—Ä—ã–π –∫–æ–¥ –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ü–æ —Ä–∞–∑–º–µ—Ä—É") ...
        const d = tierInput.fixedDiameter || 20;
        const h = tierInput.fixedHeight || 10;
        const w = tierInput.fixedWidth || (this.shape === 'rectangle' ? d * 0.75 : d);

        const vInner = this._calcVolume(this.shape, d, h, w, this.polySides);
        const areaCoat = this._calculateSurfaceArea(this.shape, d, h, false, w, this.polySides);
        
        neededFillWeight = vInner * fillingDensity;
        neededCoatWeight = areaCoat * coatingConsumption;

        tierInput.weight = neededFillWeight + neededCoatWeight;
        geom = { d, h, w, volInner: vInner, area: areaCoat };
    } 
    else {
        // ... (–°—Ç–∞—Ä—ã–π –∫–æ–¥ –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ü–æ –≤–µ—Å—É" / –ü—Ä–æ–ø–æ—Ä—Ü–∏—è) ...
        if (this.data.coatingMethod === 'proportion' && coatingRec) {
            neededCoatWeight = tierInput.weight * coatingProportionRatio;
            neededFillWeight = tierInput.weight - neededCoatWeight;
            if (neededFillWeight <= 0) neededFillWeight = 100;

            geom = this._solveGeometry({
                targetWeight: neededFillWeight, 
                shape: this.shape,
                polySides: this.polySides,
                fixedDiameter: tierInput.fixedDiameter,
                fixedWidth: tierInput.fixedWidth,
                fixedHeight: tierInput.fixedHeight,
                fillingDensity: fillingDensity,
                coatingConsumption: 0, 
                coatingMethod: 'geometry'
            });
        }
        else {
            geom = this._solveGeometry({
                targetWeight: tierInput.weight, 
                shape: this.shape,
                polySides: this.polySides,
                fixedDiameter: tierInput.fixedDiameter,
                fixedWidth: tierInput.fixedWidth,
                fixedHeight: tierInput.fixedHeight,
                fillingDensity: fillingDensity,
                coatingConsumption: coatingConsumption,
                coatingMethod: 'geometry'
            });
            neededFillWeight = geom.volInner * fillingDensity;
            neededCoatWeight = geom.area * coatingConsumption;
        }
    }

    // --- –ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–ï –ò –§–ò–ù–ê–õ–ò–ó–ê–¶–ò–Ø (–û–±—â–µ–µ –¥–ª—è –≤—Å–µ—Ö) ---
    const fillScale = neededFillWeight / fillStats.netWeight;
    let coatScale = 0;
    
    if (coatingRec) {
        const cStats = this._analyzeRecipe(coatingRec);
        if (cStats.netWeight > 0) {
            coatScale = neededCoatWeight / cStats.netWeight;
        }
    }

    this.totalFillingWeight += neededFillWeight;
    this.totalCoatingWeight += neededCoatWeight;

    this._processRecipeComponents(recipe, fillScale, `–Ø—Ä—É—Å ${tierInput.id}`, 'filling');
    if (coatingRec) {
        this._processRecipeComponents(coatingRec, coatScale, `–ü–æ–∫—Ä—ã—Ç–∏–µ (–Ø—Ä—É—Å ${tierInput.id})`, 'coating');
    }

    if (this.data.extraCoatingId) {
        const exRec = this.recipes.find(r => r.id === this.data.extraCoatingId);
        if (exRec) {
            const surfArea = this._calculateSurfaceArea(this.shape, geom.d, geom.h, false, geom.w, this.polySides);
            const exStats = this._analyzeRecipe(exRec);
            const exAreaCalib = this._calculateSurfaceArea('cylinder', exStats.geom.d, exStats.geom.h);
            const exScale = (surfArea / exAreaCalib) * (1 + (this.data.extraMarginPercent||0)/100);
            this._processRecipeComponents(exRec, exScale, `–í–µ–ª—é—Ä (–Ø—Ä—É—Å ${tierInput.id})`, 'extra');
        }
    }

    const currentTierCost = this.detailedBlocks
        .filter(blk => blk.name.includes(`–Ø—Ä—É—Å ${tierInput.id}`))
        .reduce((sum, blk) => sum + (blk.totalCost || 0), 0);

    return {
        id: tierInput.id,
        d: geom.d,
        h: geom.h,
        w: geom.w,
        weight: neededFillWeight + neededCoatWeight,
        totalCost: currentTierCost, 
        recipeName: recipe.name,
        forceHeight: tierInput.forceHeight 
    };
  }
      
  _processRecipeComponents(recipe, scale, blockPrefix, type) {
      if (!recipe.blocks) return; 

      // –î–û–ë–ê–í–ò–õ–ò bIdx (–∏–Ω–¥–µ–∫—Å –±–ª–æ–∫–∞), —á—Ç–æ–±—ã –∑–Ω–∞—Ç—å –Ω–æ–º–µ—Ä —Å–ª–æ—è
      recipe.blocks.forEach((block, bIdx) => {
          let blockScale = scale;
          let blockCost = 0;
          let blockIngs = [];
          
          if (block.ingredients) {
              block.ingredients.forEach(link => {
                  const item = this.ingredients.find(i => i.id === link.id);
                  if (item) {
                      const rawAmount = link.weight * blockScale; 
                      let cost = 0;
                      let amountForShopping = rawAmount; 
                      let unitForProduction = item.unit;
                      let isPcsCalculation = (item.unit === '—à—Ç');

                      const singleW = parseFloat(item.singleWeight) || 0;
                      const useWeight = item.useWeightInRecipe === true || item.useWeightInRecipe === "true"; 

                      if (item.unit === '—à—Ç' && singleW > 0 && useWeight) {
                          const pieces = Math.ceil(rawAmount / singleW);
                          amountForShopping = pieces;
                          cost = pieces * (item.packPrice / item.packWeight); 
                          unitForProduction = '–≥'; 
                      } 
                      else {
                          cost = rawAmount * (item.packPrice / item.packWeight);
                      }
                      
                      this._addToShoppingList(item, amountForShopping, cost, isPcsCalculation);
                      blockCost += cost;
                      
                      blockIngs.push({
                          id: item.id, // <--- –í–ê–ñ–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞
                          name: item.name, 
                          amount: parseFloat(rawAmount.toFixed(1)), 
                          unit: unitForProduction,
                          cost: Math.ceil(cost)
                      });
                  }
              });
          }
          
          this.detailedBlocks.push({
              name: `${blockPrefix}: ${block.name}`, 
              type: type, 
              ingredients: blockIngs, 
              totalCost: Math.ceil(blockCost),
              // <--- –í–ê–ñ–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º "GPS-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã" –±–ª–æ–∫–∞
              recipeId: recipe.id,
              blockIndex: bIdx 
          });
          this.totalCost += blockCost;
      });
  }
  _processExtras(extras) {
      let exCost = 0;
      let exIngs = [];
      extras.forEach(ex => {
          const item = this.ingredients.find(i => i.id === ex.id);
          if (item) {
             const cost = ex.amount * (item.packPrice / item.packWeight);
             this._addToShoppingList(item, ex.amount, cost);
             exCost += cost;
             exIngs.push({name: item.name, amount: ex.amount, unit: item.unit, cost: Math.ceil(cost)});
          }
      });
      this.detailedBlocks.push({
          name: "üì¶ –î–µ–∫–æ—Ä –∏ –£–ø–∞–∫–æ–≤–∫–∞", type: 'extra', ingredients: exIngs, totalCost: Math.ceil(exCost)
      });
      this.totalCost += exCost;
  }

  _addToShoppingList(item, amount, cost, isPcs = false) {
    const exist = this.shoppingList.find(i => i.id === item.id);
    
    let weightInGrams = amount;
    if (isPcs) {
        weightInGrams = amount * (item.singleWeight || 0);
    }

    const p_contrib = (weightInGrams / 100) * (item.p || 0);
    const f_contrib = (weightInGrams / 100) * (item.f || 0);
    const c_contrib = (weightInGrams / 100) * (item.c || 0);
    const k_contrib = (weightInGrams / 100) * (item.k || 0);

    if(exist) { 
        exist.amount += amount; 
        exist.cost += cost; 
        exist.p_tot = (exist.p_tot || 0) + p_contrib;
        exist.f_tot = (exist.f_tot || 0) + f_contrib;
        exist.c_tot = (exist.c_tot || 0) + c_contrib;
        exist.k_tot = (exist.k_tot || 0) + k_contrib;
    } else { 
        this.shoppingList.push({
            id: item.id, name: item.name, amount: amount, 
            unit: isPcs ? '—à—Ç' : item.unit, 
            cost: cost,
            p_tot: p_contrib, f_tot: f_contrib, c_tot: c_contrib, k_tot: k_contrib
        }); 
    }
}
  _analyzeRecipe(recipe) {
    const d = parseFloat(recipe.calibrationD || 16);
    const h = parseFloat(recipe.calibrationH || 10);
    const shape = recipe.calibrationShape || 'cylinder';
    
    let vol;
    if (shape === 'sphere') {
        vol = (4/3) * Math.PI * Math.pow(d/2, 3);
    } else if (shape === 'square') {
        vol = d * d * h;
    } else {
        vol = Math.PI * Math.pow(d/2, 2) * h; 
    }

    let weight = parseFloat(recipe.outputWeight);
    if (!weight || isNaN(weight)) {
        weight = recipe.blocks.reduce((sum, b) => {
          return sum + b.ingredients.reduce((s, link) => {
              const ing = this.ingredients.find(i => i.id === link.id);
              return s + (link.weight * (ing ? (ing.singleWeight || 1) : 1));
          }, 0);
        }, 0) || 1000;
    }
    
    return { netWeight: weight, geom: { d, h, volume: vol, shape: shape } };
  }

  _solveGeometry(p) {
    let d = p.fixedDiameter || 20;
    let w = p.fixedWidth || (p.shape === 'rectangle' ? d * 0.75 : d); 
    let h = p.fixedHeight || 10;
    
    if (p.shape === 'sphere' && p.fixedDiameter) { h = d; }
    else if (p.shape === 'rectangle' && p.fixedDiameter && p.fixedWidth && p.fixedHeight) {}
    else if ((p.shape === 'cylinder' || p.shape === 'square' || p.shape === 'polygon') && p.fixedDiameter && p.fixedHeight) {}
    else {
        const thick = 0.5; 
        const coatingDensity = p.coatingConsumption / thick;

        // ... –Ω–∞—á–∞–ª–æ —Ñ—É–Ω–∫—Ü–∏–∏ (—Ä–∞—Å—á–µ—Ç thick –∏ coatingDensity –æ—Å—Ç–∞–≤–ª—è–µ–º) ...

      for(let i=0; i<20; i++) { // –£–≤–µ–ª–∏—á–∏–ª–∏ —á–∏—Å–ª–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–æ 20
          const vInner = this._calcVolume(p.shape, d, h, w, p.polySides);
          const areaCoat = this._calculateSurfaceArea(p.shape, d, h, false, w, p.polySides); 
          const vCoat = areaCoat * thick;
          
          const estWeight = (vInner * p.fillingDensity) + (vCoat * coatingDensity);

          // –í–ê–ñ–ù–û: –°–Ω–∏–∑–∏–ª–∏ –ø–æ—Ä–æ–≥ –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç–∏ —Å 5–≥ –¥–æ 0.5–≥ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
          if (Math.abs(estWeight - p.targetWeight) < 0.5) break; 
          
          const ratio = p.targetWeight / estWeight;

          if (p.shape === 'sphere') { 
              d *= Math.pow(ratio, 1/3); h = d; 
          } 
          else if (p.shape === 'rectangle') {
               if (p.fixedDiameter && p.fixedWidth) h *= ratio; 
               else if (p.fixedHeight) { const f = Math.sqrt(ratio); d *= f; w *= f; }
               else if (p.fixedDiameter) h *= ratio; 
               else { const f = Math.pow(ratio, 1/3); d *= f; h *= f; w *= f; }
          } 
          else { 
               if (p.fixedDiameter) h *= ratio; 
               else if (p.fixedHeight) d *= Math.sqrt(ratio); 
               else { const f = Math.pow(ratio, 1/3); d *= f; h *= f; w *= f; }
          }
      }
    }
    
    // –û–ö–†–£–ì–õ–ï–ù–ò–ï –†–ê–ó–ú–ï–†–û–í
    d = Math.round(d); // –î–∏–∞–º–µ—Ç—Ä –æ–±—ã—á–Ω–æ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ (—Ñ–æ—Ä–º–∞)
    if (w) w = Math.round(w);
    
    // –í–´–°–û–¢–ê:
    if (p.shape === 'sphere') {
        h = d; 
    } else {
        // –í–ê–ñ–ù–û: –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ –°–û–¢–´–• (2 –∑–Ω–∞–∫–∞), —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –º–∏–ª–ª–∏–º–µ—Ç—Ä—ã
        h = Math.round(h * 100) / 100;
    }

    
    const vFinal = this._calcVolume(p.shape, d, h, w, p.polySides);
    const areaFinal = this._calculateSurfaceArea(p.shape, d, h, false, w, p.polySides);
    return { d, h, w, volInner: vFinal, area: areaFinal };
  }

  _calcVolume(shape, d, h, w, n) {
      if (shape === 'square') return d * d * h;
      if (shape === 'rectangle') return d * (w || d) * h;
      if (shape === 'sphere') return (4/3) * Math.PI * Math.pow(d/2, 3);
      if (shape === 'polygon') {
          const R = d / 2;
          const area = 0.5 * n * R * R * Math.sin((2 * Math.PI) / n);
          return area * h;
      }
      return Math.PI * Math.pow(d/2, 2) * h;
  }

  _calculateSurfaceArea(shape, d, h, bottom, w, n) {
      let top, side;
      if (shape === 'sphere') return 4 * Math.PI * Math.pow(d/2, 2);
      
      if (shape === 'polygon') {
          const R = d / 2;
          top = 0.5 * n * R * R * Math.sin((2 * Math.PI) / n);
          const a = 2 * R * Math.sin(Math.PI / n);
          side = (n * a) * h;
      } 
      else if (shape === 'square') { 
          top = d * d; 
          side = 4 * d * h; 
      }
      else if (shape === 'rectangle') { 
          const width = w || d;
          top = d * width; 
          side = 2 * (d + width) * h;
      }
      else { 
          top = Math.PI * Math.pow(d/2, 2); 
          side = Math.PI * d * h;
      }
      return side + top + (bottom ? top : 0);
  }
}

class CakeVisualizer {
  renderStack(tiers, shape, sides) {
      const W = 400, H = 500;
      const cX = W / 2;
      const n = sides || 6;

      const totalStackH = tiers.reduce((sum, t) => sum + t.h, 0);
      
      const maxStackD = Math.max(...tiers.map(t => {
          if (shape === 'rectangle' || shape === 'square') {
              return Math.sqrt(Math.pow(t.d, 2) + Math.pow(t.w || t.d, 2));
          }
          return t.d;
      }));

      const safeW = W * 0.75;
      const safeH = H * 0.85;
      let SCALE = Math.min(safeW / maxStackD, safeH / totalStackH);
      
      if (SCALE > 10) SCALE = 10; 
      if (tiers.length === 1 && SCALE > 6) SCALE = 6;

      const pxTotalH = totalStackH * SCALE;
      let currentBaseCenterY = H - (H - pxTotalH) / 2;

      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞
      const gradId = 'gradSphere_' + Math.round(Math.random() * 100000);

      let svgContent = `<defs>
        <radialGradient id="${gradId}" cx="35%" cy="35%" r="65%">
            <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#e0e0e0;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#9e9e9e;stop-opacity:1" />
        </radialGradient>
      </defs>`;

      const colFill = '#e0e0e0';
      const colStr = '#757575';
      const colDim = '#1976D2'; 

      const fmt = (num) => (num % 1 === 0) ? num : num.toFixed(1);

      tiers.forEach((t, idx) => {
          const pxD = t.d * SCALE;
          const pxH = t.h * SCALE;
          const pxW = (t.w || t.d) * SCALE;
          const pxR = pxD / 2;

          if (shape === 'sphere') {
              const r = pxD / 2;
              const cySphere = currentBaseCenterY - r; 
              if (idx === 0) svgContent += `<ellipse cx="${cX}" cy="${currentBaseCenterY}" rx="${r*0.8}" ry="${r*0.2}" fill="#000" opacity="0.15" />`;
              svgContent += `<circle cx="${cX}" cy="${cySphere}" r="${r}" fill="url(#${gradId})" stroke="${colStr}" stroke-width="1" />`;
              svgContent += `<text x="${cX}" y="${cySphere}" text-anchor="middle" dominant-baseline="middle" fill="${colDim}" font-weight="bold" font-size="12">D${fmt(t.d)}</text>`;
          
          } else if (shape === 'polygon') {
              const getPolyPoints = (cy) => {
                  let pts = [];
                  for(let i=0; i<n; i++) {
                      const angle = (i * 2 * Math.PI / n) - (Math.PI / 2); 
                      const x = cX + (pxR * Math.cos(angle));
                      const y = cy + (pxR * Math.sin(angle) * 0.4); 
                      pts.push({x, y, str:`${x},${y}`});
                  }
                  return pts;
              };
              const ptsBot = getPolyPoints(currentBaseCenterY);
              const ptsTop = getPolyPoints(currentBaseCenterY - pxH);
              const tierCenterY = currentBaseCenterY - pxH;

              for(let i=0; i<n; i++) {
                  const next = (i+1)%n;
                  if (ptsTop[i].y > tierCenterY || ptsTop[next].y > tierCenterY) {
                      svgContent += `<polygon points="${ptsTop[i].str} ${ptsTop[next].str} ${ptsBot[next].str} ${ptsBot[i].str}" fill="${(i%2===0)?'#f5f5f5':colFill}" stroke="${colStr}" stroke-width="1" />`;
                  }
              }
              svgContent += `<polygon points="${ptsTop.map(p=>p.str).join(' ')}" fill="#fff" stroke="${colStr}" stroke-width="1" />`;
              
              svgContent += `<text x="${cX}" y="${currentBaseCenterY - 10}" text-anchor="middle" fill="${colDim}" font-weight="bold" font-size="12">D${fmt(t.d)}</text>`;
              svgContent += `<text x="${cX + pxR + 10}" y="${currentBaseCenterY - pxH/2}" fill="${colDim}" font-size="12">H${fmt(t.h)}</text>`;

          } else if (shape === 'rectangle' || shape === 'square') {
              const cos30 = 0.866; const sin30 = 0.5;
              const offRx = pxD * cos30; const offRy = pxD * sin30;
              const offLx = pxW * cos30; const offLy = pxW * sin30;
              
              const shiftX = (pxD - pxW) * cos30 / 2;
              const bCx = cX - shiftX; 
              const shiftY = (pxD + pxW) * sin30 / 2;
              const bCy = currentBaseCenterY + shiftY;
              
              const tCx = bCx; const tCy = bCy - pxH;
              const tR = { x: tCx + offRx, y: tCy - offRy }; 
              const tL = { x: tCx - offLx, y: tCy - offLy }; 
              const tBack = { x: tCx + offRx - offLx, y: tCy - offRy - offLy }; 
              const bR = { x: bCx + offRx, y: bCy - offRy }; 
              const bL = { x: bCx - offLx, y: bCy - offLy };

              svgContent += `<polygon points="${tCx},${tCy} ${tR.x},${tR.y} ${bR.x},${bR.y} ${bCx},${bCy}" fill="#d0d0d0" stroke="${colStr}" stroke-width="1" />`;
              svgContent += `<polygon points="${tCx},${tCy} ${tL.x},${tL.y} ${bL.x},${bL.y} ${bCx},${bCy}" fill="${colFill}" stroke="${colStr}" stroke-width="1" />`;
              svgContent += `<polygon points="${tCx},${tCy} ${tR.x},${tR.y} ${tBack.x},${tBack.y} ${tL.x},${tL.y}" fill="#fff" stroke="${colStr}" stroke-width="1" />`;

              const midRx = (tCx + tR.x) / 2;
              const midRy = (tCy + tR.y) / 2;
              svgContent += `<text x="${midRx}" y="${midRy + 5}" fill="${colDim}" font-weight="bold" font-size="12" text-anchor="middle" transform="rotate(-30, ${midRx+10}, ${midRy-5})">${fmt(t.d)}</text>`;

              if(shape === 'rectangle' || t.d !== t.w) {
                   const midLx = (tCx + tL.x) / 2;
                   const midLy = (tCy + tL.y) / 2;
                   svgContent += `<text x="${midLx - 5}" y="${midLy + 5}" fill="${colDim}" font-weight="bold" font-size="12" text-anchor="middle" transform="rotate(30, ${midLx-10}, ${midLy-5})">${fmt(t.w)}</text>`;
              }

              const midHx = bCx;
              const midHy = (bCy + tCy) / 2;
              svgContent += `<text x="${midHx}" y="${midHy}" dx="8" fill="${colDim}" font-weight="bold" font-size="12" dominant-baseline="middle">H${fmt(t.h)}</text>`;

          } else { 
              const ry = pxR * 0.3;
              const tierTopY = currentBaseCenterY - pxH;
              svgContent += `<path d="M ${cX-pxR} ${tierTopY} v ${pxH} a ${pxR} ${ry} 0 0 0 ${pxD} 0 v -${pxH}" fill="${colFill}" stroke="${colStr}" stroke-width="1" />`;
              svgContent += `<ellipse cx="${cX}" cy="${tierTopY}" rx="${pxR}" ry="${ry}" fill="#fff" stroke="${colStr}" stroke-width="1" />`;
              svgContent += `<path d="M ${cX-pxR} ${currentBaseCenterY} a ${pxR} ${ry} 0 0 0 ${pxD} 0" fill="none" stroke="${colStr}" stroke-width="1" />`;

              svgContent += `<text x="${cX}" y="${tierTopY + 5}" fill="#333" font-size="12" font-weight="bold" text-anchor="middle">D${fmt(t.d)}</text>`;
              svgContent += `<text x="${cX + pxR + 5}" y="${currentBaseCenterY - pxH/2}" fill="${colDim}" font-size="12" font-weight="bold">H${fmt(t.h)}</text>`;
          }
          currentBaseCenterY -= pxH;
      });

      if (tiers.length > 0) {
          const arrowX = 20;
          const floorY = H - (H - pxTotalH) / 2;
          const topY = floorY - pxTotalH;
          svgContent += `<line x1="${arrowX}" y1="${floorY}" x2="${arrowX}" y2="${topY}" stroke="${colDim}" stroke-width="2"/>`;
          svgContent += `<line x1="${arrowX-5}" y1="${floorY}" x2="${arrowX+5}" y2="${floorY}" stroke="${colDim}" stroke-width="2"/>`;
          svgContent += `<line x1="${arrowX-5}" y1="${topY}" x2="${arrowX+5}" y2="${topY}" stroke="${colDim}" stroke-width="2"/>`;
          
          svgContent += `<text x="${arrowX + 20}" y="${floorY - (floorY-topY)/2}" fill="${colDim}" font-size="14" font-weight="bold" transform="rotate(-90 ${arrowX + 20},${floorY - (floorY-topY)/2})" text-anchor="middle">–í—Å–µ–≥–æ: ${fmt(totalStackH)} —Å–º</text>`;
      }

      return `<svg width="100%" height="100%" viewBox="0 0 ${W} ${H}" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" style="font-family:Arial, sans-serif;">${svgContent}</svg>`;
  }
}

  // ============================================
  // –î–í–ò–ñ–û–ö –ë–ê–ó–´ –î–ê–ù–ù–´–• (GOOGLE SHEETS API)
  // ============================================

  // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–ü–æ–∏—Å–∫ –∏–ª–∏ –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞)
// 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–ü–æ–∏—Å–∫ –∏–ª–∏ –°–æ–∑–¥–∞–Ω–∏–µ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –ë–î)
  async function apiInitDatabaseImpl() {
    try {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ Email
        if (!CURRENT_USER_EMAIL) {
            return { success: false, error: "Email –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ." };
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Drive (–î–∏—Å–∫)
        if (!gapi.client.drive) {
            return { success: false, error: "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Google Drive API –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É." };
        }

        // –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞
        const targetName = `CakePro_DB_${CURRENT_USER_EMAIL}`;

        // –ò—â–µ–º —Ñ–∞–π–ª
        const response = await gapi.client.drive.files.list({
            q: `name = '${targetName}' and mimeType = 'application/vnd.google-apps.spreadsheet' and trashed = false`,
            fields: 'files(id, name)',
            spaces: 'drive'
        });

        const files = response.result.files;
        if (files && files.length > 0) {
            // –§–∞–π–ª –Ω–∞–π–¥–µ–Ω
            USER_DB_ID = files[0].id;
            localStorage.setItem('cake_db_id', USER_DB_ID);
            console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–∞ –ë–î: ${targetName}`, USER_DB_ID);
            return { success: true, id: USER_DB_ID, status: 'connected' };
        } else {
            // –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω - —Å–æ–∑–¥–∞–µ–º
            console.log(`‚ö†Ô∏è –ë–î –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Å–æ–∑–¥–∞–µ–º: ${targetName}...`);
            const createResp = await gapi.client.sheets.spreadsheets.create({
                properties: { title: targetName },
                sheets: [
                    { properties: { title: "ingredients" } },
                    { properties: { title: "recipes" } },
                    { properties: { title: "labor" } },
                    { properties: { title: "queue" } },
                    { properties: { title: "clients" } },
                    { properties: { title: "archive" } },
                    { properties: { title: "settings" } },
                    { properties: { title: "history_stock" } }
                ]
            });
            USER_DB_ID = createResp.result.spreadsheetId;
            localStorage.setItem('cake_db_id', USER_DB_ID);
            console.log('‚úÖ –ë–î —Å–æ–∑–¥–∞–Ω–∞:', USER_DB_ID);
            return { success: true, id: USER_DB_ID, status: 'created' };
        }
    } catch (e) {
        console.error("–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞ API:", e);
        // –ü—ã—Ç–∞–µ–º—Å—è –¥–æ—Å—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç –æ–±—ä–µ–∫—Ç–∞ Google
        let msg = e.message || (e.result && e.result.error && e.result.error.message) || JSON.stringify(e);
        return { success: false, error: msg };
    }
  }

  // 2. –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö (–ß—Ç–µ–Ω–∏–µ —è—á–µ–µ–∫ A1 —Å–æ –≤—Å–µ—Ö –ª–∏—Å—Ç–æ–≤)
  // 2. –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö (–° —á—Ç–µ–Ω–∏–µ–º —á–∞–Ω–∫–æ–≤)
async function apiLoadAllDataImpl() {
    if (!USER_DB_ID) return {};
    const sheets = ['ingredients', 'recipes', 'labor', 'queue', 'settings', 'clients', 'archive', 'history_stock'];
    
    // –ß–∏—Ç–∞–µ–º –Ω–µ –ø—Ä–æ—Å—Ç–æ A1, –∞ –≤–µ—Å—å —Å—Ç–æ–ª–±–µ—Ü A (A:A)
    const ranges = sheets.map(s => `${s}!A:A`);
    
    try {
        const response = await gapi.client.sheets.spreadsheets.values.batchGet({
            spreadsheetId: USER_DB_ID,
            ranges: ranges
        });
        
        const result = {};
        const valueRanges = response.result.valueRanges;
        
        valueRanges.forEach((range, index) => {
            const sheetName = sheets[index];
            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å
            if (range.values && range.values.length > 0) {
                try {
                    // –°–∫–ª–µ–∏–≤–∞–µ–º –≤—Å–µ —è—á–µ–π–∫–∏ —Å—Ç–æ–ª–±—Ü–∞ A –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
                    const fullJson = range.values.map(row => row[0]).join('');
                    result[sheetName] = JSON.parse(fullJson);
                } catch(parseErr) {
                    console.warn("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ª–∏—Å—Ç–∞:", sheetName);
                }
            }
        });
        return result;
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", e);
        return {};
    }
}
  // 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–ó–∞–ø–∏—Å—å –≤ —è—á–µ–π–∫—É A1)
  async function apiSaveDataImpl(sheetName, data) {
    if (!USER_DB_ID) return false;
    try {
        const body = { values: [[JSON.stringify(data)]] };
        await gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId: USER_DB_ID,
            range: `${sheetName}!A1`,
            valueInputOption: "RAW",
            resource: body
        });
        console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${sheetName}`);
        return true;
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", e);
        return false;
    }
  }

  // 4. –†–∞—Å—á–µ—Ç —Ç–æ—Ä—Ç–∞ (–¢–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞!)
  function apiCalculateOrderImpl(data) {
      try {
        // –ê–¥–∞–ø—Ç–µ—Ä —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (—Å—Ç–∞—Ä—ã–π –∫–æ–¥)
        if (!data.tiers || data.tiers.length === 0) {
           data.tiers = [{
             id: 1,
             weight: data.targetWeight,
             recipeId: data.standardId,
             fixedDiameter: data.fixedDiameter,
             fixedHeight: data.fixedHeight
           }];
        }
        
        // –ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
        const calc = new CakeCalculator(data);
        const result = calc.calculate();
    
        return {
          success: true,
          svg: result.svg,
          data: result.data
        };
    
      } catch (e) {
        return { success: false, error: e.message, stack: e.stack };
      }
  }

  // ============================================
  // ADAPTER (–ú–û–°–¢ –ú–ï–ñ–î–£ –°–¢–ê–†–´–ú UI –ò –ù–û–í–´–ú API)
  // ============================================
  // –≠—Ç–æ—Ç –∫–æ–¥ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–∑–æ–≤—ã google.script.run –∏ –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –≤ –Ω–∞—à–∏ –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  const runAdapter = {
    _cb: null,
    _fail: null,
    
    withSuccessHandler: function(cb) {
        this._cb = cb;
        return this;
    },
    withFailureHandler: function(cb) {
        this._fail = cb;
        return this;
    },
    
    // –ü–µ—Ä–µ—Ö–≤–∞—Ç —Ñ—É–Ω–∫—Ü–∏–π
    apiInitDatabase: async function() {
        const res = await apiInitDatabaseImpl();
        if(this._cb) this._cb(res);
    },
    apiLoadAllData: async function() {
        const res = await apiLoadAllDataImpl();
        if(this._cb) this._cb(res);
    },
    apiSaveData: async function(node, data) {
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ, UI –æ–±—ã—á–Ω–æ –Ω–µ –∂–¥–µ—Ç –æ—Ç–≤–µ—Ç–∞, –Ω–æ –º—ã –≤–µ—Ä–Ω–µ–º true
        const res = await apiSaveDataImpl(node, data);
        if(this._cb) this._cb(res); 
    },
    apiCalculateOrder: function(data) {
        // –†–∞—Å—á–µ—Ç —Ç–µ–ø–µ—Ä—å –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π)
        const res = apiCalculateOrderImpl(data);
        if(this._cb) this._cb(res);
    }
  };

  // –ü–æ–¥–º–µ–Ω—è–µ–º –æ–±—ä–µ–∫—Ç google.script.run
  window.google = { script: { run: runAdapter } };
      </script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FF5722">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/192/cake.png">
    
    <style>

      /* --- –°–¢–ò–õ–ò –î–õ–Ø –°–¢–ï–ü–ü–ï–†–ê (–ö–Ω–æ–ø–∫–∏ +/-) --- */
/* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–µ–ø–ø–µ—Ä–æ–≤ */
.stepper {
    display: flex;
    align-items: stretch;
    border: 1px solid #ddd;
    border-radius: 6px;
    overflow: hidden;
    background: #fff;
}
.stepper input {
    border: none;
    text-align: center;
    font-weight: bold;
    font-size: 16px;
    width: 100%;
    border-left: 1px solid #eee;
    border-right: 1px solid #eee;
    margin: 0;
    border-radius: 0;
    -moz-appearance: textfield; /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å—Ç—Ä–µ–ª–∫–∏ */
}
.stepper input::-webkit-outer-spin-button,
.stepper input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
.step-btn {
    background: #f9f9f9;
    border: none;
    color: #1976D2;
    font-weight: bold;
    font-size: 18px;
    width: 40px;
    cursor: pointer;
    transition: 0.2s;
    touch-action: manipulation; /* –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–∞–ø–∞ */
}
.step-btn:active {
    background: #ddd;
    color: #0D47A1;
}

      /* --- –ö–û–õ–û–†–ò–°–¢–ò–ö–ê --- */
.color-step-box {
    flex: 1;
    background: #fff;
    border: 2px solid #eee;
    border-radius: 8px;
    padding: 10px;
    text-align: center;
    cursor: pointer;
    transition: 0.2s;
}
.color-step-box:hover { border-color: #90CAF9; }
.color-step-box.active-picker {
    border-color: #FF5722;
    background: #FFF3E0;
    box-shadow: 0 4px 10px rgba(255, 87, 34, 0.2);
    transform: translateY(-2px);
}
.color-patch {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin: 5px auto;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
}
.step-num { font-size: 10px; font-weight: bold; color: #999; text-transform: uppercase; }
.step-desc { font-size: 11px; color: #333; font-weight: bold; }

/* --- –°–¢–ò–õ–ò –ó–ê–©–ò–¢–´ –†–ï–¶–ï–ü–¢–ê --- */
.recipe-locked input, 
.recipe-locked select {
    pointer-events: none;       /* –ó–∞–ø—Ä–µ—Ç –Ω–∞–∂–∞—Ç–∏—è */
    background: transparent !important; /* –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω */
    border: none !important;    /* –ë–µ–∑ —Ä–∞–º–æ–∫ */
    color: #333 !important;     /* –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ */
    font-weight: bold;
    padding: 0;
}

/* –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ —Ä–µ–∂–∏–º–µ –∑–∞—â–∏—Ç—ã */
.recipe-locked .del-btn,
.recipe-locked .add-btn-small,
.recipe-locked button.main-btn[onclick="addBlock()"],
.recipe-locked .move-btn { 
    display: none !important; 
}

/* –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è —Å–∞–º–æ–≥–æ —Ä–µ—Ü–µ–ø—Ç–∞ */
.recipe-locked button.del-btn[onclick="deleteCurrentRecipe()"] {
    display: none !important;
}

/* –ß—Ç–æ–±—ã –ø–æ–ª—è –≤—ã–≥–ª—è–¥–µ–ª–∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ */
.recipe-locked .form-group {
    border-bottom: 1px solid #eee; /* –õ–∏–Ω–∏—è —Å–Ω–∏–∑—É –≤–º–µ—Å—Ç–æ —Ä–∞–º–∫–∏ */
    padding-bottom: 2px;
}
      
      /* --- –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ (LONG PRESS) --- */
.context-menu {
    position: fixed;
    z-index: 10000;
    background: white;
    border-radius: 8px;
    box-shadow: 0 5px 25px rgba(0,0,0,0.2);
    display: none;
    flex-direction: column;
    overflow: hidden;
    min-width: 150px;
    animation: menuScale 0.2s ease-out;
}
@keyframes menuScale {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}
.context-menu-item {
    padding: 12px 16px;
    font-size: 14px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
}
.context-menu-item:last-child { border-bottom: none; }
.context-menu-item:active { background: #f5f5f5; }
.context-menu-item.danger { color: #d32f2f; }

/* --- –°–¢–ò–õ–ò –î–õ–Ø –ù–û–í–û–ì–û –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–Ø –†–ï–ñ–ò–ú–û–í --- */
.mode-toggle-wrapper {
    display: inline-flex;
    background: #eaeff5; /* –°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π —Ñ–æ–Ω –∫–∞–ø—Å—É–ª—ã */
    border-radius: 20px;   /* –ó–∞–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ –∫—Ä–∞—è */
    padding: 3px;
    border: 1px solid #d0d7de;
    align-items: center;
}

.mode-icon {
    cursor: pointer;
    padding: 4px 8px;
    font-size: 16px;
    border-radius: 16px;
    transition: all 0.3s ease; /* –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è */
    /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∫–æ–Ω–∫–∞ —Å–µ—Ä–∞—è –∏ –±–ª–µ–∫–ª–∞—è */
    filter: grayscale(100%); 
    opacity: 0.5;
    line-height: 1;
}

/* –°–æ—Å—Ç–æ—è–Ω–∏–µ –ê–ö–¢–ò–í–ù–û–ô –∏–∫–æ–Ω–∫–∏ */
.mode-icon.active {
     background: #fff;          /* –ë–µ–ª—ã–π —Ñ–æ–Ω –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π */
     filter: grayscale(0%);     /* –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ü–≤–µ—Ç */
     opacity: 1;                /* –ü–æ–ª–Ω–∞—è —è—Ä–∫–æ—Å—Ç—å */
     box-shadow: 0 1px 4px rgba(0,0,0,0.15); /* –ù–µ–±–æ–ª—å—à–∞—è —Ç–µ–Ω—å */
     color: #1976D2;            /* –°–∏–Ω–∏–π –æ—Ç—Ç–µ–Ω–æ–∫ (–¥–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏—Ö —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —ç–º–æ–¥–∑–∏) */
}

.mode-icon:hover:not(.active) {
    opacity: 0.8; /* –ù–µ–±–æ–ª—å—à–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—É—é */
    background: #f5f8fa;
}
      
      /* --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò --- */
      * { box-sizing: border-box; }
      body { font-family: 'Segoe UI', Roboto, Arial, sans-serif; background: #f5f7fa; color: #333; padding: 15px; margin: 0; font-size: 14px; }
      /* –ë–´–õ–û: max-width: 1000px; */
.container { 
    max-width: 1400px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –Ω–∞ –æ–≥—Ä–æ–º–Ω—ã—Ö –º–æ–Ω–∏—Ç–æ—Ä–∞—Ö */
    width: 95%;        /* –ù–∞ –Ω–æ—É—Ç–±—É–∫–∞—Ö —á—É—Ç—å –æ—Ç—Å—Ç—É–ø—ã */
    margin: 0 auto; 
}


      
/* –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø (–ú–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å) */
@media (max-width: 768px) {
  /* --- 1. –§–û–†–ú–´ –í –°–¢–û–õ–ë–ò–ö --- */
    /* –õ—é–±–∞—è —Å—Ç—Ä–æ–∫–∞ —Å –ø–æ–ª—è–º–∏ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –∫–æ–ª–æ–Ω–∫—É */
    .form-row {
        flex-direction: column !important;
        gap: 12px;
        margin-bottom: 15px;
    }
    .form-group {
        width: 100% !important; /* –ü–æ–ª–µ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
        margin-right: 0 !important;
    }
    
    /* –£–±–∏—Ä–∞–µ–º –º–∏–∫—Ä–æ-–æ—Ç—Å—Ç—É–ø—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–µ—à–∞—é—Ç –Ω–∞ –º–æ–±–∏–ª–µ */
    .card { padding: 15px; }
    
    /* --- 2. –ñ–ï–õ–¢–´–ô –ë–õ–û–ö (–≠–¢–ê–õ–û–ù) --- */
    /* –¢—É—Ç –Ω–∞–º –Ω–µ –Ω—É–∂–µ–Ω —Å—Ç—Ä–æ–≥–∏–π —Å—Ç–æ–ª–±–∏–∫, –ª—É—á—à–µ —Å–µ—Ç–∫–∞ 2x2 */
    .calibration-box .form-row {
        flex-direction: row !important; /* –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä—è–¥ */
        flex-wrap: wrap;                /* –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å */
    }
    /* –ö–∞–∂–¥–æ–µ –ø–æ–ª–µ –∑–∞–Ω–∏–º–∞–µ—Ç 48% —à–∏—Ä–∏–Ω—ã (–≤—Å—Ç–∞–Ω—É—Ç –ø–æ –¥–≤–æ–µ) */
    .calibration-box .form-group {
        flex: 1 1 45% !important; 
        min-width: 120px;
    }
    /* –ü–æ–ª–µ "–§–æ—Ä–º–∞ –≤—ã–ø–µ—á–∫–∏" –ø—É—Å—Ç—å –±—É–¥–µ—Ç –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
    #rowShape .form-group { flex: 1 1 100% !important; }
    /* 1. –û—Ç–∫–ª—é—á–∞–µ–º Flex (–∫–æ–ª–æ–Ω–∫–∏) */
    .recipe-layout { display: block; position: relative; }
    
    /* 2. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: –í–∏–¥–µ–Ω —Å–ø–∏—Å–æ–∫, –°–∫—Ä—ã—Ç —Ä–µ–¥–∞–∫—Ç–æ—Ä */
    .recipe-list { width: 100%; border-right: none; display: block; }
    .recipe-editor { width: 100%; display: none; }
    
    /* 3. –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∫–æ–≥–¥–∞ –≤—ã–±—Ä–∞–Ω —Ä–µ—Ü–µ–ø—Ç) */
    /* –ú—ã –±—É–¥–µ–º –≤–µ—à–∞—Ç—å –∫–ª–∞—Å—Å .mobile-view-active –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä .recipe-layout */
    .recipe-layout.mobile-view-active .recipe-list { display: none; }
    .recipe-layout.mobile-view-active .recipe-editor { display: block; animation: fadeIn 0.3s; }
    .recipe-editor button[onclick="closeRecipeMobile()"] { display: block !important; }
    
    /* –£–≤–µ–ª–∏—á–∏–º –≤—ã—Å–æ—Ç—É —Å—Ç—Ä–æ–∫ –≤ —Å–ø–∏—Å–∫–µ —Ä–µ—Ü–µ–ø—Ç–æ–≤ –¥–ª—è –ø–∞–ª—å—Ü–µ–≤ */
    .recipe-item { padding: 15px; margin-bottom: 8px; font-size: 16px; }

    /* --- 3. –°–¢–†–û–ö–ò –ò–ù–ì–†–ï–î–ò–ï–ù–¢–û–í --- */
    .ing-row {
        display: grid !important;
        /* –î–≤–µ —Å—Ç—Ä–æ–∫–∏: 
           1. –ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É)
           2. –í–µ—Å + –ö–Ω–æ–ø–∫–∞ (—Ä—è–¥–æ–º) */
        grid-template-columns: 1fr auto; 
        grid-template-areas: 
            "name name"
            "weight del";
        gap: 8px;
        background: #f9f9f9;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #eee;
        margin-bottom: 8px;
    }
    
    .ing-search-input { grid-area: name; width: 100%; font-weight: bold; }
    .ing-weight { grid-area: weight; width: 100px !important; }
    .ing-row .del-btn { grid-area: del; width: 44px; height: 44px; background: #ffebee; border-radius: 4px; display:flex; align-items:center; justify-content:center;}

    /* --- 4. –ë–õ–û–ö –ü–ï–†–ï–°–ß–ï–¢–ê --- */
    /* –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –∫–Ω–æ–ø–∫–æ–π –ø–µ—Ä–µ—Å—á–µ—Ç–∞ (—ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π div –≤–Ω—É—Ç—Ä–∏ calibration-box) */
    .calibration-box > div:last-child {
        flex-direction: column !important; /* –≠–ª–µ–º–µ–Ω—Ç—ã –¥—Ä—É–≥ –ø–æ–¥ –¥—Ä—É–≥–æ–º */
        align-items: stretch !important;
    }
    /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ –≤–µ—Å–∞ */
    #recAdjustWeight {
        width: 100% !important;
        margin-bottom: 8px;
        text-align: center;
    }
    /* –ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å" */
    .calibration-box button {
        width: 100% !important;
    }

    /* --- 5. –û–ö–ù–û –ò–ú–ü–û–†–¢–ê –ù–ê –ú–û–ë–ò–õ–¨–ù–û–ú --- */
    /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ, —á—Ç–æ–±—ã —É–¥–æ–±–Ω–æ –±—ã–ª–æ –≤—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç */
    #importModal textarea {
        width: 100%;
        height: 200px; /* –ü–æ–±–æ–ª—å—à–µ –º–µ—Å—Ç–∞ */
        font-size: 14px; /* –ß—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –Ω–µ –±—ã–ª –º–µ–ª–∫–∏–º */
    }

    /* --- 5. –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–†: –¢–ê–ë–´ –í–ú–ï–°–¢–û –ö–û–õ–û–ù–û–ö --- */
    .comparison-wrapper {
        display: block !important; /* –£–±–∏—Ä–∞–µ–º –≥—Ä–∏–¥ */
        position: relative;
    }
    
    /* –°–∫—Ä—ã–≤–∞–µ–º –æ–±–µ –∫–æ–ª–æ–Ω–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    .compare-col {
        display: none; 
        width: 100%;
        border: none !important; /* –£–±–∏—Ä–∞–µ–º —Ä–∞–º–∫–∏, —á—Ç–æ–±—ã –Ω–µ –µ–ª–æ –º–µ—Å—Ç–æ */
        padding: 0 !important;
        box-shadow: none !important;
    }
    
    /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—É—é */
    .compare-col.active { 
    display: block !important; 
    animation: slideFade 0.3s ease-out; 
}

@keyframes slideFade {
    from { opacity: 0; transform: translateX(10px); }
    to { opacity: 1; transform: translateX(0); }
}
    
    /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –¢–∞–±–æ–≤ (–ø–æ—è–≤–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º) */
    .mobile-tabs {
        display: flex !important; /* –í–∫–ª—é—á–∞–µ–º flex */
        background: #f5f5f5;
        border-radius: 8px;
        padding: 4px;
        margin-bottom: 15px;
    }
    
    .mobile-tab-btn {
        flex: 1;
        text-align: center;
        padding: 10px;
        border-radius: 6px;
        font-weight: bold;
        color: #666;
        cursor: pointer;
        transition: 0.2s;
        font-size: 14px;
    }
    
    .mobile-tab-btn.active {
        background: #fff;
        color: #FF5722;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* --- 6. –ü–õ–ê–í–ê–Æ–©–ê–Ø –¶–ï–ù–ê (STICKY FOOTER) --- */
    .sticky-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(255, 255, 255, 0.95);
        border-top: 1px solid #ddd;
        padding: 10px 15px;
        box-shadow: 0 -4px 15px rgba(0,0,0,0.1);
        z-index: 999;
        backdrop-filter: blur(5px);
        display: flex;
        justify-content: space-between;
        align-items: center;
        /* –ê–Ω–∏–º–∞—Ü–∏—è –≤—ã–µ–∑–¥–∞ —Å–Ω–∏–∑—É */
        animation: slideUp 0.3s ease-out;
    }
    
    .footer-price {
        font-size: 20px;
        font-weight: 900;
        color: #333;
    }
    
    .footer-weight {
        font-size: 12px;
        color: #666;
    }
    
    /* –ü–æ–¥–Ω–∏–º–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç, —á—Ç–æ–±—ã —Ñ—É—Ç–µ—Ä –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª –Ω–∏–∑ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    body { padding-bottom: 80px !important; }

/* --- 7. –§–ò–ö–° –ù–ê–í–ò–ì–ê–¶–ò–ò (–ß–¢–û–ë–´ –ù–ï –í–ò–°–ï–õ–ê –í –í–û–ó–î–£–•–ï) --- */
    .navbar {
        width: 100% !important;
        max-width: 100vw !important; /* –ñ–µ—Å—Ç–∫–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞ */
        box-sizing: border-box;
        overflow: hidden; /* –û–±—Ä–µ–∑–∞–µ–º –≤—Å—ë, —á—Ç–æ —Ç–æ—Ä—á–∏—Ç */
    }
    
    .nav-group {
        width: 100%;
        max-width: 100%;
        overflow-x: auto; /* –í–∫–ª—é—á–∞–µ–º —Å–∫—Ä–æ–ª–ª –≤–Ω—É—Ç—Ä–∏ */
        display: flex;
        /* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Ä–∞—Å—Ç—è–≥–∏–≤–∞—Ç—å */
        padding-bottom: 5px; 
    }
    
    /* –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (–ë—ç–∫–∞–ø) —Å–ø—É—Å–∫–∞–µ–º –Ω–∏–∂–µ –∏ —Ç–æ–∂–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º */
    .tools-group {
        width: 100%;
        overflow-x: auto;
        justify-content: flex-start; /* –ü—Ä–∏–∂–∏–º–∞–µ–º –≤–ª–µ–≤–æ */
        padding-top: 10px;
        border-top: 1px solid #eee;
    }

/* --- 10. –ü–ê–ù–ï–õ–¨ –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í –°–ö–õ–ê–î–ê --- */
    .stock-toolbar {
        overflow-x: auto;          /* –†–∞–∑—Ä–µ—à–∞–µ–º —Å–∫—Ä–æ–ª–ª */
        white-space: nowrap;       /* –ó–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫ */
        -webkit-overflow-scrolling: touch; /* –ü–ª–∞–≤–Ω–æ—Å—Ç—å –Ω–∞ iPhone */
        
        /* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –±—ã–ª–∏ –∫—Ä—É–ø–Ω–µ–µ */
        padding: 5px !important; 
        gap: 8px !important;
        
        /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
        width: 100%;
        box-sizing: border-box;
    }
    
    /* –ó–∞–ø—Ä–µ—â–∞–µ–º –∫–Ω–æ–ø–∫–∞–º –∏ —á–µ–∫–±–æ–∫—Å—É —Å–∂–∏–º–∞—Ç—å—Å—è */
    .stock-toolbar > * {
        flex-shrink: 0 !important;
    }
    
    /* –£–±–∏—Ä–∞–µ–º "–ø—Ä–∏–∂–∞—Ç–∏–µ –≤–ø—Ä–∞–≤–æ" —É –∫–Ω–æ–ø–∫–∏ –ñ—É—Ä–Ω–∞–ª –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º, 
       —á—Ç–æ–±—ã –æ–Ω–∞ —à–ª–∞ —Å—Ä–∞–∑—É –∑–∞ –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏, –∞ –Ω–µ —É–ª–µ—Ç–∞–ª–∞ –≤ –∫–æ–Ω–µ—Ü –¥–ª–∏–Ω–Ω–æ–π –ª–µ–Ω—Ç—ã */
    .stock-toolbar button[style*="margin-left:auto"] {
        margin-left: 0 !important;
    }

/* --- –ú–û–ë–ò–õ–¨–ù–´–ï –®–¢–û–†–ö–ò (BOTTOM SHEETS) --- */
    .modal-overlay {
        align-items: flex-end !important; /* –ü—Ä–∏–∂–∏–º–∞–µ–º –∫ –Ω–∏–∑—É */
        padding: 0 !important;
    }
    
    .modal-box {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 !important;
        border-radius: 20px 20px 0 0 !important; /* –ó–∞–∫—Ä—É–≥–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤–µ—Ä—Ö */
        border-bottom: none !important;
        max-height: 85vh !important; /* –í—ã—Å–æ—Ç–∞ 85% —ç–∫—Ä–∞–Ω–∞ */
        animation: slideUpModal 0.3s cubic-bezier(0.16, 1, 0.3, 1); /* –ü–ª–∞–≤–Ω—ã–π –≤—ã–µ–∑–¥ */
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –≤—ã–µ–∑–¥–∞ —Å–Ω–∏–∑—É */
    @keyframes slideUpModal {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
    }

    /* –£—á–µ—Ç "—á–µ–ª–∫–∏" –∏ –Ω–∏–∂–Ω–µ–π –ø–æ–ª–æ—Å–∫–∏ –Ω–∞ –Ω–æ–≤—ã—Ö iPhone (Safe Area) */
.modal-box {
    /* –ß—Ç–æ–±—ã —à—Ç–æ—Ä–∫–∞ –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–∞—Å—å –Ω–∏–∂–Ω–µ–π —Å–∏—Å—Ç–µ–º–Ω–æ–π –ø–æ–ª–æ—Å–∫–æ–π */
    padding-bottom: max(25px, env(safe-area-inset-bottom)) !important;
}
.sticky-footer {
    /* –ß—Ç–æ–±—ã –ø–ª–∞–≤–∞—é—â–∞—è —Ü–µ–Ω–∞ –Ω–µ –ø—Ä–∏–ª–∏–ø–∞–ª–∞ –∫ —Å–∞–º–æ–º—É –Ω–∏–∑—É –Ω–∞ iPhone */
    padding-bottom: max(10px, env(safe-area-inset-bottom)) !important;
}

/* 1. –°–∂–∏–º–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –∫–Ω–æ–ø–∫–∞–º–∏ */
    .tier-ctrl-group {
        padding: 1px !important;      /* –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –≤–Ω—É—Ç—Ä–∏ */
        right: 5px !important;        /* –ë–ª–∏–∂–µ –∫ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é */
        gap: 0px !important;          /* –£–±–∏—Ä–∞–µ–º –∑–∞–∑–æ—Ä—ã –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫–∞–º–∏ */
        border-radius: 6px !important;
        background: rgba(255,255,255,0.9) !important; 
    }

    /* 2. –°–∂–∏–º–∞–µ–º —Å—Ç—Ä–æ–∫–∏ (D, H, W) */
    .ctrl-row {
        padding: 0 2px !important;    /* –°–≤–µ—Ä—Ö–ø–ª–æ—Ç–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã */
        gap: 1px !important;          /* –ö–Ω–æ–ø–∫–∏ –ø–æ—á—Ç–∏ –≤–ø–ª–æ—Ç–Ω—É—é –∫ —Ü–∏—Ñ—Ä–µ */
        border-radius: 4px !important;
        margin-bottom: 1px !important; /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
        height: 22px !important;       /* –§–∏–∫—Å–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É —Å—Ç—Ä–æ–∫–∏ */
        border: 1px solid #ccc !important;
    }

    /* 3. –£–º–µ–Ω—å—à–∞–µ–º —Å–∞–º–∏ –∫–Ω–æ–ø–∫–∏ */
    .ctrl-btn {
        width: 18px !important;       /* –î–µ–ª–∞–µ–º —Å–æ–≤—Å–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—ã–º–∏ */
        height: 18px !important;
        font-size: 10px !important;   /* –®—Ä–∏—Ñ—Ç –ø–ª—é—Å–∞/–º–∏–Ω—É—Å–∞ */
        line-height: 18px !important; 
        border: none !important;      /* –£–±–∏—Ä–∞–µ–º —Ä–∞–º–∫—É —É –∫–Ω–æ–ø–æ–∫ –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã */
        background: #f0f0f0 !important;
    }
    
    /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω–µ–≤–∏–¥–∏–º—É—é –æ–±–ª–∞—Å—Ç—å –Ω–∞–∂–∞—Ç–∏—è (—á—Ç–æ–±—ã –ø–∞–ª—å—Ü–µ–º –ø–æ–ø–∞–¥–∞—Ç—å) */
    .ctrl-btn::after {
        content: '';
        position: absolute;
        top: -10px; bottom: -10px; left: -10px; right: -10px;
    }

    /* 4. –£–º–µ–Ω—å—à–∞–µ–º —Ü–∏—Ñ—Ä—ã (—Ä–∞–∑–º–µ—Ä—ã) */
    .ctrl-label {
        font-size: 9px !important;    
        min-width: 10px;
        margin: 0 2px;
    }

    /* 5. –£–±–∏—Ä–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ "–Ø–†–£–° X" –ø–æ–ª–Ω–æ—Å—Ç—å—é, —á—Ç–æ–±—ã —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å –º–µ—Å—Ç–æ */
    .tier-ctrl-group > div:first-child {
        display: none !important; 
    }

    /* === –£–õ–£–ß–®–ï–ù–ò–ï –°–ü–ò–°–ö–û–í (–®–ò–†–û–ö–ò–ï –û–ö–ù–ê + 1 –ö–û–õ–û–ù–ö–ê) === */

    /* 1. –†–∞—Å—à–∏—Ä—è–µ–º —Ä–∞–±–æ—á—É—é –æ–±–ª–∞—Å—Ç—å */
    body {
        padding: 5px !important; /* –£–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –æ—Ç –∫—Ä–∞–µ–≤ —ç–∫—Ä–∞–Ω–∞ */
    }
    .card, .batch-card {
        padding: 15px 10px !important; /* –ß—É—Ç—å –º–µ–Ω—å—à–µ –æ—Ç—Å—Ç—É–ø–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ */
        border-radius: 8px !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        width: 100% !important;
    }
    
    /* 2. –ñ–µ–ª—Ç—ã–π —Å–ø–∏—Å–æ–∫ (–ü–ª–∞–Ω): –¶–∏—Ñ—Ä—ã —Å—Ç—Ä–æ–≥–æ —Å–ø—Ä–∞–≤–∞ */
    .col-tasks ul li {
        display: flex !important;
        justify-content: space-between !important; /* –†–∞–∑–Ω–æ—Å–∏–º –ø–æ –∫—Ä–∞—è–º */
        align-items: flex-end !important;          /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ –Ω–∏–∑—É —Å—Ç—Ä–æ–∫–∏ */
        border-bottom: 1px dashed #ddd;            /* –õ–∏–Ω–∏—è-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å */
        margin-bottom: 6px !important;
        padding-bottom: 2px !important;
    }
    
    /* –¢–µ–∫—Å—Ç —Å–ª–µ–≤–∞ */
    .col-tasks ul li > span { 
        text-align: left;
        padding-right: 10px;
    }
    
    /* –¶–∏—Ñ—Ä–∞ —Å–ø—Ä–∞–≤–∞ (–∂–∏—Ä–Ω–∞—è –∏ –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è) */
    .col-tasks ul li > b {
        white-space: nowrap !important; /* "71 –≥" –≤—Å–µ–≥–¥–∞ –≤–º–µ—Å—Ç–µ */
        flex-shrink: 0;                 /* –ó–∞–ø—Ä–µ—â–∞–µ–º —Å–∂–∏–º–∞—Ç—å —Ü–∏—Ñ—Ä—É */
        text-align: right;
    }

    /* 3. –°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–°–∫—Ä–∏–Ω 2): –°–¢–†–û–ì–û –û–î–ù–ê –ö–û–õ–û–ù–ö–ê */
    .shop-grid {
        display: block !important;      /* –û—Ç–∫–ª—é—á–∞–µ–º —Å–µ—Ç–∫—É 2x2 */
        grid-template-columns: none !important;
    }

    /* –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–∞ */
    .shop-grid > div {
        display: flex !important;       /* –í–∫–ª—é—á–∞–µ–º Flex */
        justify-content: space-between !important; /* –ò–º—è —Å–ª–µ–≤–∞, –≤–µ—Å —Å–ø—Ä–∞–≤–∞ */
        align-items: center !important;
        width: 100% !important;
        padding: 10px 0 !important;     /* –ë–æ–ª—å—à–µ –º–µ—Å—Ç–∞ –¥–ª—è –ø–∞–ª—å—Ü–∞ */
        border-bottom: 1px solid #eee !important; /* –ß–µ—Ç–∫–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ */
        font-size: 15px !important;     /* –¢–µ–∫—Å—Ç —á—É—Ç—å –∫—Ä—É–ø–Ω–µ–µ */
    }

    /* –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ */
    .shop-grid > div > span:first-child {
        padding-right: 15px;            /* –û—Ç—Å—Ç—É–ø –æ—Ç —Ü–∏—Ñ—Ä—ã */
        line-height: 1.3;
    }

    /* –í–µ—Å –ø—Ä–æ–¥—É–∫—Ç–∞ */
    .shop-grid > div > span:last-child {
        white-space: nowrap !important; /* –ù–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å —Ü–∏—Ñ—Ä—ã */
        font-weight: 800 !important;    /* –ñ–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç */
        color: #000 !important;
        background: #f5f5f5;            /* –õ–µ–≥–∫–∏–π —Ñ–æ–Ω –ø–æ–¥ —Ü–∏—Ñ—Ä–æ–π –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–∞ */
        padding: 2px 6px;
        border-radius: 4px;
    }

}




.sticky-footer { display: none; } /* –ù–∞ –ü–ö —Å–∫—Ä—ã—Ç–æ */

/* –°–∫—Ä—ã–≤–∞–µ–º –º–æ–±–∏–ª—å–Ω—ã–µ —Ç–∞–±—ã –Ω–∞ –ü–ö */
.mobile-tabs { display: none; }


/* –ü—Ä–æ—Å—Ç–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      
      /* --- –ù–û–í–ê–Ø –ï–î–ò–ù–ê–Ø –®–ê–ü–ö–ê (NAVBAR) --- */
.navbar {
    background: #fff;
    padding: 10px 15px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    display: flex;
    justify-content: space-between; /* –†–∞–∑–Ω–æ—Å–∏–º –º–µ–Ω—é –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –ø–æ –∫—Ä–∞—è–º */
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap; /* –ß—Ç–æ–±—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º –ø–µ—Ä–µ–Ω–æ—Å–∏–ª–æ—Å—å */
    gap: 10px;
    border: 1px solid #eee;
}

/* –ì—Ä—É–ø–ø–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (—Å–ª–µ–≤–∞) */
.nav-group {
    display: flex;
    gap: 5px;
    align-items: center;
    overflow-x: auto;          /* –†–∞–∑—Ä–µ—à–∞–µ–º —Å–∫—Ä–æ–ª–ª */
    white-space: nowrap;       /* –ó–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å –∫–Ω–æ–ø–æ–∫ –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É */
    -webkit-overflow-scrolling: touch; /* –ü–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª –Ω–∞ iPhone */
    padding-bottom: 5px;       /* –ú–µ—Å—Ç–æ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
    flex: 1;                   /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –º–µ—Å—Ç–æ */
}
/* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–æ—Å—É –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª */
.nav-group::-webkit-scrollbar { height: 0px; background: transparent; }

/* –ì—Ä—É–ø–ø–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (—Å–ø—Ä–∞–≤–∞: –±—ç–∫–∞–ø, –≤–∞–ª—é—Ç–∞) */
.tools-group {
    display: flex;
    gap: 10px;
    align-items: center;
}

/* –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –≤–∫–ª–∞–¥–æ–∫ */
.tab-btn {
    padding: 8px 16px;
    border: none;
    background: transparent;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    color: #666;
    transition: 0.2s;
    font-size: 14px;
    white-space: nowrap;
}
.tab-btn:hover { background: #f5f5f5; color: #333; }
.tab-btn.active { background: #FF5722; color: white; box-shadow: 0 2px 8px rgba(255, 87, 34, 0.25); }

/* –ö–Ω–æ–ø–∫–∞ –ù–∞—Å—Ç—Ä–æ–µ–∫ (–§–∏–Ω–∞–Ω—Å—ã) */
.settings-btn {
    background: #ECEFF1;
    color: #455A64;
}
.settings-btn:hover { background: #CFD8DC; }

      /* –ö–ê–†–¢–û–ß–ö–ò */
      .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 20px; border: 1px solid #fff; }
      h2 { margin-top: 0; font-size: 18px; color: #444; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 20px; }

      /* –§–û–†–ú–´ */
      .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
      .form-group { flex: 1; }
      .form-label { font-size: 12px; font-weight: bold; color: #666; margin-bottom: 5px; display: block; text-transform: uppercase; }
      input, select { width: 100%; padding: 8px 10px; border: 1px solid #ddd; background: #fff; border-radius: 6px; font-size: 14px; }
      input:focus, select:focus { border-color: #FF5722; outline: none; box-shadow: 0 0 0 2px rgba(255, 87, 34, 0.1); }
      
      button.main-btn { background: #FF5722; color: white; border: none; padding: 12px; width: 100%; border-radius: 6px; font-size: 15px; font-weight: bold; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(255, 87, 34, 0.2); }
      button.main-btn:hover { background: #E64A19; transform: translateY(-1px); }

    
      /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –Ø–†–£–°–û–í --- */
      .tier-card { background: #fafafa; border: 1px solid #eee; border-left: 4px solid #FF5722; padding: 10px; margin-bottom: 10px; border-radius: 6px; position: relative; }
      .tier-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-weight: bold; color: #444; font-size: 12px; }
      .tier-badge { background: #FF5722; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; }
      
      /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç–∏–Ω–∫–∏ */
      /* --- –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –°–¢–ò–õ–ò –ö–û–ù–¢–†–û–õ–û–í --- */
.tier-ctrl-group {
    pointer-events: auto;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    flex-direction: column; /* –ß—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ –≤—Å—Ç–∞–ª–∏ –¥—Ä—É–≥ –Ω–∞–¥ –¥—Ä—É–≥–æ–º */
    gap: 2px;
    align-items: center;
    z-index: 10;
}

.ctrl-row {
    background: rgba(255,255,255,0.95);
    padding: 2px 6px;
    border-radius: 12px;
    border: 1px solid #ccc;
    display: flex;
    gap: 5px;
    align-items: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.ctrl-btn { 
    width: 24px; 
    height: 24px; 
    border-radius: 50%; 
    border: 1px solid #ccc; 
    background: #fff; 
    cursor: pointer; 
    font-weight: bold; 
    color: #555; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-size: 16px; 
    padding: 0;
    /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å –∫–∞—Å–∞–Ω–∏—è –¥–ª—è –ø–∞–ª—å—Ü–∞, –Ω–µ –º–µ–Ω—è—è –≤–∏–¥ –∫–Ω–æ–ø–∫–∏ */
    position: relative;
}

/* –ù–µ–≤–∏–¥–∏–º–∞—è –æ–±–ª–∞—Å—Ç—å –≤–æ–∫—Ä—É–≥ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ª–µ–≥–∫–æ–≥–æ –ø–æ–ø–∞–¥–∞–Ω–∏—è */
.ctrl-btn::after {
    content: '';
    position: absolute;
    top: -10px; left: -10px; right: -10px; bottom: -10px;
}

.ctrl-btn:active {
    background: #FF5722;
    color: white;
    transform: scale(1.2); /* –í–∏–∑—É–∞–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫ –Ω–∞ –Ω–∞–∂–∞—Ç–∏–µ */
}
.ctrl-btn:hover { background: #FF5722; color: white; border-color: #FF5722; }

.ctrl-label {
    font-size: 9px; font-weight: 800; text-transform: uppercase; color: #555; width: 15px; text-align: center;
}
      
      /* –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø */
      .comparison-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px; align-items: start; }
      .compare-col { background: #fff; border-radius: 12px; padding: 20px; position: relative; border: 1px solid #eee; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
      .compare-col.active { border: 2px solid #FF5722; box-shadow: 0 5px 25px rgba(255, 87, 34, 0.15); z-index: 2; }
      .col-header { text-align: center; font-weight: 800; margin-bottom: 15px; text-transform: uppercase; font-size: 13px; letter-spacing: 1px; }
      .col-header.orange { color: #FF5722; }
      .visual-container { position: relative; width: 100%; height: 350px; margin-bottom: 20px; background: radial-gradient(circle, #fff 40%, #f4f4f4 100%); border-radius: 8px; overflow: hidden; border: 1px solid #f0f0f0; user-select: none; }
      .svg-box { width: 100%; height: 100%; display: block; }
      
      /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ */
      .controls-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
      /* –ò–∑–º–µ–Ω–µ–Ω–æ: –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏–∂–∞—Ç—ã –≤–ø—Ä–∞–≤–æ (right: 15px), —Ü–µ–Ω—Ç—Ä–æ–≤–∫–∞ (left/transform) –æ—Ç–º–µ–Ω–µ–Ω–∞ */
.tier-ctrl-group { 
    pointer-events: auto; 
    background: rgba(255,255,255,0.9); 
    padding: 4px; 
    border-radius: 20px; 
    display: flex; 
    gap: 4px; 
    box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
    position: absolute; 
    right: 15px;      /* –û—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞ */
    left: auto;       /* –û—Ç–º–µ–Ω—è–µ–º —Ü–µ–Ω—Ç—Ä–æ–≤–∫—É */
    transform: none;  /* –û—Ç–º–µ–Ω—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ */
    border: 1px solid #ddd; 
}
      .ctrl-btn { width: 22px; height: 22px; border-radius: 50%; border: 1px solid #ccc; background: #fff; cursor: pointer; font-weight: bold; color: #555; display: flex; align-items: center; justify-content: center; font-size: 14px; padding: 0; }
      .ctrl-btn:hover { background: #FF5722; color: white; border-color: #FF5722; }

      .price-big { font-size: 32px; font-weight: 800; color: #333; text-align: center; margin: 10px 0; }
      .price-diff { font-size: 16px; font-weight: bold; vertical-align: middle; margin-left: 8px; padding: 4px 8px; border-radius: 6px; }
      .diff-plus { color: #d32f2f; background: #ffebee; } 
      .diff-minus { color: #388E3C; background: #e8f5e9; }
      .info-row { display: flex; justify-content: space-between; font-size: 14px; padding: 6px 0; border-bottom: 1px dashed #eee; color: #555; }
      .shopping-block { margin-top: 30px; background: #fff; border: 1px solid #eee; border-left: 5px solid #FF5722; border-radius: 8px; padding: 25px; }
      .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 40px; }

      /* –°–ö–õ–ê–î –ò –ü–†–û–ß–ï–ï */
      .stock-table { width: 100%; border-collapse: collapse; font-size: 12px; }
      /* –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –°–¢–ò–õ–¨ –ó–ê–ì–û–õ–û–í–ö–û–í */
.stock-table th { 
    text-align: center; /* –¶–µ–Ω—Ç—Ä—É–µ–º —Ç–µ–∫—Å—Ç */
    padding: 10px; 
    background: #f9f9f9; 
    color: #666; 
    font-size: 11px; 
    text-transform: uppercase; 
    border-bottom: 2px solid #ddd; 
    
    /* –ù–æ–≤—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏: */
    cursor: pointer;    /* –ö—É—Ä—Å–æ—Ä-—Ä—É–∫–∞ */
    user-select: none;  /* –ó–∞—â–∏—Ç–∞ –æ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –∫–ª–∏–∫–∞—Ö */
    transition: background 0.2s;
}

/* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–≤–µ–¥–µ–Ω–∏—è */
.stock-table th:hover {
    background: #dcdcdc; /* –ß—É—Ç—å —Ç–µ–º–Ω–µ–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
    color: #333;
}
      .stock-table td { padding: 6px 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
      .del-btn { color: #e53935; cursor: pointer; font-weight: bold; background: none; border: none; font-size: 16px; opacity: 0.6; }
      .del-btn:hover { opacity: 1; transform: scale(1.1); }
      .add-btn-small { background: #4CAF50; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; text-transform: uppercase; }
      
      /* –†–ï–¶–ï–ü–¢–´ */
      .recipe-layout { display: flex; gap: 20px; }
      .recipe-list { width: 220px; border-right: 1px solid #eee; padding-right: 10px; flex-shrink: 0; }
      .recipe-editor { flex: 1; }
      .recipe-item { padding: 8px 10px; cursor: pointer; border-radius: 6px; margin-bottom: 4px; font-size: 14px; display: flex; justify-content: space-between; align-items: center; background: #fdfdfd; border: 1px solid #eee; transition: 0.2s; }
      .recipe-item.active { background: #FF5722; color: white; border-color: #FF5722; }
      .tag { font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: bold; text-transform: uppercase; background: #eee; color: #555; }
      .tag.filling { background: #E3F2FD; color: #1565C0; }
      .tag.coating { background: #FBE9E7; color: #D84315; }
      .tag.extra   { background: #F3E5F5; color: #7B1FA2; }
      .tag.decor   { background: #FCE4EC; color: #C2185B; }
      .recipe-block { background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 15px; margin-bottom: 15px; }
      .calibration-box { background: #FFF3E0; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #FFE0B2; }
      .ing-row { display: grid; grid-template-columns: 3fr 1fr 30px; gap: 10px; margin-bottom: 5px; align-items: center; }

      /* –¢–£–ú–ë–õ–ï–† */
      .toggle-wrapper { display: flex; align-items: center; background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
      .switch { position: relative; display: inline-block; width: 46px; height: 24px; flex-shrink: 0; margin-right: 12px; }
      .switch input { opacity: 0; width: 0; height: 0; }
      .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
      .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
      input:checked + .slider { background-color: #FF5722; }
      input:checked + .slider:before { transform: translateX(22px); }
      .toggle-text b { display: block; font-size: 13px; color: #333; }
      .toggle-text span { display: block; font-size: 11px; color: #888; margin-top: 2px; }

      /* –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û */
      .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
      /* –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –°–¢–ò–õ–¨ –î–õ–Ø –û–ö–û–ù */
.modal-box { 
    background: white; 
    padding: 25px; 
    border-radius: 12px; 
    width: 500px; 
    max-width: 95%; 
    
    /* –≠—Ç–∏ –¥–≤–µ —Å—Ç—Ä–æ–∫–∏ —Ä–µ—à–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—É: */
    max-height: 90vh; /* –í—ã—Å–æ—Ç–∞ –Ω–µ –±–æ–ª—å—à–µ 90% –æ—Ç —ç–∫—Ä–∞–Ω–∞ */
    overflow-y: auto; /* –ï—Å–ª–∏ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç ‚Äî –≤–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
    
    box-shadow: 0 20px 50px rgba(0,0,0,0.2); 
    position: relative; /* –ß—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–ª–∞—Å—å –≤–µ—Ä–Ω–æ */
}
      .modal-actions { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
      /* –ü–ª–∞–≤–Ω–æ–µ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ—Å—á–µ—Ç–µ */
.visual-container .svg-box {
  transition: opacity 0.2s ease-in-out;
}

/* --- –°–¢–ò–õ–ò –î–õ–Ø –ö–ù–û–ü–û–ö –î–ê–ù–ù–´–• (–ò–º–ø–æ—Ä—Ç/–ë—ç–∫–∞–ø) --- */
.data-panel { display: flex; gap: 5px; }
.data-btn { 
    padding: 6px 12px; border: none; border-radius: 4px; 
    cursor: pointer; font-size: 12px; font-weight: bold; 
    background: #e0e0e0; color: #333; transition: 0.2s;
}
.data-btn:hover { background: #d0d0d0; }
.data-btn.blue { background: #E3F2FD; color: #1565C0; border: 1px solid #BBDEFB; }
.data-btn.blue:hover { background: #BBDEFB; }

/* --- –°–¢–ò–õ–ò –î–õ–Ø –ü–û–ò–°–ö–ê –ò –§–ò–õ–¨–¢–†–û–í –†–ï–¶–ï–ü–¢–û–í --- */
.recipe-search-box {
    margin-bottom: 10px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
}
.search-input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 6px;
    margin-bottom: 8px;
    font-size: 13px;
}
.search-input:focus { border-color: #FF5722; outline: none; }

.filter-chips {
    display: flex;
    gap: 5px;
    overflow-x: auto;
    padding-bottom: 2px; /* –î–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞, –µ—Å–ª–∏ –Ω–µ –≤–ª–µ–∑–µ—Ç */
}
.chip {
    border: 1px solid #ddd;
    background: #fff;
    color: #666;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: bold;
    cursor: pointer;
    white-space: nowrap;
    transition: 0.2s;
}
.chip:hover { background: #f5f5f5; }
.chip.active {
    background: #FF5722;
    color: white;
    border-color: #FF5722;
}

/* –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —è—Ä—É—Å–æ–≤ */
.move-group {
    display: flex;
    gap: 2px;
    margin-right: 10px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è */
}
.move-btn {
    background: #f0f0f0;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    padding: 2px 8px;
    color: #555;
    transition: 0.2s;
}
.move-btn:hover {
    background: #FF5722;
    color: white;
    border-color: #FF5722;
}

/* --- –ù–û–í–´–ô –°–¢–ò–õ–¨ –î–õ–Ø –ö–û–ú–ü–ê–ö–¢–ù–û–ì–û –ü–õ–ê–ù–ê --- */
.plan-header {
    font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;
    padding: 4px 10px; margin-top: 10px; margin-bottom: 5px; border-radius: 4px;
    display: inline-block;
}
.plan-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-left-width: 5px; /* –¶–≤–µ—Ç–Ω–∞—è –ø–æ–ª–æ—Å–∫–∞ */
    border-radius: 6px;
    padding: 6px 8px; /* –û—á–µ–Ω—å –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã */
    margin-bottom: 5px;
    display: flex;
    align-items: center; /* –¶–µ–Ω—Ç—Ä–æ–≤–∫–∞ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
    gap: 10px; /* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    min-height: 40px;
}

      /* --- –°–¢–ò–õ–¨ –î–õ–Ø –ë–õ–û–ö–ê –û–§–û–†–ú–õ–ï–ù–ò–Ø –í –ü–õ–ê–ù–ï --- */
.pc-decor {
    margin-top: 6px;
    padding: 4px 6px;
    background: #fdfbf7; /* –û—á–µ–Ω—å –ª–µ–≥–∫–∏–π —Ç–µ–ø–ª—ã–π –æ—Ç—Ç–µ–Ω–æ–∫ */
    border: 1px solid #efebe9;
    border-radius: 4px;
    font-size: 11px;
    color: #555;
    line-height: 1.3;
    font-style: italic;
    /* –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–π, –æ–Ω –±—É–¥–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å—Å—è, –Ω–æ –∫–∞—Ä—Ç–æ—á–∫–∞ —Ä–∞—Å—Ç—è–Ω–µ—Ç—Å—è.
       –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –≤—Å—ë –æ–ø–∏—Å–∞–Ω–∏–µ. */
}
/* –ß–µ–∫–±–æ–∫—Å - —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä, –Ω–µ —Å–∂–∏–º–∞–µ—Ç—Å—è */
.plan-card .batch-checkbox {
    width: 18px; height: 18px;
    cursor: pointer;
    flex-shrink: 0; /* –ó–ê–ü–†–ï–¢ –ù–ê –°–ñ–ê–¢–ò–ï */
    margin: 0;
}
/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è - –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—ë —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ */
.pc-info {
    display: flex; 
    flex-direction: column; 
    overflow: hidden; 
    flex-grow: 1; /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è */
    line-height: 1.2;
}
.pc-top-row { display: flex; justify-content: space-between; align-items: baseline; }
.pc-client { font-size: 11px; color: #666; font-weight: 600; }
.pc-main { font-size: 13px; color: #222; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.pc-meta { font-size: 11px; color: #555; display: flex; flex-wrap: wrap; gap: 6px; margin-top: 2px; align-items: center; }
.pc-badge { background: #f5f5f5; padding: 1px 5px; border-radius: 3px; font-weight: 600; color: #333; font-size: 10px; border: 1px solid #eee; }
.pc-color-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; border: 1px solid rgba(0,0,0,0.1); }

/* –ö–Ω–æ–ø–∫–∏ —Å–ø—Ä–∞–≤–∞ - —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ */
.pc-actions { display: flex; gap: 5px; align-items: center; flex-shrink: 0; }
.btn-icon { background:none; border:none; cursor:pointer; font-size:16px; opacity:0.6; padding:0 4px; }
.btn-icon:hover { opacity:1; color: #d32f2f; }


/* --- –°–ï–¢–ö–ê –î–õ–Ø –ü–õ–ê–ù–ê (GRID) --- */
.plan-group-container {
    margin-bottom: 20px;
}
.plan-header-sticky {
    position: sticky; top: 0; z-index: 10;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä-—Å–µ—Ç–∫–∞: –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–∞–º–∏ –≤—Å—Ç–∞–Ω—É—Ç –≤ 2 –∏–ª–∏ 3 –∫–æ–ª–æ–Ω–∫–∏ */
.plan-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); /* –ú–∏–Ω–∏–º—É–º 300px —à–∏—Ä–∏–Ω—ã */
    gap: 12px;
    margin-top: 8px;
}

/* –û–±—ä–µ–º–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ */
.plan-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-left-width: 5px; /* –¶–≤–µ—Ç–Ω–∞—è –ø–æ–ª–æ—Å–∫–∞ */
    border-radius: 8px;
    padding: 10px;
    display: flex;
    flex-direction: column; /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ */
    justify-content: space-between;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* –õ–µ–≥–∫–∞—è —Ç–µ–Ω—å */
    transition: transform 0.2s, box-shadow 0.2s;
    height: 100%; /* –ß—Ç–æ–±—ã –≤—Å–µ –≤ —Ä—è–¥—É –±—ã–ª–∏ –æ–¥–Ω–æ–π –≤—ã—Å–æ—Ç—ã */
}
.plan-card:hover {
    transform: translateY(-3px); /* –≠—Ñ—Ñ–µ–∫—Ç –ø–∞—Ä–µ–Ω–∏—è */
    box-shadow: 0 5px 15px rgba(0,0,0,0.15); /* –¢–µ–Ω—å —Ä–∞—Å—Ç–µ—Ç */
}

/* –í–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ */
/* –í–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –∏–º–µ–Ω–µ–º –∏ —Ü–µ–Ω–æ–π */
.pc-top { 
    display: flex; 
    justify-content: space-between; /* –¢–æ–ª–∫–∞–µ—Ç –∏–º—è –≤–ª–µ–≤–æ, —Ü–µ–Ω—É –≤–ø—Ä–∞–≤–æ */
    align-items: flex-start; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –≤–µ—Ä—Ö—É, –µ—Å–ª–∏ –∏–º—è –¥–ª–∏–Ω–Ω–æ–µ */
    margin-bottom: 8px; 
    gap: 15px; /* <--- –ì–õ–ê–í–ù–û–ï: –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –∏–º–µ–Ω–µ–º –∏ —Ü–µ–Ω–æ–π */
    width: 100%;
}

/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –∑–∞—â–∏—Ç–∞, —á—Ç–æ–±—ã –¥–ª–∏–Ω–Ω–æ–µ –∏–º—è –Ω–µ –ª–æ–º–∞–ª–æ —Ü–µ–Ω—É */
.pc-top > div:first-child {
    overflow: hidden; 
    text-overflow: ellipsis; /* –¢—Ä–æ–µ—Ç–æ—á–∏–µ, –µ—Å–ª–∏ –∏–º—è —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ */
}
.pc-top > div:last-child {
    white-space: nowrap; /* –¶–µ–Ω–∞ –≤—Å–µ–≥–¥–∞ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É */
    flex-shrink: 0; /* –ó–∞–ø—Ä–µ—â–∞–µ–º —Å–∂–∏–º–∞—Ç—å —Ü–µ–Ω—É */
    text-align: right;
}
.pc-body { flex: 1; margin-bottom: 10px; } /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è */
.pc-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px dashed #eee; padding-top: 8px; }

/* –ö–Ω–æ–ø–∫–∏ */
.btn-action-group { display: flex; gap: 5px; }
.btn-done { background: #E8F5E9; color: #2E7D32; border: 1px solid #C8E6C9; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px; font-weight: bold; transition:0.2s; }
.btn-done:hover { background: #2E7D32; color: white; }

/* --- –£–õ–£–ß–®–ï–ù–ò–ï –í–ò–ó–£–ê–õ–ê: –ñ–ò–í–´–ï –°–ü–ò–°–ö–ò (HOVER) --- */

/* 1. –î–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü (–°–∫–ª–∞–¥, –ö–ª–∏–µ–Ω—Ç—ã, –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã) */
.stock-table tbody tr {
    transition: background-color 0.15s ease-in-out; /* –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ */
}
.stock-table tbody tr:hover {
    background-color: #f0f0f0; /* –¶–≤–µ—Ç –ø–æ–¥—Å–≤–µ—Ç–∫–∏ (—Å–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π) */
    cursor: pointer; /* –ö—É—Ä—Å–æ—Ä-—Ä—É–∫–∞, –Ω–∞–º–µ–∫–∞—é—â–∞—è —á—Ç–æ –º–æ–∂–Ω–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å */
}
/* –ß—Ç–æ–±—ã –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏ –Ω–µ —Å–ª–∏–≤–∞–ª–æ—Å—å, –≤—ã–¥–µ–ª–∏–º –µ–≥–æ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ */
.stock-table input:focus {
    background-color: #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* 2. –î–ª—è —Å–ø–∏—Å–∫–∞ –†–µ—Ü–µ–ø—Ç–æ–≤ (–°–ª–µ–≤–∞) */
.recipe-item {
    transition: all 0.2s ease; /* –ê–Ω–∏–º–∏—Ä—É–µ–º –∏ —Ü–≤–µ—Ç, –∏ –¥–≤–∏–∂–µ–Ω–∏–µ */
}
.recipe-item:hover {
    background-color: #e3f2fd; /* –¢—É—Ç —Å–¥–µ–ª–∞–µ–º –Ω–µ–∂–Ω–æ-–≥–æ–ª—É–±–æ–π (–≤ —Ü–≤–µ—Ç —Ç–µ–º—ã) */
    transform: translateX(4px); /* –°–¥–≤–∏–≥–∞–µ–º —Å—Ç—Ä–æ–∫—É –≤–ø—Ä–∞–≤–æ –Ω–∞ 4px */
    box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* –õ–µ–≥–∫–∞—è —Ç–µ–Ω—å */
    border-color: #90CAF9; /* –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ä–∞–º–∫—É */
}
/* –ê–∫—Ç–∏–≤–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç –≤—ã–¥–µ–ª—è–µ–º —Å–∏–ª—å–Ω–µ–µ */
.recipe-item.active {
    transform: translateX(4px);
    box-shadow: 0 2px 8px rgba(255, 87, 34, 0.3);
}

/* 3. –î–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ (Datalist/Select) - —ç—Ç–æ –±—Ä–∞—É–∑–µ—Ä –¥–µ–ª–∞–µ—Ç —Å–∞–º, –Ω–æ –º–æ–∂–Ω–æ —Å—Ç–∏–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—ã—á–Ω—ã–µ select */
select:hover {
    background-color: #fafafa;
    border-color: #bbb;
}

/* --- –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò --- */
#loadingOverlay {
    z-index: 9999; /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ, –¥–∞–∂–µ –ø–æ–≤–µ—Ä—Ö –¥—Ä—É–≥–∏—Ö –æ–∫–æ–Ω */
    background: rgba(255, 255, 255, 0.9); /* –ü–æ—á—Ç–∏ –±–µ–ª—ã–π —Ñ–æ–Ω */
    display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –∫—Ä—É—Ç–∏–ª–∫–∏ */
.spinner {
    border: 5px solid #f3f3f3; /* –°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π –∫—Ä—É–≥ */
    border-top: 5px solid #FF5722; /* –û—Ä–∞–Ω–∂–µ–≤–∞—è —à–∞–ø–∫–∞ */
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* --- CRM –ê–°–°–ò–°–¢–ï–ù–¢ (FAB) --- */
.fab-container {
    position: fixed;
    bottom: 25px;
    right: 25px;
    z-index: 1000;
    font-family: 'Segoe UI', sans-serif;
}

/* –ö–Ω–æ–ø–∫–∞-–∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫ */
/* –ö–Ω–æ–ø–∫–∞-–∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫ (–£–ú–ï–ù–¨–®–ï–ù–ù–ê–Ø) */
.fab-btn {
    width: 36px;       /* –ë—ã–ª–æ 60px */
    height: 36px;      /* –ë—ã–ª–æ 60px */
    background: #FF5722; 
    border-radius: 50%;
    box-shadow: 0 4px 10px rgba(255, 87, 34, 0.4);
    display: flex; 
    align-items: center; 
    justify-content: center;
    cursor: pointer;
    transition: transform 0.2s;
    font-size: 18px;   /* –ë—ã–ª–æ 28px ‚Äî —É–º–µ–Ω—å—à–∏–ª–∏ —ç–º–æ–¥–∑–∏ */
    position: relative;
    border: none;
}
.fab-btn:hover { transform: scale(1.1); background: #F4511E; }

/* –ö—Ä–∞—Å–Ω—ã–π –±–µ–π–¥–∂ (—Å—á–µ—Ç—á–∏–∫) - —Ç–æ–∂–µ —É–º–µ–Ω—å—à–∞–µ–º */
.fab-badge {
    position: absolute; 
    top: -4px;         /* –ß—É—Ç—å –≤—ã—à–µ */
    right: -4px;       /* –ß—É—Ç—å –ø—Ä–∞–≤–µ–µ */
    background: #d32f2f; 
    color: white;
    border-radius: 50%;
    width: 16px;       /* –ë—ã–ª–æ 24px */
    height: 16px;      /* –ë—ã–ª–æ 24px */
    font-size: 10px;   /* –®—Ä–∏—Ñ—Ç –º–µ–Ω—å—à–µ */
    font-weight: bold;
    display: flex; 
    align-items: center; 
    justify-content: center;
    border: 1px solid #fff; /* –¢–æ–Ω–∫–∞—è –æ–±–≤–æ–¥–∫–∞ */
    opacity: 0; 
    transition: opacity 0.3s;
}
.fab-badge.show { opacity: 1; }

/* –ü–∞–Ω–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—á–∞—Ç) */
.notif-panel {
    position: absolute;
    bottom: 80px; right: 0;
    width: 320px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    border: 1px solid #eee;
    overflow: hidden;
    display: none; /* –°–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    flex-direction: column;
    animation: slideUp 0.3s ease;
}
@keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

.notif-header { background: #fafafa; padding: 12px 15px; border-bottom: 1px solid #eee; font-weight: bold; color: #333; display: flex; justify-content: space-between; align-items: center; }
.notif-body { max-height: 400px; overflow-y: auto; padding: 10px; background: #fff; }
.notif-empty { text-align: center; padding: 30px 10px; color: #999; font-size: 13px; }

/* –ö–∞—Ä—Ç–æ—á–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
.notif-card {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-left: 4px solid #FF9800; /* –û—Ä–∞–Ω–∂–µ–≤–∞—è –ø–æ–ª–æ—Å–∫–∞ */
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 10px;
    position: relative;
}
.notif-title { font-size: 13px; font-weight: bold; color: #333; margin-bottom: 4px; }
.notif-text { font-size: 12px; color: #666; margin-bottom: 8px; line-height: 1.3; }
.notif-actions { display: flex; gap: 5px; }

.btn-wa { background: #E8F5E9; color: #2E7D32; border: 1px solid #C8E6C9; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; cursor: pointer; text-decoration: none; display: inline-block; }
.btn-wa:hover { background: #2E7D32; color: white; }
.btn-dismiss { background: #f5f5f5; color: #777; border: 1px solid #ddd; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; }
.btn-dismiss:hover { background: #ddd; }

/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ —Å –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–º */
.row-celebration {
    background-color: #fff8e1 !important; /* –ù–µ–∂–Ω–æ-–∂–µ–ª—Ç—ã–π —Ñ–æ–Ω */
    border-left: 4px solid #FF9800 !important; /* –û—Ä–∞–Ω–∂–µ–≤–∞—è –ø–æ–ª–æ—Å–∫–∞ */
}
/* –ß—Ç–æ–±—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ —ç—Ñ—Ñ–µ–∫—Ç –Ω–µ –ø—Ä–æ–ø–∞–¥–∞–ª, –∞ —á—É—Ç—å —Ç–µ–º–Ω–µ–ª */
.row-celebration:hover {
    background-color: #ffecb3 !important;
}

/* --- –ë–ï–ô–î–ñ–ò LTV –ò –°–¢–ê–¢–£–°–ê --- */
.badge-ltv { font-size:10px; padding:2px 6px; border-radius:10px; font-weight:bold; margin-right:5px; border:1px solid rgba(0,0,0,0.1); }
.badge-bronze { background: #fbe9e7; color: #d84315; } /* –ù–æ–≤–∏—á–æ–∫ */
.badge-silver { background: #e0f7fa; color: #006064; } /* –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π */
.badge-gold   { background: #fff8e1; color: #ff6f00; border-color:#ffb74d; } /* VIP */

/* --- –¢–ê–ë–õ–ò–¶–ê –ê–ù–ê–õ–ò–¢–ò–ö–ò --- */
.analytics-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
.analytics-table th { text-align: left; padding: 8px; background: #f5f5f5; color: #555; font-size: 12px; }
.analytics-table td { padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; }
.analytics-bar { height: 6px; background: #FF5722; border-radius: 3px; margin-top: 4px; }


.modal-box.wide {
    width: 98% !important;
    max-width: 1400px !important;
}

.hide-kbju .col-kbju { display: none; }


/* --- –õ–ê–ù–î–®–ê–§–¢–ù–´–ô –†–ï–ñ–ò–ú (–ü–û–í–û–†–û–¢ –¢–ï–õ–ï–§–û–ù–ê) --- */
@media (max-width: 900px) and (orientation: landscape) {
    
    /* 1. –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–µ—Ç–∫—É –∏–∑ –¥–≤—É—Ö –∫–æ–ª–æ–Ω–æ–∫ */
    .comparison-wrapper {
        display: grid !important;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }
    
    /* 2. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –û–ë–ï –∫–æ–ª–æ–Ω–∫–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ */
    .compare-col {
        display: block !important;
    }
    
    /* 3. –°–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–∞–±–æ–≤ (–æ–Ω –Ω–µ –Ω—É–∂–µ–Ω) */
    .mobile-tabs {
        display: none !important;
    }
    
    /* 4. –°–∫—Ä—ã–≤–∞–µ–º –Ω–∏–∂–Ω–∏–π –ª–∏–ø–∫–∏–π —Ñ—É—Ç–µ—Ä (–æ–Ω –∑–∞–Ω–∏–º–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤—ã—Å–æ—Ç—ã –≤ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏) */
    /* –¶–µ–Ω—ã –∏ —Ç–∞–∫ –≤–∏–¥–Ω—ã –≤–Ω—É—Ç—Ä–∏ –∫–æ–ª–æ–Ω–æ–∫ */
    .sticky-footer {
        display: none !important;
    }
    
    /* 5. –£–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã, —á—Ç–æ–±—ã –≤–ª–µ–∑–ª–æ –ø–æ –≤—ã—Å–æ—Ç–µ */
    .visual-container {
        height: 200px; /* –î–µ–ª–∞–µ–º —Ç–æ—Ä—Ç—ã –ø–æ–º–µ–Ω—å—à–µ –ø–æ –≤—ã—Å–æ—Ç–µ */
    }
    body {
        padding-bottom: 20px !important; /* –£–±–∏—Ä–∞–µ–º –æ—Ç—Å—Ç—É–ø –ø–æ–¥ —Ñ—É—Ç–µ—Ä */
    }
}

    
    /* --- 8. –§–ò–ö–° –°–ö–†–û–õ–õ–ê –ò –ó–ê–ü–†–ï–¢ –û–ë–ù–û–í–õ–ï–ù–ò–Ø (–§–ò–ù–ê–õ) --- */
html {
    /* –£–±–∏—Ä–∞–µ–º —Ñ–∏–∫—Å–∞—Ü–∏—é –≤—ã—Å–æ—Ç—ã –∏ —Å–∫—Ä—ã—Ç–∏–µ —Å–∫—Ä–æ–ª–ª–∞ */
    overscroll-behavior-y: none; /* –≠—Ç–æ –∑–∞–ø—Ä–µ—â–∞–µ—Ç "—Ä–µ–∑–∏–Ω–∫—É" –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
}
body {
    min-height: 100%;
    /* –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–∫—Ä–æ–ª–ª –±—Ä–∞—É–∑–µ—Ä—É */
    overscroll-behavior-y: none; 
    margin: 0;
    padding: 15px;
    padding-bottom: 80px;
    overflow-x: hidden;
    max-width: 100vw;
    /* –í–∞–∂–Ω–æ –¥–ª—è iOS, —á—Ç–æ–±—ã —Å–∫—Ä–æ–ª–ª –±—ã–ª –ø–ª–∞–≤–Ω—ã–º */
    -webkit-overflow-scrolling: touch; 
}
    
    /* –í–∞–∂–Ω–æ: —É–±–µ–¥–∏—Å—å, —á—Ç–æ —É .container –ù–ï–¢ overflow: hidden */
    .container {
        overflow: visible !important;
    }


/* --- 9. –ó–ê–©–ò–¢–ê –û–¢ –ü–û–î–í–ò–°–ê–ù–ò–ô (GPU) --- */
    .tab-content, .card, .modal-box, .visual-container {
        /* –≠—Ç–∏ —Å—Ç—Ä–æ–∫–∏ –∑–∞—Å—Ç–∞–≤–ª—è—é—Ç —Ç–µ–ª–µ—Ñ–æ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–∏–¥–µ–æ–∫–∞—Ä—Ç—É */
        transform: translateZ(0);
        -webkit-transform: translateZ(0);
        will-change: transform, opacity;
        /* –£–±–∏—Ä–∞–µ—Ç –º–µ—Ä—Ü–∞–Ω–∏–µ */
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
    }


    /* --- –°–¢–ò–õ–ò –õ–ê–ô–¢–ë–û–ö–°–ê --- */
/* --- –õ–ê–ô–¢–ë–û–ö–° (–§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–ô, –ë–ï–ó –ó–£–ú–ê, –ö–ù–û–ü–ö–ê –í–ù–ò–ó–£) --- */

.lightbox-overlay {
    display: none;       /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    position: fixed;     /* –ù–∞–º–µ—Ä—Ç–≤–æ –ø—Ä–∏–∫–ª–µ–µ–Ω–æ –∫ —ç–∫—Ä–∞–Ω—É */
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%;
    
    background: #fdfbf7; /* –ú–æ–ª–æ—á–Ω—ã–π —Ñ–æ–Ω */
    z-index: 10000;
    
    /* –¶–µ–Ω—Ç—Ä–æ–≤–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ */
    flex-direction: column;
    align-items: center;
    justify-content: center;
    
    /* –ó–∞–ø—Ä–µ—â–∞–µ–º –ª—é–±—ã–µ –¥–µ–π—Å—Ç–≤–∏—è —Å –±—Ä–∞—É–∑–µ—Ä–æ–º –Ω–∞ —ç—Ç–æ–º —Å–ª–æ–µ */
    touch-action: none; 
}

.lightbox-content {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px; /* –û—Ç—Å—Ç—É–ø—ã –æ—Ç –∫—Ä–∞–µ–≤ —ç–∫—Ä–∞–Ω–∞ */
    overflow: hidden; /* –û–±—Ä–µ–∑–∞–µ–º –≤—Å—ë, —á—Ç–æ —Ç–æ—Ä—á–∏—Ç */
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä SVG */
#lightboxSvgContainer {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* –°–∞–º SVG - –≤–ø–∏—Å—ã–≤–∞–µ–º –≤ —ç–∫—Ä–∞–Ω */
/* –°–∞–º SVG - –≤–ø–∏—Å—ã–≤–∞–µ–º –≤ —ç–∫—Ä–∞–Ω */
.lightbox-content svg, 
#lightboxSvgContainer svg {
    /* –ú—ã —Ö–æ—Ç–∏–º, —á—Ç–æ–±—ã SVG —Ç—è–Ω—É–ª—Å—è –Ω–∞ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –º–µ—Å—Ç–æ */
    width: 100% !important; 
    height: 100% !important;
    /* –£–±–∏—Ä–∞–µ–º –∂–µ—Å—Ç–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, —Ç–µ–ø–µ—Ä—å —Ä—É–ª–∏—Ç viewBox */
    max-width: none !important;  
    max-height: none !important; 
    /* –í–∞–∂–Ω–æ: —á—Ç–æ–±—ã –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –Ω–µ –∏—Å–∫–∞–∂–∞–ª–∏—Å—å, –Ω–æ –∑–∞–Ω–∏–º–∞–ª–∏ –º–∞–∫—Å–∏–º—É–º –º–µ—Å—Ç–∞ */
    object-fit: contain; 
}

/* –ö–†–ï–°–¢–ò–ö - –í–ù–ò–ó–£ –°–ü–†–ê–í–ê */
.lightbox-close {
    position: absolute;
    bottom: 30px;  /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
    right: 30px;   /* –û—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞ */
    
    width: 60px;   /* –ë–æ–ª—å—à–∞—è –∫–Ω–æ–ø–∫–∞ */
    height: 60px;
    border-radius: 50%;
    
    background: #FF5722; /* –û—Ä–∞–Ω–∂–µ–≤—ã–π (–∑–∞–º–µ—Ç–Ω—ã–π) */
    color: white;
    font-size: 30px;
    font-weight: bold;
    border: none;
    box-shadow: 0 4px 15px rgba(255, 87, 34, 0.4);
    
    cursor: pointer;
    z-index: 10002;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* –ö–Ω–æ–ø–∫–∞ —Å –ª—É–ø–æ–π (–Ω–∞ –º–∞–ª–µ–Ω—å–∫–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–µ) - –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å */
.zoom-hint-btn {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(255,255,255,0.9);
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 16px;
    pointer-events: auto !important;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    z-index: 20;
}

/* –ü–æ–¥—Å–∫–∞–∑–∫—É —É–±–∏—Ä–∞–µ–º, –æ–Ω–∞ –Ω–µ –Ω—É–∂–Ω–∞ */
.lightbox-hint { display: none; }

/* --- –†–ï–ñ–ò–ú –ì–û–¢–û–í–ö–ò (–ö–†–£–ü–ù–´–ô –®–†–ò–§–¢) --- */
.cooking-mode-active #batchContent {
    padding: 10px 5px;
}

.cooking-mode-active .batch-card {
    border-left-width: 12px !important;
    margin-bottom: 30px;
    border-radius: 12px;
}

.cooking-mode-active .col-tasks {
    display: none; /* –°–∫—Ä—ã–≤–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–æ –≤–µ—Å–∞–º */
}

.cooking-mode-active .col-ings {
    background: #fff !important;
    padding: 20px !important;
}

.cooking-mode-active .col-ings table {
    font-size: 22px !important; /* –û–≥—Ä–æ–º–Ω—ã–π —à—Ä–∏—Ñ—Ç –¥–ª—è –≤–µ—Å–∞ */
}

.cooking-mode-active .col-ings td {
    padding: 15px 0 !important;
    border-bottom: 2px solid #f0f0f0 !important;
}

.cooking-mode-active .col-ings td:last-child {
    font-size: 28px; /* –í–µ—Å –µ—â–µ –∫—Ä—É–ø–Ω–µ–µ */
    color: #000;
}

.cooking-mode-active .batch-header {
    background: #333 !important;
    color: #fff !important;
    padding: 15px !important;
}

.cooking-mode-active .batch-header span {
    color: #fff !important;
    font-size: 20px !important;
}

/* --- 3D –°–¶–ï–ù–ê (–§–ò–ù–ê–õ) --- */
.visual-container {
    height: 350px;
    background: radial-gradient(circle at center, #ffffff 0%, #f0f0f0 100%);
    border: 1px solid #ddd;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    perspective: 1000px;
    position: relative;
    /* –ó–∞—â–∏—Ç–∞ –æ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏—è –∏ —Å–∫—Ä–æ–ª–ª–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    touch-action: none;
    user-select: none;
}

.scene-stage {
    /* –¢–æ—á–∫–∞ —Ü–µ–Ω—Ç—Ä–∞ (0,0) */
    width: 0; height: 0;
    position: relative;
    transform-style: preserve-3d;
    transform: rotateX(60deg) rotateZ(-45deg); 
    transition: transform 0.1s; /* –ë—ã—Å—Ç—Ä–∞—è —Ä–µ–∞–∫—Ü–∏—è */
}

/* –§–∞–Ω—Ç–æ–º (–†–∞–º–∫–∞) */
.ghost-box {
    position: absolute;
    /* –ü–æ–∑–∏—Ü–∏—è –∑–∞–¥–∞–µ—Ç—Å—è JS-–æ–º —á–µ—Ä–µ–∑ margin */
    top: 0; left: 0; 
    border: 2px dashed rgba(33, 150, 243, 0.4);
    transform-style: preserve-3d;
    pointer-events: none;
    /* –í–∞–∂–Ω–æ: –Ω–∏–∫–∞–∫–∏—Ö transform:translate –∑–¥–µ—Å—å! */
}
/* –ö—Ä—É–≥–ª–∞—è —Ä–∞–º–∫–∞ */
.ghost-box.is-circle {
    border-radius: 50%;
    border-color: #E91E63;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–ª–æ–µ–≤ */
#cakeStack {
    position: absolute;
    top: 0; left: 0;
    width: 0; height: 0; /* JS —Å–∞–º –≤—Å—ë —Ä–∞—Å—Ç—è–Ω–µ—Ç */
    transform-style: preserve-3d;
    pointer-events: none;
}

/* –°–∞–º–∏ —Å–ª–æ–∏ */
.cake-layer {
    position: absolute;
    top: 0; left: 0;
    background-size: 100% 100%;
    background-repeat: no-repeat;
    pointer-events: none;
    backface-visibility: hidden;
}

/* –¶–≤–µ—Ç–∞ —Å–ª–æ–µ–≤ */
.cake-top {
    z-index: 2;
    filter: brightness(0) invert(1) sepia(1) saturate(4) hue-rotate(15deg) brightness(1.1) contrast(0.9) drop-shadow(0px 5px 8px rgba(0,0,0,0.25));
}
.cake-side {
    filter: brightness(0) invert(1) sepia(1) saturate(4) hue-rotate(15deg) brightness(0.6) contrast(1.2);
}

/* –ü–æ–¥–ø–∏—Å–∏ —Ä–∞–∑–º–µ—Ä–æ–≤ */
.dim-label {
    position: absolute;
    background: rgba(255,255,255,0.9);
    padding: 1px 5px;
    border-radius: 3px;
    font-size: 10px; font-weight: bold; color: #1565C0;
    border: 1px solid #90CAF9;
    transform: rotateZ(45deg) rotateX(-60deg); /* –°–º–æ—Ç—Ä—è—Ç –≤ –∫–∞–º–µ—Ä—É */
    white-space: nowrap;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
} 

      /* --- –ù–û–í–´–ô –î–ò–ó–ê–ô–ù –ü–õ–ê–ù–ê (–¢–ê–ë–´ + –°–¢–ê–¢–£–°–´) --- */

/* –õ–µ–Ω—Ç–∞ –¥–∞—Ç */
.date-tabs-container {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding-bottom: 10px;
    margin-bottom: 15px;
    -webkit-overflow-scrolling: touch;
    border-bottom: 1px solid #eee;
}

.date-tab {
    flex: 0 0 auto; /* –ù–µ —Å–∂–∏–º–∞—Ç—å */
    padding: 8px 16px;
    border-radius: 20px;
    background: #fff;
    border: 1px solid #ddd;
    color: #666;
    font-size: 13px;
    font-weight: bold;
    cursor: pointer;
    transition: 0.2s;
    text-align: center;
}

.date-tab.active {
    background: #FF5722;
    color: white;
    border-color: #FF5722;
    box-shadow: 0 4px 10px rgba(255, 87, 34, 0.3);
}

.date-tab span {
    display: block;
    font-size: 10px;
    font-weight: normal;
    opacity: 0.9;
}

/* –°—Ç—Ä–æ–∫–∞ –º–∏–∫—Ä–æ-—Å—Ç–∞—Ç—É—Å–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ */
.status-row {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px dashed #eee;
    gap: 2px;
}

.status-btn {
    flex: 1;
    border: 1px solid #eee;
    background: #fafafa;
    border-radius: 4px;
    padding: 4px 0;
    text-align: center;
    font-size: 16px;
    cursor: pointer;
    transition: 0.2s;
    opacity: 0.4; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–ª–µ–¥–Ω—ã–µ */
    filter: grayscale(100%);
}

.status-btn.done {
    opacity: 1;
    filter: grayscale(0%);
    background: #fff;
    border-color: #4CAF50;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.status-btn:active { transform: scale(0.95); }

/* --- –°–¢–ò–õ–ò –î–õ–Ø –¢–ï–•–ö–ê–†–¢–´ (–ö–û–ú–ü–ê–ö–¢–ù–´–ô –†–ï–ñ–ò–ú) --- */
.recipe-view-card {
    background: #fff;
    /* –£–±–∏—Ä–∞–µ–º —Ä–∞–º–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å —Å–Ω–∏–∑—É */
    border-bottom: 1px solid #eee; 
    margin-bottom: 0; /* –£–±–∏—Ä–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏ */
    padding: 8px 0;
}

/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–ª–æ—è (–ë–∏—Å–∫–≤–∏—Ç, –ö—Ä–µ–º) */
.rv-header {
    padding: 0 0 4px 0;
    font-size: 13px;
    font-weight: 800;
    color: #444;
    background: none; /* –£–±–∏—Ä–∞–µ–º —Å–µ—Ä—ã–π —Ñ–æ–Ω */
    border-bottom: none;
    display: flex;
    align-items: center;
    gap: 6px;
}

/* –¢–µ–ª–æ —Å–æ —Å–ø–∏—Å–∫–æ–º */
.rv-body {
    padding: 0;
    font-size: 13px;
}

/* –°—Ç—Ä–æ–∫–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ */
.rv-row {
    display: flex;
    align-items: baseline; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –Ω–∏–∂–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü–µ —Ç–µ–∫—Å—Ç–∞ */
    width: 100%;
    margin-bottom: 2px;
}

/* –ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ */
.rv-name {
    color: #555;
    flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞—Ç—å —Ç–µ–∫—Å—Ç */
    max-width: 70%; /* –ß—Ç–æ–±—ã –¥–ª–∏–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –∑–∞–¥–∞–≤–∏–ª–æ –≤–µ—Å */
}

/* –¢–æ—á–∫–∏-–Ω–∞–ø—Ä–∞–≤–ª—è—é—â–∏–µ ................. */
.rv-dots {
    flex-grow: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—ë —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ */
    border-bottom: 1px dotted #ccc; /* –°–∞–º–∏ —Ç–æ—á–∫–∏ */
    margin: 0 4px;
    position: relative;
    top: -4px; /* –ß—É—Ç—å –ø–æ–¥–Ω—è—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ */
}

/* –í–µ—Å */
.rv-val {
    font-weight: 700;
    color: #000;
    flex-shrink: 0;
    white-space: nowrap; /* –¶–∏—Ñ—Ä—ã –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å */
}

/* –¶–≤–µ—Ç–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã (—Ç–æ–Ω–∫–∞—è –ø–æ–ª–æ—Å–∫–∞ —Å–ª–µ–≤–∞) */
.recipe-view-card { border-left: 3px solid transparent; padding-left: 8px; }
.rv-type-filling { border-left-color: #42A5F5; } /* –ù–∞—á–∏–Ω–∫–∞ - –°–∏–Ω–∏–π */
.rv-type-coating { border-left-color: #795548; } /* –ü–æ–∫—Ä—ã—Ç–∏–µ - –ö–æ—Ä–∏—á–Ω–µ–≤—ã–π */
.rv-type-extra   { border-left-color: #FF9800; } /* –î–µ–∫–æ—Ä - –û—Ä–∞–Ω–∂–µ–≤—ã–π */


/* –°–ª–æ–∏ –¥–ª—è –ø—Å–µ–≤–¥–æ-3D */
.shape-layer {
    position: absolute;
    top: 0; left: 0;
    background-size: 100% 100%;
    background-repeat: no-repeat;
    pointer-events: none;
    backface-visibility: hidden; /* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ */
    opacity: 0.9;
}

/* –ë–æ–∫–æ–≤–∏–Ω—ã —Ç–µ–º–Ω–µ–µ, –≤–µ—Ä—Ö —Å–≤–µ—Ç–ª–µ–µ - –¥–ª—è –æ–±—ä–µ–º–∞ */
.shape-layer.side { filter: brightness(0.85) sepia(0.2) hue-rotate(320deg); } /* –ß—É—Ç—å "–±–∏—Å–∫–≤–∏—Ç–Ω—ã–π" –æ—Ç—Ç–µ–Ω–æ–∫ */
.shape-layer.top  { filter: brightness(1.1); }
  
    </style>
    

<div id="loadingOverlay" class="modal-overlay">
    <div style="text-align: center;">
        <div class="spinner"></div>
        <h3 style="color: #333; margin: 0;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...</h3>
        <p style="color: #666; font-size: 13px; margin-top: 5px;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
    </div>
</div>

<div id="cakeLightbox" class="lightbox-overlay">
    <button class="lightbox-close" onclick="closeLightbox()">‚úï</button>
    
    <div class="lightbox-content" onclick="event.stopPropagation()">
        <div id="lightboxSvgContainer"></div>
    </div>
    
    <div style="position:fixed; bottom:20px; color:#666; font-size:12px; pointer-events:none;">
        –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–π—Ç–∏
    </div>
</div>

<script>
// --- –ó–ê–ì–õ–£–®–ö–ê (–ß–¢–û–ë–´ –ù–ï –ë–´–õ–û –û–®–ò–ë–û–ö) ---
  // –ï—Å–ª–∏ –≥–¥–µ-—Ç–æ –≤ –∫–æ–¥–µ –æ—Å—Ç–∞–ª—Å—è —Å—Ç–∞—Ä—ã–π –≤—ã–∑–æ–≤ db.ref, –æ–Ω –ø—Ä–æ—Å—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ —Å–¥–µ–ª–∞–µ—Ç
  const db = {
    ref: function() {
        return {
            on: function(){},
            once: function(){},
            set: function(){ return Promise.resolve(); },
            update: function(){ return Promise.resolve(); },
            remove: function(){ return Promise.resolve(); },
            orderByChild: function(){ return this; },
            equalTo: function(){ return this; },
            limitToLast: function(){ return this; }
        }
    }
  };
</script>
<script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>    
  </head>
  <body>

<div id="successModal" class="modal-overlay" style="z-index: 10001;">
    <div class="modal-box" style="width: 350px; text-align: center;">
        <div style="font-size: 40px; margin-bottom: 10px;">üéâ</div>
        <h3 style="margin: 0 0 10px 0; color: #2E7D32;">–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!</h3>
        <div style="font-size: 13px; color: #666; margin-bottom: 20px;">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞–ª—å–Ω–µ–π—à–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:</div>
        
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button id="btnSuccessWA" class="main-btn" style="background:#25D366; display:none; align-items:center; justify-content:center; gap:8px;">
                <span>üí¨</span> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ WhatsApp
            </button>
            <button id="btnSuccessCal" class="main-btn" style="background:#4285F4; align-items:center; justify-content:center; gap:8px;">
                <span>üìÖ</span> –î–æ–±–∞–≤–∏—Ç—å –≤ –ö–∞–ª–µ–Ω–¥–∞—Ä—å
            </button>
            <button class="tab-btn" onclick="document.getElementById('successModal').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>
    
    <datalist id="allIngsDatalist"></datalist>
    <datalist id="allLaborDatalist"></datalist>

    <div class="container">
      <div class="navbar">
    <div class="nav-group">
        <button class="tab-btn active" onclick="switchTab('calc')">üç∞ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</button>
        <button class="tab-btn" onclick="switchTab('stock')">üì¶ –°–∫–ª–∞–¥</button>
        <button class="tab-btn" onclick="switchTab('recipes')">üìñ –†–µ—Ü–µ–ø—Ç—ã</button>
        <button class="tab-btn" onclick="switchTab('production')">üè≠ –ü–ª–∞–Ω <span id="badgeQueue" style="background:red; color:white; border-radius:10px; padding:2px 6px; font-size:10px; display:none;">0</span></button>
        <button class="tab-btn" onclick="switchTab('clients')">üë• –ö–ª–∏–µ–Ω—Ç—ã</button>
        <button class="tab-btn" onclick="switchTab('colors')">üé® –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è —Ü–≤–µ—Ç–∞</button>
        <button class="tab-btn" onclick="switchTab('shapes')">üî¢ –§–∏–≥—É—Ä—ã (SVG)</button>
        <button class="tab-btn" onclick="switchTab('archive')">üóÑÔ∏è –ê—Ä—Ö–∏–≤</button>
      
        
        <div style="width:1px; height:20px; background:#ddd; margin:0 5px;"></div>
        <button class="tab-btn settings-btn" onclick="openSettingsModal()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

    <div class="tools-group">
        <div class="data-panel">
            <button class="data-btn blue" onclick="downloadBackup()" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª (–ë—ç–∫–∞–ø)">üíæ</button>
            <button class="data-btn blue" onclick="document.getElementById('fileInput').click()" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª">üìÇ</button>
            <div style="width: 1px; background: #ccc; margin: 0 5px;"></div>
            <button class="data-btn" onclick="undo()" title="–ù–∞–∑–∞–¥ (Ctrl+Z)">‚Ü©Ô∏è</button>
            <button class="data-btn" onclick="redo()" title="–í–ø–µ—Ä–µ–¥ (Ctrl+Y)">‚Ü™Ô∏è</button>
        </div>
        <select id="currencySelect" onchange="changeCurrency(this.value)" style="width:auto; border:1px solid #ddd; padding:6px; border-radius:6px; font-weight:bold;">
            <option value="KZT">‚Ç∏</option>
            <option value="RUB">‚ÇΩ</option>
            <option value="USD">$</option>
        </select>
      
    </div>
</div>

<div id="tab-clients" class="tab-content" style="display:none;">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2>üë• –ë–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤</h2>
            <button class="add-btn-small" onclick="openClientReportsModal()" style="background:#607D8B; margin-right:10px;">üìä –û—Ç—á–µ—Ç—ã (–ü—Ä–æ–¥–∞–∂–∏/–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥)</button>
            <button class="add-btn-small" onclick="openClientModal()" style="background:#2196F3;">+ –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</button>
        </div>
        
        <input type="text" id="clientSearch" class="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É..." oninput="renderClientsCloud()">
        
        <div style="margin-bottom:15px; display:flex; gap:15px; align-items:center;">
            <label style="cursor:pointer; display:flex; align-items:center; gap:5px; font-weight:bold; color:#E65100; background:#FFF3E0; padding:5px 10px; border-radius:20px; border:1px solid #FFE0B2;">
                <input type="checkbox" id="filterUpcoming" onchange="renderClientsCloud()"> üéÅ –ü—Ä–∞–∑–¥–Ω–∏–∫–∏ (7 –¥–Ω–µ–π)
            </label>
        </div>
        
        <div style="overflow-x:auto; margin-top:15px;">
            <table class="stock-table">
                <thead>
                    <tr>
                        <th>–ö–ª–∏–µ–Ω—Ç</th>
                        <th>–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>
                        <th>–ê–ª–ª–µ—Ä–≥–∏–∏ / –ó–∞–º–µ—Ç–∫–∏</th>
                        <th style="width:40px;"></th>
                    </tr>
                </thead>
                <tbody id="clientsCloudList">
                    <tr><td colspan="4" style="text-align:center; color:#999; padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –∏–∑ –æ–±–ª–∞–∫–∞...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

      <div id="tab-archive" class="tab-content" style="display:none;">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2>üóÑÔ∏è –ê—Ä—Ö–∏–≤ –∑–∞–∫–∞–∑–æ–≤</h2>
            <div style="font-size:12px; color:#666;">
                –í—Å–µ–≥–æ: <b id="archiveTotalCount">0</b>
            </div>
        </div>

        <div style="background:#f5f5f5; padding:10px; border-radius:8px; margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
            <div style="flex:1; min-width:120px;">
                <span class="form-label">–° –¥–∞—Ç—ã:</span>
                <input type="date" id="archiveDateStart" onchange="renderArchive()">
            </div>
            <div style="flex:1; min-width:120px;">
                <span class="form-label">–ü–æ –¥–∞—Ç—É:</span>
                <input type="date" id="archiveDateEnd" onchange="renderArchive()">
            </div>
            <div style="flex:2; min-width:200px;">
                <span class="form-label">–ü–æ–∏—Å–∫ (–ò–º—è, –ù–∞—á–∏–Ω–∫–∞):</span>
                <input type="text" id="archiveSearch" placeholder="üîç –ù–∞–π—Ç–∏..." oninput="renderArchive()">
            </div>
        </div>

        <div id="archiveContainer"></div>
    </div>
</div>

<div id="clientModal" class="modal-overlay">
    <div class="modal-box" style="width: 600px; max-width: 95%; height: 80vh; display: flex; flex-direction: column;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 id="clientModalTitle" style="margin:0;">üë§ –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞</h3>
            <div id="clientTotalSpend" style="font-size:12px; background:#e8f5e9; color:#2e7d32; padding:4px 10px; border-radius:12px; font-weight:bold;">–ó–∞–∫–∞–∑–æ–≤ –Ω–∞: 0 ‚Ç∏</div>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <button class="tab-btn active" id="btnClInfo" onclick="switchClientTab('info')" style="padding:5px 15px; font-size:12px;">–æ—Å–Ω–æ–≤–Ω–æ–µ</button>
            <button class="tab-btn" id="btnClHistory" onclick="switchClientTab('history')" style="padding:5px 15px; font-size:12px;">–∏—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</button>
        </div>

        <div id="clientTabInfo" style="flex:1; overflow-y:auto; padding-right:10px;">
            <div class="form-row">
                <div class="form-group" style="flex:2;"><span class="form-label">–ò–º—è / –ù–∏–∫</span><input type="text" id="clName"></div>
                <div class="form-group"><span class="form-label">–°–∫–∏–¥–∫–∞ %</span><input type="number" id="clDiscount" value="0"></div>
            </div>
            
            <div class="form-row">
                <div class="form-group" style="flex:1.5;"> 
                    <span class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</span>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="clPhone" placeholder="+7 (___) ___-__-__" oninput="formatPhoneNumber(this)" style="font-weight:bold;">
                        <div id="messengerBtns" style="display:none; gap:2px;">
                            <button onclick="openMessenger('wa')" title="–û—Ç–∫—Ä—ã—Ç—å WhatsApp" style="background:#25D366; border:none; border-radius:4px; cursor:pointer; padding:0 8px; font-size:16px;">üü¢</button>
                            <button onclick="openMessenger('tg')" title="–û—Ç–∫—Ä—ã—Ç—å Telegram (–ø–æ –Ω–∏–∫—É)" style="background:#0088cc; border:none; border-radius:4px; cursor:pointer; padding:0 8px; font-size:16px;">üîπ</button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <span class="form-label">Instagram / TG (–ù–∏–∫)</span>
                    <input type="text" id="clSocial" placeholder="–±–µ–∑ —Å–æ–±–∞—á–∫–∏ @">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <span class="form-label">üì¢ –û—Ç–∫—É–¥–∞ —É–∑–Ω–∞–ª?</span>
                    <select id="clSource">
                        <option value="">-- –ù–µ —É–∫–∞–∑–∞–Ω–æ --</option>
                    </select>
                </div>
                <div class="form-group" style="display:flex; align-items:flex-end;">
                    <label style="cursor:pointer; color:#d32f2f; font-weight:bold; display:flex; align-items:center; gap:5px; padding:8px; border:1px solid #ffcdd2; border-radius:6px; background:#ffebee; width:100%;">
                        <input type="checkbox" id="clBlacklist"> ‚õî –ß–µ—Ä–Ω–∞—è –º–µ—Ç–∫–∞
                    </label>
                </div>
            </div>
            
            <div style="margin-top:15px; background:#fff8e1; padding:10px; border-radius:8px; border:1px solid #ffe0b2;">
                <span class="form-label" style="color:#e65100;">üìÖ –í–∞–∂–Ω—ã–µ –¥–∞—Ç—ã (–î–† –¥–µ—Ç–µ–π, –≥–æ–¥–æ–≤—â–∏–Ω—ã)</span>
                <div id="clDatesContainer"></div>
                <button class="add-btn-small" onclick="addClientDateRow()" style="background:#fb8c00; margin-top:5px; width:100%;">+ –î–æ–±–∞–≤–∏—Ç—å –¥–∞—Ç—É</button>
            </div>

            <div class="form-group" style="margin-top:15px;">
                <span class="form-label" style="color:#d32f2f;">‚ö†Ô∏è –ê–ª–ª–µ—Ä–≥–∏–∏ –∏ –≤–∞–∂–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏</span>
                <textarea id="clNotes" rows="3" style="width:100%; border:1px solid #ddd; border-radius:6px; padding:8px; font-family:inherit;"></textarea>
            </div>
        </div>

        <div id="clientTabHistory" style="display:none; flex:1; overflow-y:auto;">
           <div id="clOrdersList" style="display:grid; gap:10px; padding:10px;">
    </div>
        </div>

        <input type="hidden" id="clId">
        <div class="modal-actions" style="margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
            <button class="tab-btn" onclick="closeClientModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="main-btn" onclick="saveClientCloud()" style="width:auto; padding:8px 25px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É</button>
        </div>
    </div>
</div>

<div id="orderFinalizeModal" class="modal-overlay">
    <div class="modal-box" style="width: 550px; max-height: 95vh; overflow-y: auto;">
        <h3>üìù –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h3>
    
        <div style="background: #f0f4c3; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px dashed #c0ca33; text-align: center;">
            <div style="font-size: 12px; font-weight: bold; color: #827717; margin-bottom: 5px;">üì∏ –†–µ—Ñ–µ—Ä–µ–Ω—Å (–§–æ—Ç–æ –¥–∏–∑–∞–π–Ω–∞)</div>
            
            <input type="file" id="orderRefInput" accept="image/*" style="display:none;" onchange="processOrderImage(this)">
            
            <div id="orderRefPreviewBox" onclick="document.getElementById('orderRefInput').click()" 
                 style="width: 100%; height: 120px; background: #fff; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; position: relative; border: 1px solid #ddd;">
                <span style="color: #999; font-size: 12px;">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</span>
                <img id="orderRefImg" style="display:none; width: 100%; height: 100%; object-fit: contain;">
            </div>
            <button onclick="clearOrderImage()" id="btnDelRef" style="display:none; margin-top:5px; background:none; border:none; color:#d32f2f; font-size:11px; cursor:pointer; text-decoration:underline;">–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ</button>
        </div>

        <div class="form-row">
            <div class="form-group" style="flex:2;">
                <span class="form-label">–ö–ª–∏–µ–Ω—Ç (–ò–º—è, –¢–µ–ª –∏–ª–∏ –ò–Ω—Å—Ç–∞)</span>
                <input type="text" id="orderClientSearch" list="orderClientsDatalist" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å..." onchange="handleClientSelection()">
                <datalist id="orderClientsDatalist"></datalist>
                <input type="hidden" id="orderClientId">
            </div>
            <div class="form-group">
    <span class="form-label">üìÖ –î–∞—Ç–∞ —Å–¥–∞—á–∏</span>
    
    <input type="date" id="orderDeadline" onchange="checkDateLoad()" required>

    <div id="dateLoadIndicator" style="margin-top: 5px; font-size: 13px; font-weight: bold; display: none; padding: 5px; border-radius: 4px;"></div>
</div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <span class="form-label">–ü–æ–≤–æ–¥</span>
                <input type="text" id="orderReason" placeholder="–ù–∞–ø—Ä: –Æ–±–∏–ª–µ–π">
            </div>
            <div class="form-group">
                <span class="form-label">–î–ª—è –∫–æ–≥–æ</span>
                <input type="text" id="orderForWhom" placeholder="–ò–º—è –∏–º–µ–Ω–∏–Ω–Ω–∏–∫–∞">
            </div>
        </div>

          <div class="form-row">
            <div class="form-group">
                <span class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</span>
                <input type="text" id="orderPhone" placeholder="+7 (___) ___-__-__" oninput="formatPhoneNumber(this)">
            </div>
            <div class="form-group">
                <span class="form-label">–ù–∏–∫ –≤ —Å–æ—Ü.—Å–µ—Ç—è—Ö</span>
                <input type="text" id="orderSocial" placeholder="–±–µ–∑ @">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <span class="form-label">üìç –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</span>
                <input type="text" id="orderAddress" placeholder="–£–ª–∏—Ü–∞, –¥–æ–º, –∫–≤...">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <span class="form-label">üí∞ –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</span>
                <input type="text" id="orderPrepayment" class="money-input" placeholder="0" oninput="formatMoneyInput(this)">
            </div>
            <div class="form-group">
                <span class="form-label">–û—Å—Ç–∞—Ç–æ–∫</span>
                <input type="text" id="orderBalance" class="money-input" placeholder="0" oninput="formatMoneyInput(this)">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group" style="flex:1;">
                <span class="form-label">üé® –û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç —Ç–æ—Ä—Ç–∞</span>
                <input type="text" id="orderColor" placeholder="–ù–∞–ø—Ä: –ö—Ä–∞—Å–Ω—ã–π, –ù–µ–∂–Ω—ã–π —Ä–æ–∑–æ–≤—ã–π">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <span class="form-label">üí≥ –û–ø–ª–∞—Ç–∞</span>
                <select id="orderPayment">
                    <option value="–ü–µ—Ä–µ–≤–æ–¥ (Kaspi)">–ü–µ—Ä–µ–≤–æ–¥ (Kaspi)</option>
                    <option value="–ü–µ—Ä–µ–≤–æ–¥ (Halyk)">–ü–µ—Ä–µ–≤–æ–¥ (Halyk)</option>
                    <option value="–ù–∞–ª–∏—á–Ω—ã–µ">–ù–∞–ª–∏—á–Ω—ã–µ</option>
                    <option value="–£–¥–∞–ª–µ–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞">–£–¥–∞–ª–µ–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞</option>
                </select>
            </div>
            <div class="form-group">
                <span class="form-label">üìç –ü–æ–ª—É—á–µ–Ω–∏–µ</span>
                <select id="orderDelivery">
                    <option value="–°–∞–º–æ–≤—ã–≤–æ–∑">–°–∞–º–æ–≤—ã–≤–æ–∑</option>
                    <option value="–ö—É—Ä—å–µ—Ä">–ö—É—Ä—å–µ—Ä (–î–æ—Å—Ç–∞–≤–∫–∞)</option>
                    <option value="–í–∞—à–∞ –¥–æ—Å—Ç–∞–≤–∫–∞">–í–∞—à–∞ –¥–æ—Å—Ç–∞–≤–∫–∞</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <span class="form-label">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ (–¥–µ–∫–æ—Ä)</span>
            <textarea id="orderComment" rows="6" 
                      placeholder="–û–ø–∏—à–∏—Ç–µ –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞..." 
                      style="width:100%; border:1px solid #ddd; border-radius:6px; padding:10px; font-family:inherit; resize:vertical; min-height: 120px;"></textarea>
        </div>

        <div class="modal-actions">
            <button class="tab-btn" onclick="document.getElementById('orderFinalizeModal').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
            <button class="main-btn" onclick="confirmAddToQueueWithClient()" style="width:auto; padding:10px 30px; background:#4CAF50;">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
    </div>
</div>

      <div id="tab-calc" class="tab-content">
        <div class="card">
          <h2>‚öôÔ∏è –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¢–æ—Ä—Ç–∞</h2>
          
          <div class="form-row" style="background:#fff8e1; padding:15px; border-radius:6px; margin-bottom:15px; border:1px solid #ffe0b2; flex-wrap: wrap;">
    <div class="form-group" style="flex:2; min-width: 200px;">
        <span class="form-label">–§–æ—Ä–º–∞ —Ç–æ—Ä—Ç–∞</span>
        <select id="globalShape" onchange="updateTierUI()" style="font-weight:bold;">
            <option value="cylinder">–ö—Ä—É–≥ (–¶–∏–ª–∏–Ω–¥—Ä)</option>
            <option value="square">–ö–≤–∞–¥—Ä–∞—Ç</option>
            <option value="rectangle">–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫</option>
            <option value="sphere">–®–∞—Ä (–ë–æ–º–±–∞)</option>
            <option value="polygon">–ú–Ω–æ–≥–æ–≥—Ä–∞–Ω–Ω–∏–∫</option>
        </select>
    </div>

    <div class="form-group" id="grpSides" style="display:none; flex:1;">
        <span class="form-label">–£–≥–ª–æ–≤</span>
        <input type="number" id="globalSides" value="6">
    </div>
    <div class="form-group" id="sphereFillBlock" style="display:none; flex:2;">
        <span class="form-label">–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ</span>
        <div style="font-size:11px;">
            <label><input type="radio" name="sphereFillMode" value="recipe" onchange="calculateSide(appState.activeSide)" checked> –ö–∞–∫ –≤ —Ä–µ—Ü–µ–ø—Ç–µ</label>
            <label><input type="radio" name="sphereFillMode" value="full" onchange="calculateSide(appState.activeSide)"> –ü–æ–ª–Ω—ã–π (100%)</label>
        </div>
    </div>

    <div class="form-group" style="flex:2; min-width: 200px;">
        <span class="form-label">–ü–æ–∫—Ä—ã—Ç–∏–µ (–û–±—â–µ–µ)</span>
        <select id="coatingIdSelect" onchange="updateCoatingUI()"><option value="">-- –ì–æ–ª—ã–π --</option></select>
    </div>

    <div style="width:100%; height:1px; background:#ffe0b2; margin:10px 0;"></div>
    
    <div class="form-group" style="flex:1;">
         <span class="form-label" title="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π % –∫ –≤–µ—Å—É –Ω–∞—á–∏–Ω–∫–∏">–ó–∞–ø–∞—Å –ù–∞—á–∏–Ω–∫–∏ %</span>
         <input type="number" id="fillingMargin" value="0" placeholder="0" style="font-weight:bold; color:#E65100;">
    </div>
    <div class="form-group" style="flex:1;">
         <span class="form-label" title="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π % –∫ –≤–µ—Å—É –∫—Ä–µ–º–∞">–ó–∞–ø–∞—Å –ü–æ–∫—Ä—ã—Ç–∏—è %</span>
         <input type="number" id="coatingMargin" value="0" placeholder="0" style="font-weight:bold; color:#E65100;">
    </div>
</div>

            <div id="coatingMethodBlock" class="toggle-wrapper" style="display:none; margin-bottom:15px; padding:5px 10px; transition:0.3s;">
            <label class="switch" style="transform:scale(0.8);">
              <input type="checkbox" id="chkCoatingMethod" onchange="updateCoatingText()" checked>
               <span class="slider"></span>
            </label>
             <div class="toggle-text" id="coatingTextContainer">
              <b id="coatTitle">üìê –†–∞—Å—Ö–æ–¥ –ø–æ –ì–µ–æ–º–µ—Ç—Ä–∏–∏</b>
              <span id="coatDesc">(–ò—Å—Ö–æ–¥—è –∏–∑ –ø–ª–æ—â–∞–¥–∏ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏)</span>
            </div>
              </div>

                <div id="tiersContainer"></div>

                <div style="display:flex; justify-content:center; margin-bottom:20px;">
                  <button type="button" class="tab-btn" onclick="addTier()" style="background:#eee; border:1px dashed #ccc;">+ –î–æ–±–∞–≤–∏—Ç—å —è—Ä—É—Å</button>
                 </div>
          
                 <hr style="border:0; border-top:2px dashed #eee; margin-bottom:20px;">

                <div class="form-row">
              <div class="form-group">
                  <span class="form-label">üé® –î–æ–ø. –ø–æ–∫—Ä—ã—Ç–∏–µ (–í–µ–ª—é—Ä)</span>
                  <select id="extraCoatingIdSelect"><option value="">-- –ù–µ—Ç --</option></select>
              </div>
              <div class="form-group" style="max-width:80px;">
                  <span class="form-label">–ó–∞–ø–∞—Å %</span>
                  <input type="number" id="extraMargin" value="0">
              </div>
               </div>
        
               <div style="margin-top:5px; background:#f0f4c3; padding:15px; border-radius:8px; border:1px solid #dce775;">
              <span class="form-label" style="color:#827717; margin-bottom:10px;">üì¶ –†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏, –£—Å–ª—É–≥–∏ –∏ –î–µ–∫–æ—Ä</span>
              <div id="extrasContainer"></div>
              <div style="display:flex; gap:5px; margin-top:10px;">
                  <input id="extraItemSearch" list="allIngsDatalist" placeholder="–ü–æ–∏—Å–∫..." style="flex:2;">
                  <input type="number" id="extraItemAmount" placeholder="–ö–æ–ª-–≤–æ" style="flex:1;">
                  <button type="button" class="add-btn-small" onclick="addExtraItem()" style="background:#827717;">+</button>
              </div>
                </div>

              <div style="margin-top:15px; background:#e0f2f1; padding:15px; border-radius:8px; border:1px solid #80cbc4;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
    <span class="form-label" style="color:#00695c; margin:0;">üí∞ –¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã</span>
    <button type="button" onclick="resetLaborManual()" style="background:none; border:none; color:#00695c; cursor:pointer; font-size:11px; font-weight:bold; text-decoration:underline;">üßπ –°–±—Ä–æ—Å–∏—Ç—å —Ä—É—á–Ω—ã–µ –ø—Ä–∞–≤–∫–∏</button>
</div>
              <div class="form-row" style="margin-bottom:10px; border-bottom:1px dashed #b2dfdb; padding-bottom:10px;">
    <div class="form-group"><span class="form-label" style="color:#d32f2f;">–°—Ä–æ—á–Ω–æ—Å—Ç—å (%)</span><input type="number" id="urgencyPercent" placeholder="0"></div>
</div>
              <div id="laborListContainer" style="margin-bottom:10px;"></div>
              <div style="display:flex; gap:5px; align-items:flex-end;">
                  <div style="flex:2;"><input id="laborSearch" list="allLaborDatalist" placeholder="–ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç—ã..."></div>
                  <div style="flex:1;"><input type="number" id="laborHoursInput" placeholder="–ß–∞—Å—ã" step="0.5"></div>



<button type="button" class="add-btn-small" onclick="addLaborTask()" style="background:#00695c;">+</button>
              </div>
              <div style="margin-top:10px; text-align:right; font-size:12px; color:#004d40;">–ò—Ç–æ–≥–æ: <b id="totalNormHoursDisplay">0</b> –Ω/—á</div>
                  </div>

                

                 <div style="display:flex; gap:10px; margin-top:15px;">
              <button type="button" class="main-btn" onclick="calculateInitial()" style="background: linear-gradient(135deg, #448AFF 0%, #2962FF 100%); flex:2;">üöÄ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
              <button type="button" class="main-btn" onclick="addToQueue()" style="background: #FF9800; flex:1;">‚ûï –í –ø–ª–∞–Ω</button>
                </div>
                </div>

                   <div id="loader" style="display:none; text-align:center; width:100%; padding:20px;">‚è≥ –°—á–∏—Ç–∞–µ–º –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é...</div>

        <div id="resultsBlock" class="card" style="display:none; padding-bottom:10px;">
          <h2>üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</h2>
          <div class="comparison-wrapper">
            <div class="mobile-tabs">
        <div id="tabLeft" class="mobile-tab-btn" onclick="setActiveSide('Left')">–í–∞—Ä–∏–∞–Ω—Ç 1</div>
        <div id="tabRight" class="mobile-tab-btn active" onclick="setActiveSide('Right')">–í–∞—Ä–∏–∞–Ω—Ç 2</div>
    </div>
            <div id="col-Left" class="compare-col static" onclick="setActiveSide('Left')" style="cursor:pointer; transition:0.2s;">
               <div class="col-header gray">‚≠ê –í–∞—Ä–∏–∞–Ω—Ç 1</div>
               <div class="visual-container"> 
    <div class="zoom-hint-btn" onclick="openLightbox('Left')">üîç</div>
   <div id="tierControlsLeft" class="controls-overlay"></div>
   <div id="svgLeft" class="svg-box"></div>
</div>          
               <div class="price-big"><span id="priceLeft">0</span> <span class="curr-sym"></span></div>
               <div id="statsLeft" style="color:#555; font-size:14px; padding:0 10px;"></div>
            </div>
            <div id="col-Right" class="compare-col" onclick="setActiveSide('Right')" style="cursor:pointer; transition:0.2s;">
               <div class="col-header orange">‚úèÔ∏è –í–∞—Ä–∏–∞–Ω—Ç 2</div>
               <div class="visual-container">
    <div class="zoom-hint-btn" onclick="openLightbox('Right')">üîç</div>
                    <div id="tierControls" class="controls-overlay"></div>
                    <div id="svgRight" class="svg-box"></div>
                 </div>
               <div class="price-big"><span id="priceRight">0</span> <span class="curr-sym"></span><span id="priceDiffTag" class="price-diff"></span></div>
               <div id="statsRight" style="color:#333; font-size:14px; padding:0 10px;"></div>
            </div>
          </div>
          <div class="shopping-block">
             <h3 style="margin-top:0; font-size:16px; color:#444; border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:20px;">
               üõí –°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤: <span id="shopListTitle" style="color:#FF5722"></span>
             </h3>
             <div id="shopListContainer" class="shop-grid"></div>
          </div>
        </div>
      </div>

      <div id="tab-stock" class="tab-content" style="display:none;">
        <div class="card" style="padding: 10px; overflow-x: auto;">
           <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
             <h2>üì¶ –°–∫–ª–∞–¥ –∏ –£—Å–ª—É–≥–∏</h2>
             <div class="data-panel" style="margin:0; padding:0; background:none;">
                <button class="data-btn blue" onclick="openImportModal('ingredients')">–ò–º–ø–æ—Ä—Ç –∏–Ω–≥—Ä–∏–¥–∏–µ–Ω—Ç–æ–≤/—Ä–∞–±–æ—Ç –∏–∑ —Ç–∞–±–ª–∏—Ü—ã</button>
                <input type="file" id="fileInput" style="display:none;" onchange="loadBackupFile(this)">
             </div>
           </div>
           <div style="display:flex; gap:15px; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid #eee;">
            <div style="margin-bottom: 15px;">
    <input type="text" id="stockSearch" class="search-input" placeholder="üîç –ù–∞–π—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç –∏–ª–∏ —Ä–∞–±–æ—Ç—É..." oninput="refreshStockView()" style="width:100%; padding:10px; font-size:14px; border:1px solid #ddd; border-radius:6px;">
</div>
               <label style="cursor:pointer; display:flex; align-items:center; gap:5px;">
                   <input type="radio" name="stockType" value="ingredients" checked onchange="switchStockView('ingredients')"> 
                   <span style="font-weight:bold;">üçé –ü—Ä–æ–¥—É–∫—Ç—ã (–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã)</span>
               </label>
               <label style="cursor:pointer; display:flex; align-items:center; gap:5px;">
                   <input type="radio" name="stockType" value="labor" onchange="switchStockView('labor')"> 
                   <span style="font-weight:bold; color:#00695c;">üõ†Ô∏è –í–∏–¥—ã —Ä–∞–±–æ—Ç (–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫)</span>
               </label>
           </div>
           <div class="stock-toolbar" style="margin-bottom:15px; display:flex; gap:8px; align-items:center; background:#f5f5f5; padding:8px; border-radius:8px; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch;">
    <div style="background:white; padding:4px; border-radius:6px; border:1px solid #ddd; display:flex; gap:5px;">
        <button class="shelf-btn active" onclick="setStockShelf('all', this)" style="border:none; background:#eee; border-radius:4px; padding:5px 10px; cursor:pointer; font-weight:bold;">–í—Å–µ</button>
        <button class="shelf-btn" onclick="setStockShelf('food', this)" style="border:none; background:white; border-radius:4px; padding:5px 10px; cursor:pointer;">üçé –ü—Ä–æ–¥—É–∫—Ç—ã</button>
        <button class="shelf-btn" onclick="setStockShelf('pack', this)" style="border:none; background:white; border-radius:4px; padding:5px 10px; cursor:pointer;">üì¶ –£–ø–∞–∫/–î–µ–∫–æ—Ä</button>
    </div>
    
    <div style="width:1px; height:20px; background:#ccc; margin:0 5px;"></div>

    <button class="add-btn-small" onclick="openProcurementModal()" style="background:#4CAF50; font-size:13px; padding:8px 15px;">üõí –ó–ê–ö–£–ü</button>
    <button id="btnInventoryToggle" class="tab-btn" onclick="toggleInventoryMode()" style="background:#fff; border:1px solid #ccc; color:#555;">üîò –ò–Ω–≤–µ–Ω—Ç.</button>
    
    <label style="cursor:pointer; display:flex; align-items:center; gap:5px; margin-left:5px;">
        <input type="checkbox" id="toggleKbju" onchange="toggleKbjuColumns()"> 
        <span style="font-size:11px;">–ö–ë–ñ–£</span>
    </label>
    
   
<button class="tab-btn" onclick="openReportsModal()" style="background:#E3F2FD; color:#1565C0; border:1px solid #BBDEFB; padding: 6px 10px; flex-shrink: 0;">üìä</button>


<button class="tab-btn" onclick="openStockHistory()" style="background:#E0E0E0; border: 1px solid #ccc; padding: 6px 10px; flex-shrink: 0;">üìú</button>
</div>
           <div id="ingredientsStockBlock" style="overflow-x: auto;"> <table class="stock-table" style="min-width: 1200px;">
                <thead>
        <tr>
            <th style="width:20%" onclick="setSort('stock','name')">–†–µ—Å—É—Ä—Å <span id="sort_stock_name"></span></th>
            
            <th style="width:7%">–ï–¥.</th>
            <th style="width:7%; color:#E65100;" title="–í–µ—Å 1—à—Ç">–í–µ—Å 1—à—Ç</th>
            <th style="width:4%; color:#E65100;" title="–í –≥—Ä–∞–º–º–∞—Ö">–í –≥—Ä</th>
            
            <th class="col-kbju" style="width:9%" onclick="setSort('stock','p')">–ë <span id="sort_stock_p"></span></th>
            <th class="col-kbju" style="width:9%" onclick="setSort('stock','f')">–ñ <span id="sort_stock_f"></span></th>
            <th class="col-kbju" style="width:9%" onclick="setSort('stock','c')">–£ <span id="sort_stock_c"></span></th>
            <th class="col-kbju" style="width:9%" onclick="setSort('stock','k')">–ö–∫–∞–ª <span id="sort_stock_k"></span></th>

            <th style="width:7%" onclick="setSort('stock','packWeight')">–£–ø–∞–∫. <span id="sort_stock_packWeight"></span></th>
            <th style="width:7%" onclick="setSort('stock','packPrice')">–¶–µ–Ω–∞ <span id="sort_stock_packPrice"></span></th>
            <th style="width:6%">–ó–∞ –µ–¥.</th>
            
            <th style="width:12%; color:#1565C0;" onclick="setSort('stock','stock')">–û—Å—Ç–∞—Ç–æ–∫ <span id="sort_stock_stock"></span></th>
            <th style="width:4%"></th>
        </tr>
    </thead>
    <tbody id="stockTableBody"></tbody>
    <tfoot>
    <tr style="background:#e8f5e9;">
        <td style="display:flex; gap:5px;">
            <select id="newIngCat" style="width:40px; padding:0;" title="–ö–∞—Ç–µ–≥–æ—Ä–∏—è">
                <option value="food">üçé</option>
                <option value="pack">üì¶</option>
            </select>
            <input id="newIngName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" style="flex:1;">
        </td>
        <td>
            <select id="newIngUnit" onchange="toggleNewWeightInput()">
                <option value="–≥">–≥</option>
                <option value="—à—Ç">—à—Ç</option>
                <option value="–º–ª">–º–ª</option>
                <option value="—Å–º">—Å–º</option>
                <option value="–º">–º</option>
            </select>
        </td>
        <td><input type="number" id="newIngSingleWeight" placeholder="–í–µ—Å 1—à—Ç" disabled style="background:#eee;"></td>
        <td style="text-align:center;"><input type="checkbox" id="newIngUseWeight" title="–†–µ—Ü–µ–ø—Ç –≤ –≥—Ä–∞–º–º–∞—Ö"></td>
        
        <td class="col-kbju"><input type="number" id="newIngP" placeholder="–ë"></td>
        <td class="col-kbju"><input type="number" id="newIngF" placeholder="–ñ"></td>
        <td class="col-kbju"><input type="number" id="newIngC" placeholder="–£"></td>
        <td class="col-kbju"><input type="number" id="newIngK" placeholder="–ö–∫–∞–ª"></td>
        <td><input type="number" id="newIngPack" placeholder="–í –ø–∞—á–∫–µ"></td>
        <td><input type="number" id="newIngPrice" placeholder="–¶–µ–Ω–∞"></td>
        <td></td> 
        <td><button class="add-btn-small" onclick="addNewIngredient()">+</button></td>
    </tr>
</tfoot>
</table>
               <div style="margin-top:10px; font-size:12px; color:#888;">* <b>–í–µ—Å 1—à—Ç</b> —É–∫–∞–∑—ã–≤–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —à—Ç—É—á–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ (–Ø–π—Ü–∞ ~60–≥). –î–ª—è –≥—Ä–∞–º–º–æ–≤ —ç—Ç–æ –ø–æ–ª–µ –Ω–µ –Ω—É–∂–Ω–æ.</div>
           </div>
           <div id="laborStockBlock" style="display:none;">
               <table class="stock-table">
                <tbody id="laborTableBody"></tbody>
                  <tfoot>
                    <tr style="background:#e0f2f1;">
                        <td><input id="newLaborName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. –õ–µ–ø–∫–∞, –°–±–æ—Ä–∫–∞)"></td>
                        <td><input type="number" id="newLaborCoeff" placeholder="1.0" step="0.1" style="text-align:center; font-weight:bold;"></td>
                        <td><input type="number" id="newLaborTime" placeholder="0.5" step="0.1" style="text-align:center;"></td>
                        <td style="text-align:center;"><input type="checkbox" id="newLaborHelper" title="–ù–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è –ø–æ–º–æ—â–Ω–∏–∫—É"></td>
                        <td style="text-align:center;"><input type="checkbox" id="newLaborAuto" title="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å –≤ –Ω–æ–≤—ã–µ —Ç–æ—Ä—Ç—ã"></td>
                        <td style="text-align:center;"><button class="add-btn-small" onclick="addNewLabor()" style="background:#00695c;">+</button></td>
                    </tr>
                </tfoot>

                 
               </table>
               <div style="margin-top:10px; font-size:12px; color:#555;">* <b>–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç 1.0</b> = –û–±—ã—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞. <b>1.5</b> = –°–ª–æ–∂–Ω–∞—è (+50% –∫ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —á–∞—Å–∞).</div>
           </div>
        </div>
      </div>

      <div id="tab-recipes" class="tab-content" style="display:none;">
        <div class="card">
          <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
              <h2>üìñ –¢–µ—Ö–∫–∞—Ä—Ç—ã</h2>
              <button class="data-btn blue" onclick="openImportModal('recipes')">–ò–º–ø–æ—Ä—Ç Excel</button>
          </div>
          <div class="recipe-layout">
           <div class="recipe-list">
    <div class="recipe-search-box">
        <input type="text" id="recipeSearch" class="search-input" placeholder="üîç –ù–∞–π—Ç–∏ —Ä–µ—Ü–µ–ø—Ç..." oninput="renderRecipesList()">
        
        <div class="filter-chips">
            <button class="chip active" onclick="setRecFilter('all', this)">–í—Å–µ</button>
            <button class="chip" onclick="setRecFilter('filling', this)">–¢–æ—Ä—Ç—ã</button>
            <button class="chip" onclick="setRecFilter('coating', this)">–ö—Ä–µ–º—ã</button>
            <button class="chip" onclick="setRecFilter('decor', this)">–î–µ–∫–æ—Ä</button>
        </div>
    </div>

    <div id="recipesListContainer" style="overflow-y: auto; max-height: 600px;"></div>
    
    <button class="main-btn" onclick="createNewRecipe()" style="margin-top:10px; font-size:12px; background:#4CAF50;">+ –°–æ–∑–¥–∞—Ç—å</button>
</div>
            <div class="recipe-editor" id="recipeEditor" style="display:none;">
              <button class="tab-btn" onclick="closeRecipeMobile()" 
           style="display:none; width:100%; margin-bottom:15px; background:#f0f0f0; border:1px solid #ccc; color:#333;">
       ‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
   </button>
              <div style="display:flex; justify-content:space-between; align-items:center; background:#f5f5f5; padding:8px 12px; border-radius:8px; margin-bottom:15px; border:1px solid #ddd;">
    <div style="font-size:12px; font-weight:bold; color:#555;">
        <span id="recLockStatus">üîí –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</span>
    </div>
    <label class="switch" style="transform:scale(0.8);">
        <input type="checkbox" id="recLockToggle" onchange="toggleRecipeLock()">
        <span class="slider"></span>
    </label>
</div>
               <div class="form-row">
                 <div class="form-group" style="flex:2"><span class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</span><input id="editRecName" onchange="saveMeta()"></div>
                 <div class="form-group" style="flex:1">
                     <span class="form-label">–¢–∏–ø</span>
                     <select id="editRecType" onchange="saveMeta(); updateRecTypeUI()">
                          <option value="filling">–ù–∞—á–∏–Ω–∫–∞</option>
                          <option value="coating">–ü–æ–∫—Ä—ã—Ç–∏–µ (–ö—Ä–µ–º)</option>
                          <option value="extra">–ü–æ–∫—Ä—ã—Ç–∏–µ (–í–µ–ª—é—Ä/–ì–ª—è—Å—Å–∞–∂)</option> 
                          <option value="decor">–®—Ç—É—á–Ω—ã–π –¥–µ–∫–æ—Ä (–§–∏–≥—É—Ä–∫–∏)</option>
                      </select>
                 </div>
               </div>
               <div class="calibration-box">
  <div class="calibration-title">
      <span>üìè –≠—Ç–∞–ª–æ–Ω / –ü–∞—Ä—Ç–∏—è</span> 
      <span id="calibHint" style="font-weight:normal; text-transform:none; color:#333;"></span>
  </div>
  
  <div id="rowShape" class="form-row" style="margin-bottom:10px; border-bottom:1px dashed #e0e0e0; padding-bottom:10px;">
      <div class="form-group" style="flex:1;">
          <span class="form-label" style="color:#E65100;">–§–æ—Ä–º–∞ –≤—ã–ø–µ—á–∫–∏</span>
          <select id="calibShape" onchange="updateCalibUI(); saveMeta()" style="font-weight:bold; color:#E65100;">
    <option value="cylinder">–ö—Ä—É–≥ (–¶–∏–ª–∏–Ω–¥—Ä)</option>
    <option value="sphere">–®–∞—Ä (–ë–æ–º–±–∞)</option>
    <option value="square">–ö–≤–∞–¥—Ä–∞—Ç</option>
</select>
      </div>
      <div class="form-group" style="flex:2; display:flex; align-items:end;">
          <span style="font-size:11px; color:#666; margin-bottom:10px;">* –î–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –æ–±—ä–µ–º–æ–≤ (–¢–æ—Ä—Ç—ã)</span>
      </div>
  </div>

  <div class="form-row" style="margin-bottom:10px;">
      <div class="form-group">
          <span class="form-label" id="lblOutput">–í—ã—Ö–æ–¥ (–≥)</span>
          <input type="number" id="editRecOutput" style="font-weight:bold;" onchange="saveMeta()" placeholder="–í–µ—Å –ø–∞—Ä—Ç–∏–∏">
      </div>
      
      <div id="rowDims" style="display:contents;">
          <div class="form-group"><span class="form-label">D (—Å–º)</span><input type="number" id="calibDiam" onchange="saveMeta()"></div>
          <div class="form-group" id="grpCalibH"><span class="form-label">H (—Å–º)</span><input type="number" id="calibHeight" onchange="saveMeta()"></div>          <div class="form-group" style="flex:0.8;">
              <span class="form-label" title="–î–ª—è –±–æ–º–±">–ó–∞–ø–æ–ª–Ω.%</span>
              <input type="number" id="calibFill" placeholder="100" value="100" style="color:#E65100; font-weight:bold;" onchange="saveMeta()">
          </div>
      </div>
  </div>

  <div id="finishedWeightBlock" style="border-top:1px dashed #ccc; padding-top:10px; margin-top:5px;">
    
    <div style="display:flex; align-items:center; justify-content:flex-start; gap:10px; margin-bottom:8px;">
        <input type="checkbox" id="chkFinishedWeight" onchange="toggleFinishedWeight()" style="margin:0; width:auto; cursor:pointer;">
        
        <span onclick="document.getElementById('chkFinishedWeight').click()" 
              style="font-size:12px; font-weight:bold; color:#E65100; cursor:pointer; user-select:none;">
            –ü—Ä–∏–≤—è–∑–∞—Ç—å –∫ –≤–µ—Å—É –≥–æ—Ç–æ–≤–æ–≥–æ —Ç–æ—Ä—Ç–∞
        </span>
    </div>

    <div id="divFinWeight" style="display:none; align-items:center; justify-content:flex-start; gap:10px;">
        <input type="number" id="editTargetFinWeight" placeholder="2000" style="width:100px; font-weight:bold;" onchange="saveMeta()">
        <span style="font-size:11px; color:#666;">–≥ (—Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º)</span>
    </div>

</div>
  <div style="margin-top:8px; font-size:11px; color:#666;">–°—ã—Ä–æ–π –≤–µ—Å: <b id="recTotalWeightInfo">0</b> –≥. <span id="lossInfo"></span></div>

  <div style="margin-top:10px; padding-top:10px; border-top:1px dashed #ccc; display:flex; gap:10px; align-items:flex-end;">
      <div class="form-group" style="flex:1;">
          <span class="form-label" style="color:#1976D2;">+/- –í–µ—Å (–≥)</span>
          <input type="number" id="recAdjustWeight" placeholder="-100 –∏–ª–∏ 50" style="font-weight:bold; color:#1976D2;">
      </div>
      <button class="add-btn-small" onclick="applyRecipeAdjustment()" style="background:#1976D2; height:36px; padding:0 15px; flex:1.5;">‚ö° –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å</button>
  </div>

</div>
               <div id="blocksContainer"></div>
               <button class="main-btn" onclick="addBlock()" style="background:#2196F3; margin-top:10px;">+ –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</button>
               <div style="margin-top:20px; padding-top:15px; border-top:1px dashed #ccc;">
                   <button class="main-btn" onclick="exportRecipeToStock()" style="background:#FF9800; font-size:13px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ –°–∫–ª–∞–¥ (–∫–∞–∫ –¢–æ–≤–∞—Ä)</button>
                   <div style="font-size:10px; color:#666; margin-top:5px; text-align:center;">–ü–æ—Å—á–∏—Ç–∞–µ—Ç —Ü–µ–Ω—É –∏ —Å–æ–∑–¥–∞—Å—Ç —Ç–æ–≤–∞—Ä –Ω–∞ —Å–∫–ª–∞–¥–µ –¥–ª—è –±–ª–æ–∫–∞ "–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏"</div>
               </div>
               <div style="margin-top:20px; display:flex; gap:10px;">
                   <button class="main-btn" onclick="duplicateRecipe()" style="background:#7E57C2; flex:1;">üìë –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</button>
                   <button class="del-btn" onclick="deleteCurrentRecipe()" style="flex:1;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
               </div>
            </div>
            <div id="recipePlaceholder" class="recipe-editor" style="display:flex; justify-content:center; color:#aaa;">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ü–µ–ø—Ç</div>
          </div>
        </div>
      </div>

      

          <div id="tab-production" class="tab-content" style="display:none;">
        <div class="card">
           <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;">
              <h2 style="margin:0; border:none; padding:0;">üè≠ –ü–ª–∞–Ω (–û—á–µ—Ä–µ–¥—å)</h2>
              <div>
                 <button class="add-btn-small" onclick="openBookingModal()" style="background:#FF9800; margin-right:10px; padding:6px 12px; font-size:13px;">üìÖ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–∞—Ç—É</button>
                 <button class="del-btn" onclick="clearQueue()" style="font-size:12px; background:#ffebee; padding:5px 10px; border-radius:4px;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
              </div>
           </div>

           <div style="margin-bottom: 15px; position: relative;">
               <input type="text" id="orderSearchInput" 
                      placeholder="üîç –ò–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –Ω–∞—á–∏–Ω–∫–∞..." 
                      oninput="filterOrders()"
                      style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px;">
               
               <span id="searchClearBtn" onclick="clearSearch()" 
                     style="position: absolute; right: 10px; top: 12px; cursor: pointer; display: none; color: #999;">‚úñ</span>
           </div>
          
          
           <div id="queueContainer" style="margin-bottom:20px;">
               <div style="color:#999; text-align:center; padding:20px; border: 2px dashed #ddd; border-radius: 8px;">–í –ø–ª–∞–Ω–µ –ø—É—Å—Ç–æ.<br>–†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ —Ç–æ—Ä—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ "‚ûï –í –ø–ª–∞–Ω"</div>
           </div>
           <button class="main-btn" onclick="generateBatchReport()" style="background:#673AB7; margin-bottom:20px;">ü•£ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –°–≤–æ–¥–Ω—É—é –í–µ–¥–æ–º–æ—Å—Ç—å</button>
           <div id="batchResultBlock" style="display:none; background:#f3e5f5; padding:15px; border-radius:8px; border:1px solid #e1bee7;">
               <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #d1c4e9; padding-bottom:10px; margin-bottom:15px;">
    <h3 style="margin:0; color:#4a148c;">ü•£ –û–±—â–∏–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</h3>
    <button class="add-btn-small" id="btnToggleCookingMode" onclick="toggleCookingMode()" style="background:#673AB7; padding:8px 15px;">üë®‚Äçüç≥ –†–µ–∂–∏–º –≥–æ—Ç–æ–≤–∫–∏: –í–´–ö–õ</button>
</div>
               <div id="batchContent"></div>
           </div>
        </div>
      </div>
<div id="tab-colors" class="tab-content" style="display:none;">
    <div class="card">
        <h2>üé® –ü–æ–¥–±–æ—Ä —Ü–≤–µ—Ç–∞ (–ö–æ–ª–æ—Ä–∏—Å—Ç)</h2>
        <div style="font-size:12px; color:#666; margin-bottom:15px;">
            –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å, –æ—Ç–∫–∞–ª–∏–±—Ä—É–π—Ç–µ —Å–≤–µ—Ç –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç–∞. –ü—Ä–æ–≥—Ä–∞–º–º–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–µ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –∫—Ä–∞—Å–∏—Ç–µ–ª–µ–π.
        </div>

        <div class="form-row" style="margin-bottom: 20px;">
            <div class="form-group" style="flex: 1;">
                <label class="main-btn" style="
    background: linear-gradient(135deg, #FFCA28 0%, #F57C00 100%); /* üçä –ù–û–í–´–ô –û–†–ê–ù–ñ–ï–í–´–ô */
    padding: 12px 30px; 
    width: auto; 
    display: inline-flex; 
    align-items: center; 
    gap: 10px; 
    border-radius: 50px; 
    box-shadow: 0 4px 15px rgba(245, 124, 0, 0.35); /* –û—Ä–∞–Ω–∂–µ–≤–∞—è —Ç–µ–Ω—å */
    border: none;
    cursor: pointer;
    transition: transform 0.2s;
">
    <span style="font-size: 20px;">üìÇ</span> 
    <span style="font-weight: 700; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
        –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª
    </span>
    <input type="file" id="svgInput" accept="image/*" style="display:none;" onchange="handleSvgUpload(this)">
</label>
            </div>
            <div class="form-group" style="flex: 2; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="color-step-box" id="boxWhite" onclick="activatePicker('white')">
                    <div class="step-num">1. –°–≤–µ—Ç (–ú–æ–π)</div>
                    <div class="color-patch" id="patchWhite" style="background:#fff; border: 1px dashed #ccc;"></div>
                    <div class="step-desc">–°–≤–µ—Ç –≤ –ø–æ–º–µ—â–µ–Ω–∏–∏</div>
                </div>
                
                <div class="color-step-box" id="boxBase" onclick="activatePicker('base')">
                    <div class="step-num">2. –ë–∞–∑–∞</div>
                    <div class="color-patch" id="patchBase" style="background:#fffac1;"></div>
                    <div class="step-desc">–í–∞—à –∫—Ä–µ–º</div>
                </div>

                <div class="color-step-box" id="boxTargetWhite" onclick="activatePicker('targetWhite')">
                    <div class="step-num">3. –°–≤–µ—Ç (–§–æ—Ç–æ)</div>
                    <div class="color-patch" id="patchTargetWhite" style="background:#fff; border: 1px dashed #ccc;"></div>
                    <div class="step-desc">–ë–µ–ª—ã–π —Å –∫–∞—Ä—Ç–∏–Ω–∫–∏</div>
                </div>

                <div class="color-step-box" id="boxTarget" onclick="activatePicker('target')">
                    <div class="step-num">4. –¶–µ–ª—å</div>
                    <div class="color-patch" id="patchTarget" style="background:#ff4081;"></div>
                    <div class="step-desc">–ù—É–∂–Ω—ã–π —Ü–≤–µ—Ç</div>
                </div>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <button class="main-btn" onclick="calculateMix()" style="background:#E91E63; width: 100%; padding: 12px; font-size: 16px; box-shadow: 0 4px 15px rgba(233, 30, 99, 0.3);">üß™ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ñ–æ—Ä–º—É–ª—É</button>
        </div>

        <div style="position: relative; width: 100%; max-width: 600px; margin: 0 auto; border: 2px dashed #ddd; border-radius: 8px; overflow: hidden; background: #fafafa;">

        <div style="position: relative; width: 100%; max-width: 600px; margin: 0 auto; border: 2px dashed #ddd; border-radius: 8px; overflow: hidden; background: #fafafa;">
            <canvas id="colorCanvas" style="width: 100%; height: auto; display: block; cursor: crosshair;"></canvas>
            <div id="canvasPlaceholder" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:#999; text-align:center; pointer-events:none;">
                üì∑ –§–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
            </div>
            <div id="colorCursor" style="display:none; position:absolute; width:100px; height:100px; border:4px solid #fff; border-radius:50%; box-shadow:0 0 15px rgba(0,0,0,0.5); overflow:hidden; pointer-events:none; z-index: 100; background:#000;">
    <canvas id="loupeCanvas" width="100" height="100" style="width:100%; height:100%; display:block; image-rendering: pixelated; /* <- –í–∞–∂–Ω–æ –¥–ª—è —á–µ—Ç–∫–æ—Å—Ç–∏ –ø–∏–∫—Å–µ–ª–µ–π */"></canvas>
</div>
          <div style="margin-top: 20px; padding: 15px; background: #fff; border: 2px dashed #B0BEC5; border-radius: 8px;">
            <h3 style="margin-top:0; color: #455A64; font-size: 16px;">üé® –ú–æ—è –ø–∞–ª–∏—Ç—Ä–∞ –∫—Ä–∞—Å–∏—Ç–µ–ª–µ–π</h3>
            <div style="font-size: 12px; color: #666; margin-bottom: 10px;">–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –∫—Ä—ã—à–µ—á–∫–∏ –≤–∞—à–∏—Ö —Ç—é–±–∏–∫–æ–≤, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –∏ —Å–Ω–∏–º–∏—Ç–µ —Å –Ω–∏—Ö —Ä–µ–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç. –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–ø–æ–º–Ω–∏—Ç –∏—Ö –Ω–∞–≤—Å–µ–≥–¥–∞.</div>
            <button class="main-btn" onclick="activatePicker('palette')" style="background:#4CAF50; width: auto; padding: 8px 15px; font-size: 14px; margin-bottom: 15px;">
                ‚ûï –°–Ω—è—Ç—å —Ü–≤–µ—Ç –¥–ª—è –ø–∞–ª–∏—Ç—Ä—ã
            </button>
            <div id="myPaletteList" style="display: flex; flex-wrap: wrap; gap: 10px;">
                </div>
        </div>
        </div>

      

        <div id="colorResultBlock" style="display:none; margin-top: 20px; padding: 15px; background: #FCE4EC; border-radius: 8px; border: 1px solid #F8BBD0;">
            <h3 style="margin-top:0; color:#C2185B; text-align:center;">–†–µ—Ü–µ–ø—Ç —Å–º–µ—à–∏–≤–∞–Ω–∏—è</h3>
            <div id="colorResultText"></div>
        </div>
    </div>
</div>
      <div id="importModal" class="modal-overlay">
         <div class="modal-box">
           <h3 id="importTitle">üì• –ò–º–ø–æ—Ä—Ç</h3>
           <p id="importDesc" style="font-size:14px; color:#666;"></p>
           <textarea id="importText" rows="10" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ..."></textarea>
           <div class="modal-actions">
              <button class="tab-btn" onclick="closeImportModal()">–û—Ç–º–µ–Ω–∞</button>
              <button class="main-btn" onclick="processImport()" style="width:auto;">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å</button>
           </div>
         </div>
      </div>
      
     
    </div>

 
    <div id="printModal" class="modal-overlay">
      <div class="modal-box" style="width: 400px; text-align:center;">
        <h3>üñ®Ô∏è –ü–µ—á–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h3>
        <p style="color:#666; margin-bottom:20px;">–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:</p>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button class="main-btn" onclick="openClientCheckBuilder()" style="background:#4CAF50; display:flex; justify-content:center; align-items:center; gap:10px;">
    üßæ <span><b>–ß–µ–∫ –¥–ª—è –ö–ª–∏–µ–Ω—Ç–∞</b><br><small style="font-weight:normal; opacity:0.8">–° —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π —Ü–µ–Ω</small></span>
</button>
            <button class="main-btn" onclick="printDoc('manager')" style="background:#607D8B; display:flex; justify-content:center; align-items:center; gap:10px;">
                üìä <span><b>–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ç—á–µ—Ç + –§–∏–Ω–∞–Ω—Å—ã</b><br><small style="font-weight:normal; opacity:0.8">–ü–æ–ª–Ω–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</small></span>
            </button>
            <button class="main-btn" onclick="printSticker()" style="background:#FF9800; display:flex; justify-content:center; align-items:center; gap:10px;">
    üè∑Ô∏è <span><b>–≠—Ç–∏–∫–µ—Ç–∫–∞ 50—Ö50</b><br><small style="font-weight:normal; opacity:0.8">–î–ª—è —É–ø–∞–∫–æ–≤–∫–∏ (–ù–∞–∑–≤–∞–Ω–∏–µ, –í–µ—Å, –î–∞—Ç–∞)</small></span>
</button>
        </div>
        <div class="modal-actions" style="justify-content:center; margin-top:20px;">
           <button class="tab-btn" onclick="closePrintModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    </div>
    <div id="checkBuilderModal" class="modal-overlay">
  <div class="modal-box" style="width: 500px;">
    <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ß–µ–∫–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞</h3>
    
    <div style="background:#fff3e0; padding:10px; font-size:12px; border-radius:4px; margin-bottom:15px; color:#E65100;">
       üí° –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Å—É–º–º—É —Ç–∞–∫, –∫–∞–∫ —ç—Ç–æ –±—É–¥–µ—Ç –ø–æ–Ω—è—Ç–Ω–æ –∫–ª–∏–µ–Ω—Ç—É. –û–±—â–∏–π –∏—Ç–æ–≥ –¥–æ–ª–∂–µ–Ω —Å–æ–π—Ç–∏—Å—å.
    </div>

    <div id="checkBuilderBody" style="max-height: 400px; overflow-y:auto;">
        </div>

    <div style="margin-top:15px; background:#f9f9f9; padding:10px; border-radius:6px; display:flex; justify-content:space-between; align-items:center; font-weight:bold;">
        <span>–ò—Ç–æ–≥–æ –≤ —á–µ–∫–µ:</span>
        <span id="checkBuilderTotal" style="font-size:18px;">0</span>
    </div>
     <div style="text-align:right; font-size:11px; color:#999; margin-top:5px;">
        (–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞: <span id="checkTargetTotal">0</span>)
    </div>

    <div class="modal-actions" style="margin-top:20px;">
       <button class="tab-btn" onclick="document.getElementById('checkBuilderModal').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
       <button class="main-btn" onclick="printCustomClientCheck()" style="background:#4CAF50;">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
    </div>
  </div>
</div>
<div id="settingsModal" class="modal-overlay">
    <div class="modal-box" style="width: 600px; max-width: 95%; max-height: 90vh; overflow-y: auto; display: block;">
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <h2 style="margin:0; border:none; padding:0;">‚öôÔ∏è –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <button class="del-btn" onclick="document.getElementById('settingsModal').style.display='none'" style="font-size:24px;">√ó</button>
        </div>

        <div style="background:#e0f2f1; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #80cbc4;">
            <h4 style="margin-top:0; color:#00695c;">üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã</h4>
            <div class="form-row">
                <div class="form-group">
                    <span class="form-label">–°—Ç–∞–≤–∫–∞ –≤ —á–∞—Å (–ë–∞–∑–∞)</span>
                    <input type="number" id="hourlyRate" placeholder="0" style="font-weight:bold; font-size:16px;" onchange="saveHourlyRate()">
                </div>
                <div class="form-group" style="display:flex; align-items:end;">
                    <span style="font-size:12px; color:#555;">–î–ª—è —Ä–∞—Å—á–µ—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ –∫–æ–Ω–¥–∏—Ç–µ—Ä–∞.</span>
                </div>
            </div>
        </div>

        <div style="background:#fff3e0; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #ffe0b2;">
            <h4 style="margin-top:0; color:#e65100;">üìä –ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã (%)</h4>
            <div class="form-row">
                <div class="form-group"><span class="form-label">–ù–∞–ª–æ–≥</span><input type="number" id="finTax" onchange="saveFinance()"></div>
                <div class="form-group"><span class="form-label">–ë–∞–Ω–∫ (–≠–∫–≤–∞–π—Ä–∏–Ω–≥)</span><input type="number" id="finBank" onchange="saveFinance()"></div>
                <div class="form-group"><span class="form-label">–ê–º–æ—Ä—Ç./–°–≤–µ—Ç</span><input type="number" id="finOverhead" onchange="saveFinance()"></div>
            </div>
        </div>

        <div style="background:#f3e5f5; padding:15px; border-radius:8px; border:1px solid #e1bee7; margin-bottom:15px;">
            <h4 style="margin-top:0; color:#6a1b9a;">üßæ –£–º–Ω—ã–π –ß–µ–∫ (–°–ª–æ–≤–∞—Ä—å)</h4>
            <div class="form-group" style="margin-bottom:10px;">
                <span class="form-label" style="color:#2E7D32;">–í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ:</span>
                <input type="text" id="finForceShow" onchange="saveFinance()" placeholder="—è—Ä—É—Å, —Ñ–∏–≥—É—Ä, –¥–æ—Å—Ç–∞–≤–∫–∞..." style="border:1px solid #4CAF50;">
            </div>
            <div class="form-group">
                <span class="form-label" style="color:#E65100;">–ü—Ä—è—Ç–∞—Ç—å –≤ —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ—Ä—Ç–∞:</span>
                <input type="text" id="finForceHide" onchange="saveFinance()" placeholder="–∑–∞–º–µ—Å, –≤—ã–ø–µ—á–∫–∞, —Å–±–æ—Ä–∫–∞..." style="border:1px solid #FF9800;">
            </div>
        </div>

        <div style="background:#fff8e1; padding:15px; border-radius:8px; border:1px solid #ffe0b2; margin-bottom:15px;">
            <h4 style="margin-top:0; color:#F57C00;">üìù –°–ø–∏—Å–∫–∏ –≤—ã–±–æ—Ä–∞</h4>
            <div class="form-group" style="margin-bottom:10px;">
                <span class="form-label">–ë–∞–Ω–∫–∏:</span>
                <input type="text" id="settingBanks" onchange="saveListSettings()">
            </div>
            <div class="form-group">
                <span class="form-label">–ò—Å—Ç–æ—á–Ω–∏–∫–∏:</span>
                <input type="text" id="settingSources" onchange="saveListSettings()">
            </div>
        </div>

        <div style="background:#fff3e0; padding:15px; border-radius:8px; border:1px solid #ffe0b2; margin-bottom:15px;">
            <h4 style="margin-top:0; color:#E65100;">üèÜ –°—Ç–∞—Ç—É—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ (LTV)</h4>
            <div style="font-size:11px; color:#666; margin-bottom:10px;">
                –£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É –ø–æ–∫—É–ø–æ–∫, –æ—Ç –∫–æ—Ç–æ—Ä–æ–π –≤—ã–¥–∞–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å. –ü—Ä–æ–≥—Ä–∞–º–º–∞ –≤—ã–±–µ—Ä–µ—Ç —Å–∞–º—ã–π –≤—ã—Å–æ–∫–∏–π –ø–æ–¥—Ö–æ–¥—è—â–∏–π.
            </div>
            
            <div id="statusSettingsContainer"></div>
            
            <button class="add-btn-small" onclick="addStatusSettingRow()" style="background:#fb8c00; width:100%; margin-top:10px;">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
        </div>

        <div style="background:#ECEFF1; padding:15px; border-radius:8px; border:1px solid #CFD8DC; margin-bottom:15px;">
            <h4 style="margin-top:0; color:#455A64;">üõ†Ô∏è –°–µ—Ä–≤–∏—Å –∏ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</h4>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button class="tab-btn" onclick="recalcAllClientsGlobal()" style="width:100%; background:#fff; border:1px solid #90CAF9; color:#1565C0; text-align:left; padding:10px; display:flex; align-items:center;">
                    <span style="font-size:18px; margin-right:10px;">üîÑ</span> 
                    <div><b>–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Å—É–º–º—ã</b><br><small style="color:#666;">–ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –æ—à–∏–±–∫–∏ –≤ —Å—É–º–º–∞—Ö</small></div>
                </button>
                <button class="del-btn" onclick="forcePushClientsToCloud()" style="width:100%; background:#FFEBEE; border:1px solid #FFCDD2; color:#D32F2F; text-align:left; padding:10px; display:flex; align-items:center;">
                    <span style="font-size:18px; margin-right:10px;">‚ö†Ô∏è</span> 
                    <div><b>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ –û–±–ª–∞–∫–æ</b><br><small style="color:#D32F2F;">–ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –±–∞–∑—É –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞</small></div>
                  <button class="main-btn" onclick="forceLoadFromCloud()" style="width:100%; background:#7E57C2; margin-bottom:10px; display:flex; align-items:center;">
    <span style="font-size:18px; margin-right:10px;">üì•</span> 
    <div><b>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –û–±–ª–∞–∫–∞</b><br><small>–ó–∞–º–µ–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –¢–∞–±–ª–∏—Ü—ã</small></div>
</button>
                    <button class="main-btn" onclick="syncAllToCloud()" style="width:100%; background:#4CAF50; margin-top:10px; display:flex; align-items:center;">
    <span style="font-size:18px; margin-right:10px;">‚òÅÔ∏è</span> 
    <div><b>–í—ã–≥—Ä—É–∑–∏—Ç—å –≤—Å—ë –≤ –û–±–ª–∞–∫–æ</b><br><small>–ù–∞–∂–º–∏—Ç–µ 1 —Ä–∞–∑, —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</small></div>
</button>
                </button>
            </div>
        </div>

        <div class="modal-actions" style="margin-top:20px;">
            <button class="main-btn" onclick="saveStatusSettings(); document.getElementById('settingsModal').style.display='none'; renderClientsCloud();">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
    </div>
</div>
<div id="stickerBuilderModal" class="modal-overlay">
  <div class="modal-box" style="width: 95%; max-width: 1200px; height: 90vh; display: flex; flex-direction: column;">
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
       <h3 style="margin:0;">üõ†Ô∏è –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —ç—Ç–∏–∫–µ—Ç–∫–∏</h3>
       <button class="del-btn" onclick="document.getElementById('stickerBuilderModal').style.display='none'" style="font-size:24px;">√ó</button>
    </div>
    
    <div style="display:flex; gap:25px; flex:1; overflow:hidden;">
      <div style="flex: 1; overflow-y: auto; padding-right: 15px; border-right: 1px solid #eee;">
        
        <div class="form-group" style="margin-bottom:15px;">
            <span class="form-label">üìè –†–∞–∑–º–µ—Ä –ª–µ–Ω—Ç—ã (–º–º)</span>
            <select id="stbSizeSelector" onchange="updateStickerPreview()">
                <option value="50x30">50 x 30 (–ú–∏–Ω–∏)</option>
                <option value="50x50">50 x 50 (–ö–≤–∞–¥—Ä–∞—Ç)</option>
                <option value="50x70">50 x 70</option>
                <option value="50x80">50 x 80</option>
                <option value="50x90">50 x 90</option>
            </select>
        </div>

        <div class="form-group" style="margin-bottom:15px;">
            <span class="form-label">üìù –†–µ–∂–∏–º —Å–æ—Å—Ç–∞–≤–∞</span>
            <select id="stbCompositionMode" onchange="updateStickerPreview()">
                <option value="layersOnly">–¢–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏—è —Å–ª–æ–µ–≤ (–°–Ω–∏–∫–µ—Ä—Å, –ì–∞–Ω–∞—à...)</option>
                <option value="ingredientsOnly">–û–±—â–∏–π —Å–æ—Å—Ç–∞–≤ –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º (–ú—É–∫–∞, —Å–∞—Ö–∞—Ä...)</option>
                <option value="full">–°–ª–æ–∏ + –∏—Ö —Å–æ—Å—Ç–∞–≤ (–±–µ–∑ –≥—Ä–∞–º–º–æ–≤)</option>
            </select>
        </div>

        <div style="display:flex; gap:20px; margin-bottom:15px; background:#f9f9f9; padding:10px; border-radius:6px;">
            <label style="cursor:pointer; font-size:12px; font-weight:bold;">
                <input type="checkbox" id="stbShowKBJU" checked onchange="updateStickerPreview()"> –ü–µ—á–∞—Ç–∞—Ç—å –ö–ë–ñ–£
            </label>
        </div>

        <div class="form-group" style="margin-bottom:10px;">
            <span class="form-label">–ë—Ä–µ–Ω–¥</span>
            <input type="text" id="stbBrandName" value="VKUS.NASTI" oninput="updateStickerPreview()">
        </div>

        <div class="form-group" style="margin-bottom:10px;">
            <span class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—Ä—Ç–∞</span>
            <input type="text" id="stbCakeName" oninput="updateStickerPreview()" style="font-weight:bold;">
        </div>

        <div class="form-group" style="margin-bottom:10px;">
            <span class="form-label">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –≤–µ—Å (–∫–≥)</span>
            <input type="number" id="stbWeight" step="0.01" oninput="updateStickerPreview()" style="font-size:18px; font-weight:bold; color:#FF5722;">
        </div>

        <div class="form-group" style="margin-top:10px;">
            <span class="form-label">–î–∞—Ç–∞ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è</span>
            <input type="date" id="stbCustomDate" onchange="updateStickerPreview()" style="font-family: inherit;">
        </div>

        <input type="hidden" id="stbP"><input type="hidden" id="stbF"><input type="hidden" id="stbC"><input type="hidden" id="stbK">
        <input type="hidden" id="stbDate">
      </div>

      <div style="flex: 1.5; background: #555; display: flex; align-items: center; justify-content: center; border-radius: 8px; position: relative;">
          <div style="position: absolute; top: 10px; left: 10px; color: #fff; font-size: 11px;">–ú–∞—Å—à—Ç–∞–± –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ ~1:1</div>
          
          <div id="stickerPreviewBox" style="background:#fff; border:1px solid #000; box-sizing:border-box; padding:4mm; display:flex; flex-direction:column; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
             </div>
      </div>
    </div>

    <div class="modal-actions" style="margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
       <button class="tab-btn" onclick="document.getElementById('stickerBuilderModal').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
       <button class="main-btn" onclick="finalizeStickerPrint()" style="background:#FF9800; width:auto; padding: 12px 50px; font-size:16px;">üñ®Ô∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ü–µ—á–∞—Ç–∞—Ç—å</button>
    </div>
  </div>
</div>

<div id="bookingModal" class="modal-overlay">
    <div class="modal-box" style="width: 400px;">
        <h3 style="color:#E65100;">‚è≥ –ë—Ä–æ–Ω—å –¥–∞—Ç—ã (–ë–æ–ª–≤–∞–Ω–∫–∞)</h3>
        
        <div class="form-group" style="margin-bottom:15px;">
            <span class="form-label">–ö–ª–∏–µ–Ω—Ç</span>
            <input type="text" id="bookingClientSearch" list="orderClientsDatalist" placeholder="–ü–æ–∏—Å–∫..." onchange="handleBookingClientSelection()">
            <input type="hidden" id="bookingClientId">
        </div>

        <div class="form-group" style="margin-bottom:15px;">
            <span class="form-label">üìÖ –î–∞—Ç–∞</span>
            <input type="date" id="bookingDate">
        </div>

        <div class="form-group" style="margin-bottom:15px;">
            <span class="form-label">üí∞ –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)</span>
            <input type="number" id="bookingPrepayment" placeholder="0">
        </div>

        <div class="form-group">
            <span class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</span>
            <textarea id="bookingComment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–≤–∞–¥–µ–±–Ω—ã–π, –Ω–∞—á–∏–Ω–∫—É —Å–∫–∞–∂—É—Ç –ø–æ–∑–∂–µ..."></textarea>
        </div>

        <div class="modal-actions">
            <button class="tab-btn" onclick="document.getElementById('bookingModal').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
            <button class="main-btn" onclick="saveBooking()" style="background:#FF9800;">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
    </div>
</div>

<div class="fab-container">
    <button class="fab-btn" onclick="toggleNotifPanel()">
        üîî
        <div id="notifBadge" class="fab-badge">0</div>
    </button>
    
    <div id="notifPanel" class="notif-panel">
        <div class="notif-header">
            <span>üìÖ –í–∞–∂–Ω–æ–µ –Ω–∞ –Ω–µ–¥–µ–ª—é</span>
<span style="font-size:11px; color:#1976D2; cursor:pointer;" onclick="checkCRMEvents(false)">üîÑ</span>        </div>
        <div id="notifList" class="notif-body">
            </div>
    </div>
</div>

<div id="analyticsModal" class="modal-overlay">
    <div class="modal-box" style="width: 500px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0;">üìä –û—Ç–∫—É–¥–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç –∫–ª–∏–µ–Ω—Ç—ã?</h3>
            <button class="del-btn" onclick="document.getElementById('analyticsModal').style.display='none'" style="font-size:24px;">√ó</button>
        </div>

        <div style="background:#f9f9f9; padding:15px; border-radius:8px; border:1px solid #eee;">
            <span class="form-label">–ü–µ—Ä–∏–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–ù–æ–≤—ã–µ):</span>
            <div style="display:flex; gap:10px; margin-top:5px;">
                <input type="date" id="reportStart">
                <input type="date" id="reportEnd">
                <button class="main-btn" onclick="generateSourceReport()" style="width:auto; padding:5px 15px; font-size:13px;">–ü–æ–∫–∞–∑–∞—Ç—å</button>
            </div>
        </div>

        <div id="analyticsResults" style="margin-top:20px; max-height:400px; overflow-y:auto;">
            <div style="text-align:center; color:#999; padding:20px;">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–∫–∞–∑–∞—Ç—å"</div>
        </div>
    </div>
</div>


<div id="recipeContextMenu" class="context-menu">
    <div class="context-menu-item" onclick="handleContextAction('duplicate')">üìë –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</div>
    <div class="context-menu-item danger" onclick="handleContextAction('delete')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</div>
</div>

<div id="tab-shapes" class="tab-content" style="display:none;">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2>üî¢ 3D-–§–∏–≥—É—Ä—ã (–†–∞—Å—á–µ—Ç –ø–æ —Ñ–æ—Ç–æ)</h2>
        </div>

        <div class="form-row" style="background:#fff3e0; padding:15px; border-radius:8px; border:1px solid #ffe0b2; align-items:center;">
            <div style="flex:1;">
                <label class="main-btn" style="background:#FF9800; width:auto; display:inline-flex; gap:10px; padding:10px 20px;">
                    <span>üì∏</span> –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç—Ä–∞—Ñ–∞—Ä–µ—Ç
                    <input type="file" id="shapeImgInput" accept="image/*" style="display:none;" onchange="analyzeShapeImage(this)">
                </label>
            </div>
            <div style="flex:2; font-size:12px; color:#E65100; line-height:1.4;">
                <b>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</b><br>
                1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —á–µ—Ä–Ω–æ-–±–µ–ª—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É (—Ç—Ä–∞—Ñ–∞—Ä–µ—Ç).<br>
                2. –ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø–æ—Å—á–∏—Ç–∞–µ—Ç –ø–ª–æ—â–∞–¥—å –∏ –ø–µ—Ä–∏–º–µ—Ç—Ä.<br>
                3. –ú—ã —Ä–∞—Å—Å—á–∏—Ç–∞–µ–º –±–∏—Å–∫–≤–∏—Ç –Ω–∞ <b>–≤–µ—Å—å –ø—Ä–æ—Ç–∏–≤–µ–Ω—å</b>, –∞ –Ω–∞—á–∏–Ω–∫—É ‚Äî —Ç–æ–ª—å–∫–æ <b>–≤–Ω—É—Ç—Ä—å —Ñ–∏–≥—É—Ä—ã</b>.
            </div>
        </div>

        <div id="shapeAnalysisBlock" style="display:none; margin-top:20px;">
            <div style="display:flex; gap:20px; margin-bottom:20px;">
                <div style="width:150px; height:150px; background:#eee; border:1px solid #ccc; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                    <canvas id="shapeAnalysisCanvas" style="max-width:100%; max-height:100%;"></canvas>
                </div>
                
                <div style="flex:1;">
                    <div style="font-size:13px; color:#555; margin-bottom:5px;">–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞:</div>
                    <div class="info-row"><span>–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã:</span> <b id="lblFillRate">0%</b></div>
                    <div class="info-row"><span>–°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–∏–º–µ—Ç—Ä–∞:</span> <b id="lblPerimFactor">0</b></div>
                    <div class="info-row"><span>–ü—Ä–æ–ø–æ—Ä—Ü–∏–∏ (W/H):</span> <b id="lblAspectRatio">0</b></div>
                </div>
            </div>

            <hr style="border:0; border-top:1px dashed #ccc; margin-bottom:20px;">

<div class="visual-container" style="height: 320px; background: radial-gradient(circle, #fff 20%, #f0f2f5 100%); border: 1px solid #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; perspective: 1200px; overflow: hidden; margin-bottom: 20px; position: relative;">
    
    <div id="dimLabelW" style="position: absolute; color: #1565C0; font-weight: bold; font-size: 12px; pointer-events: none;"></div>
    <div id="dimLabelL" style="position: absolute; color: #1565C0; font-weight: bold; font-size: 12px; pointer-events: none;"></div>
    
    <div id="shapeStage" style="position: relative; transform-style: preserve-3d; transform: rotateX(60deg) rotateZ(-30deg); transition: transform 0.5s;">
        
        <div id="shapeGhostBox" style="position: absolute; border: 2px dashed rgba(33, 150, 243, 0.5); transform-style: preserve-3d; pointer-events: none;">
            <div style="position:absolute; top:-1px; left:-1px; width:10px; height:10px; border-top:2px solid #1565C0; border-left:2px solid #1565C0;"></div>
            <div style="position:absolute; bottom:-1px; right:-1px; width:10px; height:10px; border-bottom:2px solid #1565C0; border-right:2px solid #1565C0;"></div>
        </div>

        <div id="shape3DStack" style="position: absolute; top: 0; left: 0; transform-style: preserve-3d; pointer-events: none;"></div>
        
    </div>
    
    <div style="position: absolute; bottom: 10px; right: 10px; font-size: 10px; color: #999;">
        üü¶ –†–∞–º–∫–∞ = –ë–∏—Å–∫–≤–∏—Ç | üç∞ –§–∏–≥—É—Ä–∞ = –ù–∞—á–∏–Ω–∫–∞
    </div>
</div>
          
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                <div class="form-group">
                    <span class="form-label">‚öñÔ∏è –¶–µ–ª–µ–≤–æ–π –í–µ—Å (–∫–≥)</span>
                    <input type="number" id="shapeTargetWeight" value="2.0" step="0.1" style="font-size:18px; font-weight:bold; color:#2E7D32;">
                </div>
                <div class="form-group">
                    <span class="form-label">üìè –ñ–µ–ª–∞–µ–º–∞—è –í—ã—Å–æ—Ç–∞ (—Å–º)</span>
                    <input type="number" id="shapeTargetHeight" value="10" style="font-size:18px; font-weight:bold;">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group" style="flex:1;">
                    <span class="form-label">üç∞ –†–µ—Ü–µ–ø—Ç (–ù–∞—á–∏–Ω–∫–∞ + –ë–∏—Å–∫–≤–∏—Ç)</span>
                    <select id="shapeRecipeSelectMain" style="font-weight:bold;"></select>
                </div>
            </div>

            <div class="form-row" style="background:#f5f5f5; padding:10px; border-radius:6px; margin-top:10px;">
                <div class="form-group" style="flex:2;">
                    <span class="form-label">üé® –ü–æ–∫—Ä—ã—Ç–∏–µ (–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ)</span>
                    <select id="shapeCoatingSelect"></select>
                </div>
                <div class="form-group" style="flex:1;">
                    <span class="form-label">–¢–æ–ª—â–∏–Ω–∞ (–º–º)</span>
                    <input type="number" id="shapeCoatingThick" value="3" placeholder="–º–º">
                </div>
            </div>

            <button class="main-btn" onclick="calculateShapeOrder()" style="margin-top:20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">üöÄ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –≥–µ–æ–º–µ—Ç—Ä–∏—é</button>
        </div>

        <div id="shapeResultBlock" style="display:none; margin-top:25px; animation:fadeIn 0.5s;">
            <div class="card" style="background:#E8F5E9; border:2px solid #4CAF50;">
                <h3 style="margin-top:0; text-align:center; color:#2E7D32;">‚úÖ –†–∞—Å—á–µ—Ç –≥–æ—Ç–æ–≤</h3>
                
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:14px;">
                    <span>–ò—Ç–æ–≥–æ–≤—ã–µ –≥–∞–±–∞—Ä–∏—Ç—ã:</span>
                    <b style="font-size:16px;" id="resShapeDims">0 x 0 —Å–º</b>
                </div>
                <div style="font-size:11px; color:#666; text-align:right; margin-bottom:15px;">
                    (–†–∞–º–∫–∞ –¥–ª—è –≤—ã–ø–µ—á–∫–∏)
                </div>

                <div class="info-row" style="border-top:1px dashed #a5d6a7; padding-top:5px;">
                    <span>ü•û –ë–∏—Å–∫–≤–∏—Ç (–ì—Ä—è–∑–Ω—ã–π –≤–µ—Å):</span> 
                    <b id="resSpongeWeight">0 –≥</b>
                </div>
                <div class="info-row">
                    <span>ü•£ –ù–∞—á–∏–Ω–∫–∞ (–ß–∏—Å—Ç—ã–π –≤–µ—Å):</span> 
                    <b id="resFillingWeight">0 –≥</b>
                </div>
                <div class="info-row">
                    <span>üé® –ü–æ–∫—Ä—ã—Ç–∏–µ (–í–µ—Å):</span> 
                    <b id="resCoatingWeight">0 –≥</b>
                </div>
                
                <div style="margin-top:15px; background:#fff; padding:10px; border-radius:4px; font-size:12px; color:#d32f2f;">
                    ‚úÇÔ∏è <b>–û—Ç—Ö–æ–¥—ã (–û–±—Ä–µ–∑–∫–∏):</b> <span id="resWasteWeight">0</span> –≥ <br>
                    <i>* –£—á—Ç–µ–Ω–æ –≤ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏, –Ω–æ –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ –≤–µ—Å —Ç–æ—Ä—Ç–∞.</i>
                </div>

                <div style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-size:20px; font-weight:900;" id="resFinalPrice">0 ‚Ç∏</div>
                    <button class="main-btn" onclick="addShapeToQueue()" style="width:auto; padding:8px 20px; background:#FF9800;">‚ûï –í –ü–ª–∞–Ω</button>
                </div>
            </div>
        </div>
    </div>
</div>
     

      <div id="finishOrderModal" class="modal-overlay">
    <div class="modal-box" style="width: 400px; text-align:center;">
        <h3>üèÅ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h3>
        <p style="color:#666; font-size:13px; margin-bottom:20px;">
            –ó–∞–≥—Ä—É–∑–∏—Ç–µ <b>—Ñ–æ—Ç–æ –≥–æ—Ç–æ–≤–æ–≥–æ —Ç–æ—Ä—Ç–∞</b> –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏.<br>
            (–°—Ç–∞—Ä–æ–µ —Ñ–æ—Ç–æ-—Ä–µ—Ñ–µ—Ä–µ–Ω—Å –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ)
        </p>

        <div style="background: #f1f8e9; padding: 15px; border-radius: 8px; border: 1px dashed #81c784; margin-bottom: 20px;">
            <input type="file" id="finishPhotoInput" accept="image/*" style="display:none;" onchange="previewFinishPhoto(this)">
            
            <div id="finishPhotoPlaceholder" onclick="document.getElementById('finishPhotoInput').click()" 
                 style="cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:5px;">
                <span style="font-size:30px;">üì∏</span>
                <span style="font-size:12px; font-weight:bold; color:#2E7D32;">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</span>
            </div>
            
            <img id="finishPhotoPreview" style="display:none; width:100%; max-height:200px; object-fit:contain; border-radius:4px; margin-top:5px;">
            <button id="btnDelFinishPhoto" onclick="clearFinishPhoto()" style="display:none; background:none; border:none; color:#d32f2f; margin-top:5px; cursor:pointer; font-size:11px; text-decoration:underline;">–£–¥–∞–ª–∏—Ç—å</button>
        </div>

        <input type="hidden" id="finishOrderId">
        
        <div class="modal-actions" style="justify-content: center; flex-direction: column; gap: 10px;">
            <button class="main-btn" onclick="confirmFinishOrder()" style="background:#4CAF50;">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ê—Ä—Ö–∏–≤</button>
            <button class="tab-btn" onclick="document.getElementById('finishOrderModal').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

      <div id="undoToast" style="display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#333; color:white; padding:12px 20px; border-radius:30px; z-index:10000; align-items:center; gap:15px; box-shadow:0 4px 15px rgba(0,0,0,0.3);">
    <span id="undoToastText">–ó–∞–∫–∞–∑ —É–¥–∞–ª–µ–Ω</span>
    <button onclick="executeUndoAction()" style="background:#FF9800; border:none; color:white; padding:5px 12px; border-radius:15px; cursor:pointer; font-weight:bold;">–û–¢–ú–ï–ù–ò–¢–¨</button>
</div>
   <script>
      // --- 1. GLOBAL VARIABLES & STATE ---
      const DEFAULT_INGS=[{id:"i1",name:"–Ø–π—Ü–æ –°0",unit:"—à—Ç",packWeight:10,packPrice:600},{id:"i2",name:"–°–∞—Ö–∞—Ä",unit:"–≥",packWeight:1000,packPrice:800},{id:"i3",name:"–ú—É–∫–∞",unit:"–≥",packWeight:2000,packPrice:900},{id:"i4",name:"–°–ª–∏–≤–∫–∏ 33%",unit:"–≥",packWeight:1000,packPrice:2600},{id:"i5",name:"–¢–≤–æ—Ä–æ–∂–Ω—ã–π —Å—ã—Ä",unit:"–≥",packWeight:2200,packPrice:5500},{id:"i6",name:"–®–æ–∫–æ–ª–∞–¥ —Ç–µ–º–Ω—ã–π",unit:"–≥",packWeight:1000,packPrice:6000}];
      const DEFAULT_RECS=[{id:"r1",name:"–°–Ω–∏–∫–µ—Ä—Å",type:"filling",calibrationD:16,calibrationH:15,outputWeight:1410,blocks:[{name:"–û—Å–Ω–æ–≤–∞",ingredients:[{id:"i1",weight:300},{id:"i2",weight:200},{id:"i3",weight:200},{id:"i4",weight:400}]}]},{id:"r2",name:"–ì–∞–Ω–∞—à",type:"coating",calibrationD:16,calibrationH:15,outputWeight:490,blocks:[{name:"–°–æ—Å—Ç–∞–≤",ingredients:[{id:"i6",weight:250},{id:"i4",weight:250}]}]}];
      const SYMBOLS = {'RUB':'‚ÇΩ','KZT':'‚Ç∏','USD':'$'};
      
      let isInventoryMode = false; // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤
      let procurementDraft = []; // –ß–µ—Ä–Ω–æ–≤–∏–∫ –Ω–∞–∫–ª–∞–¥–Ω–æ–π


      let myIngredients = JSON.parse(localStorage.getItem('myCakeIngredients')) || DEFAULT_INGS;
      let myRecipes = JSON.parse(localStorage.getItem('myCakeRecipes')) || DEFAULT_RECS;
      let archiveOrders = []; // –õ–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à –∞—Ä—Ö–∏–≤–∞
      
      const DEFAULT_LABOR = [
          {id:"l1", name:"–í—ã–ø–µ—á–∫–∞ –∏ –∑–∞–º–µ—Å", coeff: 1.0},
          {id:"l2", name:"–°–±–æ—Ä–∫–∞ –∏ —á–µ—Ä–Ω–æ–≤–∞—è", coeff: 1.1},
          {id:"l3", name:"–§–∏–Ω–∏—à–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ", coeff: 1.2},
          {id:"l4", name:"–°–ª–æ–∂–Ω—ã–π –¥–µ–∫–æ—Ä (–õ–µ–ø–∫–∞)", coeff: 1.5},
          {id:"l5", name:"–¢–µ–º–ø–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ", coeff: 1.3}
      ];
      let myLaborServices = JSON.parse(localStorage.getItem('myCakeLabor')) || DEFAULT_LABOR;
      let currentCurrency = localStorage.getItem('cakeCurrency') || 'KZT';
      
      let activeRecId = null;
      let impMode = 'ingredients';
      let extrasList = []; 
      let currentPrintSide = 'Left';
      let productionQueue = JSON.parse(localStorage.getItem('cakeProductionQueue')) || [];

      let currentLaborList = []; 
      let currentRecFilter = 'all'; // –¢–µ–∫—É—â–∏–π —Ñ–∏–ª—å—Ç—Ä
      let stockHistory = []; // –ñ—É—Ä–Ω–∞–ª –æ–ø–µ—Ä–∞—Ü–∏–π

      let stockSort = { field: 'name', dir: 'asc' }; // –î–ª—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤
let laborSort = { field: 'name', dir: 'asc' }; // –î–ª—è —Ä–∞–±–æ—Ç
     
      
      // –ì–õ–ê–í–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï
      // –ì–õ–ê–í–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï
      let appState = {
          tiers: [{id: 1, weight: 0, recipeId: null}], // –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã (–ì–ª–∞–≤–Ω—ã–µ)
          
          // –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –∫–æ–ø–∏–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã
          leftTiers: [],
          rightTiers: [],

          results: { Left: null, Right: null },
          activeSide: 'Right',
          
          // –•—Ä–∞–Ω–∏–ª–∏—â–µ —Ä–µ–∂–∏–º–æ–≤: 'weight' –∏–ª–∏ 'size' –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —è—Ä—É—Å–∞
          tierModes: { Left: {}, Right: {} } 
      };
      // –°—Å—ã–ª–∫–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
      let state = appState.results;
      // –°–°–´–õ–ö–ê –î–õ–Ø –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò –°–û –°–¢–ê–†–´–ú–ò –§–£–ù–ö–¶–ò–Ø–ú–ò (–ü–µ—á–∞—Ç—å/–û—á–µ—Ä–µ–¥—å)
     let bareConfirmationGiven = false; // –§–ª–∞–≥: –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "–≥–æ–ª—ã–π" —Ç–æ—Ä—Ç

      // –ú–ò–ì–†–ê–¶–ò–Ø –î–ê–ù–ù–´–•
      myRecipes.forEach(r => { if(!r.type) r.type='filling'; if(!r.blocks) r.blocks=[{name:'Base',ingredients:r.ingredients||[]}]; });
      myIngredients.forEach(i => { if(!i.unit) i.unit = '–≥'; });

      // --- 2. INITIALIZATION ---
      updateUI();
      loadHourlyRate();
      loadFinance();
      saveToHistory(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      

      // --- 3. FUNCTIONS ---

     

function setStockShelf(shelf, btn) {
    currentStockShelf = shelf;
    
    // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
    document.querySelectorAll('.shelf-btn').forEach(b => {
        b.style.background = 'white';
        b.classList.remove('active');
    });
    btn.style.background = '#eee';
    btn.classList.add('active');
    
    renderStockTable(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
}

      function setRecFilter(type, btn) {
    currentRecFilter = type;
    
    // –í–∏–∑—É–∞–ª—å–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
    document.querySelectorAll('.filter-chips .chip').forEach(c => c.classList.remove('active'));
    if(btn) btn.classList.add('active');
    
    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
    renderRecipesList();
}

      function updateUI() {
    myIngredients.sort((a,b)=>a.name.localeCompare(b.name));
    const dl=document.getElementById('allIngsDatalist'); 
    if(dl) {
        dl.innerHTML='';
        myIngredients.forEach(i=>{const o=document.createElement('option');o.value=i.name;dl.appendChild(o)});
    }
    
    // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—ã–±–æ—Ä –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–æ–π ---

    // 1. –ü–æ–∫—Ä—ã—Ç–∏—è (–ö—Ä–µ–º)
    const selC=document.getElementById('coatingIdSelect'); 
    if(selC) {
       renderCoatingOptions(); // <--- –í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ä–æ–≥–æ —Ü–∏–∫–ª–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è selC
    }

    // 2. –î–æ–ø. –ø–æ–∫—Ä—ã—Ç–∏—è (–í–µ–ª—é—Ä)
    const selE=document.getElementById('extraCoatingIdSelect'); 
    if(selE) { 
        const savedVal = selE.value; // <--- –ó–ê–ü–û–ú–ù–ò–õ–ò!
        selE.innerHTML='<option value="">-- –ù–µ—Ç --</option>';
        myRecipes.filter(r=>r.type==='extra').forEach(r=>{
            const o=document.createElement('option');
            o.value=r.id;
            o.innerText=r.name;
            selE.appendChild(o);
        });
        selE.value = savedVal; // <--- –í–°–ü–û–ú–ù–ò–õ–ò!
    }
    
    // –¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã
    const dlLabor = document.getElementById('allLaborDatalist');
    if (dlLabor) {
        dlLabor.innerHTML = '';
        myLaborServices.forEach(l => {
            const opt = document.createElement('option');
            opt.value = l.name; 
            dlLabor.appendChild(opt);
        });
    }
    document.querySelectorAll('.curr-sym').forEach(e=>e.innerText=SYMBOLS[currentCurrency]);
    
    renderStockTable(); 
    renderRecipesList();
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —è—Ä—É—Å–æ–≤
    renderTierRows();
}

     function switchTab(t) {
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
    document.querySelectorAll('.nav-group .tab-btn').forEach(b => b.classList.remove('active'));
    
    const targetDiv = document.getElementById('tab-' + t);
    if (targetDiv) targetDiv.style.display = 'block';
    
    // –ò—â–µ–º –∫–Ω–æ–ø–∫—É, —É –∫–æ—Ç–æ—Ä–æ–π onclick —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω—É–∂–Ω–æ–µ –∏–º—è –≤–∫–ª–∞–¥–∫–∏
    const targetBtn = document.querySelector(`.nav-group .tab-btn[onclick*="'${t}'"]`);
    if (targetBtn) targetBtn.classList.add('active');
    
    if(t === 'clients') {
        renderClientsCloud(); 
    }
       if(t === 'archive') {
        renderArchive();
    }
}

function renderTierRows() {
    const c = document.getElementById('tiersContainer');
    if(!c) return; 
    c.innerHTML = '';
    
    // 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Ñ–æ—Ä–º—ã
    const shape = document.getElementById('globalShape').value;
    
    let dLabel = 'D (–î–∏–∞–º–µ—Ç—Ä)';
    let wLabel = 'W (–®–∏—Ä–∏–Ω–∞)';
    let hLabel = 'H (–í—ã—Å–æ—Ç–∞)';
    
    let showW = false;
    let showH = true;

    if (shape === 'rectangle') {
        dLabel = '–î–ª–∏–Ω–∞ (—Å–º)';
        wLabel = '–®–∏—Ä–∏–Ω–∞ (—Å–º)';
        showW = true;
    } else if (shape === 'square') {
        dLabel = '–°—Ç–æ—Ä–æ–Ω–∞ (—Å–º)';
    } else if (shape === 'sphere') {
        dLabel = '–î–∏–∞–º–µ—Ç—Ä (—Å–º)';
        hLabel = 'H = D'; // –î–ª—è —à–∞—Ä–∞ –≤—ã—Å–æ—Ç–∞ —Ä–∞–≤–Ω–∞ –¥–∏–∞–º–µ—Ç—Ä—É
        showH = false;    // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –≤—ã—Å–æ—Ç—ã, —á—Ç–æ–±—ã –Ω–µ –ø—É—Ç–∞—Ç—å
    }

    appState.tiers.forEach((t, idx) => {
        const div = document.createElement('div');
        div.className = 'tier-card';
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ –Ω–∞—á–∏–Ω–æ–∫
        // --- –£–ú–ù–´–ô –§–ò–õ–¨–¢–† –ù–ê–ß–ò–ù–û–ö ---
        const isBombShape = (shape === 'sphere');
        const validFillings = myRecipes.filter(r => {
            if (r.type !== 'filling') return false;
            const hasBomb = r.name.toLowerCase().includes('–±–æ–º–±–∞');
            return isBombShape ? hasBomb : !hasBomb;
        });

        // –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –∏ —Ç–µ–∫—É—â–∞—è –Ω–∞—á–∏–Ω–∫–∞ –µ–π –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é
        if (!validFillings.find(r => r.id === t.recipeId) && validFillings.length > 0) {
            t.recipeId = validFillings[0].id;
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞
        let recOptions = '';
        validFillings.forEach(r => {
            const sel = (t.recipeId === r.id) ? 'selected' : '';
            recOptions += `<option value="${r.id}" ${sel}>${r.name}</option>`;
        });
        // ------------------------------

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Ä–∏—Å–æ–≤–∞—Ç—å –ª–∏ —Å—Ç—Ä–µ–ª–∫–∏
        const isFirst = (idx === 0);
        const isLast = (idx === appState.tiers.length - 1);
        const showArrows = appState.tiers.length > 1; 

        // --- –í–ê–ñ–ù–û: –í—ã—á–∏—Å–ª—è–µ–º –∫–ª–∞—Å—Å—ã –∏–∫–æ–Ω–æ–∫ –ó–î–ï–°–¨ (–¥–æ –Ω–∞—á–∞–ª–∞ HTML) ---
        const weightClass = !t.isGeometryMode ? 'mode-icon active' : 'mode-icon';
        const geoClass = t.isGeometryMode ? 'mode-icon active' : 'mode-icon';

        div.innerHTML = `
          <div class="tier-header">
              <div style="display:flex; align-items:center;">
                  <span class="tier-badge" style="margin-right:10px;">${idx===0 ? '–ù–ò–ó (–Ø—Ä—É—Å 1)' : '–Ø–†–£–° '+(idx+1)}</span>
                  
                  ${showArrows ? `
                  <div class="move-group">
                      ${!isFirst ? `<button class="move-btn" onclick="moveTier(${idx}, -1)" title="–ü–æ–¥–Ω—è—Ç—å –≤—ã—à–µ">‚¨ÜÔ∏è</button>` : ''}
                      ${!isLast  ? `<button class="move-btn" onclick="moveTier(${idx}, 1)" title="–û–ø—É—Å—Ç–∏—Ç—å –Ω–∏–∂–µ">‚¨áÔ∏è</button>` : ''}
                  </div>
                  ` : ''}
              </div>
              
              ${idx > 0 ? `<button class="del-btn" onclick="removeTier(${idx})">‚úï</button>` : ''}
          </div>
          
          <div class="form-row" style="margin-bottom:5px; align-items: flex-end;">
              <div class="form-group" style="flex:1.5">
                 <span class="form-label">–ù–∞—á–∏–Ω–∫–∞</span>
                 <select class="tier-recipe" onchange="updateTierData(${idx}, 'recipeId', this.value)">${recOptions}</select>
              </div>
              
              <div class="form-group" style="flex:0.8; display:flex; align-items:center; padding-bottom:8px; justify-content: center;">
                 <div class="mode-toggle-wrapper">
                     <span class="${weightClass}" 
                           onclick="toggleTierInputMode(${idx}, false)" 
                           title="–†–µ–∂–∏–º: –ü–æ–¥–≥–æ–Ω –ø–æ–¥ –í–µ—Å (–≤—ã—Å–æ—Ç–∞ –∞–≤—Ç–æ)">
                           ‚öñÔ∏è
                     </span>
                     <span class="${geoClass}" 
                           onclick="toggleTierInputMode(${idx}, true)" 
                           style="margin-left:4px;" 
                           title="–†–µ–∂–∏–º: –°—Ç—Ä–æ–≥–∞—è –ì–µ–æ–º–µ—Ç—Ä–∏—è (–≤–µ—Å —Å—á–∏—Ç–∞–µ—Ç—Å—è)">
                           üìè
                     </span>
                 </div>
              </div>

              <div class="form-group" style="flex:1">
                 <span class="form-label">–í–µ—Å (–∫–≥)</span>
                 <input type="number" id="inpWeight_${idx}" class="tier-weight" value="${t.weight}" step="0.1" 
                        onchange="updateTierData(${idx}, 'weight', this.value)"
                        style="${t.isGeometryMode ? 'background:#eee; color:#999;' : ''}"
                        ${t.isGeometryMode ? 'disabled' : ''}>
              </div>
          </div>

          <div style="background:#e3f2fd; padding:6px; border-radius:4px; border:1px solid #bbdefb;">
             <div style="font-size:10px; color:#1565C0; font-weight:bold; margin-bottom:4px; display:flex; justify-content:space-between;">
                <span>üéØ –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–ï –†–ê–ó–ú–ï–†–´ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</span>
                <span style="font-weight:normal; color:#666;">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –ê–≤—Ç–æ-–ø–æ–¥–±–æ—Ä–∞</span>
             </div>
             
             <div style="display:flex; gap:5px;">
            
                 <input type="number" placeholder="${dLabel}" title="${dLabel}"
                    style="padding:4px; font-size:12px; font-weight:bold;" 
                    value="${t.fixedDiameter ? Number(t.fixedDiameter).toFixed(1) : ''}" 
                    onchange="updateTierData(${idx}, 'fixedDiameter', this.value)">
                 
                 ${showW ? `<input type="number" placeholder="${wLabel}" title="${wLabel}"
                    style="padding:4px; font-size:12px; font-weight:bold;" 
                    value="${t.fixedWidth ? Number(t.fixedWidth).toFixed(1) : ''}" 
                    onchange="updateTierData(${idx}, 'fixedWidth', this.value)">` : ''}
                 
                 ${showH ? `<input type="number" placeholder="${hLabel}" title="${hLabel}"
                    style="padding:4px; font-size:12px;" 
                    value="${t.fixedHeight ? Number(t.fixedHeight).toFixed(1) : ''}" 
                    onchange="updateTierData(${idx}, 'fixedHeight', this.value)">` : ''}
             </div>
          </div>
        `;
        c.appendChild(div);
    });
}

      function updateTierData(idx, field, val) {
    if (field === 'weight') appState.tiers[idx][field] = parseFloat(val) || 0;
    else if (field.startsWith('fixed')) appState.tiers[idx][field] = val ? parseFloat(val) : null;
    else appState.tiers[idx][field] = val;
}

function addTier() {
    // 1. –ù–∞—Ö–æ–¥–∏–º —Å–µ–ª–µ–∫—Ç –æ–±—â–µ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è
    const coatingSelect = document.getElementById('coatingIdSelect');
    const coatingValue = coatingSelect ? coatingSelect.value : "";

    // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ "-- –ì–æ–ª—ã–π --" (–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞)
    if (coatingValue === "") {
        const confirmBare = confirm("‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ!\n\n–í—ã –Ω–µ –≤—ã–±—Ä–∞–ª–∏ –æ–±—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –¥–ª—è —Ç–æ—Ä—Ç–∞ (-- –ì–æ–ª—ã–π --).\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —è—Ä—É—Å –∏ –¥–µ–ª–∞—Ç—å —Ä–∞—Å—á–µ—Ç –ë–ï–ó —É—á–µ—Ç–∞ —Ñ–∏–Ω–∏—à–Ω–æ–≥–æ –∫—Ä–µ–º–∞?");
        
        if (!confirmBare) {
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–û—Ç–º–µ–Ω–∞", –ø–µ—Ä–µ–∫–∏–¥—ã–≤–∞–µ–º –µ–≥–æ –∫ –≤—ã–±–æ—Ä—É –ø–æ–∫—Ä—ã—Ç–∏—è –∏ –≤—ã—Ö–æ–¥–∏–º
            coatingSelect.focus();
            return; 
        }
    }

    // 3. –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª "–≥–æ–ª—ã–π" —Ç–æ—Ä—Ç:
    saveToHistory(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –î–û –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —è—Ä—É—Å, –∫–æ–ø–∏—Ä—É—è –Ω–∞—á–∏–Ω–∫—É –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —è—Ä—É—Å–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
    appState.tiers.push({ 
        id: Date.now(), 
        weight: 0, 
        recipeId: appState.tiers[0] ? appState.tiers[0].recipeId : null 
    });
    
    // 4. –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    renderTierRows();
}

function removeTier(idx) {
    // –°–Ω–∞—á–∞–ª–∞ –º–µ–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
    appState.tiers.splice(idx, 1);
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é —á–∞—Å—Ç—å
    renderTierRows();
    // –§–∏–∫—Å–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∏—Å—Ç–æ—Ä–∏–∏
    saveToHistory();
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ –≤ –ø–æ–∏—Å–∫
function refreshStockView() {
    // –°–º–æ—Ç—Ä–∏–º, –∫–∞–∫–∞—è —Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–∫–∞ –≤—ã–±—Ä–∞–Ω–∞ —Å–µ–π—á–∞—Å
    const mode = document.querySelector('input[name="stockType"]:checked').value;
    
    if (mode === 'ingredients') {
        renderStockTable();
    } else {
        renderLaborTable();
    }
}

// --- –§–£–ù–ö–¶–ò–Ø –ü–ï–†–ï–ú–ï–©–ï–ù–ò–Ø –Ø–†–£–°–ê ---
function moveTier(idx, direction) {
    // direction: -1 (–í–≤–µ—Ä—Ö), +1 (–í–Ω–∏–∑)
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∏ –≥—Ä–∞–Ω–∏—Ü
    if (direction === -1 && idx === 0) return; // –ù–µ–ª—å–∑—è –ø–æ–¥–Ω—è—Ç—å —Å–∞–º—ã–π –≤–µ—Ä—Ö–Ω–∏–π
    if (direction === 1 && idx === appState.tiers.length - 1) return; // –ù–µ–ª—å–∑—è –æ–ø—É—Å—Ç–∏—Ç—å —Å–∞–º—ã–π –Ω–∏–∂–Ω–∏–π

    // –ú–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏ —ç–ª–µ–º–µ–Ω—Ç—ã –º–∞—Å—Å–∏–≤–∞
    const temp = appState.tiers[idx];
    appState.tiers[idx] = appState.tiers[idx + direction];
    appState.tiers[idx + direction] = temp;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
    renderTierRows();
    saveToHistory();
    
    // –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–µ—Å—á–µ—Ç, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É
    // calculateInitial(); 
}

function updateTierUI() {
  renderCoatingOptions(); // <--- –î–û–ë–ê–í–ò–¢–¨ –°–Æ–î–ê –ü–ï–†–í–û–ô –°–¢–†–û–ö–û–ô
    const sh = document.getElementById('globalShape').value;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–æ–ª—è
    const grpSides = document.getElementById('grpSides');
    const sphereFillBlock = document.getElementById('sphereFillBlock');
    
    if (grpSides) grpSides.style.display = (sh === 'polygon') ? 'block' : 'none';
    if (sphereFillBlock) sphereFillBlock.style.display = (sh === 'sphere') ? 'block' : 'none';

    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    updateCoatingUI(); 
    renderTierRows();
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç —Å–º–µ–Ω—ã —Ñ–æ—Ä–º—ã
    saveToHistory(); 
}

function calculateInitial() {
    const coatingSelect = document.getElementById('coatingIdSelect');
    const coatingValue = coatingSelect ? coatingSelect.value : "";
    const tierCount = appState.tiers.length;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–∫—Ä—ã—Ç–∏–µ
    if (tierCount === 1 && coatingValue === "" && !bareConfirmationGiven) {
        const confirmBare = confirm("‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –¢–û–†–¢ –ë–ï–ó –ü–û–ö–†–´–¢–ò–Ø\n__________________________________\n\n–£ –≤–∞—Å –≤—ã–±—Ä–∞–Ω —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —è—Ä—É—Å, –Ω–æ –Ω–µ —É–∫–∞–∑–∞–Ω —Ñ–∏–Ω–∏—à–Ω—ã–π –∫—Ä–µ–º.\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞—Å—á–µ—Ç –ë–ï–ó –ø–æ–∫—Ä—ã—Ç–∏—è?");
        if (!confirmBare) { coatingSelect.focus(); return; } 
        else { bareConfirmationGiven = true; }
    }

    const shape = document.getElementById('globalShape').value;

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–µ—Å–∞
    // –í–∞–ª–∏–¥–∞—Ü–∏—è (–£–º–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –í–µ—Å –∏–ª–∏ –†–∞–∑–º–µ—Ä—ã)
    if (shape !== 'sphere') {
        for (let i = 0; i < appState.tiers.length; i++) {
            const tier = appState.tiers[i];
            
            // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º "–ü–æ —Ä–∞–∑–º–µ—Ä—É" (Geometry Mode)
            if (tier.isGeometryMode) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –î–∏–∞–º–µ—Ç—Ä
                if (!tier.fixedDiameter || tier.fixedDiameter <= 0) {
                    alert(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ –Ø—Ä—É—Å–µ ${i+1} (–†–µ–∂–∏–º "–ü–æ —Ä–∞–∑–º–µ—Ä—É")!\n–ù–µ —É–∫–∞–∑–∞–Ω –î–∏–∞–º–µ—Ç—Ä (D).`);
                    return;
                }
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –í—ã—Å–æ—Ç—É
                if (!tier.fixedHeight || tier.fixedHeight <= 0) {
                    alert(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ –Ø—Ä—É—Å–µ ${i+1} (–†–µ–∂–∏–º "–ü–æ —Ä–∞–∑–º–µ—Ä—É")!\n–ù–µ —É–∫–∞–∑–∞–Ω–∞ –í—ã—Å–æ—Ç–∞ (H).`);
                    return;
                }
                // –ï—Å–ª–∏ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –®–∏—Ä–∏–Ω—É
                if (shape === 'rectangle' && (!tier.fixedWidth || tier.fixedWidth <= 0)) {
                    alert(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ –Ø—Ä—É—Å–µ ${i+1} (–†–µ–∂–∏–º "–ü–æ —Ä–∞–∑–º–µ—Ä—É")!\n–ù–µ —É–∫–∞–∑–∞–Ω–∞ –®–∏—Ä–∏–Ω–∞ (W).`);
                    return;
                }
            } 
            // –ï—Å–ª–∏ –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º (–ø–æ –í–µ—Å—É)
            else {
                if (!tier.weight || tier.weight <= 0) {
                    alert(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ –Ø—Ä—É—Å–µ ${i+1}!\n–£–∫–∞–∂–∏—Ç–µ –í–µ—Å (–∏–ª–∏ –≤–∫–ª—é—á–∏—Ç–µ –≥–∞–ª–æ—á–∫—É "–ü–æ —Ä–∞–∑–º–µ—Ä—É").`);
                    return;
                }
            }
        }
    }

    extrasList = [];         // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–∏
  

    // 1. –ê–≤—Ç–æ-—Ä–∞–±–æ—Ç—ã –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ (—Ç–µ, —á—Ç–æ —Å –≥–∞–ª–∫–æ–π –ê–≤—Ç–æ)
    myLaborServices.forEach(service => {
        if (service.isAuto) {
            const exists = currentLaborList.find(l => l.name === service.name);
            if (!exists) {
                currentLaborList.push({
                    name: service.name,
                    realHours: service.defaultTime || 1,
                    coeff: service.coeff || 1,
                    isHelper: service.isHelper || false
                });
            }
        }
    });

    const tiersPayload = appState.tiers.map(t => ({
    id: t.id,
    recipeId: t.recipeId,
    weight: t.weight * 1000, 
    // –î–û–ë–ê–í–ò–õ–ò –§–õ–ê–ì:
    isGeometryMode: t.isGeometryMode || false, 
    fixedDiameter: parseFloat(t.fixedDiameter) || null,
    fixedWidth: parseFloat(t.fixedWidth) || null,
    fixedHeight: parseFloat(t.fixedHeight) || null
}));

    const payload = {
        tiers: tiersPayload,
        shape: shape,
        polySides: parseInt(document.getElementById('globalSides').value) || 6,
        sphereFillMode: document.querySelector('input[name="sphereFillMode"]:checked')?.value || 'recipe',
        coatingId: document.getElementById('coatingIdSelect').value,
        extraCoatingId: document.getElementById('extraCoatingIdSelect').value,
        coatingMethod: document.getElementById('chkCoatingMethod').checked ? 'proportion' : 'geometry',
        coatingMarginPercent: parseFloat(document.getElementById('coatingMargin').value) || 0,
        fillingMarginPercent: parseFloat(document.getElementById('fillingMargin').value) || 0,
        extraMarginPercent: parseFloat(document.getElementById('extraMargin').value)||0,
        extras: extrasList, 
        hourlyRate: parseFloat(document.getElementById('hourlyRate').value)||0,
        ingredients: myIngredients,
        recipes: myRecipes
    };

    document.getElementById('loader').style.display = 'block';
    document.getElementById('resultsBlock').style.display = 'none';

    google.script.run.withSuccessHandler(res => {
        document.getElementById('loader').style.display = 'none';
        if(res.success) {
            appState.results.Left = res.data; 
            appState.results.Right = JSON.parse(JSON.stringify(res.data));
            appState.leftTiers = JSON.parse(JSON.stringify(tiersPayload));
            appState.rightTiers = JSON.parse(JSON.stringify(tiersPayload));

            // --- –ë–õ–û–ö –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–ò (–° –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏ —Å–∫–æ–±–æ–∫) ---
            
            // 1. –°–±–æ—Ä–∫–∞ —è—Ä—É—Å–æ–≤ (–†–∞–±–æ—Ç–∞)
            // --- –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ë–õ–û–ö –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–ò –Ø–†–£–°–û–í (V2) ---
            if (appState.tiers.length > 1) {
                // 1. –†–∞–±–æ—Ç–∞: –°–±–æ—Ä–∫–∞ —è—Ä—É—Å–æ–≤
                const assemblyTask = "–°–±–æ—Ä–∫–∞ —è—Ä—É—Å–æ–≤";
                if (!currentLaborList.find(l => l.name === assemblyTask)) {
                    const ref = myLaborServices.find(s => s.name.toLowerCase().includes("—Å–±–æ—Ä–∫–∞ —è—Ä—É—Å"));
                    currentLaborList.push({
                        name: assemblyTask,
                        realHours: ref ? ref.defaultTime : 1,
                        coeff: ref ? ref.coeff : 1.2,
                        isHelper: ref ? ref.isHelper : false
                    });
                }

                let totalHeightForAxis = 0;
                let skewersLog = [];
                let skewersTotalCm = 0;

                res.data.tiers.forEach((t, idx) => {
                    const isLast = (idx === appState.tiers.length - 1);
                    const hRounded = Math.round(t.h);

                    if (!isLast) {
                        totalHeightForAxis += t.h;
                        skewersTotalCm += (6 * hRounded);
                        skewersLog.push(`6 —à—Ç –ø–æ ${hRounded}—Å–º`);
                    } else {
                        totalHeightForAxis += (t.h / 2);
                    }

                    // –ü–û–î–õ–û–ñ–ö–ò: –ò—â–µ–º "–ü–æ–¥–ª–æ–∂–∫–∞" + —á–∏—Å–ª–æ –¥–∏–∞–º–µ—Ç—Ä–∞
                    if (idx > 0) {
    const shape = document.getElementById('globalShape').value;
    const d = Math.round(t.d);
    const w = t.w ? Math.round(t.w) : d;
    
    let podlojkaSearchName = "";
    let displayPodlojkaName = "";

    // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–æ—Ä–º—ã
    if (shape === 'rectangle' || shape === 'square') {
        // –î–ª—è –∫–≤–∞–¥—Ä–∞—Ç–æ–≤ –∏ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤ –∏—â–µ–º —Ñ–æ—Ä–º–∞—Ç "20x30" –∏–ª–∏ "30x20"
        displayPodlojkaName = `–ü–æ–¥–ª–æ–∂–∫–∞ ${d}x${w}`;
        podlojkaSearchName = `${d}x${w}`; 
    } else {
        // –î–ª—è –∫—Ä—É–≥–∞, —à–∞—Ä–∞ –∏ –º–Ω–æ–≥–æ–≥—Ä–∞–Ω–Ω–∏–∫–∞ –∏—â–µ–º —Ñ–æ—Ä–º–∞—Ç "D20"
        displayPodlojkaName = `–ü–æ–¥–ª–æ–∂–∫–∞ D${d}`;
        podlojkaSearchName = `D${d}`;
    }

    if (!extrasList.find(ex => ex.name.includes(displayPodlojkaName))) {
        // –£–º–Ω—ã–π –ø–æ–∏—Å–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ
        const ing = myIngredients.find(i => {
            const n = i.name.toLowerCase();
            const hasBaseName = n.includes('–ø–æ–¥–ª–æ–∂–∫');
            
            if (shape === 'rectangle' || shape === 'square') {
                // –ò—â–µ–º –æ–±–∞ —Ä–∞–∑–º–µ—Ä–∞ –≤ –ª—é–±–æ–º –ø–æ—Ä—è–¥–∫–µ (20x30 –∏–ª–∏ 30x20)
                return hasBaseName && n.includes(d.toString()) && n.includes(w.toString());
            } else {
                return hasBaseName && n.includes(d.toString());
            }
        });

        extrasList.push({ 
            id: ing ? ing.id : 'manual', 
            name: displayPodlojkaName, 
            amount: 1, 
            unit: '—à—Ç', 
            type: 'extra' 
        });
                        }
                    }
                });

                // –¶–ï–ù–¢–†–ê–õ–¨–ù–ê–Ø –û–°–¨: –†–∞—Å—á–µ—Ç –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è
                if (!extrasList.find(ex => ex.name.includes("–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –æ—Å—å"))) {
                    const axisIng = myIngredients.find(i => i.name.toLowerCase().includes("—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –æ—Å—å"));
                    let finalAmt = Math.round(totalHeightForAxis);
                    let unit = '—Å–º';
                    if (axisIng && axisIng.unit === '–º') { finalAmt /= 100; unit = '–º'; }
                    
                    extrasList.push({ 
                        id: axisIng ? axisIng.id : 'manual', 
                        name: `–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –æ—Å—å (${Math.round(totalHeightForAxis)} —Å–º)`, 
                        amount: finalAmt, 
                        unit: axisIng ? axisIng.unit : unit, 
                        type: 'extra' 
                    });
                }

                // –®–ü–ê–ñ–ö–ò: –†–∞—Å—á–µ—Ç –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è
                if (!extrasList.find(ex => ex.name.includes("–®–ø–∞–∂–∫–∏"))) {
                    const skewIng = myIngredients.find(i => i.name.toLowerCase().includes("—à–ø–∞–∂–∫–∏"));
                    let finalSkewAmt = skewersTotalCm;
                    let skewUnit = '—Å–º';
                    // –ï—Å–ª–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ —à–ø–∞–∂–∫–∏ –≤ –º–µ—Ç—Ä–∞—Ö, –ø–µ—Ä–µ–≤–æ–¥–∏–º (78—Å–º -> 0.78–º)
                    if (skewIng && skewIng.unit === '–º') { finalSkewAmt /= 100; skewUnit = '–º'; }
                    
                    extrasList.push({ 
                        id: skewIng ? skewIng.id : 'manual', 
                        name: `–®–ø–∞–∂–∫–∏ (—É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ): ${skewersLog.join(', ')}`, 
                        amount: finalSkewAmt, 
                        unit: skewIng ? skewIng.unit : skewUnit, 
                        type: 'extra' 
                    });
                }
            }
            // 3. –ë–æ–º–±–∞
            if (document.getElementById('globalShape').value === 'sphere') {
                ["–ë–æ–º–±–∞ –ø–æ–¥—Å—Ç–∞–≤–∫–∞", "–ë–æ–º–±–∞ —Ñ–∏—Ç–∏–ª—å"].forEach(itemName => {
                    if (!extrasList.find(ex => ex.name === itemName)) {
                        const ing = myIngredients.find(i => i.name === itemName);
                        if (ing) extrasList.push({ id: ing.id, name: ing.name, amount: 1, unit: ing.unit, type: 'extra' });
                    }
                });
            }

            // 4. –ê–≤—Ç–æ-—Ä–∞–±–æ—Ç–∞: –í–µ–ª—é—Ä
            const extraCoatingId = document.getElementById('extraCoatingIdSelect').value;
            if (extraCoatingId) {
                const velourTask = "–ü–æ–∫—Ä—ã—Ç–∏–µ –≤–µ–ª—é—Ä–æ–º";
                if (!currentLaborList.find(l => l.name === velourTask)) {
                    // –ò—â–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —ç—Ç–æ–π —Ä–∞–±–æ—Ç—ã –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ
                    const ref = myLaborServices.find(s => s.name.toLowerCase().includes("–≤–µ–ª—é—Ä"));
                    currentLaborList.push({
                        name: velourTask,
                        realHours: ref ? ref.defaultTime : 0.5, // 30 –º–∏–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –Ω–µ—Ç –≤ –±–∞–∑–µ
                        coeff: ref ? ref.coeff : 1.3,           // –ö–æ—ç—Ñ—Ñ 1.3, –µ—Å–ª–∏ –Ω–µ—Ç –≤ –±–∞–∑–µ
                        isHelper: ref ? ref.isHelper : false
                    });
                }
            }

            renderLaborTasks();
            renderExtras();
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –û–ë–ï —Å—Ç–æ—Ä–æ–Ω—ã, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å –∞–≤—Ç–æ-—Ä–∞–±–æ—Ç—ã –∫–æ –≤—Å–µ–º –≤–∞—Ä–∏–∞–Ω—Ç–∞–º
            calculateSide('Left');
            calculateSide('Right');
            
            document.getElementById('resultsBlock').style.display = 'block';
            document.getElementById('svgLeft').innerHTML = res.svg;
            document.getElementById('svgRight').innerHTML = res.svg;
            updateStats('Left');
            updateStats('Right');
            renderControls(); 
            setActiveSide('Right');
        } else {
            alert('–û—à–∏–±–∫–∞: ' + res.error);
        }
    }).apiCalculateOrder(payload);
}
// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è —Ñ–æ—Ä–º—ã –≤ –æ—à–∏–±–∫–µ (–¥–æ–±–∞–≤—å—Ç–µ –µ—ë –≥–¥–µ-–Ω–∏–±—É–¥—å –≤ —Å–∫—Ä–∏–ø—Ç–µ –∏–ª–∏ –æ–Ω–∞ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤–Ω—É—Ç—Ä–∏ calculateInitial, –µ—Å–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –µ—ë —Ç–∞–º, –Ω–æ –ª—É—á—à–µ –æ—Ç–¥–µ–ª—å–Ω–æ)
function getActionName(shape) {
    const map = {'cylinder': '–¶–∏–ª–∏–Ω–¥—Ä', 'square': '–ö–≤–∞–¥—Ä–∞—Ç', 'rectangle': '–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫', 'polygon': '–ú–Ω–æ–≥–æ–≥—Ä–∞–Ω–Ω–∏–∫'};
    return map[shape] || shape;
}



function modifyTier(side, idx, axis, delta) {
    let tiersData = (side === 'Left') ? appState.leftTiers : appState.rightTiers;
    if (!tiersData || !tiersData[idx]) return;

    const tierObj = tiersData[idx]; 
    const currentRes = appState.results[side].tiers[idx]; 
    const globalShape = appState.results[side].geometry.shape; 
    
    const isGeo = tierObj.isGeometryMode;

    // === 1. –ò–ó–ú–ï–ù–ï–ù–ò–ï –î–ò–ê–ú–ï–¢–†–ê (D) –∏–ª–∏ –®–ò–†–ò–ù–´ (W) ===
    if (axis === 'd' || axis === 'w') {
        const field = (axis === 'd') ? 'fixedDiameter' : 'fixedWidth';
        // –ë–µ—Ä–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ null
        const currentVal = tierObj[field] || ((axis === 'd') ? currentRes.d : currentRes.w);
        
        // –ú–µ–Ω—è–µ–º
        tierObj[field] = Math.round(currentVal + delta);
        if (tierObj[field] < 5) tierObj[field] = 5; // –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö

        // –°–ø–µ—Ü. –ª–æ–≥–∏–∫–∞ –¥–ª—è –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ (—Ñ–∏–∫—Å–∏—Ä—É–µ–º –≤—Ç–æ—Ä—É—é —Å—Ç–æ—Ä–æ–Ω—É)
        if (globalShape === 'rectangle') {
             if (axis === 'd' && !tierObj.fixedWidth) tierObj.fixedWidth = Math.round(currentRes.w);
             if (axis === 'w' && !tierObj.fixedDiameter) tierObj.fixedDiameter = Math.round(currentRes.d);
        }

        if (isGeo) {
            // –†–µ–∂–∏–º "–ü–æ —Ä–∞–∑–º–µ—Ä—É":
            // –î–∏–∞–º–µ—Ç—Ä –∏–∑–º–µ–Ω–∏–ª—Å—è -> –í—ã—Å–æ—Ç—É –Ω–∞–¥–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å (—á—Ç–æ–±—ã –Ω–µ —É–ø–ª—ã–ª–∞), –í–µ—Å –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å.
            if (!tierObj.fixedHeight) tierObj.fixedHeight = currentRes.h;
            tierObj.weight = 0; 
        } 
        else {
            // –†–µ–∂–∏–º "–ü–æ –≤–µ—Å—É":
            // –î–∏–∞–º–µ—Ç—Ä –∏–∑–º–µ–Ω–∏–ª—Å—è -> –í—ã—Å–æ—Ç—É —Å–±—Ä–∞—Å—ã–≤–∞–µ–º (–æ–Ω–∞ –ø–æ–¥—Å—Ç—Ä–æ–∏—Ç—Å—è –ø–æ–¥ –≤–µ—Å).
            tierObj.fixedHeight = null; 
            delete tierObj.forceHeight;
        }
    }

    // === 2. –ò–ó–ú–ï–ù–ï–ù–ò–ï –í–´–°–û–¢–´ (H) - –¢–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ü–æ —Ä–∞–∑–º–µ—Ä—É" ===
    else if (axis === 'h' && isGeo) {
        let currentH = tierObj.fixedHeight || currentRes.h;
        let newH = parseFloat((currentH + delta).toFixed(1));
        if (newH < 1) newH = 1;

        tierObj.fixedHeight = newH;
        
        // –§–∏–∫—Å–∏—Ä—É–µ–º –¥–∏–∞–º–µ—Ç—Ä, –µ—Å–ª–∏ –Ω–µ –±—ã–ª, —á—Ç–æ–±—ã –Ω–µ –ø–æ–ø–ª—ã–ª
        if (!tierObj.fixedDiameter) tierObj.fixedDiameter = Math.round(currentRes.d);
        if (globalShape === 'rectangle' && !tierObj.fixedWidth) tierObj.fixedWidth = Math.round(currentRes.w);
        
        // –í–µ—Å –ø–æ–¥ —Å–±—Ä–æ—Å
        tierObj.weight = 0;
    }

    calculateSide(side);
}



function calculateSide(side) {
    // 1. –ë–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã
    const sourceTiers = (side === 'Left') ? appState.leftTiers : appState.rightTiers;
    
    // 2. –°–æ–±–∏—Ä–∞–µ–º payload (–∫–æ–ø–∏—è –ª–æ–≥–∏–∫–∏ calculateInitial, –Ω–æ —Å sourceTiers)
    const payload = {
        tiers: sourceTiers,
        shape: document.getElementById('globalShape').value,
        polySides: parseInt(document.getElementById('globalSides').value) || 6,
        sphereFillMode: document.querySelector('input[name="sphereFillMode"]:checked') ? document.querySelector('input[name="sphereFillMode"]:checked').value : 'recipe',
        coatingId: document.getElementById('coatingIdSelect').value,
        extraCoatingId: document.getElementById('extraCoatingIdSelect').value,
        coatingMethod: document.getElementById('chkCoatingMethod').checked ? 'proportion' : 'geometry',
        // --- –ò–ó–ú–ï–ù–ï–ù–û: –ë–ï–†–ï–ú –ò–ó –ü–û–õ–ï–ô, –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ 0 ---
        coatingMarginPercent: parseFloat(document.getElementById('coatingMargin').value) || 0,
        fillingMarginPercent: parseFloat(document.getElementById('fillingMargin').value) || 0,
        // ------------------------------------------------
        extraMarginPercent: parseFloat(document.getElementById('extraMargin').value)||0,
        extras: extrasList, 
        hourlyRate: parseFloat(document.getElementById('hourlyRate').value)||0,
        hoursSpent: currentLaborList.reduce((sum,item)=>sum+(item.realHours*item.coeff),0),
        urgencyPercent: parseFloat(document.getElementById('urgencyPercent').value)||0,
        ingredients: myIngredients,
        recipes: myRecipes
    };

    // 3. –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç (—Ç–∏—Ö–∏–π)
    const svgEl = document.getElementById('svg' + side);
    svgEl.style.opacity = '0.5';

    // 4. –ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    google.script.run.withSuccessHandler(res => {
        svgEl.style.opacity = '1';
        if(res.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –¢–û–õ–¨–ö–û —ç—Ç—É —Å—Ç–æ—Ä–æ–Ω—É
            appState.results[side] = res.data;
            state = appState.results; // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

          if (autoAddPackaging(res.data)) {
                renderExtras();
                console.log("–£–ø–∞–∫–æ–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ä–∞—Å—á–µ—Ç–∞...");
                calculateSide(side); 
                return; 
            }

            document.getElementById('svg' + side).innerHTML = res.svg;
            updateStats(side);
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏, –µ—Å–ª–∏ –ø–æ–º–µ–Ω—è–ª–∞—Å—å –≥–µ–æ–º–µ—Ç—Ä–∏—è
            if(side === 'Right') renderControls();
            if(side === 'Left' && typeof renderControlsLeft === 'function') renderControlsLeft();
            
            setActiveSide(side);
            forceRepaint();
        }
    }).apiCalculateOrder(payload);
}

// --- –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–ò–°–¢–ò–ö–ò (–° –†–ê–ó–†–Ø–î–ù–û–°–¢–¨–Æ –¶–ï–ù–´) ---
function updateStats(side) {
    const d = appState.results[side];
    
    // 1. –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É (–ë–æ–ª—å—à–∞—è —Ü–∏—Ñ—Ä–∞)
    const priceEl = document.getElementById('price' + side);
    if (priceEl) {
        // –î–û–ë–ê–í–õ–ï–ù–û: .toLocaleString('ru-RU') –¥–ª—è –ø—Ä–æ–±–µ–ª–æ–≤ (55 273)
        priceEl.innerText = Math.round(d.costs.finalPrice).toLocaleString('ru-RU');
    }

    // 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —è—Ä—É—Å–æ–≤ (–°–Ω–∏–∑—É –≤–≤–µ—Ä—Ö)
    let tiersHtml = '';
    const shape = d.geometry.shape;

    d.tiers.forEach((t, i) => {
        let sizeStr = '';
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä
        if (shape === 'rectangle') {
            sizeStr = `${Math.round(t.d)}x${Math.round(t.w)} —Å–º`;
        } else if (shape === 'square') {
            sizeStr = `${Math.round(t.d)}x${Math.round(t.d)} —Å–º`;
        } else {
            sizeStr = `D${Math.round(t.d)} —Å–º`;
        }

        // –í–ê–ñ–ù–û: –¢—É—Ç —É–±—Ä–∞–ª–∏ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã
        const hVal = (t.h % 1 === 0) ? t.h : t.h.toFixed(1); 
        const hStr = (shape === 'sphere') ? '' : ` / H${hVal}`;

        tiersHtml += `
        <div style="display:flex; justify-content:space-between; border-bottom:1px dotted #e0e0e0; padding:4px 0; font-size:13px;">
            <span>
                <b style="color:#FF5722; margin-right:5px;">${i + 1}.</b>
                ${sizeStr}${hStr}
            </span>
            <span style="font-weight:bold; color:#555;">${(t.weight / 1000).toFixed(2)} –∫–≥</span>
        </div>`;
    });

    // 3. –°–æ–±–∏—Ä–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –±–ª–æ–∫ (–í–µ—Å —Ç–æ–∂–µ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Å–∏–≤—ã–º, –Ω–æ –æ–±—ã—á–Ω–æ —Ç–∞–º –Ω—É–∂–Ω—ã —Ç–æ—á–∫–∏, –æ—Å—Ç–∞–≤–∏–º toFixed)
    const html = `
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
         <button class="add-btn-small" style="background:#607D8B;" onclick="printTechCard('${side}')">üñ®Ô∏è –ß–µ–∫ –∫–ª–∏–µ–Ω—Ç—É –∏ –æ—Ç—á–µ—Ç</button>
         <span style="font-size:12px; color:#999;">${d.tiers.length} —è—Ä—É—Å(–∞)</span>
      </div>

      <div style="background:#f9f9f9; padding:10px; border-radius:6px; border:1px solid #eee; margin-bottom:10px;">
          <div style="font-size:10px; font-weight:bold; color:#999; margin-bottom:5px; text-transform:uppercase;">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è (–°–Ω–∏–∑—É –≤–≤–µ—Ä—Ö):</div>
          ${tiersHtml}
      </div>

      <div class="info-row" style="border-top:2px solid #eee; padding-top:10px;">
          <span>‚öñÔ∏è –í–µ—Å –∏—Ç–æ–≥–æ:</span> 
          <b style="font-size:16px;">${(d.weights.total / 1000).toFixed(2)} –∫–≥</b>
      </div>
      <div class="info-row">
          <span>üìè –í—ã—Å–æ—Ç–∞ –æ–±—â–∞—è:</span> 
          <b>${d.geometry.h.toFixed(1)} —Å–º</b>
      </div>
      <div class="info-row" style="color:#777; font-size:12px;">
          –ù–∞—á–∏–Ω–∫–∞: ${(d.weights.filling / 1000).toFixed(2)} –∫–≥ | –ö—Ä–µ–º: ${(d.weights.coating / 1000).toFixed(2)} –∫–≥
      </div>
    `;

    document.getElementById('stats' + side).innerHTML = html;
    updatePriceDiff();
}

// --- –û–ë–ù–û–í–õ–ï–ù–ò–ï –®–ò–õ–¨–î–ò–ö–ê –†–ê–ó–ù–ò–¶–´ –¶–ï–ù (+/-) ---
function updatePriceDiff() {
    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–µ–∏—Ö —Å—Ç–æ—Ä–æ–Ω
    if (!appState.results.Left || !appState.results.Right) return;

    // 2. –ë–µ—Ä–µ–º –∏—Ç–æ–≥–æ–≤—ã–µ —Ü–µ–Ω—ã
    const pLeft = appState.results.Left.costs.finalPrice;
    const pRight = appState.results.Right.costs.finalPrice;
    
    // 3. –°—á–∏—Ç–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É
    const diff = pRight - pLeft;
    const tag = document.getElementById('priceDiffTag');
    
    if (!tag) return;

    // 4. –û—Ñ–æ—Ä–º–ª—è–µ–º
    if (diff === 0) {
        tag.style.display = 'none'; // –ï—Å–ª–∏ —Ü–µ–Ω—ã —Ä–∞–≤–Ω—ã, —Å–∫—Ä—ã–≤–∞–µ–º
    } else {
        tag.style.display = 'inline-block';
        
        // –ó–Ω–∞–∫ "+" –¥–ª—è –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö —á–∏—Å–µ–ª (–º–∏–Ω—É—Å —Å—Ç–∞–≤–∏—Ç—Å—è —Å–∞–º)
        const sign = diff > 0 ? '+' : ''; 
        
        // –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï: –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã
        const fmtDiff = Math.round(diff).toLocaleString('ru-RU');
        
        tag.innerText = sign + fmtDiff;
        
        // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç (–ó–µ–ª–µ–Ω—ã–π –µ—Å–ª–∏ –¥–µ—à–µ–≤–ª–µ, –ö—Ä–∞—Å–Ω—ã–π –µ—Å–ª–∏ –¥–æ—Ä–æ–∂–µ)
        // –õ–æ–≥–∏–∫–∞: –µ—Å–ª–∏ "–í–∞—à –≤–∞—Ä–∏–∞–Ω—Ç" –¥–æ—Ä–æ–∂–µ –∞–≤—Ç–æ ‚Äî —ç—Ç–æ "–ø–ª—é—Å" –∫ —Ü–µ–Ω–µ (–∫—Ä–∞—Å–Ω—ã–π/–æ–±—ã—á–Ω—ã–π)
        // –ï—Å–ª–∏ –¥–µ—à–µ–≤–ª–µ ‚Äî "–º–∏–Ω—É—Å" (–∑–µ–ª–µ–Ω—ã–π/–≤—ã–≥–æ–¥–∞)
        if (diff > 0) {
            tag.className = 'price-diff diff-plus';  // –°—Ç–∏–ª—å –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —Ü–µ–Ω—ã
        } else {
            tag.className = 'price-diff diff-minus'; // –°—Ç–∏–ª—å –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏
        }
    }
}
      
 

function renderControls() {
    // –†–µ–Ω–¥–µ—Ä–∏–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –û–ë–ï–ò–• –∫–æ–ª–æ–Ω–æ–∫
    renderSideControls('Left');
    renderSideControls('Right');
}

function renderSideControls(side) {
    const containerId = (side === 'Left') ? 'tierControlsLeft' : 'tierControls';
    const c = document.getElementById(containerId);
    if (!c) return;
    c.innerHTML = '';

    const res = appState.results[side];
    if (!res || !res.tiers) return;

    const sourceTiers = (side === 'Left') ? appState.leftTiers : appState.rightTiers;
    const globalShape = res.geometry.shape; 

    res.tiers.forEach((t, idx) => {
        const isGeo = sourceTiers[idx] && sourceTiers[idx].isGeometryMode;

        const grp = document.createElement('div');
        grp.className = 'tier-ctrl-group';
        grp.style.bottom = (10 + idx * 18) + '%'; 

        let html = '';
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
        html += `<div style="margin-bottom:4px; text-align:center;">
             <span style="font-size:10px; font-weight:bold; color:#999; text-transform:uppercase;">–Ø—Ä—É—Å ${idx+1}</span>
        </div>`;

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±—É–∫–≤—É (D –∏–ª–∏ S –∏–ª–∏ L)
        let dLabel = (globalShape === 'square') ? 'S' : 'D';
        if (globalShape === 'rectangle') dLabel = 'L';

        // 1. –î–ò–ê–ú–ï–¢–† / –î–õ–ò–ù–ê (–ö–Ω–æ–ø–∫–∏ –µ—Å—Ç—å –í–°–ï–ì–î–ê)
        html += `
        <div class="ctrl-row">
           <button class="ctrl-btn" onclick="event.stopPropagation(); modifyTier('${side}', ${idx}, 'd', -1)">-</button>
           <span class="ctrl-label" style="color:#1565C0" title="–î–∏–∞–º–µ—Ç—Ä/–î–ª–∏–Ω–∞">${dLabel}: ${Math.round(t.d)}</span>
           <button class="ctrl-btn" onclick="event.stopPropagation(); modifyTier('${side}', ${idx}, 'd', 1)">+</button>
        </div>`;

        // 2. –®–ò–†–ò–ù–ê (–¢–æ–ª—å–∫–æ –¥–ª—è –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞, –∫–Ω–æ–ø–∫–∏ –µ—Å—Ç—å –í–°–ï–ì–î–ê)
        if (globalShape === 'rectangle') {
            html += `
            <div class="ctrl-row">
               <button class="ctrl-btn" onclick="event.stopPropagation(); modifyTier('${side}', ${idx}, 'w', -1)">-</button>
               <span class="ctrl-label" style="color:#1565C0" title="–®–∏—Ä–∏–Ω–∞">W: ${Math.round(t.w)}</span>
               <button class="ctrl-btn" onclick="event.stopPropagation(); modifyTier('${side}', ${idx}, 'w', 1)">+</button>
            </div>`;
        }

        // 3. –í–´–°–û–¢–ê (–ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–µ–∂–∏–º–∞)
        if (isGeo) {
            // –†–µ–∂–∏–º "–ü–æ —Ä–∞–∑–º–µ—Ä—É": –ö–Ω–æ–ø–∫–∏ –ï–°–¢–¨ (–∫—Ä–æ–º–µ —à–∞—Ä–∞)
            if (globalShape !== 'sphere') {
                html += `
                <div class="ctrl-row">
                   <button class="ctrl-btn" onclick="event.stopPropagation(); modifyTier('${side}', ${idx}, 'h', -1)">-</button>
                   <span class="ctrl-label" style="color:#1565C0" title="–í—ã—Å–æ—Ç–∞">H: ${t.h}</span>
                   <button class="ctrl-btn" onclick="event.stopPropagation(); modifyTier('${side}', ${idx}, 'h', 1)">+</button>
                </div>`;
            } else {
                html += `<div style="text-align:center; font-size:10px; color:#1565C0;">H: ${t.h}</div>`;
            }
        } else {
            // –†–µ–∂–∏–º "–ü–æ –≤–µ—Å—É": –ö–Ω–æ–ø–æ–∫ –ù–ï–¢ (–í—ã—Å–æ—Ç–∞ –∞–≤—Ç–æ)
            html += `<div style="text-align:center; font-size:10px; color:#888; margin-top:2px;">H: ${t.h} —Å–º (–∞–≤—Ç–æ)</div>`;
        }

        // 4. –í–ï–° (–ö–Ω–æ–ø–æ–∫ –ù–ï–¢ –ù–ò–ö–û–ì–î–ê, —Ç–æ–ª—å–∫–æ –∏–Ω—Ñ–æ)
        html += `<div style="text-align:center; font-size:10px; color:#555; margin-top:2px; font-weight:bold;">‚öñÔ∏è ${(t.weight/1000).toFixed(2)} –∫–≥</div>`;

        grp.innerHTML = html;
        c.appendChild(grp);
    });
}

// –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ü–ò–°–ö–ê (–¢–ï–•–ö–ê–†–¢–ê) - –ö–û–ú–ü–ê–ö–¢–ù–´–ô –í–ò–î –° –¢–û–ß–ö–ê–ú–ò
function setActiveSide(side) {
    appState.activeSide = side;
    
    // 1. –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏
    document.querySelectorAll('.compare-col').forEach(e => e.classList.remove('active'));
    const col = document.getElementById('col-' + side);
    if(col) col.classList.add('active');
    
    // 2. –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¢–∞–±–æ–≤ (–ú–æ–±–∏–ª—å–Ω—ã–µ)
    document.querySelectorAll('.mobile-tab-btn').forEach(b => b.classList.remove('active'));
    const tabBtn = document.getElementById('tab' + side);
    if(tabBtn) tabBtn.classList.add('active');

    // 3. –û–±–Ω–æ–≤–ª—è–µ–º –ü–ª–∞–≤–∞—é—â–∏–π –§—É—Ç–µ—Ä
    updateStickyFooter(side);

    // 4. –û–¢–†–ò–°–û–í–ö–ê –†–ï–¶–ï–ü–¢–ê
    const res = appState.results[side];
    if (!res) return;

    // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–ø–∏—Å–∫–∞
    const titleEl = document.getElementById('shopListTitle');
    if(titleEl) {
        titleEl.innerHTML = (side === 'Left' ? '–í–∞—Ä–∏–∞–Ω—Ç 1' : '–í–∞—Ä–∏–∞–Ω—Ç 2') + 
                            ` <span style="font-size:12px; color:#999; font-weight:normal;">(–¢–µ—Ö–∫–∞—Ä—Ç–∞)</span>`;
    }

    const container = document.getElementById('shopListContainer');
    container.innerHTML = '';
    container.style.display = 'block'; 

    if (!res.detailedBlocks || res.detailedBlocks.length === 0) {
        container.innerHTML = '<div style="color:#999; text-align:center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
        return;
    }

    // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –ø–µ—Ä–µ–≤–æ–¥–∞ ID -> –ù–æ–º–µ—Ä —è—Ä—É—Å–∞
    const tierMap = {};
    if (res.tiers) {
        res.tiers.forEach((t, index) => {
            tierMap[t.id] = index + 1;
        });
    }

    let html = '';

    res.detailedBlocks.forEach(block => {
        if (!block.ingredients || block.ingredients.length === 0) return;

        let typeClass = 'rv-type-filling';
        // –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —É–±—Ä–∞—Ç—å –∏–∫–æ–Ω–∫–∏, –æ—Å—Ç–∞–≤—å—Ç–µ icon –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π
        let icon = ''; 
        const nameLow = block.name.toLowerCase();

        // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ —Ü–≤–µ—Ç–æ–≤
        if (block.type === 'coating') { typeClass = 'rv-type-coating'; icon = 'üé®'; }
        else if (block.type === 'extra') { typeClass = 'rv-type-extra'; icon = 'üì¶'; }
        else if (nameLow.includes('–±–∏—Å–∫–≤–∏—Ç')) icon = 'üçû';
        else if (nameLow.includes('–∫—Ä–µ–º')) icon = 'ü•£';
        else if (nameLow.includes('–ø—Ä–æ–ø–∏—Ç–∫–∞')) icon = 'üíß';
        else if (nameLow.includes('–∫–æ–Ω—Ñ–∏') || nameLow.includes('–Ω–∞—á–∏–Ω–∫–∞')) icon = 'üçì';

        // –û—á–∏—â–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
        let displayName = block.name;
        displayName = displayName.replace(/–Ø—Ä—É—Å\s+(\d+)/g, (match, id) => {
            return tierMap[id] ? `–Ø—Ä—É—Å ${tierMap[id]}` : match;
        });
        
        let rows = '';
        block.ingredients.forEach(ing => {
            let val = ing.amount;
            let valStr = (val > 10) ? Math.round(val) : parseFloat(val.toFixed(1));
            
            // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–¢–†–û–ö–ò –° –¢–û–ß–ö–ê–ú–ò ---
            rows += `
            <div class="rv-row">
                <div class="rv-name">${ing.name}</div>
                <div class="rv-dots"></div>
                <div class="rv-val">${valStr} ${ing.unit}</div>
            </div>`;
            // ----------------------------------
        });

        html += `
        <div class="recipe-view-card ${typeClass}">
            <div class="rv-header">
                ${icon} <span>${displayName}</span>
            </div>
            <div class="rv-body">
                ${rows}
            </div>
        </div>`;
    });

    container.innerHTML = html;
}


// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ—É—Ç–µ—Ä–∞
function updateStickyFooter(side) {
    const res = appState.results[side];
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ñ—É—Ç–µ—Ä, –µ—Å–ª–∏ –µ—Å—Ç—å (—á—Ç–æ–±—ã –Ω–µ –ø–ª–æ–¥–∏—Ç—å –¥—É–±–ª–∏)
    const old = document.getElementById('mobileStickyFooter');
    if(old) old.remove();
    
    if(!res) return;

    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
    const div = document.createElement('div');
    div.id = 'mobileStickyFooter';
    div.className = 'sticky-footer'; // –ö–ª–∞—Å—Å —Å display:none –¥–ª—è –ü–ö –∏ flex –¥–ª—è –º–æ–±–∞–π–ª
    
    const price = Math.round(res.costs.finalPrice).toLocaleString('ru-RU');
    const weight = (res.weights.total / 1000).toFixed(2);
    const currency = SYMBOLS[currentCurrency] || '';

    div.innerHTML = `
        <div>
            <div class="footer-weight">‚öñÔ∏è ${weight} –∫–≥</div>
            <div class="footer-price">${price} ${currency}</div>
        </div>
        <button class="main-btn" onclick="printTechCard('${side}')" 
                style="width:auto; padding:8px 20px; background:#4CAF50; font-size:14px; margin:0;">
            üßæ –ß–µ–∫
        </button>
    `;
    document.body.appendChild(div);
}

      // --- –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (STOCK, IMPORT –∏ —Ç.–¥.) –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ---
function renderStockTable() {
    const tb = document.getElementById('stockTableBody');
    if (!tb) return;
    
    tb.innerHTML = '';
    const search = document.getElementById('stockSearch').value.toLowerCase().trim();

    // 1. –ú–∞–ø–ø–∏–Ω–≥
    let list = myIngredients.map((item, index) => ({ data: item, originalIndex: index }));

    // 2. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ü–û–ò–°–ö
    list = list.filter(wrapper => wrapper.data.name.toLowerCase().includes(search));

    // 3. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ü–û–õ–ö–ò (–ù–û–í–û–ï!)
    if (currentStockShelf !== 'all') {
        list = list.filter(wrapper => {
            const cat = wrapper.data.category || 'food'; // –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç, —Å—á–∏—Ç–∞–µ–º –ü—Ä–æ–¥—É–∫—Ç–æ–º
            return cat === currentStockShelf;
        });
    }

    // 4. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    list.sort((a, b) => {
        let valA = a.data[stockSort.field];
        let valB = b.data[stockSort.field];
        if (typeof valA === 'string') valA = valA.toLowerCase();
        if (typeof valB === 'string') valB = valB.toLowerCase();
        if (stockSort.field === 'packPrice' || stockSort.field === 'stock') {
             valA = parseFloat(valA) || 0; valB = parseFloat(valB) || 0;
        }
        if (valA < valB) return stockSort.dir === 'asc' ? -1 : 1;
        if (valA > valB) return stockSort.dir === 'asc' ? 1 : -1;
        return 0;
    });

    // 5. –†–µ–Ω–¥–µ—Ä
    list.forEach(wrapper => {
        const i = wrapper.data;
        const x = wrapper.originalIndex;

        const stockVal = i.stock || 0;
        let stockStyle = 'font-weight:bold; text-align:center; width:80px;';
        if (stockVal < 0) stockStyle += ' background:#ffebee; color:#d32f2f; border:1px solid #ef9a9a;';
        else if (stockVal < (i.packWeight * 0.2)) stockStyle += ' background:#fffde7; color:#f57f17;'; 
        else stockStyle += ' background:#e8f5e9; color:#2e7d32;';

        const disabledAttr = isInventoryMode ? '' : 'disabled';
        const opacityStyle = isInventoryMode ? '' : 'opacity:0.8; cursor:not-allowed;';
        
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        const isPack = (i.category === 'pack');
        
        tb.innerHTML += `<tr>
         

<td style="display: flex; align-items: center; gap: 5px; padding: 5px;">
     <select onchange="updIng(${x}, 'category', this.value); renderStockTable();" 
             style="font-size: 16px; border: none; background: transparent; cursor: pointer; width: 30px; padding: 0; appearance: none; -webkit-appearance: none; text-align: center;" 
             title="–°–º–µ–Ω–∏—Ç—å –ø–æ–ª–∫—É">
         <option value="food" ${!isPack ? 'selected' : ''}>üçé</option>
         <option value="pack" ${isPack ? 'selected' : ''}>üì¶</option>
     </select>
     
     <input value="${i.name}" onchange="updIng(${x},'name',this.value)" style="flex: 1; min-width: 0;">
</td>
          
          <td><select onchange="updIng(${x},'unit',this.value); renderStockTable();">
            <option value="–≥" ${i.unit==='–≥'?'selected':''}>–≥</option>
            <option value="—à—Ç" ${i.unit==='—à—Ç'?'selected':''}>—à—Ç</option>
            <option value="–º–ª" ${i.unit==='–º–ª'?'selected':''}>–º–ª</option>
            <option value="—Å–º" ${i.unit==='—Å–º'?'selected':''}>—Å–º</option>
            <option value="–º" ${i.unit==='–º'?'selected':''}>–º</option>
          </select></td>
          
          <td><input type="number" value="${i.singleWeight || (i.unit === '—à—Ç' ? 0 : 1)}" 
                 onchange="updIng(${x},'singleWeight',this.value)"
                 style="font-weight:bold; color:${i.unit==='—à—Ç' ? '#E65100' : '#ccc'}; background:${i.unit==='—à—Ç' ? '#fff' : '#eee'};" 
                 ${i.unit !== '—à—Ç' ? 'disabled' : ''}>
          </td>
          
          <td style="text-align:center;">
             <input type="checkbox" ${i.useWeightInRecipe ? 'checked' : ''} 
                    onchange="updIng(${x},'useWeightInRecipe',this.checked)"
                    ${i.unit !== '—à—Ç' ? 'disabled' : ''}>
          </td>

          <td class="col-kbju"><input type="number" value="${i.p||0}" onchange="updIng(${x},'p',this.value)"></td>
          <td class="col-kbju"><input type="number" value="${i.f||0}" onchange="updIng(${x},'f',this.value)"></td>
          <td class="col-kbju"><input type="number" value="${i.c||0}" onchange="updIng(${x},'c',this.value)"></td>
          <td class="col-kbju"><input type="number" value="${i.k||0}" onchange="updIng(${x},'k',this.value)"></td>

          <td><input type="text" value="${parseFloat(i.packWeight||0).toLocaleString('ru-RU')}" onchange="updIng(${x},'packWeight',this.value)" style="text-align:right;"></td>
          <td><input type="text" value="${parseFloat(i.packPrice||0).toLocaleString('ru-RU')}" onchange="updIng(${x},'packPrice',this.value)" style="text-align:right;"></td>

          <td style="color:#888; font-size:11px; text-align:right;">
              ${(i.packPrice/i.packWeight).toLocaleString('ru-RU', {maximumFractionDigits: 1})}
          </td>
          
          <td>
            <input type="text" value="${parseFloat(stockVal).toLocaleString('ru-RU')}" 
                   onchange="updIng(${x},'stock',this.value)" 
                   style="${stockStyle} ${opacityStyle} text-align:right;" 
                   ${disabledAttr}>
          </td>

          <td><button class="del-btn" onclick="delIng(${x})">‚úï</button></td>
        </tr>`;
    });
    
    updateSortArrows('stock');
}

     
      function toggleNewWeightInput() {
          const u = document.getElementById('newIngUnit').value;
          const inp = document.getElementById('newIngSingleWeight');
          if (u === '—à—Ç') { inp.disabled = false; inp.style.background = '#fff'; inp.value = ''; } else { inp.disabled = true; inp.style.background = '#eee'; inp.value = '1'; }
      }
 function updIng(x, f, v) { 
    // –î–æ–±–∞–≤–∏–ª–∏ 'stock' –≤ —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫, —á—Ç–æ–±—ã –æ–Ω —Ç–æ–∂–µ –æ—á–∏—â–∞–ª—Å—è –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤
    const numFields = ['packWeight', 'packPrice', 'singleWeight', 'p', 'f', 'c', 'k', 'stock'];
    
    if (numFields.includes(f)) {
        // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ –º–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—É—é –Ω–∞ —Ç–æ—á–∫—É
        let cleanVal = String(v).replace(/\s/g, '').replace(/\u00A0/g, '').replace(',', '.');
        myIngredients[x][f] = parseFloat(cleanVal) || 0;
    } else {
        myIngredients[x][f] = v;
    }
    
    saveIngs(); 
    saveToHistory(); 
}
function delIng(x) { 
    if (confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç —Å–æ —Å–∫–ª–∞–¥–∞?')) {
        myIngredients.splice(x, 1); 
        saveIngs(); 
        renderStockTable();
        saveToHistory(); 
    }
}
      // --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï –î–û–ë–ê–í–õ–ï–ù–ò–ï –ò–ù–ì–†–ï–î–ò–ï–ù–¢–û–í ---
function addNewIngredient() {
    // 1. –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—è (–¥–æ–±–∞–≤–ª–µ–Ω—ã —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ω–æ–≤—ã–µ ID)
    const nameInput = document.getElementById('newIngName');
    const unitInput = document.getElementById('newIngUnit');
    const packInput = document.getElementById('newIngPack');
    const priceInput = document.getElementById('newIngPrice');
    const singleInput = document.getElementById('newIngSingleWeight');
    const catInput = document.getElementById('newIngCat');
    
    // –ù–æ–≤—ã–µ –ø–æ–ª—è –ö–ë–ñ–£
    const pInput = document.getElementById('newIngP');
    const fInput = document.getElementById('newIngF');
    const cInput = document.getElementById('newIngC');
    const kInput = document.getElementById('newIngK');
    const useWeightInput = document.getElementById('newIngUseWeight');

    // 2. –î–æ—Å—Ç–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
    const n = nameInput.value.trim();
    const u = unitInput.value;
    const packStr = packInput.value.replace(',', '.');
    const priceStr = priceInput.value.replace(',', '.');
    const singleStr = singleInput.value.replace(',', '.');

    const pack = parseFloat(packStr);
    const price = parseFloat(priceStr);
    
    // –°—á–∏—Ç—ã–≤–∞–µ–º –ö–ë–ñ–£ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–º–µ–Ω—É –∑–∞–ø—è—Ç–æ–π –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
    const p = parseFloat((pInput.value || "0").replace(',', '.'));
    const f = parseFloat((fInput.value || "0").replace(',', '.'));
    const c = parseFloat((cInput.value || "0").replace(',', '.'));
    const k = parseFloat((kInput.value || "0").replace(',', '.'));

    // 3. –ü—Ä–æ–≤–µ—Ä–∫–∏ (–í–∞–ª–∏–¥–∞—Ü–∏—è)
    if (!n) { alert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞!'); return; }
    if (isNaN(pack) || pack <= 0) { alert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –≤–µ—Å —É–ø–∞–∫–æ–≤–∫–∏!'); return; }
    if (isNaN(price) || price < 0) { alert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É!'); return; }

    // 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ—Å–∞ 1 —à—Ç—É–∫–∏ (–í–∞—à–∞ –ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞)
    let single = 1;
    if (u === '—à—Ç') {
        const sVal = parseFloat(singleStr);
        single = (isNaN(sVal) || sVal < 0) ? 0 : sVal;
    }

    // 5. –î–æ–±–∞–≤–ª—è–µ–º –≤ –±–∞–∑—É (–°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é)
    saveToHistory();
    myIngredients.push({
        id: 'i' + Date.now(), 
        name: n,
        category: catInput.value,
        unit: u, 
        singleWeight: single,
        useWeightInRecipe: useWeightInput.checked,
        packWeight: pack, 
        packPrice: price,
        p: p, f: f, c: c, k: k // –ù–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –æ–±—ä–µ–∫—Ç
       
    }); 

    // 6. –û—á–∏—â–∞–µ–º –ø–æ–ª—è (–í—Å–µ, –≤–∫–ª—é—á–∞—è –ö–ë–ñ–£)
    nameInput.value = ''; 
    packInput.value = ''; 
    priceInput.value = ''; 
    pInput.value = '';
    fInput.value = '';
    cInput.value = '';
    kInput.value = '';
    if(singleInput) singleInput.value = (u === '—à—Ç' ? '' : '1');

    // 7. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º
    saveIngs(); 
    saveToHistory();
    useWeightInput.checked = false;
}
// --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï –î–û–ë–ê–í–õ–ï–ù–ò–ï –†–ê–ë–û–¢ ---
// --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï –î–û–ë–ê–í–õ–ï–ù–ò–ï –†–ê–ë–û–¢ ---
function addNewLabor() {
    const nameInput = document.getElementById('newLaborName');
    const coeffInput = document.getElementById('newLaborCoeff');
    const timeInput = document.getElementById('newLaborTime');
    const helperInput = document.getElementById('newLaborHelper');
    const autoInput = document.getElementById('newLaborAuto');
    
    const n = nameInput.value.trim();
    const cStr = coeffInput.value.replace(',', '.');
    const tStr = timeInput.value.replace(',', '.');
    
    let c = parseFloat(cStr);
    let t = parseFloat(tStr);

    if (!n) {
        alert("‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä '–õ–µ–ø–∫–∞')!");
        return;
    }
    
    // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ –≤–≤–µ–¥–µ–Ω—ã –∏–ª–∏ –≤–≤–µ–¥–µ–Ω—ã –∫—Ä–∏–≤–æ, —Å—Ç–∞–≤–∏–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
    if (isNaN(c) || c <= 0) c = 1.0;
    if (isNaN(t) || t < 0) t = 0;

    myLaborServices.push({ 
        id: 'l' + Date.now(), 
        name: n, 
        coeff: c,
        defaultTime: t,
        isHelper: helperInput.checked,
        isAuto: autoInput.checked
    });
    
    // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
    nameInput.value = '';
    coeffInput.value = ''; 
    timeInput.value = '';
    helperInput.checked = false;
    autoInput.checked = false;
    
    saveLabor();
    renderLaborTable(); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Ä–∞–±–æ—Ç
    saveToHistory();
}
    function saveIngs() { 
    localStorage.setItem('myCakeIngredients', JSON.stringify(myIngredients)); 
    saveToCloud('ingredients', myIngredients); // <--- –ù–û–í–ê–Ø –°–¢–†–û–ö–ê
    updateUI(); 
}

    function renderRecipesList() {
    const c = document.getElementById('recipesListContainer');
    c.innerHTML = '';
    
    // 1. –ü–æ–ª—É—á–∞–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
    const search = document.getElementById('recipeSearch').value.toLowerCase().trim();
    
    // 2. –§–∏–ª—å—Ç—Ä—É–µ–º –∏ –°–æ—Ä—Ç–∏—Ä—É–µ–º
    const filtered = myRecipes.filter(r => {
        // –§–∏–ª—å—Ç—Ä –ø–æ –¢–∏–ø—É (–¢–æ—Ä—Ç—ã, –ö—Ä–µ–º—ã...)
        if (currentRecFilter !== 'all') {
            // –ù—é–∞–Ω—Å: 'extra' (–í–µ–ª—é—Ä) —Ç–æ–∂–µ –æ—Ç–Ω–µ—Å–µ–º –∫ –∫—Ä–µ–º–∞–º –∏–ª–∏ –¥–µ–∫–æ—Ä—É? 
            // –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º —Å—Ç—Ä–æ–≥–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ, –Ω–æ –º–æ–∂–Ω–æ —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å.
            if (currentRecFilter === 'coating' && (r.type === 'coating' || r.type === 'extra')) return true; // –ö—Ä–µ–º—ã + –í–µ–ª—é—Ä –≤–º–µ—Å—Ç–µ
            if (r.type !== currentRecFilter) return false;
        }
        return true;
    }).filter(r => {
        // –§–∏–ª—å—Ç—Ä –ø–æ –ü–æ–∏—Å–∫—É (–ù–∞–∑–≤–∞–Ω–∏–µ)
        return r.name.toLowerCase().includes(search);
    }).sort((a, b) => {
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ê-–Ø
        return a.name.localeCompare(b.name);
    });

    // 3. –†–∏—Å—É–µ–º
    if (filtered.length === 0) {
        c.innerHTML = `<div style="text-align:center; color:#999; font-size:12px; padding:20px;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ü§∑‚Äç‚ôÇÔ∏è</div>`;
        return;
    }

    filtered.forEach(r => {
        const d = document.createElement('div');
        d.className = 'recipe-item ' + (r.id === activeRecId ? 'active' : '');
        
        let typeName = '–¢–æ—Ä—Ç';
        let typeColor = '#E3F2FD; color:#1565C0'; 

        if (r.type === 'coating') { typeName = '–ö—Ä–µ–º'; typeColor = '#FBE9E7; color:#D84315'; }
        else if (r.type === 'extra') { typeName = '–ü–æ–∫—Ä.'; typeColor = '#F3E5F5; color:#7B1FA2'; } 
        else if (r.type === 'decor') { typeName = '–î–µ–∫–æ—Ä'; typeColor = '#FCE4EC; color:#C2185B'; }

        d.innerHTML = `
            <div style="font-weight:600;">${r.name}</div>
            <div style="font-size:10px; padding:2px 6px; border-radius:4px; background:${typeColor}; white-space:nowrap;">${typeName}</div>
        `;
        d.style.display = 'flex';
        d.style.justifyContent = 'space-between';
        d.style.alignItems = 'center';

        // --- –õ–û–ì–ò–ö–ê LONG PRESS ---
        let pressTimer;
        d.ontouchstart = (e) => {
            pressTimer = setTimeout(() => {
                showRecipeContextMenu(e, r.id);
            }, 600); // 0.6 —Å–µ–∫ —É–¥–µ—Ä–∂–∞–Ω–∏—è
        };
        d.ontouchend = () => clearTimeout(pressTimer);
        d.ontouchmove = () => clearTimeout(pressTimer);
        
        // –û–±—ã—á–Ω—ã–π –∫–ª–∏–∫
        d.onclick = () => { loadRec(r.id); };
        
        c.appendChild(d);
    });
}
      // --- 1. –ó–ê–ì–†–£–ó–ö–ê –†–ï–¶–ï–ü–¢–ê (–° –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º 70%) ---
function loadRec(id){
    activeRecId = id; 
    renderRecipesList();
    document.getElementById('recipePlaceholder').style.display = 'none'; 
    document.getElementById('recipeEditor').style.display = 'block';
    const layout = document.querySelector('.recipe-layout');
    if (layout) layout.classList.add('mobile-view-active');
    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–≤–µ—Ä—Ö, —á—Ç–æ–±—ã —Å—Ä–∞–∑—É –≤–∏–¥–µ—Ç—å –Ω–∞—á–∞–ª–æ —Ä–µ—Ü–µ–ø—Ç–∞
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    const r = myRecipes.find(x => x.id === id);
    if(!r) return;

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
    document.getElementById('editRecName').value = r.name; 
    document.getElementById('editRecType').value = r.type;
    document.getElementById('editRecOutput').value = r.outputWeight || ''; 
    document.getElementById('calibDiam').value = r.calibrationD || 16; 
    document.getElementById('calibHeight').value = r.calibrationH || 10;
    document.getElementById('calibShape').value = r.calibrationShape || 'cylinder';
    // –í–ê–ñ–ù–û: –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è (–¥–ª—è –ë–æ–º–±)
    document.getElementById('calibFill').value = r.fillPercent || 100;
    
    // –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    updateRecTypeUI();
    
    // –õ–æ–≥–∏–∫–∞ –≥–∞–ª–æ—á–∫–∏ –≤–µ—Å–∞
    const chk = document.getElementById('chkFinishedWeight');
    // –ì–∞–ª–æ—á–∫–∞ —Å—Ç–æ–∏—Ç, –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –≤–µ—Å –∑–∞–¥–∞–Ω –∏ –æ–Ω –±–æ–ª—å—à–µ 0
    chk.checked = (r.targetFinishedWeight && r.targetFinishedWeight > 0);
    document.getElementById('editTargetFinWeight').value = r.targetFinishedWeight || '';
    toggleFinishedWeight(false); // false = –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–∏—Ç—å UI

    renderBlocks(r);
  setRecipeLockState(true);
}


// --- 2. –û–¢–†–ò–°–û–í–ö–ê –ë–õ–û–ö–û–í (–ò–°–ü–†–ê–í–õ–ï–ù–û –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –í–ï–°–ê) ---
function renderBlocks(r) {
    const c = document.getElementById('blocksContainer'); 
    c.innerHTML = ''; 
    
    let totRaw = 0; 
    let totReady = 0; // –°—á–∏—Ç–∞–µ–º –∏ –≥–æ—Ç–æ–≤—ã–π –≤–µ—Å —Ç–æ–∂–µ

    const blocks = r.blocks || [];

    blocks.forEach((b, bx) => {
        let rows = '';
        
        const ings = b.ingredients || [];

        ings.forEach((l, ix) => {
            const ing = myIngredients.find(i => i.id === l.id);
            const val = parseFloat(l.weight) || 0;
            const outVal = l.outputWeight ? parseFloat(l.outputWeight) : val; // –ï—Å–ª–∏ –≤—ã—Ö–æ–¥–∞ –Ω–µ—Ç, –æ–Ω —Ä–∞–≤–µ–Ω –≤—Ö–æ–¥—É
            
            let weightInGrams = val;
            let readyWeightInGrams = outVal;

            // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —à—Ç—É–∫ –≤ –≥—Ä–∞–º–º—ã –¥–ª—è –∏—Ç–æ–≥–∞
            if (ing && ing.unit === '—à—Ç') {
                const useWeightMode = ing.useWeightInRecipe === true || ing.useWeightInRecipe === "true";
                if (useWeightMode) {
                    weightInGrams = val;
                    readyWeightInGrams = outVal;
                } else {
                    const single = ing.singleWeight || 0;
                    weightInGrams = val * single;
                    // –ï—Å–ª–∏ —É–≤–∞—Ä–∫–∞ –∑–∞–¥–∞–Ω–∞ –¥–ª—è —à—Ç—É–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∂–µ–ª—Ç–∫–∏), —Å—á–∏—Ç–∞–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏—é, –∏–Ω–∞—á–µ –±–µ—Ä–µ–º —Å—ã—Ä–æ–π –≤–µ—Å
                    readyWeightInGrams = l.outputWeight ? (outVal * single) : weightInGrams; 
                }
            }
            
            totRaw += weightInGrams;
            totReady += readyWeightInGrams;
            
            const n = ing ? ing.name : (l.id === '' ? '' : '??? (–£–¥–∞–ª–µ–Ω)');
            
            // –°—Ç–∏–ª—å –¥–ª—è –ø–æ–ª—è –≤—ã—Ö–æ–¥–∞ (–µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –≤—Ö–æ–¥–∞ - –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º)
            const isReduced = l.outputWeight && l.outputWeight < val;
            const outStyle = isReduced 
                ? "border:1px solid #FFCC80; background:#FFF3E0; color:#E65100; font-weight:bold;" 
                : "border:1px solid #eee; color:#666;";

            rows += `
            <div class="ing-row" style="display: grid; grid-template-columns: 2fr 0.8fr 0.8fr 30px; gap: 5px;">
                <input class="ing-search-input" list="allIngsDatalist" value="${n}" placeholder="–ü—Ä–æ–¥—É–∫—Ç" onchange="resIng(this,${bx},${ix})">
                
                <input type="number" class="ing-weight" value="${l.weight}" step="0.1" placeholder="–í—Ö–æ–¥" title="–°—ã—Ä–æ–π –≤–µ—Å" onchange="updBI(${bx},${ix},this.value)">
                
                <input type="number" value="${l.outputWeight || ''}" step="0.1" placeholder="=" title="–í—ã—Ö–æ–¥ (–≥–æ—Ç–æ–≤—ã–π –≤–µ—Å). –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è." 
                       style="${outStyle} border-radius:4px; padding:5px; width:100%;" 
                       onchange="updBIOutput(${bx},${ix},this.value)">
                
                <button class="del-btn" onclick="delBI(${bx},${ix})">‚úï</button>
            </div>`;
        });

        const div = document.createElement('div'); 
        div.className = 'recipe-block';
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">
                <input style="border:none; font-weight:bold; color:#1976D2; font-size:14px; width:80%;" value="${b.name}" onchange="updBN(${bx},this.value)" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–æ—è">
                <button class="del-btn" style="font-size:12px;" onclick="delBlk(${bx})">üóëÔ∏è</button>
            </div>
            
            <div style="display:flex; font-size:10px; color:#999; margin-bottom:5px; padding-left:5px;">
                <span style="flex:2;">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</span>
                <span style="flex:0.8;">–í—Ö–æ–¥</span>
                <span style="flex:0.8;">–í—ã—Ö–æ–¥</span>
                <span style="width:30px;"></span>
            </div>

            ${rows}
            <div style="margin-top:10px; text-align:center;">
                <button class="add-btn-small" onclick="addBI(${bx})">+ –°—Ç—Ä–æ–∫–∞</button>
            </div>`;
        c.appendChild(div);
    });
    
    // –ò–Ω—Ñ–æ –ø–æ –æ–±—â–µ–º—É –≤–µ—Å—É
    const outputWeight = parseFloat(document.getElementById('editRecOutput').value) || 0; 
    
    const infoEl = document.getElementById('recTotalWeightInfo');
    const lossEl = document.getElementById('lossInfo');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º: –°—ã—Ä–æ–π -> –ì–æ—Ç–æ–≤—ã–π
    infoEl.innerHTML = `${Math.round(totRaw).toLocaleString()} –≥ <span style="color:#999;">‚ûú</span> <span style="color:#2E7D32;">${Math.round(totReady).toLocaleString()} –≥</span>`;
    
    // –°—á–∏—Ç–∞–µ–º –ø–æ—Ç–µ—Ä–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –í–í–ï–î–ï–ù–ù–û–ì–û –≤ —Ä–µ—Ü–µ–ø—Ç–µ "–í—ã—Ö–æ–¥–∞ –ø–∞—Ä—Ç–∏–∏" (–µ—Å–ª–∏ –æ–Ω –∑–∞–¥–∞–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)
    if (outputWeight > 0) {
        const diff = totReady - outputWeight; // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ä–∞—Å—á–µ—Ç–Ω—ã–π –≥–æ—Ç–æ–≤—ã–π —Å —ç—Ç–∞–ª–æ–Ω–Ω—ã–º –≥–æ—Ç–æ–≤—ã–º
        if (Math.abs(diff) > 5) {
             lossEl.innerHTML = ` (–†–∞—Å—á–µ—Ç –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –≠—Ç–∞–ª–æ–Ω–∞ –Ω–∞ ${Math.round(diff)}–≥)`;
             lossEl.style.color = "orange";
        } else {
             lossEl.innerHTML = ` (–°–æ–≤–ø–∞–¥–∞–µ—Ç —Å —ç—Ç–∞–ª–æ–Ω–æ–º)`;
             lossEl.style.color = "green";
        }
    } else {
        lossEl.innerHTML = "";
    }
}

// --- 3. –ì–ê–õ–û–ß–ö–ê –í–ï–°–ê (–° –§–ò–ö–°–ê–¶–ò–ï–ô –°–ù–Ø–¢–ò–Ø) ---
function toggleFinishedWeight(doSave = true) {
    const chk = document.getElementById('chkFinishedWeight');
    const div = document.getElementById('divFinWeight');
    const inp = document.getElementById('editTargetFinWeight');
    
    if (chk.checked) {
        div.style.display = 'flex';
    } else {
        div.style.display = 'none';
        inp.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ
        
        // –ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ï—Å–ª–∏ –º—ã —Å–Ω—è–ª–∏ –≥–∞–ª–æ—á–∫—É, –Ω—É–∂–Ω–æ –°–†–ê–ó–£ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç—Ç–æ –≤ –±–∞–∑—É,
        // –∏–Ω–∞—á–µ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –≤–µ—Ä–Ω–µ—Ç—Å—è —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.
        if (doSave && activeRecId) {
            saveMeta();
        }
    }
}
      function saveMeta(){saveToHistory();
    const r = myRecipes.find(x => x.id === activeRecId);
    r.name = document.getElementById('editRecName').value; 
    r.type = document.getElementById('editRecType').value;
    r.outputWeight = parseFloat(document.getElementById('editRecOutput').value) || ''; 
    r.calibrationD = parseFloat(document.getElementById('calibDiam').value);
    if (document.getElementById('calibShape').value === 'sphere') {
        r.calibrationH = r.calibrationD; 
    } else {
        r.calibrationH = parseFloat(document.getElementById('calibHeight').value);
    }
    r.calibrationShape = document.getElementById('calibShape').value;
    // !!! –í–û–¢ –≠–¢–ê –°–¢–†–û–ö–ê –í–ê–ñ–ù–ê !!!
    r.fillPercent = parseFloat(document.getElementById('calibFill').value) || 100; 
    
    // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ (–≤–µ—Å –≥–æ—Ç–æ–≤–æ–≥–æ —Ç–æ—Ä—Ç–∞ –∏ —Ç.–¥.)
    const useFin = document.getElementById('chkFinishedWeight').checked;
    r.targetFinishedWeight = useFin ? (parseFloat(document.getElementById('editTargetFinWeight').value)||0) : null;
    
    saveRecs(); 
}
      // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–µ—Ü–µ–ø—Ç–æ–≤ (resIng, updBI, delBI, addBI, addBlock, delBlk, updBN, createNew, delete)
      // --- –£–ú–ù–´–ô –ü–û–ò–°–ö –ò–ù–ì–†–ï–î–ò–ï–ù–¢–ê –° –ü–ï–†–ï–•–û–î–û–ú –ù–ê –°–ö–õ–ê–î ---
function resIng(el, b, i) {
    const rawName = el.value.trim();
    if (!rawName) return; 

    // –ò—â–µ–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç (–±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞)
    const found = myIngredients.find(x => x.name.toLowerCase() === rawName.toLowerCase());

    if (found) {
      saveToHistory();
        // –ù–∞—à–ª–∏ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º ID
        const r = myRecipes.find(x => x.id === activeRecId);
        r.blocks[b].ingredients[i].id = found.id;
        el.value = found.name; // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä (–º—É–∫–∞ -> –ú—É–∫–∞)
        saveRecs();
    } else {
        // –ù–ï –ù–ê–®–õ–ò - –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –¥–æ–±–∞–≤–∏—Ç—å
        if (confirm(`‚ö†Ô∏è –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç "${rawName}" –Ω–µ –Ω–∞–π–¥–µ–Ω!\n\n–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –°–∫–ª–∞–¥, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –µ–≥–æ —Å–µ–π—á–∞—Å?`)) {
            // 1. –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∫–ª–∞–¥–∫—É
            switchTab('stock');
            
            // 2. –í–ø–∏—Å—ã–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ –ø–æ–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
            const nameInput = document.getElementById('newIngName');
            if (nameInput) {
                nameInput.value = rawName;
                nameInput.focus();
                nameInput.scrollIntoView({behavior: "smooth", block: "center"});
            }
        }
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤ —Ä–µ—Ü–µ–ø—Ç–µ, —á—Ç–æ–±—ã –Ω–µ –≤–∏—Å–µ–ª "–ø—Ä–∏–∑—Ä–∞–∫"
        el.value = '';
        const r = myRecipes.find(x => x.id === activeRecId);
        r.blocks[b].ingredients[i].id = "";
        saveRecs();
    }
}
      // --- –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –†–ï–¶–ï–ü–¢–û–ú (–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï) ---

// 1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç
function createNewRecipe() {
    saveToHistory();
    const id = 'r' + Date.now();
    // –°–æ–∑–¥–∞–µ–º –±–æ–ª–≤–∞–Ω–∫—É
    myRecipes.push({
        id: id,
        name: '–ù–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç',
        type: 'filling',
        blocks: [{ name: '–û—Å–Ω–æ–≤–∞', ingredients: [] }],
        ingredients: [] // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º
    });
    
    saveRecs(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ç–∞–±–ª–∏—Ü—É
    loadRec(id); // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
    
    // –î–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ: —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —ç–∫—Ä–∞–Ω —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    const layout = document.querySelector('.recipe-layout');
    if (layout) layout.classList.add('mobile-view-active');
}

// 2. –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç
function duplicateRecipe() {
    if (!activeRecId) return;
    
    const src = myRecipes.find(r => r.id === activeRecId);
    if (!src) return;

    saveToHistory();
    // –î–µ–ª–∞–µ–º –≥–ª—É–±–æ–∫—É—é –∫–æ–ø–∏—é –æ–±—ä–µ–∫—Ç–∞
    const copy = JSON.parse(JSON.stringify(src));
    copy.id = 'r' + Date.now();
    copy.name = copy.name + ' (–ö–æ–ø–∏—è)';
    
    myRecipes.push(copy);
    saveRecs();
    loadRec(copy.id);
    
    // –î–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ
    const layout = document.querySelector('.recipe-layout');
    if (layout) layout.classList.add('mobile-view-active');
}

// --- –•–µ–ª–ø–µ—Ä—ã –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ—Å—Ç–∞–≤–∞ ---

// –î–æ–±–∞–≤–∏—Ç—å –ë–ª–æ–∫ (–°–ª–æ–π)
function addBlock() {
    const r = myRecipes.find(x => x.id === activeRecId);
    if (!r) return;
    
    saveToHistory();
    if (!r.blocks) r.blocks = [];
    r.blocks.push({ name: '–ù–æ–≤—ã–π —Å–ª–æ–π', ingredients: [] });
    
    saveRecs();
    renderBlocks(r); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞
}

// –£–¥–∞–ª–∏—Ç—å –ë–ª–æ–∫
function delBlk(bIndex) {
    const r = myRecipes.find(x => x.id === activeRecId);
    if (!r) return;
    
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±–ª–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤?')) {
        saveToHistory();
        r.blocks.splice(bIndex, 1);
        saveRecs();
        renderBlocks(r);
    }
}

// –î–æ–±–∞–≤–∏—Ç—å –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç (—Å—Ç—Ä–æ–∫—É) –≤ –±–ª–æ–∫
function addBI(bIndex) {
    const r = myRecipes.find(x => x.id === activeRecId);
    if (!r) return; // –í–æ—Ç —Ç—É—Ç –±—ã–ª–∞ –æ—à–∏–±–∫–∞ undefined
    if (!r.blocks[bIndex]) return;

    saveToHistory();
    // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤–∞ ingredients –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º
    if (!r.blocks[bIndex].ingredients) r.blocks[bIndex].ingredients = [];
    
    r.blocks[bIndex].ingredients.push({ id: '', weight: 0 });
    
    saveRecs();
    renderBlocks(r);
}

// –£–¥–∞–ª–∏—Ç—å –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
function delBI(bIndex, iIndex) {
    const r = myRecipes.find(x => x.id === activeRecId);
    if (!r) return;

    saveToHistory();
    r.blocks[bIndex].ingredients.splice(iIndex, 1);
    
    saveRecs();
    renderBlocks(r);
}


// –û–±–Ω–æ–≤–∏—Ç—å –≤–µ—Å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞
function updBI(bIndex, iIndex, val) {
    const r = myRecipes.find(x => x.id === activeRecId);
    if (!r) return;

    // –°–ù–ê–ß–ê–õ–ê —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é (–¥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–µ—Å–∞)
    saveToHistory();

    // –ó–∞–º–µ–Ω–∞ –∑–∞–ø—è—Ç–æ–π –Ω–∞ —Ç–æ—á–∫—É –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
    let num = parseFloat(String(val).replace(',', '.'));
    if (isNaN(num)) num = 0;
    
    r.blocks[bIndex].ingredients[iIndex].weight = num;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–º—è—Ç—å –∏ –æ–±–ª–∞–∫–æ
    localStorage.setItem('myCakeRecipes', JSON.stringify(myRecipes)); 
    saveToCloud('recipes', myRecipes); 
    
    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é (—á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏–ª–∏—Å—å –∏—Ç–æ–≥–∏)
    renderBlocks(r); 
}

     function updBIOutput(bIndex, iIndex, val) {
    const r = myRecipes.find(x => x.id === activeRecId);
    if (!r) return;
    
    saveToHistory();
    
    // –ï—Å–ª–∏ –ø—É—Å—Ç–æ –∏–ª–∏ 0 - —É–¥–∞–ª—è–µ–º —Å–≤–æ–π—Å—Ç–≤–æ, —á—Ç–æ–±—ã —ç–∫–æ–Ω–æ–º–∏—Ç—å –ø–∞–º—è—Ç—å
    if (!val || parseFloat(val) === 0) {
        delete r.blocks[bIndex].ingredients[iIndex].outputWeight;
    } else {
        // –ó–∞–º–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—É—é –Ω–∞ —Ç–æ—á–∫—É
        r.blocks[bIndex].ingredients[iIndex].outputWeight = parseFloat(val.replace(',', '.'));
    }
    
    saveRecs();
    renderBlocks(r); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏
}

// –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞
function updBN(bIndex, val) {
    const r = myRecipes.find(x => x.id === activeRecId);
    if (!r) return;
    
    r.blocks[bIndex].name = val;
    saveRecs();
}

     
     
      function deleteCurrentRecipe(){ 
    saveToHistory();
    if(confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–µ—Ü–µ–ø—Ç?')){
        myRecipes = myRecipes.filter(x => x.id !== activeRecId);
        activeRecId = null;
        saveRecs();
        
        // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
        document.getElementById('recipeEditor').style.display = 'none';
        document.getElementById('recipePlaceholder').style.display = 'flex';
        
        renderRecipesList();
        
        // --- –ú–û–ë–ò–õ–¨–ù–´–ô –í–û–ó–í–†–ê–¢ ---
        closeRecipeMobile(); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É
    }
}
      
      function saveRecs() { 
    saveToHistory(); 
    localStorage.setItem('myCakeRecipes', JSON.stringify(myRecipes)); 
    saveToCloud('recipes', myRecipes); // <--- –ù–û–í–ê–Ø –°–¢–†–û–ö–ê
    updateUI(); 
}
      
      // Extras & Labor & Finance & Print & Queue - –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏–π –æ—Å—Ç–∞—é—Ç—Å—è (–æ–Ω–∏ –µ—Å—Ç—å –≤—ã—à–µ –≤ –∫–æ–¥–µ –∏–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ)
      function loadFinance() { document.getElementById('finTax').value = localStorage.getItem('cakeFinTax')||3; document.getElementById('finBank').value = localStorage.getItem('cakeFinBank')||1; document.getElementById('finOverhead').value = localStorage.getItem('cakeFinOverhead')||5; }
      // --- –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò –§–ò–ù–ê–ù–°–û–í ---

function saveFinance() { 
    localStorage.setItem('cakeFinTax', document.getElementById('finTax').value); 
    localStorage.setItem('cakeFinBank', document.getElementById('finBank').value); 
    localStorage.setItem('cakeFinOverhead', document.getElementById('finOverhead').value);
    localStorage.setItem('cakeHourlyRate', document.getElementById('hourlyRate').value);

    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–∫–∏ —Å–ª–æ–≤
    localStorage.setItem('cakeFinForceShow', document.getElementById('finForceShow').value);
    localStorage.setItem('cakeFinForceHide', document.getElementById('finForceHide').value);
    const settingsObj = {
        tax: document.getElementById('finTax').value,
        bank: document.getElementById('finBank').value,
        overhead: document.getElementById('finOverhead').value,
        hourlyRate: document.getElementById('hourlyRate').value // –î–æ–±–∞–≤–∏–º —Å—é–¥–∞ –∏ —Å—Ç–∞–≤–∫—É
    };
    saveToCloud('settings', settingsObj);
}

function loadFinance() { 
    document.getElementById('finTax').value = localStorage.getItem('cakeFinTax')||3; 
    document.getElementById('finBank').value = localStorage.getItem('cakeFinBank')||1; 
    document.getElementById('finOverhead').value = localStorage.getItem('cakeFinOverhead')||5; 
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–∫–∏ —Å–ª–æ–≤ (–∏–ª–∏ —Å—Ç–∞–≤–∏–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ, –µ—Å–ª–∏ –ø—É—Å—Ç–æ)
    const defaultShow = "—è—Ä—É—Å, —Ñ–∏–≥—É—Ä, –¥–æ—Å—Ç–∞–≤–∫–∞, –∞—Ä–µ–Ω–¥–∞, –ø–æ–¥—Å—Ç–∞–≤–∫–∞, –º–∏—à–∫–∞, —Ç–æ–ø–ø–µ—Ä, –ø–µ—á–∞—Ç—å, –ø—Ä—è–Ω–∏–∫, –ª–µ–¥–µ–Ω";
    const defaultHide = "–∑–∞–º–µ—Å, –≤—ã–ø–µ—á–∫–∞, —Å–±–æ—Ä–∫–∞, —á–µ—Ä–Ω–æ–≤–æ–µ, –ø–æ–∫—Ä—ã—Ç–∏–µ, –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ, –≥–∞–Ω–∞—à, –±–∏—Å–∫–≤–∏—Ç, –Ω–∞—á–∏–Ω–∫–∞, –∫—Ä–µ–º";
    
    document.getElementById('finForceShow').value = localStorage.getItem('cakeFinForceShow') || defaultShow;
    document.getElementById('finForceHide').value = localStorage.getItem('cakeFinForceHide') || defaultHide;
}
      function saveHourlyRate() { localStorage.setItem('cakeHourlyRate', document.getElementById('hourlyRate').value); }
      function loadHourlyRate() { const r=localStorage.getItem('cakeHourlyRate'); if(r) document.getElementById('hourlyRate').value=r; }
      
      // --- –î–û–ë–ê–í–õ–ï–ù–ò–ï –†–ê–°–•–û–î–ù–ò–ö–ê (–° –ú–ì–ù–û–í–ï–ù–ù–´–ú –ê–í–¢–û–°–ï–ô–í–û–ú) ---
function addExtraItem() { 
    const name = document.getElementById('extraItemSearch').value; 
    const amount = parseFloat(document.getElementById('extraItemAmount').value); 
    
    if(!name || !amount) return; 
    
    const ing = myIngredients.find(i => i.name === name); 
    if(!ing) return; 
    
    // 1. –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫
    extrasList.push({
        id: ing.id,
        name: ing.name,
        amount: amount,
        unit: ing.unit
    }); 
    
    // 2. –û–±–Ω–æ–≤–ª—è–µ–º —ç–∫—Ä–∞–Ω
    renderExtras(); 
    
    // 3. –û—á–∏—â–∞–µ–º –ø–æ–ª—è
    document.getElementById('extraItemSearch').value = ''; 
    document.getElementById('extraItemAmount').value = ''; 
    
    // 4. –°–û–•–†–ê–ù–Ø–ï–ú –ò–°–¢–û–†–ò–Æ –ò –ê–í–¢–û–°–ï–ô–í
    saveToHistory(); 
    performAutoSave(); // <--- –í–ê–ñ–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ä–∞–∑—É –∂–µ!
}


      function removeExtraItem(i) { extrasList.splice(i,1); renderExtras(); }
      function renderExtras() { saveToHistory(); const c=document.getElementById('extrasContainer'); c.innerHTML=''; extrasList.forEach((item,i)=>{ c.innerHTML+=`<div style="display:flex; justify-content:space-between; border-bottom:1px solid #e0e0e0; padding:4px 0; font-size:13px;"><span>${item.name}</span><span><b>${item.amount}</b> ${item.unit} <span onclick="removeExtraItem(${i})" style="color:red; cursor:pointer;">‚úï</span></span></div>`; }); }
      
      // –ü—Ä–∏–º–µ—Ä —Ç–æ–≥–æ, –∫–∞–∫ –¥–æ–ª–∂–Ω–∞ –≤—ã–≥–ª—è–¥–µ—Ç—å —Ñ—É–Ω–∫—Ü–∏—è –≤ Index.html
// --- –î–û–ë–ê–í–õ–ï–ù–ò–ï –†–ê–ë–û–¢–´ (–° –£–ß–ï–¢–û–ú –ü–û–ú–û–©–ù–ò–ö–ê) ---
// --- –î–û–ë–ê–í–õ–ï–ù–ò–ï –†–ê–ë–û–¢–´ (–ò–°–ü–†–ê–í–õ–ï–ù–û: –£—á–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞) ---
function addLaborTask() {
    const searchInput = document.getElementById('laborSearch');
    const hoursInput = document.getElementById('laborHoursInput');
    
    const name = searchInput.value.trim();
    const h = parseFloat(hoursInput.value);
    
    if (!name || isNaN(h)) {
        alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç—É –∏ —É–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è!");
        return;
    }

    // –ò—â–µ–º —Ä–∞–±–æ—Ç—É –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ
    const s = myLaborServices.find(l => l.name === name);

    // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫
    currentLaborList.push({
        name: name,
        realHours: h,
        coeff: s ? s.coeff : 1.0,
        // –ë–ï–†–ï–ú –ù–ê–°–¢–†–û–ô–ö–£ –ò–ó –°–ü–†–ê–í–û–ß–ù–ò–ö–ê (–µ—Å–ª–∏ —Ç–∞–º —Å—Ç–æ–∏—Ç "–ü–æ–º–æ—â–Ω–∏–∫", —Å—Ç–∞–≤–∏–º true)
        isHelper: s ? s.isHelper : false 
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —ç–∫—Ä–∞–Ω
    renderLaborTasks();
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
    searchInput.value = '';
    hoursInput.value = '';
    
    saveToHistory();
    performAutoSave();
    
    // –°—Ä–∞–∑—É –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É, –µ—Å–ª–∏ —Ç–æ—Ä—Ç —É–∂–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω
    recalcLaborCost();
}
function removeLaborTask(i) { 
    currentLaborList.splice(i, 1); 
    renderLaborTasks(); 
    saveToHistory(); 
    performAutoSave(); // <--- –í–ê–ñ–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ä–∞–∑—É –∂–µ!
}
    function renderLaborTasks() {
    const c = document.getElementById('laborListContainer');
    c.innerHTML = '';
    let totalNorm = 0;
    
    currentLaborList.forEach((l, i) => {
        const norm = l.realHours * l.coeff;
        totalNorm += norm;
        
        // –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
        const icon = l.isHelper ? 'üë∑‚Äç‚ôÇÔ∏è' : 'üë§';
        const title = l.isHelper ? '–ü–æ–º–æ—â–Ω–∏–∫ (–†–∞—Å—Ö–æ–¥)' : '–Ø —Å–∞–º (–î–æ—Ö–æ–¥)';
        const btnBg = l.isHelper ? '#ffebee' : '#e8f5e9'; // –ö—Ä–∞—Å–Ω—ã–π –∏–ª–∏ –ó–µ–ª–µ–Ω—ã–π —Ñ–æ–Ω –∫–Ω–æ–ø–∫–∏
        const style = l.isHelper ? 'color:#d32f2f;' : 'color:#00695c;';

        const isManualStyle = l.isManual ? 'background-color: #fff3e0; border-color: #ffb74d;' : '';

        c.innerHTML += `<div style="display:flex; justify-content:space-between; border-bottom:1px dotted #b2dfdb; padding:4px 0; align-items:center;">
            <div style="flex:2; display:flex; align-items:center;">
                <button onclick="toggleLaborHelper(${i})" title="${title}" 
                    style="cursor:pointer; border:1px solid #ccc; background:${btnBg}; border-radius:4px; padding:2px 6px; margin-right:8px; font-size:14px; transition:0.2s;">
                    ${icon}
                </button>
                
                <span>
                    ${l.name} <small style="color:#888;">x${l.coeff}</small>
                </span>
            </div>
            
            <span style="flex:1; display:flex; align-items:center; gap:5px;">
                <input type="number" value="${l.realHours}" step="0.1" 
                    style="width:45px; padding:2px; border:1px solid #ccc; border-radius:4px; text-align:center; font-size:12px; ${isManualStyle}"
                    onchange="updateLaborHours(${i}, this.value)"> —á
            </span>
            <span style="flex:0.5; text-align:right;">
                <b style="${style}">${norm.toFixed(1)}</b> 
                <span onclick="removeLaborTask(${i})" style="color:#ccc; cursor:pointer; margin-left:10px; font-weight:bold;">‚úï</span>
            </span>
        </div>`;
    });
    document.getElementById('totalNormHoursDisplay').innerText = totalNorm.toFixed(1);
}
// –ù–æ–≤–∞—è –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–∞—Å–æ–≤
function updateLaborHours(idx, val) {
    const newHours = parseFloat(val) || 0;
    // –°—Ç–∞–≤–∏–º –º–µ—Ç–∫—É, —á—Ç–æ –≤—Ä–µ–º—è –≤–≤–µ–¥–µ–Ω–æ –≤—Ä—É—á–Ω—É—é
    currentLaborList[idx].realHours = newHours;
    currentLaborList[idx].isManual = true; 

    renderLaborTasks();
    performAutoSave();
    recalcLaborCost();

    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é —á–∞—Å—Ç—å (—Ü–µ–Ω—É), –Ω–µ —Ç—Ä–æ–≥–∞—è –≥–µ–æ–º–µ—Ç—Ä–∏—é
    if (appState.results[appState.activeSide]) {
        const side = appState.activeSide;
        const data = appState.results[side];
        
        // –°—á–∏—Ç–∞–µ–º –Ω–æ–≤—É—é –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç
        const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;
        let newLaborCost = 0;
        currentLaborList.forEach(l => {
            newLaborCost += (l.realHours * l.coeff * hourlyRate);
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ç–µ–∫—É—â–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
        data.costs.laborCost = newLaborCost;
        data.costs.finalPrice = Math.ceil((data.costs.totalProductionCost + newLaborCost) * (1 + (data.costs.urgency || 0) / 100));

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—É —Ü–µ–Ω—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ
        updateStats(side);
    }
}

      function updateCoatingUI() {
        const val = document.getElementById('coatingIdSelect').value;
    if (val !== "") {
        bareConfirmationGiven = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥, –µ—Å–ª–∏ –ø–æ–∫—Ä—ã—Ç–∏–µ –±—ã–ª–æ –≤—ã–±—Ä–∞–Ω–æ
    }
    const shape = document.getElementById('globalShape').value;   // –ö–∞–∫–∞—è —Ñ–æ—Ä–º–∞?
    
    const block = document.getElementById('coatingMethodBlock');
    const chk = document.getElementById('chkCoatingMethod');

    // –õ–æ–≥–∏–∫–∞: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç—É–º–±–ª–µ—Ä –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ –ø–æ–∫—Ä—ã—Ç–∏–µ –ò —Ñ–æ—Ä–º–∞ –ù–ï –°—Ñ–µ—Ä–∞
    if (val && shape !== 'sphere') {
        block.style.display = 'flex';
    } else {
        block.style.display = 'none';
        
        // –ï—Å–ª–∏ —ç—Ç–æ –°—Ñ–µ—Ä–∞ - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—ã–∫–ª—é—á–∞–µ–º "–ü—Ä–æ–ø–æ—Ä—Ü–∏—é", 
        // —á—Ç–æ–±—ã –≤—Å–µ–≥–¥–∞ —Å—á–∏—Ç–∞–ª–æ—Å—å –ø–æ –ì–µ–æ–º–µ—Ç—Ä–∏–∏ (–ø–ª–æ—â–∞–¥–∏ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏)
        if (shape === 'sphere') {
            chk.checked = false;
        }
    }
    updateCoatingText();
}

// --- –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê –†–ï–¶–ï–ü–¢–ê (–°–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏–≤—è–∑–∫–∏ –¥–ª—è –∫—Ä–µ–º–æ–≤) ---
function updateRecTypeUI() {
    const type = document.getElementById('editRecType').value;
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const blockFinWeight = document.getElementById('finishedWeightBlock');
    const chkFinishedWeight = document.getElementById('chkFinishedWeight');
    const rowShape = document.getElementById('rowShape');
    const rowDims = document.getElementById('rowDims');
    const lblOutput = document.getElementById('lblOutput');
    const grpFill = document.getElementById('calibFill').parentElement; 

    // –°–±—Ä–æ—Å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è)
    rowShape.style.display = 'flex';
    rowDims.style.display = 'contents';
    grpFill.style.visibility = 'visible'; 
    lblOutput.innerText = '–í—ã—Ö–æ–¥ (–≥)';

    // 1. –ù–ê–ß–ò–ù–ö–ê –ò–õ–ò –ö–†–ï–ú (–†–∞–∑—Ä–µ—à–∞–µ–º –ø—Ä–∏–≤—è–∑–∫—É –∫ –≤–µ—Å—É –≥–æ—Ç–æ–≤–æ–≥–æ —Ç–æ—Ä—Ç–∞)
    if (type === 'filling' || type === 'coating') {
        blockFinWeight.style.display = 'block';
        
        if (type === 'coating') {
            grpFill.style.visibility = 'hidden'; // –ö—Ä–µ–º—ã –Ω–µ –ø–µ–∫—É—Ç—Å—è, –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–µ –Ω—É–∂–Ω–æ
        }
    } 
    // 2. –î–ï–ö–û–† (–®—Ç—É—á–Ω—ã–π)
    else if (type === 'decor') {
        blockFinWeight.style.display = 'none';
        chkFinishedWeight.checked = false;
        toggleFinishedWeight(true);
        rowShape.style.display = 'none';
        rowDims.style.display = 'none';
        lblOutput.innerText = '–í–µ—Å –≤—Å–µ–π –ø–∞—Ä—Ç–∏–∏ (–≥)';
    } 
    // 3. –í–ï–õ–Æ–† / –ì–õ–Ø–°–°–ê–ñ
    else {
        blockFinWeight.style.display = 'none';
        chkFinishedWeight.checked = false;
        toggleFinishedWeight(true);
        grpFill.style.visibility = 'hidden';
    }
}
      
      // –ü–µ—á–∞—Ç—å
     
      function printTechCard(side) { currentPrintSide = side; document.getElementById('printModal').style.display = 'flex'; }
      
      
      // Queue & Batch (–°–æ–∫—Ä–∞—â–µ–Ω–Ω–æ, —Ç.–∫. –∫–æ–¥ —É–∂–µ –±—ã–ª)
      updateQueueBadge();

    function saveQueue() { 
    localStorage.setItem('cakeProductionQueue', JSON.stringify(productionQueue)); 
    saveToCloud('queue', productionQueue); // <--- –ù–û–í–ê–Ø –°–¢–†–û–ö–ê
    renderQueue(); 
    updateQueueBadge(); 
}
      function updateQueueBadge() { const b=document.getElementById('badgeQueue'); if(productionQueue.length>0){b.style.display='inline-block'; b.innerText=productionQueue.length;}else b.style.display='none'; }

      // --- –û–¢–†–ò–°–û–í–ö–ê –°–ü–ò–°–ö–ê –ó–ê–ö–ê–ó–û–í ---
// --- –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ü–ï–†–ï–ú–ï–ù–ù–ê–Ø –î–õ–Ø –§–ò–õ–¨–¢–†–ê –î–ê–¢ ---
let activeDateFilter = 'all'; // 'all' –∏–ª–∏ 'YYYY-MM-DD'

// --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–¢–†–ò–°–û–í–ö–ò –û–ß–ï–†–ï–î–ò (–¢–ê–ë–´ + –ö–ê–†–¢–û–ß–ö–ò) ---
function renderQueue() {
    const c = document.getElementById('queueContainer');
    if (!c) return;

    if (!productionQueue || productionQueue.length === 0) {
        c.innerHTML = '<div style="color:#999; text-align:center; padding:40px; border: 2px dashed #ddd; border-radius: 12px; background:#fafafa;">üì≠ –í –ø–ª–∞–Ω–µ –ø—É—Å—Ç–æ.</div>';
        return;
    }

    // 1. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ
    productionQueue.sort((a, b) => {
        if (!a.date) return 1;
        if (!b.date) return -1;
        return new Date(a.date) - new Date(b.date);
    });

    // 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–∞–±–æ–≤ (–î–∞—Ç)
    let tabsHtml = `<button class="date-tab ${activeDateFilter === 'all' ? 'active' : ''}" onclick="setDateFilter('all')">–í–°–ï</button>`;
    
    // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–∞—Ç—ã
    const uniqueDates = [...new Set(productionQueue.map(i => i.date || 'no_date'))];
    
    const today = new Date().toISOString().split('T')[0];
    
    uniqueDates.forEach(date => {
        if (date === 'no_date') return;
        
        const dObj = new Date(date);
        const dayName = dObj.toLocaleDateString('ru-RU', { weekday: 'short' }).toUpperCase(); // –ü–ù, –í–¢...
        const dayNum = dObj.toLocaleDateString('ru-RU', { day: 'numeric', month: 'numeric' }); // 15.02
        
        let label = dayNum;
        if (date === today) label = "üî• –°–µ–≥–æ–¥–Ω—è";
        
        const isActive = (activeDateFilter === date) ? 'active' : '';
        
        // –ü–æ–¥—Å—á–µ—Ç –∫–æ–ª-–≤–∞ –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ —ç—Ç—É –¥–∞—Ç—É
        const count = productionQueue.filter(i => i.date === date).length;

        tabsHtml += `
            <button class="date-tab ${isActive}" onclick="setDateFilter('${date}')">
                ${label}
                <span>${dayName} (${count})</span>
            </button>`;
    });

    // –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è —Ç–∞–±–æ–≤
    let finalHtml = `<div class="date-tabs-container">${tabsHtml}</div>`;
  // –í—Å—Ç–∞–≤–ª—è–µ–º –µ—ë —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Ç–∞–±–æ–≤, –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∫–æ–º –∫–∞—Ä—Ç–æ—á–µ–∫
    finalHtml += `
    <div style="margin-bottom:10px; display:flex; justify-content:flex-end; padding-right:5px;">
        <label style="font-size:12px; cursor:pointer; color:#1976D2; font-weight:bold; background:#e3f2fd; padding:6px 12px; border-radius:20px; display:flex; align-items:center; gap:6px; transition:0.2s;">
            <input type="checkbox" onchange="toggleAllBatch(this)" checked style="margin:0; width:16px; height:16px; cursor:pointer;"> 
            –í—ã–±—Ä–∞—Ç—å –≤—Å–µ –¥–ª—è –≤–µ–¥–æ–º–æ—Å—Ç–∏
        </label>
    </div>`;

    // 3. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞
    let filteredQueue = productionQueue;
    if (activeDateFilter !== 'all') {
        filteredQueue = productionQueue.filter(item => (item.date || 'no_date') === activeDateFilter);
    }

    // 4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ (–°–ï–¢–ö–ê)
    finalHtml += `<div class="plan-grid">`;

    filteredQueue.forEach(item => {
        const isBooking = (item.type === 'booking');
        const borderCol = isBooking ? '#FF9800' : '#4CAF50'; 
        const bgCol = isBooking ? '#fff8e1' : '#fff';
        const priceDisplay = Math.round(item.price).toLocaleString();

        // –¢–µ–∫—Å—Ç –¥–µ–∫–æ—Ä–∞
        let decorHtml = "";
        if (item.comment && item.comment.trim() !== "") {
            decorHtml = `<div class="pc-decor">üìù ${item.comment}</div>`;
        }

        // –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        let mainTitle = isBooking ? "‚è≥ –ë—Ä–æ–Ω—å" : (item.desc || "–ó–∞–∫–∞–∑");
        let specsHtml = "";
        let colorHtml = "";

        if (!isBooking && item.data && item.data.tiers) {
            const recipes = [...new Set(item.data.tiers.map(t => t.recipeName))].join(' + ');
            mainTitle = recipes;
            
            // –†–∞–∑–º–µ—Ä—ã
            const sizes = item.data.tiers.map(t => {
                 const shape = item.data.geometry.shape;
                 const d = Math.round(t.d); const h = Math.round(t.h);
                 return (shape === 'rectangle') ? `${d}x${Math.round(t.w)}` : `D${d}`;
            }).join(' + ');
            
            specsHtml = `<div style="margin-top:4px; display:flex; gap:5px; flex-wrap:wrap;">
                             <span class="pc-badge">${sizes}</span> 
                             <span class="pc-badge">${item.weight} –∫–≥</span>
                         </div>`;
        }

        if (item.color) {
             colorHtml = `<span class="pc-badge" style="margin-top:4px;">üé® ${item.color}</span>`;
        }

        // --- –ú–ò–ö–†–û-–°–¢–ê–¢–£–°–´ (–ß–ï–ö–ë–û–ö–°–´) ---
        // –ï—Å–ª–∏ —É –∑–∞–∫–∞–∑–∞ –µ—â–µ –Ω–µ—Ç –æ–±—ä–µ–∫—Ç–∞ progress, —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π
        const p = item.progress || { bake: false, assemble: false, decor: false, pack: false };
        
        const statusRow = `
        <div class="status-row">
            <div class="status-btn ${p.bake ? 'done' : ''}" onclick="toggleProgress('${item.id}', 'bake')" title="–í—ã–ø–µ—á–∫–∞">ü•ö</div>
            <div class="status-btn ${p.assemble ? 'done' : ''}" onclick="toggleProgress('${item.id}', 'assemble')" title="–°–±–æ—Ä–∫–∞">üèóÔ∏è</div>
            <div class="status-btn ${p.decor ? 'done' : ''}" onclick="toggleProgress('${item.id}', 'decor')" title="–î–µ–∫–æ—Ä">üé®</div>
            <div class="status-btn ${p.pack ? 'done' : ''}" onclick="toggleProgress('${item.id}', 'pack')" title="–£–ø–∞–∫–æ–≤–∫–∞">üì¶</div>
        </div>`;

       
        // –°–ë–û–†–ö–ê –ö–ê–†–¢–û–ß–ö–ò (–° –†–ê–ë–û–ß–ò–ú –î–û–õ–ì–ò–ú –ù–ê–ñ–ê–¢–ò–ï–ú)
        finalHtml += `
        <div class="plan-card" 
             style="border-left-color: ${borderCol}; background: ${bgCol}; min-height:auto; position:relative; user-select:none; -webkit-touch-callout: none;"
             oncontextmenu="return false;"
             onmousedown="startLongPress('${item.id}')" 
             onmouseup="cancelLongPress()" 
             onmouseleave="cancelLongPress()"
             ontouchstart="startLongPress('${item.id}')" 
             ontouchend="cancelLongPress()"
             ontouchmove="cancelLongPress()"
             >
             
           <div id="edit-hint-${item.id}" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:10; align-items:center; justify-content:center; color:#1976D2; font-weight:bold; font-size:18px; border-radius:8px;">
               ‚úèÔ∏è –û—Ç–ø—É—Å–∫–∞–π—Ç–µ...
           </div>

           <div class="pc-top">
               <div style="display:flex; align-items:center; gap:8px;">
                   <input type="checkbox" class="batch-checkbox" value="${item.id}" checked onclick="event.stopPropagation()">
                   <span class="pc-client" style="font-size:12px;">üë§ ${item.name}</span>
               </div>
               <div style="font-weight:bold; font-size:12px;">${priceDisplay}</div>
           </div>

           <div class="pc-body">
               <div class="pc-main" style="white-space:normal; line-height:1.25;">${mainTitle}</div>
               ${specsHtml}
               ${colorHtml}
               ${decorHtml}
               ${!isBooking ? statusRow : ''} 
           </div>

           <div class="pc-footer">
               <div style="font-size:10px; color:#999;">${formatDateRu(item.date)}</div>
               <div class="btn-action-group">
                   ${item.refImage ? `<button class="btn-done" style="background:#FCE4EC; color:#C2185B; border:none;" onclick="viewOrderRef('${item.id}'); event.stopPropagation();">üì∑</button>` : ''}
                   
                   ${isBooking ? 
                       `<button class="btn-done" style="background:#FFF3E0; color:#E65100; border-color:#FFE0B2;" onclick="startConvertingBooking('${item.id}'); event.stopPropagation();">üéÇ –í —Ä–∞–±–æ—Ç—É</button>` 
                       : 
                       `<button class="btn-done" onclick="finishOrder('${item.id}', '${item.name}'); event.stopPropagation();">‚úÖ –ì–æ—Ç–æ–≤–æ</button>`
                   }
                   
                   <button class="btn-icon" onclick="editOrderFromQueue('${item.id}'); event.stopPropagation();" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                   
                   <button class="btn-icon" onclick="removeFromQueue('${item.id}'); event.stopPropagation();">üóëÔ∏è</button>
               </div>
           </div>
       </div>`;
    });

    finalHtml += `</div>`; // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–µ—Ç–∫—É
    c.innerHTML = finalHtml;
}

// --- üîç –ü–û–ò–°–ö –ü–û –ó–ê–ö–ê–ó–ê–ú ---
function filterOrders() {
    const term = document.getElementById('orderSearchInput').value.toLowerCase().trim();
    const clearBtn = document.getElementById('searchClearBtn');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫—Ä–µ—Å—Ç–∏–∫
    if (clearBtn) clearBtn.style.display = term ? 'block' : 'none';

    if (!term) {
        // –ï—Å–ª–∏ –ø—É—Å—Ç–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å—ë (—Å–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ)
        renderQueue(productionQueue); 
        return;
    }

    // –§–∏–ª—å—Ç—Ä—É–µ–º –º–∞—Å—Å–∏–≤
    const filtered = productionQueue.filter(order => {
        // –ò—â–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –≤: –ò–º–µ–Ω–∏, –¢–µ–ª–µ—Ñ–æ–Ω–µ, –ù–∞–∑–≤–∞–Ω–∏–∏ —Ç–æ—Ä—Ç–∞, –î–∞—Ç–µ
        const nameMatch = (order.name || '').toLowerCase().includes(term);
        const phoneMatch = (order.phone || '').includes(term);
        const dateMatch = (order.date || '').includes(term);
        
        // –î–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –Ω–∞—á–∏–Ω–∫–µ –Ω—É–∂–Ω–æ –∑–∞–≥–ª—è–Ω—É—Ç—å –≤–Ω—É—Ç—Ä—å –æ–±—ä–µ–∫—Ç–∞ data (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å)
        let cakeMatch = false;
        if (order.data && order.data.name) {
            cakeMatch = order.data.name.toLowerCase().includes(term);
        }

        return nameMatch || phoneMatch || dateMatch || cakeMatch;
    });

    // –†–µ–Ω–¥–µ—Ä–∏–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
    renderQueue(filtered);
}

// --- üö¶ –ü–†–û–í–ï–†–ö–ê –ó–ê–ì–†–£–ñ–ï–ù–ù–û–°–¢–ò –î–ê–¢–´ ---
function checkDateLoad() {
    const dateInput = document.getElementById('orderDeadline');
    const indicator = document.getElementById('dateLoadIndicator');
    
    if (!dateInput || !indicator) return;
    
    const selectedDate = dateInput.value;
    if (!selectedDate) {
        indicator.style.display = 'none';
        return;
    }

    // –°—á–∏—Ç–∞–µ–º –∑–∞–∫–∞–∑—ã –Ω–∞ —ç—Ç—É –¥–∞—Ç—É (–∏—Å–∫–ª—é—á–∞—è —Ç–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –º—ã —Å–µ–π—á–∞—Å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º, –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–∞–≤–∫–∞)
    // editingOrderId - —ç—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –∏–∑ –Ω–∞—à–µ–≥–æ –ø—Ä–æ—à–ª–æ–≥–æ —à–∞–≥–∞
    const count = productionQueue.filter(o => o.date === selectedDate && o.id !== editingOrderId).length;

    indicator.style.display = 'block';

    if (count === 0) {
        indicator.style.background = '#E8F5E9'; // –°–≤–µ—Ç–ª–æ-–∑–µ–ª–µ–Ω—ã–π
        indicator.style.color = '#2E7D32';
        indicator.innerHTML = `‚úÖ –°–≤–æ–±–æ–¥–Ω–æ (–ó–∞–∫–∞–∑–æ–≤: 0)`;
    } 
    else if (count <= 2) {
        indicator.style.background = '#FFF3E0'; // –°–≤–µ—Ç–ª–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π
        indicator.style.color = '#EF6C00';
        indicator.innerHTML = `‚ö†Ô∏è –ü–ª–æ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å (–£–∂–µ –µ—Å—Ç—å: ${count})`;
    } 
    else {
        indicator.style.background = '#FFEBEE'; // –°–≤–µ—Ç–ª–æ-–∫—Ä–∞—Å–Ω—ã–π
        indicator.style.color = '#C62828';
        indicator.innerHTML = `üî• –ü–ï–†–ï–ì–†–£–ó! (–£–∂–µ –∑–∞–∫–∞–∑–æ–≤: ${count})`;
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–∏–±—Ä–∞—Ü–∏—é, —á—Ç–æ–±—ã –ø—Ä–∏–≤–ª–µ—á—å –≤–Ω–∏–º–∞–Ω–∏–µ
        if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
    }
}
     
function clearSearch() {
    document.getElementById('orderSearchInput').value = '';
    filterOrders(); // –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–∞
}
  
// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–∞—Ç—ã
function setDateFilter(date) {
    activeDateFilter = date;
    renderQueue();
    // –í–∏–±—Ä–∞—Ü–∏—è –¥–ª—è —Ç–∞–∫—Ç–∏–ª—å–Ω–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞
    if(navigator.vibrate) navigator.vibrate(10); 
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ (–í—ã–ø–µ—á–µ–Ω–æ/–°–æ–±—Ä–∞–Ω–æ...)
function toggleProgress(id, step) {
    const item = productionQueue.find(i => i.id === id);
    if (item) {
        if (!item.progress) item.progress = {};
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º true/false
        item.progress[step] = !item.progress[step];
        
        // –°—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è–µ–º
        saveQueue();
        
        // –í–∏–±—Ä–∞—Ü–∏—è
        if(navigator.vibrate) navigator.vibrate(5);
        
        // –ù–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤—Å—ë (—á—Ç–æ–±—ã –Ω–µ –º–æ—Ä–≥–∞–ª–æ), –∞ –º–µ–Ω—è–µ–º –∫–ª–∞—Å—Å —Ç–æ—á–µ—á–Ω–æ? 
        // –ù–µ—Ç, –ø—Ä–æ—â–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –≤—Å—ë, —ç—Ç–æ –±—ã—Å—Ç—Ä–æ.
        renderQueue(); 
    }
}
// –•–µ–ª–ø–µ—Ä –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–π –¥–∞—Ç—ã (2026-02-25 -> 25.02)
function formatDateRu(isoDate) {
    if (!isoDate) return '';
    const parts = isoDate.split('-');
    return `${parts[2]}.${parts[1]}`;
}

// –•–µ–ª–ø–µ—Ä "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
function toggleAllBatch(source) {
    document.querySelectorAll('.batch-checkbox').forEach(cb => cb.checked = source.checked);
}
 


// --- –î–û–ë–ê–í–ò–¢–¨ –≠–¢–£ –§–£–ù–ö–¶–ò–Æ (–û–ß–ò–°–¢–ö–ê –í–°–ï–ì–û –ü–õ–ê–ù–ê) ---
function clearQueue() {
    if (productionQueue.length === 0) return;
    
    if (confirm('‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ü–û–õ–ù–û–°–¢–¨–Æ –æ—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –ø–ª–∞–Ω –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞?\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –∑–∞–∫–∞–∑—ã.')) {
        saveToHistory(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã (Ctrl+Z)
        productionQueue = []; // –û—á–∏—â–∞–µ–º –º–∞—Å—Å–∏–≤
        saveQueue(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–º—è—Ç—å
        updateQueueBadge(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫—Ä–∞—Å–Ω—ã–π –∫—Ä—É–∂–æ–∫
        renderQueue(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω (—Ç–∞–º –ø–æ—è–≤–∏—Ç—Å—è –Ω–∞–¥–ø–∏—Å—å "–í –ø–ª–∞–Ω–µ –ø—É—Å—Ç–æ")
        
        // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ –≤–µ–¥–æ–º–æ—Å—Ç–∏, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –æ—Ç–∫—Ä—ã—Ç
        const batchBlock = document.getElementById('batchResultBlock');
        if (batchBlock) batchBlock.style.display = 'none';
    }
}

    async function removeFromQueue(id, askConfirm = true) { // –î–æ–±–∞–≤–∏–ª–∏ async
    const idx = productionQueue.findIndex(item => item.id === id);
    if (idx === -1) return;

    if(askConfirm && !confirm("–£–¥–∞–ª–∏—Ç—å –∏–∑ –ø–ª–∞–Ω–∞ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ?")) return;

    const order = productionQueue[idx];

    // 1. –£–¥–∞–ª—è–µ–º —Ñ–æ—Ç–æ —Å –î–∏—Å–∫–∞ (–µ—Å–ª–∏ –æ–Ω–æ —É—Å–ø–µ–ª–æ —Ç—É–¥–∞ —É–ª–µ—Ç–µ—Ç—å)
    if (order.refImage && order.refImage.startsWith('DRIVE:')) {
        const fileId = order.refImage.split(':')[1];
        apiDeleteFileFromDrive(fileId); // –ó–∞–ø—É—Å–∫–∞–µ–º –∏ –Ω–µ –∂–¥–µ–º (—Ñ–æ–Ω–æ–º)
    }

    // 2. –£–¥–∞–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
    saveToHistory();
    productionQueue.splice(idx, 1);
    imageDB.delete(id); // –£–¥–∞–ª—è–µ–º –∏–∑ –∫—ç—à–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    
    saveQueue();
    updateQueueBadge();
}
      // --- –î–û–ë–ê–í–õ–ï–ù–ò–ï –í –ü–õ–ê–ù (–° –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –º–Ω–æ–≥–æ—è—Ä—É—Å–Ω–æ—Å—Ç–∏) ---

      
      // –ß—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ addToQueue, printDoc –∏ generateBatchReport - —è –∏—Ö –æ—Å—Ç–∞–≤–∏–ª –≤ HTML –≤—ã—à–µ –ø–æ–ª–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏. 
      // –í —ç—Ç–æ–º –±–ª–æ–∫–µ —Å–∫—Ä–∏–ø—Ç–∞ –æ–Ω–∏ —É–∂–µ –ø—Ä–æ–ø–∏—Å–∞–Ω—ã.
      // =========================================================================




function closePrintModal() {
    document.getElementById('printModal').style.display = 'none';
}

function printDoc(type) {
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –≤—ã–±–æ—Ä–∞, –µ—Å–ª–∏ –æ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞
    closePrintModal();
    
    // –ë–µ—Ä–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ —Ä–∞—Å—á–µ—Ç–∞
    const side = currentPrintSide;
    const data = appState.results[side]; 

    // –ó–∞—â–∏—Ç–∞: –µ—Å–ª–∏ —Ä–∞—Å—á–µ—Ç–∞ –Ω–µ—Ç
    if (!data || !data.shoppingList || data.shoppingList.length === 0) {
        alert("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ —Ç–æ—Ä—Ç!");
        return;
    }

    // –û–±—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    const recName = myRecipes.find(r => r.id === appState.tiers[0].recipeId)?.name || "–¢–æ—Ä—Ç";
    const dateStr = new Date().toLocaleDateString();
    const currency = SYMBOLS[currentCurrency] || '';
    
    // –§–æ—Ä–º–∞—Ç—Ç–µ—Ä —á–∏—Å–µ–ª (10 000)
    const fmt = (num) => Math.round(num || 0).toLocaleString('ru-RU');

    // ==========================================
    // 1. –ß–ï–ö –î–õ–Ø –ö–õ–ò–ï–ù–¢–ê (–û—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –±—ã–ª–æ)
    // ==========================================
    if (type === 'client') {
        const totalWeight = (data.weights.total / 1000).toFixed(2);
        
        let rows = '';
        // –Ø—Ä—É—Å—ã
        data.tiers.forEach((t, i) => {
            const sizeStr = (data.geometry.shape === 'rectangle') ? `${Math.round(t.d)}x${Math.round(t.w)}` : `D${Math.round(t.d)}`;
            rows += `<tr>
                <td style="padding:10px 0; border-bottom:1px solid #eee;">
                    <b>${i + 1} —è—Ä—É—Å: ${t.recipeName}</b><br>
                    <span style="font-size:12px; color:#666;">${sizeStr} —Å–º, H${Math.round(t.h)} —Å–º</span>
                </td>
                <td style="text-align:right; font-weight:bold;">${fmt(t.totalCost)} ${currency}</td>
            </tr>`;
        });
        
        // –£—Å–ª—É–≥–∏ (—Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É —Ü–µ–Ω–æ–π –∏ —Å—É–º–º–æ–π —è—Ä—É—Å–æ–≤)
        const decorAndLabor = data.costs.finalPrice - data.tiers.reduce((sum, t) => sum + t.totalCost, 0);
        if (decorAndLabor > 0) {
            rows += `<tr>
                <td style="padding:10px 0; border-bottom:1px solid #eee;"><b>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∏ –¥–µ–∫–æ—Ä</b></td>
                <td style="text-align:right; font-weight:bold;">${fmt(decorAndLabor)} ${currency}</td>
            </tr>`;
        }

        const html = `
            <div style="text-align:center; margin-bottom:30px;">
                <h1 style="margin:0; font-size:24px;">–ó–ê–ö–ê–ó</h1>
                <div style="color:#666;">${dateStr}</div>
            </div>
            <table style="width:100%; border-collapse:collapse;">${rows}</table>
            <div style="margin-top:20px; padding-top:10px; border-top:2px solid #333; display:flex; justify-content:space-between; align-items:center;">
                <div>–í–µ—Å: <b>${totalWeight} –∫–≥</b></div>
                <div style="font-size:22px; font-weight:900;">${fmt(data.costs.finalPrice)} ${currency}</div>
            </div>
            <div style="text-align:center; margin-top:40px; font-style:italic; color:#888;">–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑! ‚ù§Ô∏è</div>
        `;
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (—Ñ—É–Ω–∫—Ü–∏—è printWindow —É –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å)
        printWindow(html, 'Check_Client');
    }

    // =======================================================
    // 2. –ü–†–û–ò–ó–í–û–î–°–¢–í–ï–ù–ù–´–ô –û–¢–ß–ï–¢ (–ú–ï–ù–ï–î–ñ–ï–†) - –û–ë–ù–û–í–õ–ï–ù–ù–´–ô
    // =======================================================
    else if (type === 'manager') {
        const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;
        
        // --- –°–ß–ò–¢–ê–ï–ú –§–ò–ù–ê–ù–°–´ –ü–û –ù–û–í–û–ô –õ–û–ì–ò–ö–ï ---
        
        const revenue = data.costs.finalPrice; // –¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏
        const materialsCost = data.costs.totalProductionCost; // –ü—Ä–æ–¥—É–∫—Ç—ã + –î–µ–∫–æ—Ä (–†–ê–°–•–û–î)
        
        // –†–∞–∑–¥–µ–ª—è–µ–º —Ä–∞–±–æ—Ç—É –Ω–∞ –°–≤–æ—é (–î–æ—Ö–æ–¥) –∏ –ù–∞–µ–º–Ω—É—é (–†–∞—Å—Ö–æ–¥)
        let myLaborCost = 0;
        let hiredLaborCost = 0;
        
        // –ë–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Ä–∞–±–æ—Ç –Ω–∞ —ç–∫—Ä–∞–Ω–µ
        currentLaborList.forEach(l => {
            const cost = l.realHours * l.coeff * hourlyRate;
            if (l.isHelper) {
                hiredLaborCost += cost; // –ü–æ–º–æ—â–Ω–∏–∫ - —ç—Ç–æ —Ä–∞—Å—Ö–æ–¥
            } else {
                myLaborCost += cost;    // –Ø —Å–∞–º - —ç—Ç–æ –¥–æ—Ö–æ–¥
            }
        });

        // –ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã (–ù–∞–ª–æ–≥, –ë–∞–Ω–∫, –ê–º–æ—Ä—Ç–∏–∑–∞—Ü–∏—è)
        const taxPct = parseFloat(document.getElementById('finTax').value) || 0;
        const bankPct = parseFloat(document.getElementById('finBank').value) || 0;
        const overheadPct = parseFloat(document.getElementById('finOverhead').value) || 0;
        
        const overheadCost = revenue * ((taxPct + bankPct + overheadPct) / 100);

        // –í–ù–ï–®–ù–ò–ï –†–ê–°–•–û–î–´ (—Ç–æ, —á—Ç–æ —É—Ö–æ–¥–∏—Ç –∏–∑ —Å–µ–º—å–∏)
        const externalCosts = materialsCost + hiredLaborCost + overheadCost;
        
        // –í–ê–® –ß–ò–°–¢–´–ô –î–û–•–û–î (–û—Å—Ç–∞—Ç–æ–∫ –≤ –∫–∞—Ä–º–∞–Ω–µ)
        const totalIncome = revenue - externalCosts;
        
        // –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å
        const margin = revenue > 0 ? Math.round((totalIncome / revenue) * 100) : 0;

        // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø –¢–ê–ë–õ–ò–¶ ---

        // 1. –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
        let ingRows = '';
        data.shoppingList.forEach(ing => {
            ingRows += `<tr>
                <td>${ing.name}</td>
                <td style="text-align:center;">${fmt(ing.amount)} ${ing.unit}</td>
                <td style="text-align:right; color:#666;">${fmt(ing.cost)}</td>
            </tr>`;
        });

        // 2. –†–∞–±–æ—Ç—ã (—Å –∏–∫–æ–Ω–∫–∞–º–∏)
        let laborRows = '';
        currentLaborList.forEach(l => {
            const cost = l.realHours * l.coeff * hourlyRate;
            const icon = l.isHelper ? 'üë∑‚Äç‚ôÇÔ∏è' : 'üë§';
            const color = l.isHelper ? 'color:#d32f2f;' : 'color:#2E7D32;'; // –ö—Ä–∞—Å–Ω—ã–π –∏–ª–∏ –ó–µ–ª–µ–Ω—ã–π
            
            laborRows += `<tr>
                <td>${icon} ${l.name}</td>
                <td style="text-align:center;">${l.realHours} —á</td>
                <td style="text-align:right; font-weight:bold; ${color}">${fmt(cost)}</td>
            </tr>`;
        });

        // --- HTML –û–¢–ß–ï–¢–ê ---
        const html = `
            <h2 style="text-align:center; margin:0 0 5px 0;">üìä –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ç—á–µ—Ç</h2>
            <div style="text-align:center; color:#666; margin-bottom:20px;">${recName} (${(data.weights.total/1000).toFixed(2)} –∫–≥)</div>

            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <div style="flex:1; background:#E3F2FD; padding:10px; border-radius:6px; border:1px solid #BBDEFB; text-align:center;">
                    <div style="font-size:10px; color:#1565C0;">–¶–ï–ù–ê –¢–û–†–¢–ê</div>
                    <div style="font-size:18px; font-weight:bold;">${fmt(revenue)}</div>
                </div>
                
                <div style="flex:1; background:#ffebee; padding:10px; border-radius:6px; border:1px solid #ffcdd2; text-align:center;">
                    <div style="font-size:10px; color:#d32f2f;">–†–ê–°–•–û–î–´</div>
                    <div style="font-size:18px; font-weight:bold;">-${fmt(externalCosts)}</div>
                    <div style="font-size:9px; margin-top:2px;">(–ú–∞—Ç + –ü–æ–º + –ù–∞–∫–ª)</div>
                </div>

                <div style="flex:1.2; background:#E8F5E9; padding:10px; border-radius:6px; border:1px solid #C8E6C9; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                    <div style="font-size:10px; color:#2E7D32; font-weight:bold;">–í–ê–® –î–û–•–û–î</div>
                    <div style="font-size:22px; font-weight:900; color:#2E7D32;">${fmt(totalIncome)}</div>
                    <div style="font-size:9px; color:#555;">–ú–∞—Ä–∂–∞: ${margin}%</div>
                </div>
            </div>

            <div style="display:flex; gap:20px; margin-bottom:20px;">
                <div style="flex:1;">
                    <h4 style="margin:0 0 5px 0; border-bottom:2px solid #ddd;">üõí –ú–∞—Ç–µ—Ä–∏–∞–ª—ã (–°–∫–ª–∞–¥)</h4>
                    <table style="width:100%; font-size:12px;">
                        ${ingRows}
                    </table>
                    <div style="text-align:right; font-weight:bold; margin-top:5px; color:#d32f2f;">–ò—Ç–æ–≥–æ: -${fmt(materialsCost)}</div>
                </div>
                
                <div style="flex:1;">
                    <h4 style="margin:0 0 5px 0; border-bottom:2px solid #ddd;">üõ†Ô∏è –¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã</h4>
                    <table style="width:100%; font-size:12px;">
                        ${laborRows}
                    </table>
                    <div style="text-align:right; font-size:11px; color:#666; margin-top:5px;">
                        (üë§ –í—ã / üë∑‚Äç‚ôÇÔ∏è –ü–æ–º–æ—â–Ω–∏–∫)
                    </div>
                    
                    <div style="margin-top:20px; font-size:11px; color:#666; border-top:1px dashed #ccc; padding-top:5px;">
                        <b>–ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã:</b><br>
                        –ù–∞–ª–æ–≥, –ë–∞–Ω–∫, –ê–º–æ—Ä—Ç–∏–∑–∞—Ü–∏—è: <b style="color:#d32f2f;">-${fmt(overheadCost)} ${currency}</b>
                    </div>
                </div>
            </div>
        `;
        
        printWindow(html, 'Production_Report');
    }
    
    // 3. –≠–¢–ò–ö–ï–¢–ö–ê (–ü—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é)
    else if (type === 'sticker') {
       printSticker();
    }
}
// --- –î–û–ë–ê–í–õ–ï–ù–ò–ï –í –ü–õ–ê–ù (–° –∑–∞–ø—Ä–æ—Å–æ–º –ò–º–µ–Ω–∏ –∏ –¶–≤–µ—Ç–∞) ---
// 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫–Ω–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
// 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫–Ω–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è (–ò–°–ü–†–ê–í–õ–ï–ù–û: –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π)
function addToQueue() {
  editingOrderId = null;
  const btn = document.querySelector('#orderFinalizeModal .main-btn');
    if(btn) {
        btn.innerText = "–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑";
        btn.style.background = "#4CAF50";
    }
    const res = appState.results[appState.activeSide];
    if (!res || !res.costs || res.costs.totalProductionCost === 0) {
        alert("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ —Ç–æ—Ä—Ç!");
        return;
    }

    // --- –û–ß–ò–°–¢–ö–ê –ü–û–õ–ï–ô (–ß–¢–û–ë–´ –ù–ï –ë–´–õ–û –°–¢–ê–†–´–• –î–ê–ù–ù–´–•) ---
    document.getElementById('orderClientSearch').value = ''; // –ò–º—è
    document.getElementById('orderClientId').value = '';     // –°–∫—Ä—ã—Ç—ã–π ID (–í–∞–∂–Ω–æ!)
    document.getElementById('orderReason').value = '';
    document.getElementById('orderForWhom').value = '';
    document.getElementById('orderPhone').value = '';
    document.getElementById('orderSocial').value = '';
    document.getElementById('orderAddress').value = '';
    document.getElementById('orderPrepayment').value = '';
    document.getElementById('orderBalance').value = '';
    document.getElementById('orderColor').value = '';
    document.getElementById('orderPayment').selectedIndex = 0; // –°–±—Ä–æ—Å –Ω–∞ –ø–µ—Ä–≤—ã–π –ø—É–Ω–∫—Ç
    document.getElementById('orderDelivery').selectedIndex = 0;
    document.getElementById('orderComment').value = '';
    
    // ---------------------------------------------------

    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–∞—Ç—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–≤—Ç—Ä–∞)
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('orderDeadline').value = tomorrow.toISOString().split('T')[0];

    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ (–ò–º—è, –¢–µ–ª–µ—Ñ–æ–Ω, –°–æ—Ü—Å–µ—Ç–∏)
    const datalist = document.getElementById('orderClientsDatalist');
    datalist.innerHTML = '';
    Object.keys(clientsDataLocal).forEach(id => {
        const c = clientsDataLocal[id];
        // –î–û–ë–ê–í–õ–ï–ù–ê –ü–†–û–í–ï–†–ö–ê: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ –∏–º—è –ø—É—Å—Ç–æ–µ –∏–ª–∏ undefined
        if (!c || !c.name || c.name === 'undefined') return; 

        const option = document.createElement('option');
        option.value = c.name;
        option.innerText = `${c.phone || ''} ${c.social || ''}`; 
        datalist.appendChild(option);
    });
    clearOrderImage(); // <--- –î–û–ë–ê–í–ò–¢–¨
    document.getElementById('orderFinalizeModal').style.display = 'flex';
  checkDateLoad();
}

// 2. –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞ (–∞–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ID –ø–æ –∏–º–µ–Ω–∏)
// 2. –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞ (–∞–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ID –ø–æ –∏–º–µ–Ω–∏)
function handleClientSelection() {
    const nameInput = document.getElementById('orderClientSearch').value.trim();
    const clientIdInput = document.getElementById('orderClientId');
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º ID, –ø–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
    clientIdInput.value = ""; 

    if (!nameInput) return;

    // –ò—â–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–∞–∫–æ–π –∫–ª–∏–µ–Ω—Ç –≤ –±–∞–∑–µ (–°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞!)
    const foundId = Object.keys(clientsDataLocal).find(id => {
        const cName = clientsDataLocal[id].name;
        return cName && cName.toLowerCase() === nameInput.toLowerCase();
    });

    if (foundId) {
            clientIdInput.value = foundId; // –ù–∞—à–ª–∏! –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—É—é –∫–∞—Ä—Ç–æ—á–∫—É
            const client = clientsDataLocal[foundId];
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –≤ —Ñ–æ—Ä–º—É
            if (client.phone) document.getElementById('orderPhone').value = client.phone;
            if (client.social) document.getElementById('orderSocial').value = client.social;
        } else {
            // –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω (–≤–≤–æ–¥—è—Ç –Ω–æ–≤–æ–≥–æ), –æ—á–∏—â–∞–µ–º –ø–æ–ª—è, —á—Ç–æ–±—ã –Ω–µ –≤–∏—Å–µ–ª–∏ —á—É–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
            document.getElementById('orderPhone').value = '';
            document.getElementById('orderSocial').value = '';
        }
}
// --- –§–£–ù–ö–¶–ò–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò –î–ê–ù–ù–´–• –ü–ï–†–ï–î –°–û–•–†–ê–ù–ï–ù–ò–ï–ú ---
function optimizeOrderPayload(resData) {
    // –î–µ–ª–∞–µ–º –≥–ª—É–±–æ–∫—É—é –∫–æ–ø–∏—é, —á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–º–∞—Ç—å —Ç–æ, —á—Ç–æ —Å–µ–π—á–∞—Å –Ω–∞ —ç–∫—Ä–∞–Ω–µ
    const data = JSON.parse(JSON.stringify(resData));

    // –•–µ–ª–ø–µ—Ä –¥–ª—è –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è
    const round2 = (num) => Math.round((parseFloat(num) || 0) * 100) / 100;

    // 1. –ß–∏—Å—Ç–∏–º –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫
    if (data.shoppingList) {
        data.shoppingList = data.shoppingList.map(item => ({
            id: item.id,
            name: item.name,
            amount: round2(item.amount), // –û–∫—Ä—É–≥–ª—è–µ–º –≤–µ—Å
            unit: item.unit,
            cost: Math.ceil(item.cost),  // –û–∫—Ä—É–≥–ª—è–µ–º —Ü–µ–Ω—É –¥–æ —Ü–µ–ª–æ–≥–æ
            // –£–î–ê–õ–Ø–ï–ú –ö–ë–ñ–£ (p_tot, f_tot...) - –æ–Ω–∏ –∑–∞–Ω–∏–º–∞—é—Ç 40% –º–µ—Å—Ç–∞!
        }));
    }

    // 2. –ß–∏—Å—Ç–∏–º –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ –±–ª–æ–∫–∞–º (–¥–ª—è —Å—É-—à–µ—Ñ–∞)
    if (data.detailedBlocks) {
        data.detailedBlocks.forEach(block => {
            // –û–∫—Ä—É–≥–ª—è–µ–º —Ü–µ–Ω—É –±–ª–æ–∫–∞
            block.totalCost = Math.ceil(block.totalCost);
            
            if (block.ingredients) {
                block.ingredients = block.ingredients.map(ing => ({
                    // –ù–∞–º –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ –∏–º—è, –≤–µ—Å, –µ–¥.–∏–∑–º –∏ —Ü–µ–Ω–∞ (–¥–ª—è –æ—Ç—á–µ—Ç–æ–≤)
                    // ID –∑–¥–µ—Å—å –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω, –µ—Å–ª–∏ –µ—Å—Ç—å –∏–º—è, –Ω–æ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
                    id: ing.id, 
                    name: ing.name,
                    amount: round2(ing.amount),
                    unit: ing.unit,
                    cost: Math.ceil(ing.cost)
                }));
            }
        });
    }
    
    // 3. –û–∫—Ä—É–≥–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–µ –≤–µ—Å–∞ –∏ —Ü–µ–Ω—ã
    if (data.weights) {
        data.weights.total = round2(data.weights.total);
        data.weights.filling = round2(data.weights.filling);
        data.weights.coating = round2(data.weights.coating);
    }
    
    return data;
}
// 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –∏ –ø–µ—Ä–µ—Å—á–µ—Ç —Å—É–º–º—ã
// 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (–° –ü–û–î–î–ï–†–ñ–ö–û–ô –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø)
async function confirmAddToQueueWithClient() {
    let resData;
    let laborData;
    let extrasData;

    // --- –õ–û–ì–ò–ö–ê: –ù–û–í–´–ô –ò–õ–ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï? ---
    if (editingOrderId) {
        // –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï: –ë–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ—Ä—Ç–∞ –∏–∑ –°–¢–ê–†–û–ì–û –∑–∞–∫–∞–∑–∞ (–º—ã –∏—Ö –Ω–µ –º–µ–Ω—è–ª–∏)
        const oldOrder = productionQueue.find(o => o.id === editingOrderId);
        if (!oldOrder) { alert("–û—à–∏–±–∫–∞: –∑–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω"); return; }
        
        resData = oldOrder.data;     // –û—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ä–∞—Å—á–µ—Ç —Ç–æ—Ä—Ç–∞
        laborData = oldOrder.labor;  // –û—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ä–∞–±–æ—Ç—ã
        extrasData = oldOrder.extras;// –û—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–∏
        
        // (–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –º–µ–Ω—è—Ç—å –≤–µ—Å/—Ü–µ–Ω—É –≤—Ä—É—á–Ω—É—é, –º–æ–∂–Ω–æ –±—Ä–∞—Ç—å –∏—Ö –∏–∑ –∏–Ω–ø—É—Ç–æ–≤, –Ω–æ –ø–æ–∫–∞ –±–µ—Ä–µ–º —Ä–∞—Å—á–µ—Ç–Ω—ã–µ)
        // –ù–æ —Ü–µ–Ω—ã (–ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞/–æ—Å—Ç–∞—Ç–æ–∫) –±–µ—Ä–µ–º –Ω–æ–≤—ã–µ –∏–∑ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –Ω–∏–∂–µ
    } else {
        // –ù–û–í–´–ô: –ë–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–†–ê
        resData = appState.results[appState.activeSide];
        if (!resData || !resData.costs || resData.costs.totalProductionCost === 0) {
            alert("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ —Ç–æ—Ä—Ç!");
            return;
        }
        // –ë–µ—Ä–µ–º —Ç–µ–∫—É—â–∏–µ —Å–ø–∏—Å–∫–∏ —Ä–∞–±–æ—Ç –∏ –¥–æ–ø–æ–≤
        laborData = JSON.parse(JSON.stringify(currentLaborList || []));
        extrasData = JSON.parse(JSON.stringify(extrasList || []));
    }

    let clientName = document.getElementById('orderClientSearch').value.trim();
    let clientId = document.getElementById('orderClientId').value;
    
    // ... (–∫–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ —Ç–æ—Ç –∂–µ, —Å–æ–∫—Ä–∞—Ç–∏–ª –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏) ...
    // –ê–≤—Ç–æ-—Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ (–µ—Å–ª–∏ –Ω–æ–≤—ã–π)
// --- –ü–û–õ–£–ß–ê–ï–ú –î–ê–ù–ù–´–ï –ò–ó –§–û–†–ú–´ ---
    const inputPhone = document.getElementById('orderPhone').value.trim();
    const inputSocial = document.getElementById('orderSocial').value.trim();

    // –ê–≤—Ç–æ-—Å–æ–∑–¥–∞–Ω–∏–µ –ò–õ–ò –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
    if (!clientId) {
        // 1. –ï–°–õ–ò –ù–û–í–´–ô ‚Äî –°–û–ó–î–ê–ï–ú
        clientId = 'c' + Date.now();
        clientsDataLocal[clientId] = {
            name: clientName,
            phone: inputPhone,
            social: inputSocial,
            created: new Date().toISOString(),
            totalSpend: 0,
            history: {}
        };
    } else {
        // 2. –ï–°–õ–ò –°–£–©–ï–°–¢–í–£–ï–¢ ‚Äî –û–ë–ù–û–í–õ–Ø–ï–ú –ö–û–ù–¢–ê–ö–¢–´
        if (clientsDataLocal[clientId]) {
            clientsDataLocal[clientId].phone = inputPhone;
            clientsDataLocal[clientId].social = inputSocial;
            // –ï—Å–ª–∏ –∏–º—è –≤ –ø–æ–∏—Å–∫–µ –∏—Å–ø—Ä–∞–≤–∏–ª–∏ ‚Äî –æ–±–Ω–æ–≤–∏–º –∏ –∏–º—è
            if (clientName) clientsDataLocal[clientId].name = clientName;
        }
    }

    const prepStr = document.getElementById('orderPrepayment').value.replace(/\D/g, '');
    const balStr = document.getElementById('orderBalance').value.replace(/\D/g, '');
    const prepaymentVal = parseFloat(prepStr) || 0;
    const balanceVal = parseFloat(balStr) || 0;
    
    // –¶–µ–Ω—É —Ç–æ—Ä—Ç–∞ –±–µ—Ä–µ–º –∏–∑ —Ä–∞—Å—á–µ—Ç–∞. –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –º–µ–Ω—è—Ç—å —Ü–µ–Ω—É –≤—Ä—É—á–Ω—É—é –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ - –Ω—É–∂–Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫–∞.
    // –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ä–∞—Å—á–µ—Ç–Ω—É—é —Ü–µ–Ω—É.
    const orderPrice = resData.costs.finalPrice;
    
    const orderData = {
        id: editingOrderId || ('ord_' + Date.now()), // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π ID –µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º
        clientId: clientId,
        name: clientName,
        phone: document.getElementById('orderPhone').value.trim(),
        social: document.getElementById('orderSocial').value.trim(),
        address: document.getElementById('orderAddress').value.trim(),
        prepayment: prepaymentVal,
        balance: balanceVal,
        date: document.getElementById('orderDeadline').value,
        reason: document.getElementById('orderReason').value,
        forWhom: document.getElementById('orderForWhom').value,
        color: document.getElementById('orderColor').value,
        payment: document.getElementById('orderPayment').value,
        delivery: document.getElementById('orderDelivery').value,
        comment: document.getElementById('orderComment').value,
        price: orderPrice,
        weight: (resData.weights.total / 1000).toFixed(2),
        
        data: resData, // –°–æ—Ö—Ä–∞–Ω—è–µ–º (—Å—Ç–∞—Ä—ã–µ –∏–ª–∏ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–æ—Ä—Ç–∞)
        labor: laborData,
        extras: extrasData,
        
        // –§–æ—Ç–æ: –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∏–ª–∏ –Ω–æ–≤–æ–µ - –±—É–¥–µ—Ç LOCAL_DB. –ï—Å–ª–∏ –Ω–µ—Ç - –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ (–µ—Å–ª–∏ –±—ã–ª–æ)
        refImage: currentOrderImageBase64 ? 'LOCAL_DB' : (editingOrderId ? 'LOCAL_DB' : null)
    };

    // --- –°–û–•–†–ê–ù–ï–ù–ò–ï –§–û–¢–û ---
   // --- –°–û–•–†–ê–ù–ï–ù–ò–ï –§–û–¢–û (–ì–ò–ë–†–ò–î–ù–û–ï) ---
    // 1. –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ (–¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏)
    if (currentOrderImageBase64) {
        imageDB.save(orderData.id, currentOrderImageBase64);
        
        // 2. –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤ –û–±–ª–∞–∫–æ (—Ñ–æ–Ω–æ–º, —á—Ç–æ–±—ã –Ω–µ —Ç–æ—Ä–º–æ–∑–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
        // –ù–æ –ª—É—á—à–µ –ø–æ–¥–æ–∂–¥–∞—Ç—å –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å ID —Ñ–∞–π–ª–∞ —Å—Ä–∞–∑—É.
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ –∏–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞
        const btn = document.querySelector('#orderFinalizeModal .main-btn');
        const oldText = btn.innerText;
        btn.innerText = "‚òÅÔ∏è –ì—Ä—É–∑–∏–º —Ñ–æ—Ç–æ...";
        btn.disabled = true;

        try {
            const fileName = `Order_${orderData.id}_${clientName}.jpg`;
            const driveFileId = await apiUploadPhotoToDrive(currentOrderImageBase64, fileName);
            
            if (driveFileId) {
                orderData.refImage = 'DRIVE:' + driveFileId;
            } else {
                // –ï—Å–ª–∏ –Ω–µ –≤—ã—à–ª–æ, –æ—Å—Ç–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –º–µ—Ç–∫—É
                orderData.refImage = 'LOCAL_DB'; 
            }
        } catch(e) {
            console.log('–û—à–∏–±–∫–∞ –æ–±–ª–∞–∫–∞, —Ñ–æ—Ç–æ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ');
            orderData.refImage = 'LOCAL_DB';
        }
        
        btn.innerText = oldText;
        btn.disabled = false;
    } 
    // –ï—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ –º–µ–Ω—è–ª–∏ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏, –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Å—Å—ã–ª–∫—É (DRIVE:... –∏–ª–∏ LOCAL_DB)
    else if (editingOrderId) {
        const oldOrder = productionQueue.find(o => o.id === editingOrderId);
        if (oldOrder && oldOrder.refImage) {
            orderData.refImage = oldOrder.refImage;
        }
    }
    // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∏ —Ñ–æ—Ç–æ –Ω–µ –º–µ–Ω—è–ª–∏ - –æ–Ω–æ –æ—Å—Ç–∞–µ—Ç—Å—è –≤ –±–∞–∑–µ –ø–æ —Ç–æ–º—É –∂–µ ID, –Ω–∏—á–µ–≥–æ –¥–µ–ª–∞—Ç—å –Ω–µ –Ω–∞–¥–æ.

    // --- –û–ë–ù–û–í–õ–ï–ù–ò–ï –û–ß–ï–†–ï–î–ò ---
    if (editingOrderId) {
        // –ò—â–µ–º –∏–Ω–¥–µ–∫—Å –∏ –∑–∞–º–µ–Ω—è–µ–º
        const idx = productionQueue.findIndex(o => o.id === editingOrderId);
        if (idx !== -1) productionQueue[idx] = orderData;
        
        // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∫–ª–∏–µ–Ω—Ç–∞ (—É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∑–∞–ø–∏—Å—å, –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é, —Ç.–∫. –¥–∞–Ω–Ω—ã–µ –º–æ–≥–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è)
        if (clientsDataLocal[clientId] && clientsDataLocal[clientId].history) {
            clientsDataLocal[clientId].history[orderData.id] = orderData;
        }
    } else {
        // –ù–æ–≤—ã–π –∑–∞–∫–∞–∑
        productionQueue.push(orderData);
    }

    // --- –°–ë–†–û–° –ò –°–û–•–†–ê–ù–ï–ù–ò–ï ---
    editingOrderId = null; // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    const btn = document.querySelector('#orderFinalizeModal .main-btn');
    btn.innerText = "–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑";
    btn.style.background = "#4CAF50"; 

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å—ë
    saveQueue();
    localStorage.setItem('cachedClients', JSON.stringify(clientsDataLocal));
    saveToCloud('clients', clientsDataLocal);
    performAutoSave();

    document.getElementById('orderFinalizeModal').style.display = 'none';
    clearOrderImage();

    // --- –§–ò–ù–ê–õ–¨–ù–û–ï –û–ö–ù–û ---
    // (–ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ –∂–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ WhatsApp/–ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏)
    const waBtn = document.getElementById('btnSuccessWA');
    const calBtn = document.getElementById('btnSuccessCal');
    
    if (orderData.phone) {
        const dateRu = orderData.date.split('-').reverse().join('.');
        const cleanPhone = orderData.phone.replace(/\D/g, '');
        // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è... (–º–æ–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–∑ —Å—Ç–∞—Ä–æ–π —Ñ—É–Ω–∫—Ü–∏–∏)
        const waText = `–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ –∑–∞–∫–∞–∑—É üéÇ\n\n–î–∞—Ç–∞: *${dateRu}*\n...`; 
        waBtn.style.display = 'flex';
        waBtn.onclick = () => window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(waText)}`, '_blank');
    } else {
        waBtn.style.display = 'none';
    }
    
    const links = createCalendarLinks(orderData);
    calBtn.onclick = () => window.open(links.googleUrl, '_blank');

    document.getElementById('successModal').style.display = 'flex';
}
     // --- 1. –û–ë–†–ê–ë–û–¢–ö–ê –§–û–¢–û (–°–ñ–ê–¢–ò–ï) ---
let currentOrderImageBase64 = null; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ñ–æ—Ç–æ

function processOrderImage(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const img = new Image();
            img.src = e.target.result;
            
            img.onload = function() {
                // –°–∂–∏–º–∞–µ–º
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä 800px (—Ö–≤–∞—Ç–∏—Ç –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞)
                const MAX_WIDTH = 800;
                const MAX_HEIGHT = 800;
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                } else {
                    if (height > MAX_HEIGHT) {
                        width *= MAX_HEIGHT / height;
                        height = MAX_HEIGHT;
                    }
                }

                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);

                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ JPEG —Å –∫–∞—á–µ—Å—Ç–≤–æ–º 0.6 (60%)
                const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
                currentOrderImageBase64 = dataUrl;
                document.getElementById('orderRefImg').src = dataUrl;
                document.getElementById('orderRefImg').style.display = 'block';
                document.getElementById('orderRefPreviewBox').querySelector('span').style.display = 'none';
                document.getElementById('btnDelRef').style.display = 'inline-block';
            };
        };
        reader.readAsDataURL(file);
    }
}

function clearOrderImage() {
    currentOrderImageBase64 = null;
    const input = document.getElementById('orderRefInput');
    const img = document.getElementById('orderRefImg');
    const span = document.getElementById('orderRefPreviewBox')?.querySelector('span');
    const btn = document.getElementById('btnDelRef');

    if (input) input.value = '';
    if (img) { img.src = ''; img.style.display = 'none'; }
    if (span) span.style.display = 'block';
    if (btn) btn.style.display = 'none';
}


// --- 2. –ü–†–û–°–ú–û–¢–† –§–û–¢–û (–£–ú–ù–´–ô: –ò–©–ï–¢ –í–ï–ó–î–ï) ---
// --- 2. –ü–†–û–°–ú–û–¢–† –§–û–¢–û (–£–ú–ù–´–ô: –° –ü–†–û–í–ï–†–ö–û–ô –í–ï–†–°–ò–ò) ---
async function viewOrderRef(orderId) {
    // 1. –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –≤ –ü–õ–ê–ù–ï (–ê–∫—Ç–∏–≤–Ω—ã–µ)
    let order = productionQueue.find(o => o.id === orderId);

    // 2. –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî –∏—â–µ–º –≤ –ê–†–•–ò–í–ï
    if (!order) {
        order = archiveOrders.find(o => o.id === orderId);
    }

    // 3. –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ—Ç ‚Äî –∏—â–µ–º –≥–ª—É–±–æ–∫–æ –≤ –ö–õ–ò–ï–ù–¢–ê–•
    if (!order) {
        for (const clientId in clientsDataLocal) {
            const client = clientsDataLocal[clientId];
            if (client.history && client.history[orderId]) {
                order = client.history[orderId];
                break;
            }
        }
    }

    if (!order) {
        alert("‚ùå –û—à–∏–±–∫–∞: –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.");
        return;
    }

    // --- –õ–û–ì–ò–ö–ê –ü–†–û–í–ï–†–ö–ò –ê–ö–¢–£–ê–õ–¨–ù–û–°–¢–ò –ö–≠–®–ê (–ù–û–í–û–ï) ---
    const remoteLink = order.refImage; // –°—Å—ã–ª–∫–∞ –∏–∑ –æ–±–ª–∞–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, DRIVE:1A2B3C...)
    const cacheKey = 'img_ver_' + orderId; // –ö–ª—é—á –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏
    const lastKnownLink = localStorage.getItem(cacheKey); // –ß—Ç–æ –º—ã —Å–∫–∞—á–∏–≤–∞–ª–∏ –≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑?

    // –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –≤ –æ–±–ª–∞–∫–µ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Ç–æ–≥–æ, —á—Ç–æ –º—ã –ø–æ–º–Ω–∏–º ‚Äî –∑–Ω–∞—á–∏—Ç —Ñ–æ—Ç–æ –æ–±–Ω–æ–≤–∏–ª–æ—Å—å!
    if (remoteLink && remoteLink.startsWith('DRIVE:') && lastKnownLink !== remoteLink) {
        console.log("üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ! –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫—ç—à...");
        await imageDB.delete(orderId); // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–∑ –ø–∞–º—è—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        localStorage.setItem(cacheKey, remoteLink); // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
    }
    // ----------------------------------------------------

    let imageUrl = null;
    const loader = document.getElementById('loadingOverlay');

    try {
        // –ê. –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –∫—ç—à–µ (IndexedDB)
        const localData = await imageDB.get(orderId);
        
        if (localData) {
            imageUrl = localData;
            console.log('üì∏ –§–æ—Ç–æ –≤–∑—è—Ç–æ –∏–∑ –∫—ç—à–∞ (–±—ã—Å—Ç—Ä–æ)');
        } 
        // –ë. –ï—Å–ª–∏ –Ω–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ ‚Äî –∫–∞—á–∞–µ–º —Å –î–∏—Å–∫–∞
        else if (order.refImage && order.refImage.startsWith('DRIVE:')) {
            const fileId = order.refImage.split(':')[1];
            
            if(loader) {
                loader.style.display = 'flex';
                const status = document.getElementById('dbStatus');
                if(status) status.innerText = "‚òÅÔ∏è –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ...";
            }

            const cloudData = await apiDownloadPhotoFromDrive(fileId);
            
            if(loader) loader.style.display = 'none';

            if (cloudData) {
                imageUrl = cloudData;
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                imageDB.save(orderId, cloudData); 
                // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –≤–µ—Ä—Å–∏—é, —á—Ç–æ–±—ã –≤ –±—É–¥—É—â–µ–º –∑–Ω–∞—Ç—å, —á—Ç–æ —ç—Ç–æ –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç —Ñ–∞–π–ª
                localStorage.setItem(cacheKey, order.refImage);
            }
        }
        // –í. –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç (Base64 –≤–Ω—É—Ç—Ä–∏)
        else if (order.refImage && order.refImage.startsWith('data:image')) {
            imageUrl = order.refImage;
        }

    } catch (e) {
        console.error(e);
        if(loader) loader.style.display = 'none';
        alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ: " + e.message);
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–∞–π—Ç–±–æ–∫—Å
    if (imageUrl) {
        const container = document.getElementById('lightboxSvgContainer');
        container.innerHTML = `<img src="${imageUrl}" style="max-width:100%; max-height:100%; object-fit:contain; box-shadow:0 0 20px rgba(0,0,0,0.5);">`;
        document.getElementById('cakeLightbox').style.display = 'flex';
    } else {
        alert("‚ö†Ô∏è –§–æ—Ç–æ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏–ª–∏ —Å—Å—ã–ª–∫–∞ —É—Å—Ç–∞—Ä–µ–ª–∞.");
    }
}

// 4. –§–£–ù–ö–¶–ò–Ø –ü–ï–†–ï–°–ß–ï–¢–ê –û–ë–©–ï–ô –°–£–ú–ú–´ (–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è)
function recalculateClientTotal(clientId) {
    db.ref(`clients/${clientId}/history`).once('value', (snapshot) => {
        const history = snapshot.val();
        let total = 0;
        if (history) {
            Object.values(history).forEach(order => {
                total += parseFloat(order.price) || 0;
            });
        }
        db.ref(`clients/${clientId}/totalSpend`).set(total);
    });
}

// --- –≠–ö–°–ü–û–†–¢ –†–ï–¶–ï–ü–¢–ê –ù–ê –°–ö–õ–ê–î (–° —Ä–∞—Å—á–µ—Ç–æ–º —Ü–µ–Ω—ã –∑–∞ —à—Ç) ---
function exportRecipeToStock() {
    const r = myRecipes.find(x => x.id === activeRecId);
    if (!r) return;

    // 1. –°—á–∏—Ç–∞–µ–º —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—Å–µ—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –≤ —Ä–µ—Ü–µ–ø—Ç–µ
    let totalCost = 0;
    // (–ü—Ä–æ–±–µ–≥–∞–µ–º –ø–æ –≤—Å–µ–º –±–ª–æ–∫–∞–º –∏ —Å—Ç—Ä–æ–∫–∞–º)
    if (r.blocks) {
        r.blocks.forEach(b => {
            if (b.ingredients) {
                b.ingredients.forEach(link => {
                    const ing = myIngredients.find(i => i.id === link.id);
                    if (ing) {
                        // –¶–µ–Ω–∞ –∑–∞ 1 –µ–¥. * –í–µ—Å –≤ —Ä–µ—Ü–µ–ø—Ç–µ
                        const pricePerUnit = ing.packPrice / ing.packWeight;
                        totalCost += pricePerUnit * (parseFloat(link.weight)||0);
                    }
                });
            }
        });
    }

    // 2. –ï—Å–ª–∏ —ç—Ç–æ –î–ï–ö–û–† - —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–ª-–≤–æ —à—Ç—É–∫
    let yieldCount = "1";
    let promptText = `–†–µ—Ü–µ–ø—Ç: "${r.name}"\n–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–∞—Ä—Ç–∏–∏: ${Math.ceil(totalCost)} ${SYMBOLS[currentCurrency]}\n\n`;
    
    if (r.type === 'decor') {
        promptText += "–°–∫–æ–ª—å–∫–æ –®–¢–£–ö —Ñ–∏–≥—É—Ä–æ–∫ –ø–æ–ª—É—á–∏–ª–æ—Å—å –∏–∑ —ç—Ç–æ–π –ø–∞—Ä—Ç–∏–∏?";
    } else {
        promptText += "–°–∫–æ–ª—å–∫–æ –ø–æ—Ä—Ü–∏–π/—à—Ç—É–∫ –∏–∑–¥–µ–ª–∏–π –ø–æ–ª—É—á–∏–ª–æ—Å—å?";
    }

    const input = prompt(promptText, "1");
    if (!input) return;
    
    const count = parseFloat(input);
    if (!count || count <= 0) { alert('–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ'); return; }

    // 3. –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—É –∑–∞ 1 —à—Ç
    const costPerItem = Math.ceil(totalCost / count);
    // –í–µ—Å 1 —à—Ç—É–∫–∏ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω –æ–±—â–∏–π –≤–µ—Å –ø–∞—Ä—Ç–∏–∏)
    const weightPerItem = r.outputWeight ? (r.outputWeight / count) : 0;

    // 4. –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä –Ω–∞ —Å–∫–ª–∞–¥–µ
    let stockItem = myIngredients.find(i => i.name === r.name);

    if (stockItem) {
        if (confirm(`–¢–æ–≤–∞—Ä "${r.name}" —É–∂–µ –µ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ.\n–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞: ${stockItem.packPrice}\n–ù–æ–≤–∞—è —Ü–µ–Ω–∞: ${costPerItem}\n\n–û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É?`)) {
            stockItem.packPrice = costPerItem;
            stockItem.packWeight = 1; // –£–ø–∞–∫–æ–≤–∫–∞ = 1 —à—Ç
            stockItem.unit = '—à—Ç';
            stockItem.singleWeight = weightPerItem; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–µ—Å –æ–¥–Ω–æ–π —Ñ–∏–≥—É—Ä–∫–∏
            saveIngs();
            alert('‚úÖ –¶–µ–Ω–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
        }
    } else {
        myIngredients.push({
            id: 'prod_' + Date.now(),
            name: r.name,
            unit: '—à—Ç',
            singleWeight: weightPerItem, // –í–µ—Å 1 —à—Ç (–¥–ª—è —Å–ø—Ä–∞–≤–∫–∏)
            packWeight: 1,   // –í –ø–∞—á–∫–µ 1 —à—Ç
            packPrice: costPerItem // –¶–µ–Ω–∞ –∑–∞ —ç—Ç—É 1 —à—Ç
        });
        saveIngs();
        alert(`‚úÖ –¢–æ–≤–∞—Ä "${r.name}" —Å–æ–∑–¥–∞–Ω –Ω–∞ —Å–∫–ª–∞–¥–µ!\n–¶–µ–Ω–∞: ${costPerItem} –∑–∞ 1 —à—Ç.`);
    }
}

// --- –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–í–û–î–ù–û–ô –í–ï–î–û–ú–û–°–¢–ò (–° –ó–ê–ú–ï–°–ê–ú–ò –î–õ–Ø –ö–†–ï–ú–ê v7) ---
function generateBatchReport() {
    // 1. –ü–†–û–í–ï–†–ö–ò
    const checkboxes = document.querySelectorAll('.batch-checkbox:checked');
    if (checkboxes.length === 0) {
        alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∑–∞–∫–∞–∑ –≥–∞–ª–æ—á–∫–æ–π!");
        return;
    }

    const selectedIds = Array.from(checkboxes).map(cb => cb.value);
    const ordersToProcess = productionQueue.filter(ord => selectedIds.includes(ord.id));

    let batches = {};

    // 2. –û–ë–†–ê–ë–û–¢–ö–ê –î–ê–ù–ù–´–•
    ordersToProcess.forEach(ord => {
        if (!ord.data || !ord.data.detailedBlocks) return; 

        const ordColor = ord.color ? ord.color.trim() : null;

        ord.data.detailedBlocks.forEach(block => {
            if (!block.ingredients) return; 

            const type = block.type; 
            
            // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –æ–±—ä–µ–∫—Ç —è—Ä—É—Å–∞ –¥–ª—è —Ä–∞–∑–º–µ—Ä–æ–≤
            // (–ò—â–µ–º –≤ –∏–º–µ–Ω–∏ "–Ø—Ä—É—Å X", –µ—Å–ª–∏ –Ω–µ –Ω–∞—Ö–æ–¥–∏–º - –±–µ—Ä–µ–º –æ–±—â—É—é –≥–µ–æ–º–µ—Ç—Ä–∏—é)
            let tierObj = null;
            const match = block.name.match(/–Ø—Ä—É—Å\s+(\d+)/);
            if (match && ord.data.tiers) {
                 tierObj = ord.data.tiers.find(t => t.id == match[1]);
            }
            
            // --- –†–ê–ó–ú–ï–†–´ ---
            let sizeInfo = "";
            let tierHeight = 0;
            let displayD = 0;
            let displayW = 0;

            if (tierObj) {
                const shape = ord.data.geometry.shape;
                displayD = Math.round(tierObj.d);
                const h = Math.round(tierObj.h);
                displayW = tierObj.w ? Math.round(tierObj.w) : displayD;
                tierHeight = h;
                sizeInfo = (shape === 'rectangle') ? `${displayD}x${displayW} H${h}` : `D${displayD} H${h}`;
            } else {
                sizeInfo = ord.data.geometry ? `D${ord.data.geometry.d}` : "";
                tierHeight = ord.data.geometry ? ord.data.geometry.h : 0;
                displayD = ord.data.geometry ? ord.data.geometry.d : 0;
            }

            const nameLower = block.name.toLowerCase();
            if (nameLower.includes('–º—É—Å—Å')) {
                let mousseD = displayD - 2;
                let mousseW = displayW - 2; 
                let mousseLabel = (ord.data.geometry.shape === 'rectangle') ? `${mousseD}x${mousseW}` : `D${mousseD}`;
                sizeInfo += ` <span style="color:#E65100; font-weight:bold; background:#FFF3E0; padding:0 3px; border-radius:3px;">(–ú—É—Å—Å ${mousseLabel})</span>`;
            }

            const isRecipeExtra = nameLower.includes('–≤–µ–ª—é—Ä') || nameLower.includes('–≥–ª—è—Å—Å–∞–∂') || nameLower.includes('–ø–æ–∫—Ä—ã—Ç–∏–µ');

            // --- –û–ß–ò–°–¢–ö–ê –ò–ú–ï–ù–ò –î–õ–Ø –ì–†–£–ü–ü–ò–†–û–í–ö–ò ---
            // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ —Å—É—Ç—å: "–°–Ω–∏–∫–µ—Ä—Å: –ö—Ä–µ–º" -> "–ö—Ä–µ–º"
            let cleanName = block.name;
            if (block.name.includes(':')) {
                cleanName = block.name.split(':').pop().trim();
            } else {
                cleanName = block.name.replace(/(\(?\s*–Ø—Ä—É—Å\s+[^):]+\s*\)?)/gi, '').replace(/–ü–æ–∫—Ä—ã—Ç–∏–µ/gi, '').replace(/–í–µ–ª—é—Ä/gi, '').trim();
            }

            // –ö–ï–ô–° 1: –î–ï–ö–û–†
            if (type === 'extra' && !isRecipeExtra) {
                block.ingredients.forEach(ing => {
                    const itemName = ing.name; 
                    if (!batches[itemName]) {
                        batches[itemName] = {
                            name: itemName, type: 'decor_item', totalWeight: 0, ingredients: {}, tasks: [],        
                            coatingBaseTotal: 0, coatingBaseTasks: [], coatingColors: {}
                        };
                    }
                    const batch = batches[itemName];
                    if (!batch.ingredients[ing.name]) batch.ingredients[ing.name] = { amount: 0, unit: ing.unit };
                    batch.ingredients[ing.name].amount += ing.amount;
                    batch.tasks.push({ client: ord.name, info: sizeInfo, displayValue: `${ing.amount} ${ing.unit}` });
                });
            } 
            // –ö–ï–ô–° 2: –ü–†–û–î–£–ö–¢–´ (–û–°–ù–û–í–ù–û–ô –†–ê–°–ß–ï–¢)
            else {
                if (!batches[cleanName]) {
                    batches[cleanName] = {
                        name: cleanName, type: type, totalWeight: 0, ingredients: {}, tasks: [],
                        coatingBaseTotal: 0, coatingBaseTasks: [], coatingColors: {}
                    };
                }
                const batch = batches[cleanName];
                
                // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏
                let currentBlockRawSum = 0;
                let taskBaseReadyWeight = 0; 
                let taskSpecialItems = []; 

                // 1. –ò–©–ï–ú –ë–õ–û–ö –í –û–†–ò–ì–ò–ù–ê–õ–¨–ù–û–ú –†–ï–¶–ï–ü–¢–ï (–ë–ê–ó–ê –î–ê–ù–ù–´–•)
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ recipeId –∏ blockIndex –¥–ª—è 100% —Ç–æ—á–Ω–æ—Å—Ç–∏
                let originalBlock = null;
                if (block.recipeId && block.blockIndex !== undefined) {
                    const r = myRecipes.find(rr => rr.id === block.recipeId);
                    if (r && r.blocks && r.blocks[block.blockIndex]) {
                        originalBlock = r.blocks[block.blockIndex];
                    }
                }

                // 2. –°–ß–ò–¢–ê–ï–ú –í–ï–°–ê
                block.ingredients.forEach((ing, idx) => {
                    const ingKey = ing.name; 
                    if (!batch.ingredients[ingKey]) {
                        batch.ingredients[ingKey] = { name: ing.name, amount: 0, unit: ing.unit };
                    }
                    batch.ingredients[ingKey].amount += ing.amount;
                    
                    let weightInGrams = 0; 
                    if (ing.unit === '—à—Ç') {
                        const refIng = myIngredients.find(i => i.name === ing.name);
                        weightInGrams = ing.amount * ((refIng && refIng.singleWeight) ? refIng.singleWeight : 0);
                    } else if (['–≥','ml','–º–ª'].includes(ing.unit)) {
                        weightInGrams = ing.amount;
                    }
                    
                    currentBlockRawSum += weightInGrams;
                    batch.totalWeight += weightInGrams;

                    // --- –õ–û–ì–ò–ö–ê –ß–ò–°–¢–û–ì–û –í–ï–°–ê (–£–í–ê–†–ö–ê) ---
                    let readyWeightInGrams = weightInGrams; 
                    let isSpecial = false;

                    if (originalBlock) {
                        // –ò—â–µ–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ –ø–æ ID (—Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±)
                        let origIng = null;
                        if (ing.id) {
                            origIng = originalBlock.ingredients.find(i => i.id === ing.id);
                        }
                        
                        // –ï—Å–ª–∏ ID –Ω–µ—Ç (—Å—Ç–∞—Ä—ã–π –∑–∞–∫–∞–∑), –ø—Ä–æ–±—É–µ–º –ø–æ –∏–º–µ–Ω–∏
                        if (!origIng) {
                            origIng = originalBlock.ingredients.find(i => {
                                const dbIng = myIngredients.find(mi => mi.id === i.id);
                                return dbIng && dbIng.name.toLowerCase().trim() === ing.name.toLowerCase().trim();
                            });
                        }

                        if (origIng) {
                            const origIn = parseFloat(origIng.weight);
                            const origOut = parseFloat(origIng.outputWeight);
                            
                            // –ï–°–õ–ò –í–´–•–û–î –ó–ê–î–ê–ù –ò –û–¢–õ–ò–ß–ê–ï–¢–°–Ø (–ü–Æ–†–ï –£–í–ê–†–ò–õ–û–°–¨)
                            if (origOut && origIn > 0 && Math.abs(origOut - origIn) > 0.1) {
                                const ratio = origOut / origIn;
                                readyWeightInGrams = weightInGrams * ratio;
                                isSpecial = true; 
                            }
                        }
                    }
                    
                    if (isSpecial) {
                        taskSpecialItems.push({ name: ing.name, weight: readyWeightInGrams });
                    } else {
                        taskBaseReadyWeight += readyWeightInGrams;
                    }
                });
                
                const totalTaskReadyWeight = taskBaseReadyWeight + taskSpecialItems.reduce((s, i) => s + i.weight, 0);
                const batchesCount = ord.batchCount || 1; 

                // --- –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï HTML –ó–ê–î–ê–ß–ò ---
                
                const weightPerBatchReady = totalTaskReadyWeight / batchesCount;
                const readySpecialPerBatch = taskSpecialItems.map(i => ({...i, weight: i.weight / batchesCount}));

                // –ú–∏–Ω–∏-—Ä–µ—Ü–µ–ø—Ç –¥–ª—è –∑–∞–∫—É–ø–∞
                let recipeHTML = "";
                if (batchesCount > 1) {
                    const ingList = block.ingredients.map(ing => {
                        const val = ing.amount / batchesCount;
                        const valStr = (val > 5) ? Math.round(val) : ((val % 1 === 0) ? val : val.toFixed(1));
                        return `<span style="white-space:nowrap;">${ing.name}: <b>${valStr}${ing.unit}</b></span>`;
                    }).join(', ');
                    recipeHTML = `<div style="margin-top:4px; padding:5px; background:rgba(0,0,0,0.03); border-radius:4px; font-size:11px; line-height:1.4; border-left:3px solid #795548; color:#444;">ü•£ <b>–ù–ê 1 –ó–ê–ú–ï–° (–°—ã—Ä–æ–π):</b><br>${ingList}</div>`;
                }

                // --- –°–¢–†–û–ö–ò –° –ß–ò–°–¢–´–ú –í–ï–°–û–ú ---
                let breakdownHTML = "";
                if (readySpecialPerBatch.length > 0) {
                    readySpecialPerBatch.forEach(item => {
                        breakdownHTML += `<div style="font-size:12px; font-weight:bold; color:#E65100; margin-top:2px; margin-left:15px;">
                            ‚Ä¢ ${item.name} (—á–∏—Å—Ç—ã–π): <b>${Math.round(item.weight)} –≥</b>
                        </div>`;
                    });
                }

                for (let i = 1; i <= batchesCount; i++) {
                    let distributionStr = "";
                    const distWeight = Math.floor(weightPerBatchReady); 
                    
                    if (tierHeight > 10 && cleanName.toLowerCase().includes('–±–∏—Å–∫–≤–∏—Ç')) {
                        const portion = Math.floor(distWeight / 2);
                        distributionStr = ` | <span style="color:#E65100; font-weight:bold;">‚§µÔ∏è 2 —Ñ–æ—Ä–º—ã –ø–æ ~${portion} –≥</span>`;
                    } else {
                        distributionStr = ` | <span style="color:#E65100; font-weight:bold;">‚§µÔ∏è –≤ –∫–æ–ª—å—Ü–æ ~${distWeight} –≥</span>`;
                    }

                    let prefix = "";
                    if (batchesCount > 1) {
                        prefix = `<span style="background:#333; color:#fff; padding:1px 4px; border-radius:3px; font-size:10px; margin-right:5px;">–ó–ê–ú–ï–° ${i}/${batchesCount}</span>`;
                    }
                    
                    // –ï–°–õ–ò –ö–†–ï–ú + –¶–í–ï–¢
                    if (type === 'coating' && ordColor) {
                        const rough = weightPerBatchReady * 0.67;
                        batch.coatingBaseTotal += rough;
                        // –ü–∏—à–µ–º –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é –≤ —á–µ—Ä–Ω–æ–≤–æ–π —Å–ª–æ–π
                        batch.coatingBaseTasks.push({ 
                            client: ord.name, info: sizeInfo, 
                            displayValue: `${prefix}<b>~${Math.round(rough)} –≥</b> (—á–µ—Ä–Ω–æ–≤–æ–π) ${breakdownHTML} ${recipeHTML}` 
                        });
                        
                        const finish = weightPerBatchReady * 0.33;
                        if (!batch.coatingColors[ordColor]) batch.coatingColors[ordColor] = [];
                        batch.coatingColors[ordColor].push({ 
                            client: ord.name, info: sizeInfo, 
                            displayValue: `${prefix}<b>~${Math.round(finish)} –≥</b>` 
                        });
                    } 
                    // –ò–ù–ê–ß–ï
                    else {
                        if (type === 'coating') {
                            batch.coatingBaseTotal += weightPerBatchReady;
                            batch.coatingBaseTasks.push({ 
                                client: ord.name, info: sizeInfo, 
                                displayValue: `${prefix}<b>~${Math.round(weightPerBatchReady)} –≥</b> (–í–µ—Å—å) ${breakdownHTML} ${recipeHTML}` 
                            });
                        } else {
                            batch.tasks.push({ 
                                client: ord.name, 
                                info: sizeInfo, 
                                displayValue: `${prefix}<b>~${Math.round(weightPerBatchReady)} –≥</b> (–≥–æ—Ç–æ–≤–æ–≥–æ) ${distributionStr} ${breakdownHTML} ${recipeHTML}`
                            });
                        }
                    }
                }
            }
        });
    });

    // --- 3. –ì–ï–ù–ï–†–ê–¶–ò–Ø HTML ---
    let html = `
    <style>
        .btn-pdf { background: linear-gradient(135deg, #673AB7 0%, #512DA8 100%); color: white; border: none; padding: 10px 24px; border-radius: 50px; font-size: 14px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(103, 58, 183, 0.3); display: flex; align-items: center; gap: 8px; }
        .batch-card { background:#fff; border-left:6px solid #ccc; border-radius:4px; margin-bottom:15px; box-shadow:0 2px 4px rgba(0,0,0,0.1); overflow:hidden; page-break-inside: avoid; }
        .batch-header { padding:10px 15px; border-bottom:1px solid rgba(0,0,0,0.05); display:flex; justify-content:space-between; align-items:center; }
        .batch-body { display:flex; flex-wrap:wrap; }
        .col-tasks { flex:1; min-width:300px; padding:15px; border-right:1px dashed rgba(0,0,0,0.1); }
        .col-ings { flex:1; min-width:240px; padding:15px; background:rgba(0,0,0,0.02); }
        .task-client { font-weight: 800; font-size: 14px; color: #000; }
        .task-info { font-weight: bold; font-size: 13px; color: #333; margin-left: 5px; }
    </style>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; padding-bottom:15px; border-bottom:2px solid #f0f0f0;">
        <div style="font-size:20px; font-weight:bold; color:#4527a0;">üìÖ –ü–ª–∞–Ω –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</div>
        <button class="btn-pdf" onclick="openBatchPDF()">üñ®Ô∏è –ü–µ—á–∞—Ç—å / PDF</button>
    </div>
    
    <div id="printArea">`;

    const sortedKeys = Object.keys(batches).sort((a,b) => {
        const getScore = (batch) => {
            const n = batch.name.toLowerCase();
            const t = batch.type;
            if (n.includes('–±–∏—Å–∫–≤–∏—Ç')) return 10;
            if (n.includes('–ø—Ä–æ–ø–∏—Ç–∫–∞')) return 20;
            if (t === 'filling') return 30; 
            if (t === 'decor_item' || t === 'decor') return 80;
            if (t === 'coating') return 90; 
            if (t === 'extra') return 100; 
            return 50;
        };
        return getScore(batches[a]) - getScore(batches[b]);
    });

    let decorBatches = [];

    sortedKeys.forEach(key => {
        const b = batches[key];
        if (b.type === 'decor_item') { decorBatches.push(b); return; }

        let bg = '#fff'; let border = '#ccc'; let icon = 'üì¶';
        const nLow = b.name.toLowerCase();
        
        if (nLow.includes('–±–∏—Å–∫–≤–∏—Ç')) { bg = '#FFF8E1'; border = '#FFC107'; icon = 'üçû'; }
        else if (nLow.includes('–∫–æ–Ω—Ñ–∏') || nLow.includes('–Ω–∞—á–∏–Ω–∫–∞')) { bg = '#FCE4EC'; border = '#E91E63'; icon = 'üçì'; }
        else if (nLow.includes('–ø—Ä–æ–ø–∏—Ç–∫–∞')) { bg = '#E0F7FA'; border = '#00BCD4'; icon = 'üíß'; }
        else if (b.type === 'filling' && nLow.includes('–∫—Ä–µ–º')) { bg = '#E8EAF6'; border = '#3F51B5'; icon = 'ü•£'; }
        else if (b.type === 'coating') { bg = '#EFEBE9'; border = '#795548'; icon = 'üé®'; }
        else if (b.type === 'extra')   { bg = '#F3E5F5'; border = '#9C27B0'; icon = '‚ú®'; }

        let listTitle = (b.type === 'extra') ? '–†–∞—Å—Ö–æ–¥:' : '–ö–∞—Ä—Ç–∞ —Ä–∞–∑–ª–∏–≤–∞ (–ì–æ—Ç–æ–≤—ã–π –≤–µ—Å):';
        if (b.coatingBaseTasks.length > 0) listTitle = '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ (–ì–æ—Ç–æ–≤—ã–π –≤–µ—Å):';

        const weightLabel = (b.totalWeight > 0) ? `–°—ã—Ä–æ–π –≤–µ—Å (–ò—Ç–æ–≥–æ): <b>${(b.totalWeight/1000).toFixed(2)} –∫–≥</b>` : '';

        html += `<div class="batch-card" style="background:${bg}; border-color:${border};">
                    <div class="batch-header">
                        <span style="font-size:16px; font-weight:bold; color:#333;">${icon} ${b.name}</span>
                        <span style="font-size:13px; color:#555; background:rgba(255,255,255,0.6); padding:2px 8px; border-radius:12px;">${weightLabel}</span>
                    </div>
                    <div class="batch-body">
                        <div class="col-tasks">`;
                        
        if (b.type === 'coating') {
            if (b.coatingBaseTasks.length > 0) {
                html += `<div style="margin-bottom:15px; padding-left:5px;">
                            <div style="font-size:12px; font-weight:bold; color:#5D4037;">üöß –ë–∞–∑–∞ / –ß–µ—Ä–Ω–æ–≤–∞—è: <span style="background:#fff; padding:0 4px;">~${Math.round(b.coatingBaseTotal)} –≥</span></div>
                            <ul style="margin:2px 0 0 15px; padding:0; list-style:none;">`;
                b.coatingBaseTasks.forEach(t => html += `<li style="margin-bottom:4px;"><span class="task-client">${t.client}</span> <span class="task-info">(${t.info})</span>: <b>${t.displayValue}</b></li>`);
                html += `</ul></div>`;
            }
            if (Object.keys(b.coatingColors).length > 0) {
                html += `<div style="font-size:12px; font-weight:bold; color:#5D4037; margin-bottom:5px;">üñåÔ∏è –§–∏–Ω–∏—à (–¶–≤–µ—Ç–∞):</div>`;
                for (const [color, tasks] of Object.entries(b.coatingColors)) {
                    let dot = '‚ö™'; const cL = color.toLowerCase();
                    if(cL.includes('–∫—Ä–∞—Å–Ω')) dot = 'üî¥'; else if(cL.includes('—Å–∏–Ω')) dot = 'üîµ'; else if(cL.includes('–∑–µ–ª–µ–Ω')) dot = 'üü¢'; else if(cL.includes('—á–µ—Ä–Ω')) dot = '‚ö´'; else if(cL.includes('–∂–µ–ª—Ç')) dot = 'üü°';
                    html += `<div style="margin-left:5px; margin-bottom:5px; border-left:2px solid #ddd; padding-left:8px;">
                                <div style="font-size:12px;">${dot} <b>${color}</b></div>
                                <ul style="margin:2px 0 0 15px; padding:0; list-style:none;">`;
                    tasks.forEach(t => html += `<li style="margin-bottom:4px;"><span class="task-client">${t.client}</span> <span class="task-info">(${t.info})</span>: <b>${t.displayValue}</b></li>`);
                    html += `</ul></div>`;
                }
            }
        } else {
            html += `<div style="font-size:11px; font-weight:bold; color:#666; margin-bottom:5px; text-transform:uppercase;">${listTitle}</div>
                     <table style="width:100%; font-size:13px;">`;
            b.tasks.forEach(t => {
                html += `<tr style="border-bottom:1px dotted #ccc;">
                            <td style="padding:6px 0; vertical-align:top;">
                                <span class="task-client">${t.client}</span>
                                <span class="task-info">(${t.info})</span>
                            </td>
                            <td style="text-align:right; font-weight:bold; vertical-align:top; padding-left:10px;">${t.displayValue}</td>
                         </tr>`;
            });
            html += `</table>`;
        }
        html += `</div>`; 

        html += `<div class="col-ings">
                    <div style="font-size:11px; font-weight:bold; text-transform:uppercase; color:#999; margin-bottom:8px;">ü•£ –ó–∞–∫—É–ø / –û–±—â–∏–π —Å–∫–ª–∞–¥:</div>
                    <table style="width:100%; font-size:13px; border-collapse:collapse;">`;
        
        Object.values(b.ingredients).forEach(data => {
            const ingName = data.name; 
            let val = data.amount;
            let displayVal;
            if (val > 5) {
                displayVal = Math.round(val);
            } else {
                if (data.unit === '—à—Ç') {
                     displayVal = (val % 1 === 0) ? val : val.toFixed(1);
                } else {
                     displayVal = (val % 1 === 0) ? val : val.toFixed(2);
                }
            }

            let displayAmount = `${displayVal} ${data.unit}`;
            if (ingName.toLowerCase().includes('—è–π—Ü–æ') && data.unit === '–≥') {
                let approxPcs = Math.round(val / 55);
                displayAmount += ` <small style="color:#666; font-weight:normal;">(~${approxPcs} —à—Ç)</small>`;
            }
            html += `<tr style="border-bottom:1px solid rgba(0,0,0,0.05);">
                        <td style="padding:3px 0;">${ingName}</td>
                        <td style="padding:3px 0; text-align:right; font-weight:bold;">${displayAmount}</td>
                      </tr>`;
        });
        html += `</table></div></div></div>`;
    });

    if (decorBatches.length > 0) {
        html += `<div class="batch-card" style="border-left-color:#4CAF50; background:#F1F8E9;">
                    <div class="batch-header" style="background:#E8F5E9;">
                        <span style="font-size:16px; font-weight:bold; color:#2E7D32;">üèóÔ∏è –ö–û–ú–ü–õ–ï–ö–¢–ê–¶–ò–Ø (–î–µ–∫–æ—Ä –∏ –£–ø–∞–∫–æ–≤–∫–∞)</span>
                    </div>
                    <div style="padding:0;">`;
        decorBatches.forEach((b, idx) => {
            const rowBg = (idx % 2 === 0) ? '#fff' : '#f9fbe7';
            let totalQtyStr = "";
            for (const [ingName, data] of Object.entries(b.ingredients)) { totalQtyStr = `${data.amount} ${data.unit}`; }

            const detailInfo = ordersToProcess.map(ord => {
                const found = ord.extras.find(ex => ex.name === b.name || b.name.includes(ex.name));
                return found ? found.comment : null;
            }).find(c => c !== null);

            html += `<div style="background:${rowBg}; padding:8px 15px; border-bottom:1px solid #eee; display:flex; flex-direction:column;">
                <div style="width:100%; display:flex; justify-content:space-between; margin-bottom:4px;">
                    <span style="font-weight:bold; font-size:14px; color:#333;">üì¶ ${b.name}</span>
                    <span style="font-weight:bold; font-size:13px; color:#2E7D32; background:#C8E6C9; padding:1px 6px; border-radius:4px;">–í—Å–µ–≥–æ: ${totalQtyStr}</span>
                </div>
                
                ${detailInfo ? `<div style="font-size:12px; color:#E65100; font-weight:bold; margin-bottom:5px; padding-left:10px;">üìê –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: ${detailInfo}</div>` : ''}

                <div style="width:100%; padding-left:10px;">
                    <table style="width:100%; font-size:13px; color:#555;">`;
            
            b.tasks.forEach(t => {
                html += `<tr>
                    <td style="padding:3px 0;">‚îî <span class="task-client">${t.client}</span> <span class="task-info">(${t.info})</span></td>
                    <td style="text-align:right;">${t.displayValue}</td>
                </tr>`;
            });
            html += `</table></div></div>`;
        });
        html += `</div></div>`;
    }
    
    html += `</div>`;
    
    const resDiv = document.getElementById('batchContent');
    resDiv.innerHTML = html;
    document.getElementById('batchResultBlock').style.display = 'block';
    resDiv.scrollIntoView({behavior: 'smooth', block: 'start'});
}
// ==========================================
// –õ–û–ì–ò–ö–ê –°–ö–õ–ê–î–ê (–ü–†–û–î–£–ö–¢–´ + –†–ê–ë–û–¢–´) - –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–û
// ==========================================

// 1. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ü—Ä–æ–¥—É–∫—Ç–∞–º–∏ –∏ –†–∞–±–æ—Ç–∞–º–∏


function renderLaborTable() {
    const tb = document.getElementById('laborTableBody');
    if (!tb) return;
    const search = document.getElementById('stockSearch').value.toLowerCase().trim();

    // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–µ–ø–µ—Ä—å —Ä–∏—Å—É–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤ HTML (—Å–º. –®–∞–≥ 5), –Ω–æ –º–æ–∂–Ω–æ –∏ –∑–¥–µ—Å—å,
    // –æ–¥–Ω–∞–∫–æ –ª—É—á—à–µ –æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—á–Ω—ã–π HTML header –∏ –æ–±–Ω–æ–≤–ª—è—Ç—å —Å—Ç—Ä–µ–ª–∫–∏.
    // –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å—Ç—Ä–æ–∫.

    // 1. –ú–∞–ø–ø–∏–Ω–≥ –∏ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    let list = myLaborServices.map((item, index) => ({ data: item, originalIndex: index }));
    
    list = list.filter(w => w.data.name.toLowerCase().includes(search));
    
    list.sort((a, b) => {
        let valA = a.data[laborSort.field];
        let valB = b.data[laborSort.field];
        if (typeof valA === 'string') valA = valA.toLowerCase();
        if (typeof valB === 'string') valB = valB.toLowerCase();
        
        if (valA < valB) return laborSort.dir === 'asc' ? -1 : 1;
        if (valA > valB) return laborSort.dir === 'asc' ? 1 : -1;
        return 0;
    });

    // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–ª–æ (–Ω–µ —Ç—Ä–æ–≥–∞—è —à–∞–ø–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –≤ thead)
    // –ù–æ —É –Ω–∞—Å –≤ —Å—Ç–∞—Ä–æ–º –∫–æ–¥–µ —à–∞–ø–∫–∞ –±—ã–ª–∞ –≤–Ω—É—Ç—Ä–∏ innerHTML.
    // –î–∞–≤–∞–π—Ç–µ —Å–¥–µ–ª–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ: –ü–µ—Ä–µ–∑–∞–ø–∏—à–µ–º –≤—Å–µ.
    
    
    const header = `<tr>
        <th style="width:40%" onclick="setSort('labor','name')">–í–∏–¥ —Ä–∞–±–æ—Ç—ã ${getSortArrow('labor','name')}</th>
        <th style="width:15%" onclick="setSort('labor','coeff')" title="–°–ª–æ–∂–Ω–æ—Å—Ç—å">–ö–æ—ç—Ñ. ${getSortArrow('labor','coeff')}</th>
        <th style="width:15%" onclick="setSort('labor','defaultTime')" title="–í—Ä–µ–º—è">–ß–∞—Å. ${getSortArrow('labor','defaultTime')}</th>
        <th style="width:10%" title="–ü–æ–º–æ—â–Ω–∏–∫">üë∑‚Äç‚ôÇÔ∏è</th>
        <th style="width:10%" title="–ê–≤—Ç–æ-–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ">‚ûï</th>
        <th style="width:10%"></th>
    </tr>`;
    
    let rows = '';
    list.forEach(wrapper => {
        const l = wrapper.data;
        const x = wrapper.originalIndex;

        rows += `
        <tr>
            <td><input value="${l.name}" onchange="updLabor(${x},'name',this.value)"></td>
            <td><input type="number" value="${l.coeff}" step="0.1" onchange="updLabor(${x},'coeff',this.value)" style="text-align:center;"></td>
            <td><input type="number" value="${l.defaultTime || 0}" step="0.1" onchange="updLabor(${x},'defaultTime',this.value)" style="text-align:center;"></td>
            <td style="text-align:center;"><input type="checkbox" ${l.isHelper ? 'checked' : ''} onchange="updLabor(${x},'isHelper',this.checked)"></td>
            <td style="text-align:center;"><input type="checkbox" ${l.isAuto ? 'checked' : ''} onchange="updLabor(${x},'isAuto',this.checked)"></td>
            <td style="text-align:center;"><button class="del-btn" onclick="delLabor(${x})">‚úï</button></td>
        </tr>`;
    });
    
    tb.innerHTML = header + rows;
}

// 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–π —è—á–µ–π–∫–∏ —Ä–∞–±–æ—Ç—ã
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
function updLabor(idx, field, val) {
    if (field === 'coeff' || field === 'defaultTime') {
        myLaborServices[idx][field] = parseFloat(val) || 0;
    } else {
        myLaborServices[idx][field] = val;
    }
    saveLabor();
    saveToHistory(); // –§–∏–∫—Å–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
function delLabor(idx) {
    if(confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤–∏–¥ —Ä–∞–±–æ—Ç –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞?')) {
        myLaborServices.splice(idx, 1);
        saveLabor();       // 1. –°–æ—Ö—Ä–∞–Ω–∏–ª–∏ –≤ LocalStorage
        renderLaborTable(); // 2. –û–±–Ω–æ–≤–∏–ª–∏ —Ç–∞–±–ª–∏—Ü—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ
        saveToHistory();   // 3. –°–¥–µ–ª–∞–ª–∏ —Å–Ω–∏–º–æ–∫ –¥–ª—è Undo
    }
}

// 6. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç—å
function saveLabor() {
    localStorage.setItem('myCakeLabor', JSON.stringify(myLaborServices));
    saveToCloud('labor', myLaborServices); // <--- –î–æ–±–∞–≤–ª–µ–Ω–æ
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
    const dlLabor = document.getElementById('allLaborDatalist');
    if (dlLabor) {
        dlLabor.innerHTML = '';
        myLaborServices.forEach(l => {
            const opt = document.createElement('option');
            opt.value = l.name; 
            dlLabor.appendChild(opt);
        });
    }
}

// ==========================================
// üß© –°–ò–°–¢–ï–ú–ù–´–ï –§–£–ù–ö–¶–ò–ò (–ë–≠–ö–ê–ü, –ò–ú–ü–û–†–¢, –≠–ö–°–ü–û–†–¢)
// ==========================================

function downloadBackup() {
    // 1. –ò–º—è —Ñ–∞–π–ª–∞
    const now = new Date();
    const defaultName = `–ö–æ–Ω–¥–∏—Ç–µ—ÄPRO_${now.toLocaleDateString()}_${now.getHours()}-${now.getMinutes()}`;
    let fileName = prompt("–ò–º—è —Ñ–∞–π–ª–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏:", defaultName);
    if (fileName === null) return;
    if (!fileName.trim()) fileName = defaultName;
    if (!fileName.endsWith('.json')) fileName += '.json';

    // 2. –°–±–æ—Ä –í–°–ï–• –¥–∞–Ω–Ω—ã—Ö
    const data = {
        // –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        ingredients: myIngredients,
        recipes: myRecipes,
        labor: myLaborServices,
        queue: productionQueue,
        clients: clientsDataLocal, // <--- –î–û–ë–ê–í–ò–õ–ò –≠–¢–£ –°–¢–†–û–ö–£ (–¢–µ–ø–µ—Ä—å –∫–ª–∏–µ–Ω—Ç—ã –≤ —Ñ–∞–π–ª–µ!)
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        settings: {
            currency: currentCurrency,
            hourlyRate: document.getElementById('hourlyRate').value,
            tax: document.getElementById('finTax').value,
            bank: document.getElementById('finBank').value,
            overhead: document.getElementById('finOverhead').value
        },

        // –¢–æ, —á—Ç–æ —Å–µ–π—á–∞—Å –Ω–∞ —ç–∫—Ä–∞–Ω–µ (–¢–µ–∫—É—â–∞—è —Ä–∞–±–æ—Ç–∞)
        currentSession: {
            tiers: appState.tiers,
            shape: document.getElementById('globalShape').value,
            sides: document.getElementById('globalSides').value,
            coatingId: document.getElementById('coatingIdSelect').value,
            extraCoatingId: document.getElementById('extraCoatingIdSelect').value,
            sphereFillMode: document.querySelector('input[name="sphereFillMode"]:checked') ? document.querySelector('input[name="sphereFillMode"]:checked').value : 'recipe',
            extras: extrasList,
            laborList: currentLaborList
        },
        
        backupDate: new Date().toLocaleString()
    };
    
    // 3. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
    const jsonStr = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonStr], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    a.click();
    
    setTimeout(() => URL.revokeObjectURL(url), 100);
}

function loadBackupFile(el) {
    const f = el.files[0];
    if (!f) return;

    // 1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
    const loader = document.getElementById('loadingOverlay');
    loader.style.display = 'flex';

    // 2. –ò—Å–ø–æ–ª—å–∑—É–µ–º setTimeout, —á—Ç–æ–±—ã –¥–∞—Ç—å –±—Ä–∞—É–∑–µ—Ä—É –≤—Ä–µ–º—è –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Å–ø–∏–Ω–Ω–µ—Ä
    // –ø–µ—Ä–µ–¥ —Ç–µ–º, –∫–∞–∫ JS –Ω–∞—á–Ω–µ—Ç —Ç—è–∂–µ–ª—É—é —Ä–∞–±–æ—Ç—É –ø–æ –ø–∞—Ä—Å–∏–Ω–≥—É —Ñ–∞–π–ª–∞
    setTimeout(() => {
        const r = new FileReader();
        
        r.onload = e => {
            try {
                const d = JSON.parse(e.target.result);

                // --- –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ë–ê–ó ---
                if (d.ingredients) { myIngredients = d.ingredients; saveIngs(); }
                if (d.recipes) { myRecipes = d.recipes; saveRecs(); }
                if (d.labor) { myLaborServices = d.labor; saveLabor(); }
                if (d.queue) { productionQueue = d.queue; saveQueue(); }

                // --- –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ö–õ–ò–ï–ù–¢–û–í ---
                // (–¢—É—Ç –±—É–¥–µ—Ç –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —Å–ø–∏–Ω–Ω–µ—Ä –ø–æ–∫–∞ –ø–æ–≤–∏—Å–∏—Ç –Ω–∞ —Ñ–æ–Ω–µ)
                if (d.clients) {
                    // –í—Ä–µ–º–µ–Ω–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä –¥–ª—è –¥–∏–∞–ª–æ–≥–∞, —á—Ç–æ–±—ã –±—ã–ª–æ –≤–∏–¥–Ω–æ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ confirm
                    loader.style.display = 'none'; 
                    if (confirm("–í —Ñ–∞–π–ª–µ –µ—Å—Ç—å –±–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤. –ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—ë –ª–æ–∫–∞–ª—å–Ω–æ?")) {
                        clientsDataLocal = d.clients;
                        localStorage.setItem('cachedClients', JSON.stringify(clientsDataLocal));
                        renderClientsCloud();
                    }
                    // –ï—Å–ª–∏ —Ä–∞–±–æ—Ç–∞–µ–º –¥–∞–ª—å—à–µ, –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –ª–æ–∞–¥–µ—Ä, –Ω–æ —Ç—É—Ç –º—ã —É–∂–µ –ø–æ—á—Ç–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏
                }

                // --- –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ù–ê–°–¢–†–û–ï–ö ---
                if (d.settings) {
                    if (d.settings.currency) changeCurrency(d.settings.currency);
                    
                    const setVal = (id, val) => { 
                        const el = document.getElementById(id); 
                        if (el) el.value = val; 
                    };
                    
                    setVal('hourlyRate', d.settings.hourlyRate);
                    setVal('finTax', d.settings.tax);
                    setVal('finBank', d.settings.bank);
                    setVal('finOverhead', d.settings.overhead);
                    
                    saveHourlyRate();
                    saveFinance();
                } else if (d.currency) {
                    changeCurrency(d.currency);
                }

                // --- –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –¢–ï–ö–£–©–ï–ô –°–ï–°–°–ò–ò (–≠–ö–†–ê–ù–ê) ---
                if (d.currentSession) {
                    const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
                    
                    setVal('globalShape', d.currentSession.shape || 'cylinder');
                    setVal('globalSides', d.currentSession.sides || 6);

                    if (d.currentSession.tiers) appState.tiers = d.currentSession.tiers;
                    
                    extrasList = d.currentSession.extras || [];
                    currentLaborList = d.currentSession.laborList || [];

                    updateUI();
                    updateTierUI();
                    renderExtras();
                    renderLaborTasks();

                    if (d.currentSession.coatingId) {
                        setVal('coatingIdSelect', d.currentSession.coatingId);
                        updateCoatingUI();
                    }
                    if (d.currentSession.extraCoatingId) {
                        setVal('extraCoatingIdSelect', d.currentSession.extraCoatingId);
                    }
                    if (d.currentSession.sphereFillMode) {
                        const r = document.querySelector(`input[name="sphereFillMode"][value="${d.currentSession.sphereFillMode}"]`);
                        if(r) r.checked = true;
                    }
                }

                // --- –§–ò–ù–ê–õ ---
                // –ú—ã —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert("–ì–æ—Ç–æ–≤–æ"), –∫–∞–∫ –≤—ã –ø—Ä–æ—Å–∏–ª–∏.
                // –ü—Ä–æ—Å—Ç–æ —Ç–∏—Ö–æ –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É.

            } catch (err) {
                alert('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞! ' + err.message);
            } finally {
                // 4. –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ
                // (–î–∞–∂–µ –µ—Å–ª–∏ –±—ã–ª–∞ –æ—à–∏–±–∫–∞)
                loader.style.display = 'none';
                el.value = ''; // –û—á–∏—â–∞–µ–º –∏–Ω–ø—É—Ç —Ñ–∞–π–ª–∞
            }
        };

        // –ó–∞–ø—É—Å–∫–∞–µ–º —á—Ç–µ–Ω–∏–µ
        r.readAsText(f);
        
    }, 50); // –ó–∞–¥–µ—Ä–∂–∫–∞ 50–º—Å –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ UI
}

// --- 3. –£–ú–ù–´–ô –ò–ú–ü–û–†–¢ (EXCEL) ---

// –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –∫–Ω–æ–ø–∫–∏ –ò–º–ø–æ—Ä—Ç –ø—Ä–∏ —Å–º–µ–Ω–µ –≤–∫–ª–∞–¥–∫–∏ —Å–∫–ª–∞–¥–∞
function switchStockView(mode) {
    const ingBlock = document.getElementById('ingredientsStockBlock');
    const laborBlock = document.getElementById('laborStockBlock');
    // –ö–Ω–æ–ø–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ (–Ω–∞—Ö–æ–¥–∏–º –µ—ë –ø–æ —Ç–µ–∫—Å—Ç—É –∏–ª–∏ –∫–ª–∞—Å—Å—É, –ª—É—á—à–µ –¥–æ–±–∞–≤–∏—Ç—å ID –≤ HTML, –Ω–æ –º–æ–∂–Ω–æ –∏ —Ç–∞–∫)
    const importBtn = document.querySelector("button[onclick^='openImportModal']");
    
    if (mode === 'ingredients') {
        ingBlock.style.display = 'block';
        laborBlock.style.display = 'none';
        renderStockTable();
        if(importBtn) importBtn.setAttribute('onclick', "openImportModal('ingredients')");
    } else {
        ingBlock.style.display = 'none';
        laborBlock.style.display = 'block';
        renderLaborTable();
        if(importBtn) importBtn.setAttribute('onclick', "openImportModal('labor')");
    }
}

function openImportModal(mode) {
    impMode = mode;
    document.getElementById('importModal').style.display = 'flex';
    const titleEl = document.getElementById('importTitle');
    const descEl = document.getElementById('importDesc');
    const area = document.getElementById('importText');
    
    area.value = ''; // –û—á–∏—Å—Ç–∫–∞

    if (mode === 'ingredients') {
        titleEl.innerText = 'üçé –ò–º–ø–æ—Ä—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤';
        descEl.innerHTML = '–ö–æ–ø–∏—Ä—É–π—Ç–µ –∏–∑ Excel (–±–µ–∑ —à–∞–ø–∫–∏).<br>–ü–æ—Ä—è–¥–æ–∫: <b>–ù–∞–∑–≤–∞–Ω–∏–µ | –ï–¥.–∏–∑–º | –ë | –ñ | –£ | –ö–∫–∞–ª | –í–µ—Å –ø–∞—á–∫–∏ | –¶–µ–Ω–∞ –ø–∞—á–∫–∏</b>';
        area.placeholder = "–ú—É–∫–∞\t–≥\t1000\t500\n–°–∞—Ö–∞—Ä\t–≥\t1000\t600...";
    } 
    else if (mode === 'labor') {
        titleEl.innerText = 'üõ†Ô∏è –ò–º–ø–æ—Ä—Ç –≤–∏–¥–æ–≤ —Ä–∞–±–æ—Ç';
        descEl.innerHTML = '–ö–æ–ø–∏—Ä—É–π—Ç–µ –∏–∑ Excel (–±–µ–∑ —à–∞–ø–∫–∏).<br>–ü–æ—Ä—è–¥–æ–∫ –∫–æ–ª–æ–Ω–æ–∫: <b>–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã | –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (1.0 - 2.0)</b>';
        area.placeholder = "–õ–µ–ø–∫–∞ —Ñ–∏–≥—É—Ä–∫–∏\t1.5\n–°–±–æ—Ä–∫–∞ —è—Ä—É—Å–∞\t1.2...";
    }
    else if (mode === 'recipes') {
        titleEl.innerText = 'üìñ –ò–º–ø–æ—Ä—Ç —Ä–µ—Ü–µ–ø—Ç–æ–≤';
        descEl.innerHTML = '–°—Ç—Ä—É–∫—Ç—É—Ä–∞ (4 –∫–æ–ª–æ–Ω–∫–∏):<br><b>–†–µ—Ü–µ–ø—Ç | –ë–ª–æ–∫ (–°–ª–æ–π) | –ü—Ä–æ–¥—É–∫—Ç | –í–µ—Å (–≥)</b>';
        area.placeholder = "–°–Ω–∏–∫–µ—Ä—Å\t–ë–∏—Å–∫–≤–∏—Ç\t–Ø–π—Ü–æ\t200\n–°–Ω–∏–∫–µ—Ä—Å\t–ë–∏—Å–∫–≤–∏—Ç\t–ú—É–∫–∞\t150...";
    }
}

function closeImportModal() {
    document.getElementById('importModal').style.display = 'none';
}

function processImport() {
    const txt = document.getElementById('importText').value;
    if (!txt.trim()) return;
    
    const lines = txt.split('\n');
    let cnt = 0;

    // 1. –ò–ú–ü–û–†–¢ –ü–†–û–î–£–ö–¢–û–í
    // –ù–∞–π—Ç–∏ –≤–Ω—É—Ç—Ä–∏ processImport –±–ª–æ–∫ –¥–ª—è –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –∏ –∑–∞–º–µ–Ω–∏—Ç—å:
if (impMode === 'ingredients') {
    lines.forEach(l => {
        const c = l.split('\t'); 
        if (c.length >= 8) { 
            const n = c[0].trim(); // –ù–∞–∑–≤–∞–Ω–∏–µ
            const u = c[1].trim(); // –ï–¥.–∏–∑–º
            
            // –ö–ë–ñ–£ (–∏–Ω–¥–µ–∫—Å—ã 2-5)
            const prot = parseFloat(c[2].replace(',', '.')) || 0;
            const fat  = parseFloat(c[3].replace(',', '.')) || 0;
            const carb = parseFloat(c[4].replace(',', '.')) || 0;
            const kcal = parseFloat(c[5].replace(',', '.')) || 0;
            
            // –í–µ—Å –∏ –¶–µ–Ω–∞ (–∏–Ω–¥–µ–∫—Å—ã 6-7)
            const w = parseFloat(c[6].replace(',', '.')) || 0; 
            const p = parseFloat(c[7] ? c[7].replace(',', '.') : 0); 
            
            if (n && w) {
                // –ü–†–û–í–ï–†–ö–ê –ù–ê –°–û–í–ü–ê–î–ï–ù–ò–ï: –∏—â–µ–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç —Å —Ç–∞–∫–∏–º –∂–µ –∏–º–µ–Ω–µ–º
                const existingIndex = myIngredients.findIndex(item => item.name.toLowerCase() === n.toLowerCase());

                const newObjData = {
                    name: n,
                    unit: u,
                    packWeight: w,
                    packPrice: p || 0,
                    p: prot, 
                    f: fat, 
                    c: carb, 
                    k: kcal,
                    singleWeight: (u === '—à—Ç' ? 0 : 1)
                };

                if (existingIndex !== -1) {
                    // –ï–°–õ–ò –ù–ê–®–õ–ò: –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ ID)
                    myIngredients[existingIndex] = { ...myIngredients[existingIndex], ...newObjData };
                } else {
                    // –ï–°–õ–ò –ù–ï –ù–ê–®–õ–ò: –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
                    const newObj = {
                        id: 'imp_' + Date.now() + Math.random(),
                        ...newObjData
                    };
                    myIngredients.push(newObj);
                }
                cnt++;
            }
        }
    });
    saveIngs();
    renderStockTable(); // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ
}
    // 2. –ò–ú–ü–û–†–¢ –†–ê–ë–û–¢ (–ù–û–í–û–ï!)
    else if (impMode === 'labor') {
        lines.forEach(l => {
            const c = l.split('\t');
            if (c.length >= 1) {
                const n = c[0].trim();
                const coeff = c[1] ? parseFloat(c[1].replace(',', '.')) : 1.0;
                
                if (n) {
                    myLaborServices.push({
                        id: 'l_imp_' + Date.now() + Math.random(),
                        name: n,
                        coeff: coeff || 1.0
                    });
                    cnt++;
                }
            }
        });
        saveLabor();
        renderLaborTable(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É —Å—Ä–∞–∑—É
    }
    // 3. –ò–ú–ü–û–†–¢ –†–ï–¶–ï–ü–¢–û–í (–°–ª–æ–∂–Ω—ã–π)
    // --- –ó–ê–ú–ï–ù–ê –î–õ–Ø –ë–õ–û–ö–ê –†–ï–¶–ï–ü–¢–û–í ---
    else if (impMode === 'recipes') {
        let missingIngredientsCount = 0; // –°—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ —Å–æ–∑–¥–∞–ª–∏ —Å –Ω—É–ª—è

        lines.forEach(l => {
            const c = l.split('\t');
            if (c.length >= 4) {
                const rName = c[0].trim();
                const bName = c[1].trim();
                const iName = c[2].trim();
                const w = parseFloat(c[3].replace(',', '.'));
                
                if (rName && bName && iName) {
                    // 1. –ò—â–µ–º/–°–æ–∑–¥–∞–µ–º —Ä–µ—Ü–µ–ø—Ç
                    let r = myRecipes.find(x => x.name === rName);
                    if (!r) {
                        r = { id: 'rImp' + Date.now() + Math.random(), name: rName, type: 'filling', blocks: [] };
                        myRecipes.push(r);
                    }
                    
                    // 2. –ò—â–µ–º/–°–æ–∑–¥–∞–µ–º –±–ª–æ–∫
                    let b = r.blocks.find(x => x.name === bName);
                    if (!b) {
                        b = { name: bName, ingredients: [] };
                        r.blocks.push(b);
                    }
                    
                    // 3. –ò—â–µ–º –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç (–£–ú–ù–´–ô –ü–û–ò–°–ö)
                    // –ò—â–µ–º –±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞ (–°–∞—Ö–∞—Ä = —Å–∞—Ö–∞—Ä)
                    let ing = myIngredients.find(x => x.name.toLowerCase() === iName.toLowerCase());
                    let ingId = '';

                    if (ing) {
                        ingId = ing.id;
                    } else {
                        // –ï–°–õ–ò –ù–ï–¢ - –°–û–ó–î–ê–ï–ú –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò
                        ingId = 'auto_' + Date.now() + Math.random();
                        myIngredients.push({
                            id: ingId,
                            name: iName,
                            unit: '–≥',       // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≥—Ä–∞–º–º—ã
                            packWeight: 1000,// –ó–∞–≥–ª—É—à–∫–∞
                            packPrice: 0,    // –¶–ï–ù–ê 0 - –ß–¢–û–ë–´ –í–´ –ó–ê–ú–ï–¢–ò–õ–ò
                            p:0, f:0, c:0, k:0
                        });
                        missingIngredientsCount++;
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Ä–µ—Ü–µ–ø—Ç
                    b.ingredients.push({ id: ingId, weight: w });
                    cnt++;
                }
            }
        });
        
        saveIngs(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
        saveRecs(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ—Ü–µ–ø—Ç—ã

        if (missingIngredientsCount > 0) {
            alert(`‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n–ò–º–ø–æ—Ä—Ç –ø—Ä–æ—à–µ–ª, –Ω–æ ${missingIngredientsCount} –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –Ω–µ –±—ã–ª–æ –Ω–∞ —Å–∫–ª–∞–¥–µ.\n\n–û–Ω–∏ —Å–æ–∑–¥–∞–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å –¶–ï–ù–û–ô 0.\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–π–¥–∏—Ç–µ –Ω–∞ –°–∫–ª–∞–¥ –∏ –ø—Ä–æ—Å—Ç–∞–≤—å—Ç–µ –∏–º —Ü–µ–Ω—ã!`);
        }
    }
    // ----------------------------------

    alert(`‚úÖ –£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ —Å—Ç—Ä–æ–∫: ${cnt}`);
    closeImportModal();
}

// --- –û–¢–ö–†–´–¢–ò–ï –ü–†–ï–î–ü–†–û–°–ú–û–¢–†–ê (–ë–ï–ó –ê–í–¢–û-–ü–ï–ß–ê–¢–ò) ---
function openBatchPDF() {
    const content = document.getElementById('printArea').innerHTML;
    const win = window.open('', '_blank', 'height=800,width=1000,scrollbars=yes');
    
    win.document.write('<html><head><title>–ü–ª–∞–Ω –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</title>');
    
    // –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ü–ï–ß–ê–¢–ò
    win.document.write(`
        <style>
            body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
            .page { background: #fff; padding: 30px; max-width: 210mm; margin: 0 auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 8px; }
            
            /* –ö–∞—Ä—Ç–æ—á–∫–∏ –±–ª–æ–∫–æ–≤ (–ë–∏—Å–∫–≤–∏—Ç, –ö—Ä–µ–º –∏ —Ç.–¥.) */
            .batch-card { 
                background: #fff; border-radius: 12px; margin-bottom: 20px; 
                border: 1px solid #e0e0e0; border-left-width: 8px !important; 
                overflow: hidden; page-break-inside: avoid; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            }
            .batch-header { 
                padding: 12px 20px; background: rgba(0,0,0,0.03); 
                display: flex; justify-content: space-between; align-items: center;
                border-bottom: 1px solid #eee; font-weight: bold;
            }
            .batch-body { display: flex; flex-wrap: wrap; }
            .col-tasks { flex: 1.2; padding: 15px; border-right: 1px dashed #ddd; }
            .col-ings { flex: 0.8; padding: 15px; background: #fafafa; }
            
            /* –®—Ä–∏—Ñ—Ç—ã –∏ —Ç–∞–±–ª–∏—Ü—ã */
            table { width: 100%; border-collapse: collapse; font-size: 13px; }
            td { padding: 6px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
            .task-client { font-weight: 800; color: #000; font-size: 14px; }
            .task-info { color: #666; font-size: 12px; margin-left: 5px; }
            
            /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —ç–∫—Ä–∞–Ω–∞) */
            .toolbar { position: fixed; top: 0; left: 0; right: 0; background: #333; padding: 10px; text-align: center; z-index: 1000; display: flex; justify-content: center; gap: 15px; }
            .btn { padding: 8px 20px; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; color: #fff; }
            .btn-print { background: #673AB7; }
            
            @media print {
                body { background: #fff; padding: 0; }
                .page { box-shadow: none; max-width: 100%; padding: 0; }
                .toolbar { display: none !important; }
                .batch-card { border: 1px solid #ccc; border-left-width: 8px !important; }
            }
        </style>
    `);
    
    win.document.write('</head><body>');
    win.document.write('<div class="toolbar"><button class="btn btn-print" onclick="window.print()">üñ®Ô∏è –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å –ü–ª–∞–Ω</button><button class="btn" style="background:#555" onclick="window.close()">‚úï –ó–∞–∫—Ä—ã—Ç—å</button></div>');
    win.document.write('<div style="margin-top:60px;"><div class="page">');
    win.document.write(content);
    win.document.write('</div></div></body></html>');
    
    win.document.close();
}

// --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–õ–Ø–ú–ò –≠–¢–ê–õ–û–ù–ê (–°–∫—Ä—ã–≤–∞–µ–º H –¥–ª—è —à–∞—Ä–∞) ---
function updateCalibUI() {
    const shape = document.getElementById('calibShape').value;
    const grpH = document.getElementById('grpCalibH');
    
    if (shape === 'sphere') {
        // –ï—Å–ª–∏ –®–∞—Ä -> –°–∫—Ä—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É
        grpH.style.display = 'none';
    } else {
        // –ï—Å–ª–∏ –¶–∏–ª–∏–Ω–¥—Ä –∏–ª–∏ –ö–≤–∞–¥—Ä–∞—Ç -> –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É
        grpH.style.display = 'block';
    }
} 

// ==========================================
// ‚ö° –ê–í–¢–û–°–û–•–†–ê–ù–ï–ù–ò–ï (–ë–ï–ó–û–ü–ê–°–ù–ê–Ø –í–ï–†–°–ò–Ø v3.1)
// ==========================================

var AUTOSAVE_KEY_V3 = 'cake_app_autosave_v3_safe'; 

// 1. –¢–∏—Ö–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
// 1. –ê–í–¢–û–°–û–•–†–ê–ù–ï–ù–ò–ï (–ü–ò–°–ê–¢–ï–õ–¨)
function performAutoSave() {
    const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : 0; };
    const getRadio = (name) => { const el = document.querySelector(`input[name="${name}"]:checked`); return el ? el.value : null; };

    const data = {
        // –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        ingredients: myIngredients,
        recipes: myRecipes,
        labor: myLaborServices,
        queue: productionQueue,
        clients: clientsDataLocal,
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        settings: {
            currency: currentCurrency,
            hourlyRate: getVal('hourlyRate'),
            tax: getVal('finTax'),
            bank: getVal('finBank'),
            overhead: getVal('finOverhead')
        },
        
        // –¢–µ–∫—É—â–∞—è —Ä–∞–±–æ—Ç–∞ (–°–µ—Å—Å–∏—è)
        currentSession: {
            tiers: appState.tiers,
            shape: getVal('globalShape') || 'cylinder',
            sides: getVal('globalSides') || 6,
            coatingId: getVal('coatingIdSelect'),
            extraCoatingId: getVal('extraCoatingIdSelect'),
            sphereFillMode: getRadio('sphereFillMode') || 'recipe',
            
            // --- –í–ê–ñ–ù–û! –°–û–•–†–ê–ù–Ø–ï–ú –°–ü–ò–°–ö–ò –†–ê–°–•–û–î–ù–ò–ö–û–í –ò –†–ê–ë–û–¢ ---
            extras: extrasList || [],       
            laborList: currentLaborList || []
            // --------------------------------------------------
        },
        timestamp: Date.now()
    };
    
    try { 
        localStorage.setItem(AUTOSAVE_KEY_V3, JSON.stringify(data)); 
        // –í—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (F12)
        console.log('‚úÖ AutoSave OK. Extras:', (extrasList||[]).length, 'Labor:', (currentLaborList||[]).length);
    } catch (e) { 
        console.warn('AutoSave failed', e); 
    }
}


// 2. –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï (–ß–ò–¢–ê–¢–ï–õ–¨) - –° –õ–û–ê–î–ï–†–û–ú
function checkAndRestoreAutoSave() {
    const raw = localStorage.getItem(AUTOSAVE_KEY_V3);
    if (!raw) return;

    try {
        const d = JSON.parse(raw);
        const timeStr = new Date(d.timestamp).toLocaleTimeString();
        
        // –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –î–û –ø–æ—è–≤–ª–µ–Ω–∏—è –ª–æ–∞–¥–µ—Ä–∞
        if (confirm(`üíæ –ù–∞–π–¥–µ–Ω–æ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç ${timeStr}.\n–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É?`)) {
            
            // 1. –í–ö–õ–Æ–ß–ê–ï–ú –õ–û–ê–î–ï–†
            const loader = document.getElementById('loadingOverlay');
            if(loader) loader.style.display = 'flex';

            // 2. –î–∞–µ–º –±—Ä–∞—É–∑–µ—Ä—É 50–º—Å –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –ª–æ–∞–¥–µ—Ä, –ø–æ—Ç–æ–º —Ä–∞–±–æ—Ç–∞–µ–º
            setTimeout(() => {
                try {
                    // --- –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ë–ê–ó ---
                    if (d.ingredients) { myIngredients = d.ingredients; saveIngs(); }
                    if (d.recipes) { myRecipes = d.recipes; saveRecs(); }
                    if (d.labor) { myLaborServices = d.labor; saveLabor(); }
                    if (d.queue) { productionQueue = d.queue; saveQueue(); }

                    if (d.clients) { 
        clientsDataLocal = d.clients;
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à, —á—Ç–æ–±—ã –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –æ–Ω–∏ —Ç–æ–∂–µ –ø–æ–¥—Ö–≤–∞—Ç–∏–ª–∏—Å—å
        localStorage.setItem('cachedClients', JSON.stringify(clientsDataLocal));
        // –ï—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞—Ö - –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        renderClientsCloud();
    }
                    
                    // --- –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ù–ê–°–¢–†–û–ï–ö ---
                    if (d.settings) {
                        if(d.settings.currency) changeCurrency(d.settings.currency);
                        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
                        setVal('hourlyRate', d.settings.hourlyRate);
                        setVal('finTax', d.settings.tax);
                        setVal('finBank', d.settings.bank);
                        setVal('finOverhead', d.settings.overhead);
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º, –Ω–æ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –æ—Ç—Ä–∏—Å–æ–≤–æ–∫
                        localStorage.setItem('cakeHourlyRate', d.settings.hourlyRate);
                        saveFinance(); 
                    }

                    // --- –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –≠–ö–†–ê–ù–ê (–°–ï–°–°–ò–ò) ---
                    if (d.currentSession) {
                        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
                        
                        setVal('globalShape', d.currentSession.shape || 'cylinder');
                        setVal('globalSides', d.currentSession.sides || 6);
                        
                        if (d.currentSession.tiers) appState.tiers = d.currentSession.tiers;
                        
                        // –°–ø–∏—Å–∫–∏
                        extrasList = d.currentSession.extras || [];
                        currentLaborList = d.currentSession.laborList || [];
                        
                        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤—Å–µ–≥–æ
                        updateUI(); 
                        updateTierUI();
                        renderExtras();      
                        renderLaborTasks(); 

                        if(d.currentSession.coatingId) {
                            setVal('coatingIdSelect', d.currentSession.coatingId);
                            updateCoatingUI();
                        }
                        if(d.currentSession.extraCoatingId) {
                            setVal('extraCoatingIdSelect', d.currentSession.extraCoatingId);
                        }
                        if (d.currentSession.sphereFillMode) {
                           const r = document.querySelector(`input[name="sphereFillMode"][value="${d.currentSession.sphereFillMode}"]`);
                           if(r) r.checked = true;
                        }
                        
                        // –ï—Å–ª–∏ –±—ã–ª–∏ —Ä–∞—Å—á–µ—Ç—ã ‚Äî –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É
                        if (appState.results && appState.results.Right) {
                             calculateSide('Right');
                        }
                    }

                    // –£—Å–ø–µ—Ö! (–ê–ª–µ—Ä—Ç —É–±—Ä–∞–ª–∏, –ø—Ä–æ—Å—Ç–æ –º–æ–ª—á–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ–º)
                    
                } catch (err) {
                    console.error(err);
                    alert("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏: " + err.message);
                } finally {
                    // 3. –í–´–ö–õ–Æ–ß–ê–ï–ú –õ–û–ê–î–ï–†
                    if(loader) loader.style.display = 'none';
                }
            }, 50); // –ü–∞—É–∑–∞ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            
        

        } else {
            // –ë–´–õ–û (–û–ü–ê–°–ù–û):
            // productionQueue = [];
            // db.ref('queue').set([]); 
            // localStorage.removeItem('cakeProductionQueue');           
            // renderQueue();            
            
            // –°–¢–ê–õ–û (–ë–ï–ó–û–ü–ê–°–ù–û):
            console.log("–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –û–±–ª–∞–∫–∞/–ü–∞–º—è—Ç–∏.");
            
            // –ü—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º —Ñ–∞–π–ª –∞–≤—Ç–æ—Å–µ–π–≤–∞, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –Ω–∞–¥–æ–µ–¥–∞–ª, 
            // –Ω–æ –ù–ï —Ç—Ä–æ–≥–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (productionQueue)
            localStorage.removeItem(AUTOSAVE_KEY_V3);
            
            // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –æ–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ, —á—Ç–æ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å –∏–∑ –±–∞–∑—ã
            updateQueueBadge(); 
        }
        
    } catch (e) { console.log('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è', e); }
}

// --- –ó–ê–ü–£–°–ö –¢–ê–ô–ú–ï–†–û–í ---

// 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É (60000 –º—Å)
setInterval(performAutoSave, 60000);

// 2. –ù–∞–ø–æ–º–∏–Ω–∞–µ–º —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç (900000 –º—Å)
setInterval(() => {
    if(confirm("‚è≥ –ü—Ä–æ—à–ª–æ 15 –º–∏–Ω—É—Ç. –°–∫–∞—á–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é (–ë—ç–∫–∞–ø)?")) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ—É–Ω–∫—Ü–∏—è, —á—Ç–æ–±—ã –Ω–µ —É–ø–∞–ª–æ
        if(typeof downloadBackup === 'function') {
            downloadBackup();
        } else {
            alert("–§—É–Ω–∫—Ü–∏—è –±—ç–∫–∞–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
        }
    }
}, 1800000);

// 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ (—Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π, —á—Ç–æ–±—ã DOM –ø—Ä–æ–≥—Ä—É–∑–∏–ª—Å—è)
setTimeout(checkAndRestoreAutoSave, 1000);

// 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
window.addEventListener('beforeunload', () => {
    performAutoSave();
});

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
window.addEventListener('beforeunload', () => {
    performAutoSave();
});

// --- –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –¢–ï–ö–°–¢–ê –¢–£–ú–ë–õ–ï–†–ê ---
function updateCoatingText() {
    const chk = document.getElementById('chkCoatingMethod');
    const title = document.getElementById('coatTitle');
    const desc = document.getElementById('coatDesc');
    const container = document.getElementById('coatingMethodBlock');

    if (chk.checked) {
        // –†–ï–ñ–ò–ú: –ü–†–û–ü–û–†–¶–ò–Ø (–í–ö–õ)
        title.innerText = "‚öñÔ∏è –†–∞—Å—Ö–æ–¥ –ø–æ –í–µ—Å—É (–ü—Ä–æ–ø–æ—Ä—Ü–∏—è)";
        title.style.color = "#FF5722"; // –û—Ä–∞–Ω–∂–µ–≤—ã–π —Ü–≤–µ—Ç
        desc.innerText = "(–ö–∞–∫ –¥–æ–ª—è –æ—Ç –≤–µ—Å–∞ –Ω–∞—á–∏–Ω–∫–∏)";
        container.style.borderColor = "#ffccbc"; // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ä–∞–º–∫–∏
        container.style.background = "#fffbe6";
    } else {
        // –†–ï–ñ–ò–ú: –ì–ï–û–ú–ï–¢–†–ò–Ø (–í–´–ö–õ)
        title.innerText = "üìê –†–∞—Å—Ö–æ–¥ –ø–æ –ì–µ–æ–º–µ—Ç—Ä–∏–∏ (–ü–ª–æ—â–∞–¥—å)";
        title.style.color = "#333"; // –ß–µ—Ä–Ω—ã–π —Ü–≤–µ—Ç
        desc.innerText = "(–ò—Å—Ö–æ–¥—è –∏–∑ –ø–ª–æ—â–∞–¥–∏ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏)";
        container.style.borderColor = "#ddd";
        container.style.background = "#fff";
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è —á–∞—Å–æ–≤ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –Ω–∞–∑–≤–∞–Ω–∏—è
document.getElementById('laborSearch').addEventListener('input', function(e) {
    const name = e.target.value.trim();
    const hoursInput = document.getElementById('laborHoursInput');
    
    // –ò—â–µ–º —Ä–∞–±–æ—Ç—É –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ
    const service = myLaborServices.find(l => l.name === name);
    
    if (service) {
        // –ï—Å–ª–∏ —Ä–∞–±–æ—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞ ‚Äî –≤—Å—Ç–∞–≤–ª—è–µ–º –µ—ë —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –≤—Ä–µ–º—è –≤ –ø–æ–ª–µ "–ß–∞—Å—ã"
        hoursInput.value = service.defaultTime || 0;
    }
});

// --- –§–ò–ù–ê–õ–¨–ù–´–ô –ë–õ–û–ö UNDO/REDO ---
// --- –ï–î–ò–ù–´–ô –ë–õ–û–ö –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ò–°–¢–û–†–ò–ï–ô –ò –ü–ê–ú–Ø–¢–¨–Æ ---
var historyStack = [];
var redoStack = [];
const MAX_HISTORY = 30;

function saveToHistory() {
    try {
        if (typeof myIngredients === 'undefined' || typeof productionQueue === 'undefined' || !appState) return;
        const currentState = {
            ingredients: JSON.parse(JSON.stringify(myIngredients)),
            recipes: JSON.parse(JSON.stringify(myRecipes)),
            labor: JSON.parse(JSON.stringify(myLaborServices)),
            queue: JSON.parse(JSON.stringify(productionQueue)),
            tiers: JSON.parse(JSON.stringify(appState.tiers)),
            extras: JSON.parse(JSON.stringify(extrasList || [])),
            laborList: JSON.parse(JSON.stringify(currentLaborList || [])),
            clients: JSON.parse(JSON.stringify(clientsDataLocal || {})),
            archive: JSON.parse(JSON.stringify(archiveOrders || [])),
            stockHistory: JSON.parse(JSON.stringify(stockHistory || [])),
            calcState: {
                shape: document.getElementById('globalShape')?.value || 'cylinder',
                coatingId: document.getElementById('coatingIdSelect')?.value || '',
                extraCoatingId: document.getElementById('extraCoatingIdSelect')?.value || ''
            },
            colorsPalette: JSON.parse(JSON.stringify(myColorsPalette || [])),
            colorSelected: JSON.parse(JSON.stringify(colorState.colors || {})),
            
            // üî• –ù–û–í–û–ï: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–≥—É—Ä
            shapeState: JSON.parse(JSON.stringify(shapeState)) 
        };
        
        // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π (–µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å - –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º)
        if (historyStack.length > 0 && JSON.stringify(currentState) === JSON.stringify(historyStack[historyStack.length - 1])) return;
        
        historyStack.push(currentState);
        if (historyStack.length > MAX_HISTORY) historyStack.shift();
        redoStack = []; 
        updateHistoryButtons();
    } catch (e) { console.log("–ò—Å—Ç–æ—Ä–∏—è –Ω–µ –≥–æ—Ç–æ–≤–∞"); }
}

function undo() {
    if (historyStack.length <= 1) return;
    redoStack.push(historyStack.pop());
    applyState(historyStack[historyStack.length - 1]);
}

function redo() {
    if (redoStack.length === 0) return;
    const next = redoStack.pop();
    historyStack.push(next);
    applyState(next);
}

function applyState(state) {
    if (!state) return;
    myIngredients = JSON.parse(JSON.stringify(state.ingredients));
    myRecipes = JSON.parse(JSON.stringify(state.recipes));
    myLaborServices = JSON.parse(JSON.stringify(state.labor));
    productionQueue = JSON.parse(JSON.stringify(state.queue));
    appState.tiers = JSON.parse(JSON.stringify(state.tiers));
    extrasList = JSON.parse(JSON.stringify(state.extras || []));
    currentLaborList = JSON.parse(JSON.stringify(state.laborList || []));
    clientsDataLocal = JSON.parse(JSON.stringify(state.clients || {}));
    archiveOrders = JSON.parse(JSON.stringify(state.archive || []));
    stockHistory = JSON.parse(JSON.stringify(state.stockHistory || []));
    
    // –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
    if (state.calcState) {
        if (document.getElementById('globalShape')) document.getElementById('globalShape').value = state.calcState.shape;
        if (document.getElementById('coatingIdSelect')) document.getElementById('coatingIdSelect').value = state.calcState.coatingId;
        if (document.getElementById('extraCoatingIdSelect')) document.getElementById('extraCoatingIdSelect').value = state.calcState.extraCoatingId;
        updateTierUI(); 
    }
    
    // –ö–æ–ª–æ—Ä–∏—Å—Ç–∏–∫–∞
    if (state.colorsPalette) {
        myColorsPalette = JSON.parse(JSON.stringify(state.colorsPalette));
        localStorage.setItem('myColorsPalette', JSON.stringify(myColorsPalette));
        if (typeof renderPaletteUI === 'function') renderPaletteUI();
    }
    if (state.colorSelected) {
        colorState.colors = JSON.parse(JSON.stringify(state.colorSelected));
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç–∞ –ø–ª–∞—à–µ–∫
        const updatePatch = (id, rgb) => { const el = document.getElementById(id); if (el && rgb) el.style.background = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`; };
        updatePatch('patchWhite', colorState.colors.white);
        updatePatch('patchBase', colorState.colors.base);
        updatePatch('patchTargetWhite', colorState.colors.targetWhite);
        updatePatch('patchTarget', colorState.colors.target);
    }

    // üî• –ù–û–í–û–ï: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –§–∏–≥—É—Ä
    if (state.shapeState) {
        shapeState = JSON.parse(JSON.stringify(state.shapeState));
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º UI
        const isCircle = (shapeState.currentShape === 'circle');
        const radio = document.querySelector(`input[name="bakeShape"][value="${shapeState.currentShape}"]`);
        if(radio) radio.checked = true;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–µ –±–ª–æ–∫–∏
        document.getElementById('blockRect').style.display = isCircle ? 'none' : 'contents';
        document.getElementById('blockCircle').style.display = isCircle ? 'block' : 'none';
        
        const ghost = document.getElementById('ghostBox');
        if(isCircle) ghost.classList.add('is-circle'); else ghost.classList.remove('is-circle');
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω–ø—É—Ç—ã
        const {l, w, h, d, weight} = shapeState.current;
        const setVal = (id, v) => { const el = document.getElementById(id); if(el) el.value = v; };
        setVal('inpL', Math.round(l));
        setVal('inpW', Math.round(w));
        setVal('inpD', Math.round(d));
        setVal('inpH', h);
        setVal('inpWeight', weight);

        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å—Ü–µ–Ω—É –∏ —Å–ª–æ–∏
        if (shapeState.cleanImgUrl) {
            document.getElementById('shapeCalcBlock').style.display = 'block';
            updateShapeRecipes();
            generate3DLayers(); // –†–∏—Å—É–µ–º —Å–ª–æ–∏ –∑–∞–Ω–æ–≤–æ
            update3DScene(l, w, h, d); // –°—Ç–∞–≤–∏–º –∏—Ö –Ω–∞ –º–µ—Å—Ç–æ
        }
    }
  
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ
    localStorage.setItem('myCakeIngredients', JSON.stringify(myIngredients));
    localStorage.setItem('myCakeRecipes', JSON.stringify(myRecipes));
    localStorage.setItem('myCakeLabor', JSON.stringify(myLaborServices));
    localStorage.setItem('cakeProductionQueue', JSON.stringify(productionQueue));
    localStorage.setItem('cachedClients', JSON.stringify(clientsDataLocal));
    renderClientsCloud(); 

    updateUI(); 
    renderQueue();
    updateQueueBadge();
    if (typeof renderLaborTasks === 'function') renderLaborTasks();
    if (typeof renderExtras === 'function') renderExtras();
    updateHistoryButtons();
    if (appState.results && appState.results.Right) calculateSide('Right');
    if (document.getElementById('historyModal')?.style.display === 'flex') openStockHistory(); 
    
    if (activeRecId) {
        const restoredRec = myRecipes.find(x => x.id === activeRecId);
        if (restoredRec) {
             renderBlocks(restoredRec);
        } else {
             document.getElementById('recipeEditor').style.display = 'none';
             document.getElementById('recipePlaceholder').style.display = 'flex';
             activeRecId = null;
        }
    }
    
    const clIdVal = document.getElementById('clId').value;
    if (document.getElementById('clientModal').style.display === 'flex' && clIdVal) {
        if (clientsDataLocal[clIdVal]) openClientModal(clIdVal); else closeClientModal();
    }
}

function updateHistoryButtons() {
    const btnU = document.querySelector("button[onclick='undo()']");
    const btnR = document.querySelector("button[onclick='redo()']");
    if (btnU) btnU.style.opacity = (historyStack.length <= 1) ? "0.3" : "1";
    if (btnR) btnR.style.opacity = (redoStack.length === 0) ? "0.3" : "1";
}

// –ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò
window.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.code === 'KeyZ') { e.preventDefault(); undo(); }
    if (e.ctrlKey && e.code === 'KeyY') { e.preventDefault(); redo(); }
});

function changeCurrency(val) {
    // 1. –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
    currentCurrency = val;
    
    // 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø–∞–º—è—Ç—å –±—Ä–∞—É–∑–µ—Ä–∞
    localStorage.setItem('cakeCurrency', val);
    
    // 3. –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å –∫–ª–∞—Å—Å–æ–º 'curr-sym' –∏ –º–µ–Ω—è–µ–º –∏—Ö —Ç–µ–∫—Å—Ç (–Ω–∞–ø—Ä. ‚Ç∏ –Ω–∞ ‚ÇΩ)
    const symbol = SYMBOLS[val] || '';
    document.querySelectorAll('.curr-sym').forEach(el => {
        el.innerText = symbol;
    });
    
    // 4. –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç –≤ —à–∞–ø–∫–µ, —á—Ç–æ–±—ã –æ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª –∑–Ω–∞—á–µ–Ω–∏—é (–∞–∫—Ç—É–∞–ª—å–Ω–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –±—ç–∫–∞–ø–∞)
    const sel = document.getElementById('currencySelect');
    if (sel) sel.value = val;

    // 5. –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã, –≥–¥–µ –µ—Å—Ç—å —Ä–∞—Å—á–µ—Ç—ã —Ü–µ–Ω
    renderStockTable();
    renderLaborTable();
    
    // 6. –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ - –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    if (appState.results) {
        if (appState.results.Left) updateStats('Left');
        if (appState.results.Right) updateStats('Right');
    }
    
    // 7. –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ –≤ –ø–ª–∞–Ω–µ
    renderQueue();
}

// –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏
setTimeout(() => { if(historyStack.length === 0) saveToHistory(); }, 2000);

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä—É—á–Ω–æ–π —Å–±–æ—Ä–∫–∏
let customCheckData = [];

// 1. –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞
function openClientCheckBuilder() {
    closePrintModal();
    
    const side = currentPrintSide;
    const res = appState.results[side];
    if (!res) return;

    const fullPrice = res.costs.finalPrice;
    
    // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ë–ï–†–ï–ú –°–õ–û–í–ê –ò–ó –ù–ê–°–¢–†–û–ï–ö ---
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ –∏–Ω–ø—É—Ç–æ–≤, –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –∏ —Ä–∞–∑–±–∏–≤–∞–µ–º –ø–æ –∑–∞–ø—è—Ç–æ–π
    const getList = (id) => {
        return document.getElementById(id).value
            .toLowerCase()
            .split(',')
            .map(s => s.trim()) // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
            .filter(s => s);    // –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    };

    const forceShowKeywords = getList('finForceShow');
    const standardHideKeywords = getList('finForceHide');
    // ------------------------------------------

    let explicitServicesSum = 0;
    const servicesRows = [];

    // --- 1. –ò–©–ï–ú –í –†–ê–ë–û–¢–ê–• (–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã) ---
    if (res.costs.laborCost > 0 && currentLaborList) {
        currentLaborList.forEach(l => {
            const name = l.name.toLowerCase();
            const cost = l.realHours * l.coeff * (parseFloat(document.getElementById('hourlyRate').value)||0);
            
            const mustShow = forceShowKeywords.some(k => name.includes(k));
            // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –ò–õ–ò —ç—Ç–æ –Ω–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ä—É—Ç–∏–Ω–∞
            if (mustShow || !standardHideKeywords.some(k => name.includes(k))) {
                servicesRows.push({ name: l.name, price: Math.ceil(cost) });
                explicitServicesSum += cost;
            }
        });
    }

    // --- 2. –ò–©–ï–ú –í –ú–ê–¢–ï–†–ò–ê–õ–ê–• (–ú–∏—à–∫–∏, –î–µ–∫–æ—Ä, –¢–æ–ø–ø–µ—Ä—ã) ---
    // –ü—Ä–æ—Ö–æ–¥–∏–º—Å—è –ø–æ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –¥–æ—Ä–æ–≥–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã/—Ñ–∏–≥—É—Ä–∫–∏
    if (res.detailedBlocks) {
        res.detailedBlocks.forEach(block => {
            // –ï—Å–ª–∏ —ç—Ç–æ –±–ª–æ–∫ "–î–µ–∫–æ—Ä –∏ –£–ø–∞–∫–æ–≤–∫–∞" –∏–ª–∏ –ª—é–±–æ–π "Extra", –∑–∞–≥–ª—è–Ω–µ–º –≤–Ω—É—Ç—Ä—å
            if (block.type === 'extra' || block.name.includes('–î–µ–∫–æ—Ä')) {
                block.ingredients.forEach(ing => {
                    const iName = ing.name.toLowerCase();
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º—è –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä. "–®–æ–∫–æ–ª–∞–¥–Ω—ã–π –º–∏—à–∫–∞")
                    if (forceShowKeywords.some(k => iName.includes(k))) {
                        // –ù–∞—à–ª–∏!
                        const cost = ing.cost; 
                        servicesRows.push({ name: ing.name, price: Math.ceil(cost) });
                        explicitServicesSum += cost;
                    }
                });
            }
            // –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∞–º –ë–ª–æ–∫ —Ä–µ—Ü–µ–ø—Ç–∞ (–µ—Å–ª–∏ –≤—ã –¥–æ–±–∞–≤–∏–ª–∏ —Ä–µ—Ü–µ–ø—Ç "–ú–∏—à–∫–∞")
            else if (block.type === 'decor') {
                 if (forceShowKeywords.some(k => block.name.toLowerCase().includes(k))) {
                     const cost = block.totalCost;
                     servicesRows.push({ name: block.name, price: Math.ceil(cost) });
                     explicitServicesSum += cost;
                 }
            }
        });
    }

    // –°—Ä–æ—á–Ω–æ—Å—Ç—å
    if (res.costs.urgency > 0) {
        const urgencySum = Math.ceil((fullPrice / (1 + res.costs.urgency/100)) * (res.costs.urgency/100));
        servicesRows.push({ name: "–°—Ä–æ—á–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è", price: urgencySum });
        explicitServicesSum += urgencySum;
    }

    // --- 3. –û–°–¢–ê–¢–û–ö –†–ê–°–ü–†–ï–î–ï–õ–Ø–ï–ú –ü–û –Ø–†–£–°–ê–ú ---
    let baseCakePrice = fullPrice - explicitServicesSum;
    const totalWeight = res.weights.total;
    const rows = [];
    
    res.tiers.forEach((t, i) => {
        const tierRatio = t.weight / totalWeight;
        const tierPrice = Math.round(baseCakePrice * tierRatio);
        
        const sizeStr = (res.geometry.shape === 'rectangle') ? `${Math.round(t.d)}x${Math.round(t.w)}` : `D${Math.round(t.d)}`;
        const desc = `${t.recipeName} (${sizeStr} —Å–º, ${(t.weight/1000).toFixed(2)} –∫–≥)`;

        rows.push({ type: 'tier', name: `–Ø—Ä—É—Å ${i+1}: ${t.recipeName}`, desc: desc, price: tierPrice });
    });

    servicesRows.forEach(s => rows.push({ type: 'service', name: s.name, desc: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ', price: s.price }));
    
    renderCheckBuilder(rows, fullPrice);
    document.getElementById('checkBuilderModal').style.display = 'flex';
}
function renderCheckBuilder(rows, targetTotal) {
    const c = document.getElementById('checkBuilderBody');
    c.innerHTML = '';
    
    rows.forEach((row, idx) => {
        const isTier = (row.type === 'tier');
        const icon = isTier ? 'üç∞' : 'üé®';
        const bg = isTier ? '#fff' : '#f1f8e9';
        
        // –§–û–†–ú–ê–¢–ò–†–£–ï–ú –¶–ï–ù–£ –°–†–ê–ó–£ –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
        const formattedPrice = row.price.toLocaleString('ru-RU');

        c.innerHTML += `
        <div style="background:${bg}; padding:10px; border:1px solid #ddd; border-radius:6px; margin-bottom:8px; display:flex; gap:10px; align-items:center;">
            <div style="font-size:20px;">${icon}</div>
            <div style="flex:1;">
                <input type="text" value="${row.name}" style="width:100%; font-weight:bold; border:none; background:transparent; margin-bottom:2px;">
                <input type="text" value="${row.desc}" style="width:100%; font-size:11px; color:#666; border:none; background:transparent;">
            </div>
            <div style="width:100px;">
                <input type="text" class="money-input" value="${formattedPrice}" oninput="formatMoneyInput(this)" style="width:100%; text-align:right; font-weight:bold; padding:5px; border:1px solid #ccc; border-radius:4px;">
            </div>
            <button class="del-btn" onclick="this.parentElement.remove(); recalcBuilderTotal();">‚úï</button>
        </div>`;
    });

    // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    c.innerHTML += `<button class="add-btn-small" onclick="addCheckRow()" style="width:100%; margin-top:10px; background:#eee; color:#333;">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>`;

    document.getElementById('checkTargetTotal').innerText = targetTotal.toLocaleString('ru-RU') + ' ' + (SYMBOLS[currentCurrency]||'');
    recalcBuilderTotal();
}

// –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏, —á—Ç–æ–±—ã —Ç–∞–º —Ç–æ–∂–µ –±—ã–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π input
function addCheckRow() {
    const c = document.getElementById('checkBuilderBody');
    const newDiv = document.createElement('div');
    newDiv.innerHTML = `
        <div style="background:#f1f8e9; padding:10px; border:1px solid #ddd; border-radius:6px; margin-bottom:8px; display:flex; gap:10px; align-items:center;">
            <div style="font-size:20px;">‚ú®</div>
            <div style="flex:1;">
                <input type="text" value="–£—Å–ª—É–≥–∞ / –¢–æ–≤–∞—Ä" style="width:100%; font-weight:bold; border:none; background:transparent; margin-bottom:2px;">
                <input type="text" value="" style="width:100%; font-size:11px; color:#666; border:none; background:transparent;" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
            </div>
            <div style="width:100px;">
                <input type="text" class="money-input" value="0" oninput="formatMoneyInput(this)" style="width:100%; text-align:right; font-weight:bold; padding:5px; border:1px solid #ccc; border-radius:4px;">
            </div>
            <button class="del-btn" onclick="this.parentElement.remove(); recalcBuilderTotal();">‚úï</button>
        </div>`;
    c.insertBefore(newDiv, c.lastElementChild);
}

function recalcBuilderTotal() {
    let sum = 0;
    // –ò—â–µ–º –ø–æ –∫–ª–∞—Å—Å—É money-input
    document.querySelectorAll('#checkBuilderBody input.money-input').forEach(inp => {
        // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã (–Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–µ –∏ –æ–±—ã—á–Ω—ã–µ) –ø–µ—Ä–µ–¥ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ–º –≤ —á–∏—Å–ª–æ
        const cleanVal = inp.value.replace(/\s/g, '').replace(/\u00A0/g, '');
        sum += parseFloat(cleanVal) || 0;
    });
    
    const totalEl = document.getElementById('checkBuilderTotal');
    const currency = SYMBOLS[currentCurrency] || '';
    
    totalEl.innerText = Math.round(sum).toLocaleString('ru-RU') + ' ' + currency;

    const targetTxt = document.getElementById('checkTargetTotal').innerText;
    const target = parseFloat(targetTxt.replace(/[^\d]/g, '')) || 0;
    
    if (Math.abs(sum - target) > 10) {
        totalEl.style.color = '#d32f2f'; 
    } else {
        totalEl.style.color = '#2E7D32'; 
    }
}

// 3. –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–µ—á–∞—Ç—å (–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF –∏–∑ —Ç–æ–≥–æ, —á—Ç–æ –Ω–∞—Å–æ–±–∏—Ä–∞–ª–∏)
function printCustomClientCheck() {
    const rows = [];
    let finalSum = 0;
    
    const body = document.getElementById('checkBuilderBody');
    // –ë–µ—Ä–µ–º —Å—Ç—Ä–æ–∫–∏
    const divs = body.querySelectorAll('div[style*="display:flex"]'); 
    
    divs.forEach(div => {
        const inputs = div.querySelectorAll('input');
        // –ü–æ—Ä—è–¥–æ–∫: 0-Name, 1-Desc, 2-Price
        const name = inputs[0].value;
        const desc = inputs[1].value;
        // –ß–∏—Å—Ç–∏–º —Ü–µ–Ω—É –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤
        const rawPrice = inputs[2].value.replace(/\s/g, '').replace(/\u00A0/g, '');
        const price = parseFloat(rawPrice) || 0;
        
        rows.push({ name, desc, price });
        finalSum += price;
    });

    document.getElementById('checkBuilderModal').style.display = 'none';
    generateCustomHtml(rows, finalSum);
}
// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–≤–æ–¥–∞ –Ω–∞ –ª–µ—Ç—É (1000 -> 1 000)
function formatMoneyInput(input) {
    // 1. –£–±–∏—Ä–∞–µ–º –≤—Å—ë, –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä
    let val = input.value.replace(/\D/g, ''); 
    if (val === '') return;
    
    // 2. –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
    input.value = parseInt(val).toLocaleString('ru-RU');
    
    // 3. –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–∏–π –∏—Ç–æ–≥
    recalcBuilderTotal(); 
}
function generateCustomHtml(rows, total) {
    const currency = SYMBOLS[currentCurrency] || '';
    // –§—É–Ω–∫—Ü–∏—è –∫—Ä–∞—Å–æ—Ç—ã: 10000 -> 10 000
    const fmt = (num) => Math.round(num).toLocaleString('ru-RU');
    
    // –ë–µ—Ä–µ–º –æ–±—â–∏–π –≤–µ—Å –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏
    const data = appState.results[currentPrintSide];
    const totalWeight = (data.weights.total / 1000).toFixed(2);

    let html = `<html><head><title>–ß–µ–∫ –∑–∞–∫–∞–∑–∞</title><style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; padding: 30px; max-width: 600px; margin: 0 auto; color:#333; }
        .no-print { position: fixed; top: 20px; right: 20px; padding: 10px 20px; background: #333; color: #fff; cursor: pointer; border-radius: 4px; border:none; }
        @media print { .no-print { display: none; } }
    </style></head><body>`;
    
    html += `<button class="no-print" onclick="window.print()">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>`;
    
    html += `
    <div style="text-align: center; margin-bottom: 30px;">
        <div style="font-size: 26px; font-weight: 900; color: #333; text-transform: uppercase;">–ó–∞–∫–∞–∑ ‚Ññ${Date.now().toString().slice(-5)}</div>
        <div style="width: 40px; height: 3px; background: #FF5722; margin: 10px auto;"></div>
    </div>`;

    html += `<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
        <thead>
            <tr style="border-bottom: 2px solid #333;">
                <th style="text-align: left; padding: 10px 0; font-size: 11px; text-transform: uppercase; color: #888;">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                <th style="text-align: right; padding: 10px 0; font-size: 11px; text-transform: uppercase; color: #888;">–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
            </tr>
        </thead>
        <tbody>`;

    rows.forEach(r => {
        html += `
        <tr>
            <td style="padding: 12px 0; border-bottom: 1px solid #eee;">
                <div style="font-weight: bold; font-size: 14px; color: #000;">${r.name}</div>
                <div style="font-size: 12px; color: #666; margin-top: 2px;">${r.desc}</div>
            </td>
            <td style="text-align: right; padding: 12px 0; font-weight: bold; font-size: 14px; border-bottom: 1px solid #eee; vertical-align: top;">
                ${fmt(r.price)} ${currency}
            </td>
        </tr>`;
    });

    html += `</tbody></table>`;

    html += `
    <div style="background: #f9f9f9; border-radius: 12px; padding: 20px; border: 1px solid #eee;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #666;">
             <span>–í–µ—Å –∏–∑–¥–µ–ª–∏—è:</span>
             <span style="font-weight: bold; color: #333;">${totalWeight} –∫–≥</span>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #ddd; pt: 12px; margin-top: 10px; padding-top: 10px;">
            <span style="font-size: 16px; font-weight: bold; text-transform: uppercase;">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span>
            <span style="font-size: 24px; font-weight: 900; color: #FF5722;">${fmt(total)} ${currency}</span>
        </div>
    </div>
    
    <div style="text-align: center; margin-top: 40px;">
        <div style="font-size: 14px; font-weight: bold;">–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –≤—ã–±–æ—Ä! ‚ù§Ô∏è</div>
    </div>`;

    html += `</body></html>`;
    
    const win = window.open('', '_blank');
    win.document.write(html);
    win.document.close();
}

function openSettingsModal() {
    // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
    loadFinance(); 
    loadHourlyRate();
    loadStatusSettings();
    document.getElementById('settingsModal').style.display = 'flex';
}

function printSticker() {
    closePrintModal();
    const data = appState.results[currentPrintSide];
    if (!data) return;

    const uniqueRecipes = [...new Set(data.tiers.map(t => t.recipeName))];
    document.getElementById('stbCakeName').value = uniqueRecipes.length === 1 ? uniqueRecipes[0] : "–¢–æ—Ä—Ç –ê—Å—Å–æ—Ä—Ç–∏";
    document.getElementById('stbWeight').value = (data.weights.total / 1000).toFixed(2);
    // –ü–æ–ª—É—á–∞–µ–º "—Å–µ–≥–æ–¥–Ω—è" –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const dd = String(now.getDate()).padStart(2, '0');
    const dateForInput = `${yyyy}-${mm}-${dd}`; // 2026-02-07

    document.getElementById('stbDate').value = new Date().toLocaleDateString(); // –î–ª—è —Å–∫—Ä—ã—Ç–æ–≥–æ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    document.getElementById('stbCustomDate').value = dateForInput; // –î–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ö–ë–ñ–£ –≤ —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
    const kbju = data.kbju100 || {p:0, f:0, c:0, k:0};
    document.getElementById('stbP').value = kbju.p;
    document.getElementById('stbF').value = kbju.f;
    document.getElementById('stbC').value = kbju.c;
    document.getElementById('stbK').value = kbju.k;

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å–æ—Å—Ç–∞–≤–æ–≤ –¥–ª—è –∫–µ—à–∞
    window.stickerCache = {
        layersOnly: getLayersText(data),
        ingredientsOnly: getIngredientsText(data),
        full: getFullText(data)
    };

    document.getElementById('stickerBuilderModal').style.display = 'flex';
    updateStickerPreview();
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤ (–¥–æ–±–∞–≤—å—Ç–µ –∏—Ö –ø–æ—Å–ª–µ printSticker)
function getLayersText(data) {
    let names = [];
    data.detailedBlocks.filter(b => b.type === 'filling' || b.type === 'coating').forEach(b => {
        let n = b.name.replace(/–Ø—Ä—É—Å\s+\d+:\s*/gi, '').replace(/–ü–æ–∫—Ä—ã—Ç–∏–µ\s+\(–Ø—Ä—É—Å\s+\d+\):\s*/gi, '').split('|')[0].trim();
        
        if (b.type === 'coating') {
            const coatingSelect = document.getElementById('coatingIdSelect');
            if (coatingSelect && coatingSelect.selectedIndex > 0) {
                n = coatingSelect.options[coatingSelect.selectedIndex].text.split('|')[0].trim();
            }
        }
        if (!names.includes(n)) names.push(n);
    });
    return names.join(', ');
}

function getIngredientsText(data) {
    if (!data.shoppingList) return "–°–æ—Å—Ç–∞–≤ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω";
    return data.shoppingList
        .filter(i => i.amount > 0.1) // —É–±–∏—Ä–∞–µ–º –º–∏–∫—Ä–æ-–¥–æ–∑—ã
        .map(i => i.name.toLowerCase())
        .join(', ');
}

function getFullText(data) {
    let lines = [];
    data.detailedBlocks.filter(b => b.type === 'filling' || b.type === 'coating').forEach(b => {
        let n = b.name.replace(/–Ø—Ä—É—Å\s+\d+:\s*/gi, '').replace(/–ü–æ–∫—Ä—ã—Ç–∏–µ\s+\(–Ø—Ä—É—Å\s+\d+\):\s*/gi, '').split('|')[0].trim();
        
        // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ–∫—Ä—ã—Ç–∏–µ –∏ –≤ —Å–∏—Å—Ç–µ–º–µ –≤—ã–±—Ä–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç, —É—Ç–æ—á–Ω—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
        if (b.type === 'coating') {
            const coatingSelect = document.getElementById('coatingIdSelect');
            if (coatingSelect && coatingSelect.selectedIndex > 0) {
                n = coatingSelect.options[coatingSelect.selectedIndex].text.split('|')[0].trim();
            }
        }

        let ings = b.ingredients.map(i => i.name.toLowerCase()).join(', ');
        lines.push(`${n} (${ings})`);
    });
    return lines.join('; ');
}

function updateStickerPreview() {
    // 1. –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏—Ö –Ω–∞–ª–∏—á–∏–µ (–∑–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫ null)
    const sizeEl = document.getElementById('stbSizeSelector');
    const brandEl = document.getElementById('stbBrandName');
    const nameEl = document.getElementById('stbCakeName');
    const weightEl = document.getElementById('stbWeight');
    const modeEl = document.getElementById('stbCompositionMode');
    const showKBJUEl = document.getElementById('stbShowKBJU');
    const customDateEl = document.getElementById('stbCustomDate');
    const hiddenDateEl = document.getElementById('stbDate');
    const box = document.getElementById('stickerPreviewBox');

    if (!sizeEl || !box) return; // –ï—Å–ª–∏ –±–∞–∑–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –≤—ã—Ö–æ–¥–∏–º

    // 2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏ —Ä–µ–∂–∏–º –ø–æ–≤–æ—Ä–æ—Ç–∞
    let [w, h] = sizeEl.value.split('x').map(Number);
    const isSmallVertical = (sizeEl.value === '50x30');
    
    if (isSmallVertical) {
        [w, h] = [30, 50]; // –ü–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –¥–ª—è —É–∑–∫–æ–π —ç—Ç–∏–∫–µ—Ç–∫–∏
    }

    // 3. –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    const brand = brandEl ? brandEl.value : "–ë—Ä–µ–Ω–¥";
    const name = nameEl ? nameEl.value : "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—Ä—Ç–∞";
    const weight = weightEl ? weightEl.value : "0.00";
    const mode = modeEl ? modeEl.value : "layersOnly";
    const showKBJU = showKBJUEl ? showKBJUEl.checked : true;
    // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞ –¥–∞—Ç—ã –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è (2026-02-07 -> 07.02.2026)
    let displayDate = "";
    if (customDateEl && customDateEl.value) {
        const parts = customDateEl.value.split('-'); // —Ä–∞–∑–±–∏–≤–∞–µ–º 2026-02-07
        if (parts.length === 3) {
            displayDate = `${parts[2]}.${parts[1]}.${parts[0]}`; // —Å–æ–±–∏—Ä–∞–µ–º 07.02.2026
        } else {
            displayDate = customDateEl.value;
        }
    } else if (hiddenDateEl) {
        displayDate = hiddenDateEl.value;
    }
    
    const compText = (window.stickerCache && window.stickerCache[mode]) ? window.stickerCache[mode] : "";

    // 4. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å —à—Ä–∏—Ñ—Ç–∞ (–¥–ª—è 50—Ö30 —É–º–µ–Ω—å—à–∞–µ–º –Ω–∞ 20%)
    const fBase = isSmallVertical ? 0.8 : 1; 

    // 5. –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    box.style.width = (w * 3.7) + 'px'; 
    box.style.height = (h * 3.7) + 'px';
    box.style.padding = isSmallVertical ? '2mm' : '3mm';
    box.style.display = "flex";
    box.style.flexDirection = "column";
    box.style.justifyContent = "space-between";

    // 6. –§–æ—Ä–º–∏—Ä—É–µ–º –±–ª–æ–∫ –ö–ë–ñ–£
    // 6. –§–æ—Ä–º–∏—Ä—É–µ–º –±–ª–æ–∫ –ö–ë–ñ–£ (–¶–≤–µ—Ç –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ —á–µ—Ä–Ω—ã–π #000, –¥–æ–±–∞–≤–ª–µ–Ω font-weight:bold)
    let kbjuHtml = '';
    if (showKBJU) {
        const p = document.getElementById('stbP')?.value || "0";
        const f = document.getElementById('stbF')?.value || "0";
        const c = document.getElementById('stbC')?.value || "0";
        const k = document.getElementById('stbK')?.value || "0";
        kbjuHtml = `<div style="font-size:${6 * fBase}pt; color:#000; font-weight:bold; border-top:1px dashed #000; padding-top:2px; margin-top:2px;">–ë:${p} –ñ:${f} –£:${c} –ö–∫–∞–ª:${k}</div>`;
    }

    // 7. –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π HTML (–¶–≤–µ—Ç –¥–∞—Ç—ã –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ #000, –¥–æ–±–∞–≤–ª–µ–Ω font-weight:bold)
    box.innerHTML = `
    <div style="display: flex; flex-direction: column; height: 100%; width: 100%; justify-content: space-between; pointer-events: none; color: #000;">
        <div style="flex-shrink: 0;">
            <div style="font-size:${6 * fBase}pt; color:#000; font-weight:900; text-align:center; text-transform:uppercase;">${brand}</div>
            <div style="font-size:${10 * fBase}pt; font-weight:900; text-align:center; border-bottom:1.5px solid #000; line-height:1.1; margin-bottom:2px; padding-bottom:1px; color:#000;">${name}</div>
        </div>
        
        <div style="font-size:${6.5 * fBase}pt; line-height:1.1; text-align:left; overflow: hidden; flex-grow: 1; margin: 2px 0; color:#000;">
            <b>–°–æ—Å—Ç–∞–≤:</b> ${compText}
        </div>
        
        <div style="flex-shrink: 0;">
            ${kbjuHtml}
            <div style="font-size:${14 * fBase}pt; font-weight:900; text-align:center; line-height:1; margin-top:2px; color:#000;">${weight} –∫–≥</div>
            <div style="font-size:${6 * fBase}pt; text-align:center; color:#000; font-weight:bold; margin-top:1px;">–î–∞—Ç–∞: ${displayDate} | 72—á</div>
        </div>
    </div>
    `;
}

function finalizeStickerPrint() {
    const sizeSelector = document.getElementById('stbSizeSelector').value;
    let [w, h] = sizeSelector.split('x').map(Number);
    
    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–ª–∏ 50—Ö30, –ø–µ—á–∞—Ç–∞–µ–º –∫–∞–∫ 30–º–º —à–∏—Ä–∏–Ω–∞ –∏ 50–º–º –≤—ã—Å–æ—Ç–∞
    if (sizeSelector === '50x30') {
        [w, h] = [30, 50];
    }
    
    const content = document.getElementById('stickerPreviewBox').innerHTML;
    document.getElementById('stickerBuilderModal').style.display = 'none';

    const win = window.open('', '_blank');
    win.document.write(`<html><head><title>–ü–µ—á–∞—Ç—å</title><style>
        @page { size: ${w}mm ${h}mm; margin: 0; }
        body { 
            width: ${w}mm; height: ${h}mm; 
            margin: 0; padding: 2mm; box-sizing: border-box; 
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        * { box-sizing: border-box; }
    </style></head><body onload="window.print();window.close()">
        ${content}
    </body></html>`);
    win.document.close();
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞
let clientsDataLocal = {};

// 1. –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ –≤ –º–æ–¥–∞–ª–∫–µ –∫–ª–∏–µ–Ω—Ç–∞
function switchClientTab(tab) {
    document.getElementById('clientTabInfo').style.display = (tab === 'info') ? 'block' : 'none';
    document.getElementById('clientTabHistory').style.display = (tab === 'history') ? 'block' : 'none';
    document.getElementById('btnClInfo').classList.toggle('active', tab === 'info');
    document.getElementById('btnClHistory').classList.toggle('active', tab === 'history');
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –¥–∞—Ç—ã –≤ –º–æ–¥–∞–ª–∫—É
function addClientDateRow(date = '', comment = '') {
    const container = document.getElementById('clDatesContainer');
    const div = document.createElement('div');
    div.className = 'form-row date-row';
    div.style.marginBottom = '5px';
    div.innerHTML = `
        <input type="date" class="cl-date-val" value="${date}" style="flex:1.2; font-size:12px;">
        <input type="text" class="cl-date-comm" placeholder="–ß–µ–π –¥–µ–Ω—å?" value="${comment}" style="flex:2; font-size:12px;">
        <button class="del-btn" onclick="this.parentElement.remove()" style="padding:0 5px;">‚úï</button>
    `;
    container.appendChild(div);
}


// –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
function closeClientModal() {
    const modal = document.getElementById('clientModal');
    if (modal) modal.style.display = 'none';
}
function openClientModal(id = null) {
    document.getElementById('clientModal').style.display = 'flex';
    switchClientTab('info');
    document.getElementById('clDatesContainer').innerHTML = '';
    
    if(id && clientsDataLocal[id]) {
        const c = clientsDataLocal[id];
        document.getElementById('clId').value = id;
        document.getElementById('clName').value = c.name;
        document.getElementById('clPhone').value = c.phone || '';
        document.getElementById('clSocial').value = c.social || '';
        document.getElementById('clDiscount').value = c.discount || 0;
        document.getElementById('clNotes').value = c.notes || '';
        document.getElementById('clientModalTitle').innerText = 'üìù ' + c.name;
        document.getElementById('clSource').value = c.source || '';
        document.getElementById('clSource').setAttribute('data-current', c.source || ''); // –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
        document.getElementById('clBlacklist').checked = c.isProblem || false; // –ß–µ–∫–±–æ–∫—Å —á–µ—Ä–Ω–æ–π –º–µ—Ç–∫–∏
        
        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–∫–∏ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, —á—Ç–æ–±—ã –≤—ã–¥–µ–ª–∏—Ç—å –Ω—É–∂–Ω–æ–µ)
        updateDropdownsFromSettings();
        
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞—Ç—ã
        if(c.importantDates) {
            c.importantDates.forEach(d => addClientDateRow(d.date, d.comment));
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞, —Å–¥–µ–ª–∞–µ–º –∫–æ–≥–¥–∞ –ø—Ä–∏–≤—è–∂–µ–º –ü–ª–∞–Ω –∫ –∫–ª–∏–µ–Ω—Ç—É)
        renderClientOrdersHistory(id);
        
        // –°—á–∏—Ç–∞–µ–º –æ–±—â—É—é —Å—É–º–º—É (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ –¥–∞–Ω–Ω—ã—Ö)
        // –í—ã–≤–æ–¥ —Å—É–º–º—ã —Å –∫–Ω–æ–ø–∫–æ–π –ø–µ—Ä–µ—Å—á–µ—Ç–∞
        const total = c.totalSpend || 0;
        const symbol = SYMBOLS[currentCurrency] || '';
        const spendDiv = document.getElementById('clientTotalSpend');
        
        spendDiv.innerHTML = `
            –ó–∞–∫–∞–∑–æ–≤ –Ω–∞: <b>${total.toLocaleString()} ${symbol}</b>
            <span onclick="forceRecalcClient('${id}')" style="cursor:pointer; margin-left:8px; font-size:14px;" title="–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Å—É–º–º—É –ø–æ –∏—Å—Ç–æ—Ä–∏–∏">üîÑ</span>
        `;
        formatPhoneNumber(document.getElementById('clPhone'));
    } else {
        document.getElementById('clId').value = '';
        document.getElementById('clName').value = '';
        document.getElementById('clPhone').value = '';
        document.getElementById('clSocial').value = '';
        document.getElementById('clDiscount').value = '0';
        document.getElementById('clNotes').value = '';
        document.getElementById('clientModalTitle').innerText = 'üë§ –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç';
        document.getElementById('clientTotalSpend').innerText = '–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç';
        document.getElementById('clSource').value = '';
        document.getElementById('clBlacklist').checked = false;
        addClientDateRow(); // –û–¥–Ω–∞ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
    }
}

function saveClientCloud() {
    const idInput = document.getElementById('clId');
    // –ï—Å–ª–∏ ID –Ω–µ—Ç, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π. –ï—Å–ª–∏ –µ—Å—Ç—å - –±–µ—Ä–µ–º –µ–≥–æ.
    const id = idInput.value || 'c' + Date.now();
    
    const name = document.getElementById('clName').value.trim();
    if(!name) { alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!"); return; }

    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞—Ç—ã
    const dates = [];
    document.querySelectorAll('.date-row').forEach(row => {
        const d = row.querySelector('.cl-date-val').value;
        const c = row.querySelector('.cl-date-comm').value;
        if(d) dates.push({date: d, comment: c});
    });

    // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –∫–ª–∏–µ–Ω—Ç–∞
    const clientData = {
        name: name,
        phone: document.getElementById('clPhone').value,
        social: document.getElementById('clSocial').value,
        discount: parseFloat(document.getElementById('clDiscount').value) || 0,
        notes: document.getElementById('clNotes').value,
        importantDates: dates,
        source: document.getElementById('clSource').value,
        isProblem: document.getElementById('clBlacklist').checked,
        // –ï—Å–ª–∏ —ç—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ–ª—è (–∏—Å—Ç–æ—Ä–∏—é –∏ —Ç.–¥.), –∏–Ω–∞—á–µ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ
        history: clientsDataLocal[id] ? clientsDataLocal[id].history : {},
        totalSpend: clientsDataLocal[id] ? clientsDataLocal[id].totalSpend : 0,
        created: clientsDataLocal[id] ? clientsDataLocal[id].created : new Date().toISOString(),
        updated: new Date().toISOString()
    };
saveToHistory();
    // 1. –ú–ì–ù–û–í–ï–ù–ù–û–ï –õ–û–ö–ê–õ–¨–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï (OPTIMISTIC UPDATE)
    // –ú—ã —Å—Ä–∞–∑—É –ø–∏—à–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±—Ä–∞—É–∑–µ—Ä
    clientsDataLocal[id] = clientData;
    localStorage.setItem('cachedClients', JSON.stringify(clientsDataLocal));
    
    // –°—Ä–∞–∑—É –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    renderClientsCloud();
    closeClientModal();

    
    // 2. –û–¢–ü–†–ê–í–ö–ê –í –û–ë–õ–ê–ö–û (Google Sheets)
    // –ú—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º –í–°–Æ –±–∞–∑—É –∫–ª–∏–µ–Ω—Ç–æ–≤ —Ü–µ–ª–∏–∫–æ–º, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –æ–¥–∏–Ω —Ñ–∞–π–ª
    saveToCloud('clients', clientsDataLocal);
}

function renderClientOrdersHistory(clientId) {
    const container = document.getElementById('clOrdersList');
    if (!container) return;

    const client = clientsDataLocal[clientId];
    if (!client || !client.history) {
        container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">–ó–∞–∫–∞–∑–æ–≤ –µ—â–µ –Ω–µ –±—ã–ª–æ</div>';
        return;
    }

    let html = '';
    const orders = Object.values(client.history).reverse(); // –°–≤–µ–∂–∏–µ —Å–≤–µ—Ä—Ö—É

    orders.forEach(order => {
        const symbol = SYMBOLS[currentCurrency] || '';
        const isDone = (order.status === 'completed');
        const statusIcon = isDone ? '‚úÖ' : '‚è≥';
        
        // –°–æ—Å—Ç–∞–≤
        let cakeDetails = "";
        if (order.data && order.data.tiers) {
            cakeDetails = order.data.tiers.map((t, idx) => {
                const shape = order.data.geometry.shape;
                const size = (shape === 'rectangle') ? `${Math.round(t.d)}x${Math.round(t.w)}` : `D${Math.round(t.d)}`;
                return `<div style="margin-bottom:2px;">‚Ä¢ <b>${t.recipeName}</b> (${size} —Å–º, H${Math.round(t.h)})</div>`;
            }).join('');
        }

        // –§–æ—Ç–æ
        let photoBadge = '';
        if (order.refImage) {
            const btnText = isDone ? "üì∑ –ò—Ç–æ–≥" : "üì∏ –†–µ—Ñ";
            const btnStyle = isDone ? "background:#E8F5E9; color:#2E7D32;" : "background:#FFF3E0; color:#E65100;";
            photoBadge = `<button onclick="viewOrderRef('${order.id}')" style="${btnStyle} border:none; padding:2px 8px; border-radius:10px; font-size:11px; cursor:pointer; font-weight:bold; margin-left:auto;">${btnText}</button>`;
        }

        // –î–æ–ø –ø–æ–ª—è
        const forWhom = order.forWhom ? `üë§ –î–ª—è: <b>${order.forWhom}</b>` : '';
        const reason = order.reason ? `üéâ ${order.reason}` : '';

        html += `
            <div style="background:#fff; padding:12px; border-radius:8px; border:1px solid #e0e0e0; font-size:13px; position:relative; margin-bottom:10px; box-shadow:0 1px 2px rgba(0,0,0,0.05);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; border-bottom:1px solid #f5f5f5; padding-bottom:5px;">
                    <div style="color:#666;">${statusIcon} ${order.date}</div>
                    <div style="font-weight:bold; color:#333;">${Math.round(order.price).toLocaleString()} ${symbol}</div>
                </div>
                
                <div style="margin-bottom:5px; font-size:12px; color:#555;">
                    ${reason} ${forWhom ? ' | ' + forWhom : ''}
                </div>

                <div style="background:#f9f9f9; padding:8px; border-radius:6px; margin-bottom:5px;">
                   ${cakeDetails || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}
                   <div style="font-weight:bold; font-size:11px; margin-top:4px; text-align:right;">‚öñÔ∏è ${order.weight} –∫–≥</div>
                </div>
                
                ${order.comment ? `<div style="font-size:12px; font-style:italic; color:#795548; margin-bottom:5px;">üé® ${order.comment}</div>` : ''}

                <div style="display:flex; align-items:center; margin-top:8px;">
                     ${!isDone ? `<button onclick="editOrderInHistory('${clientId}', '${order.id}')" style="color:#1976D2; background:none; border:none; cursor:pointer; font-size:11px; font-weight:bold; margin-right:10px;">‚úèÔ∏è –ò–ó–ú–ï–ù–ò–¢–¨</button>` : ''}
                     <button onclick="deleteOrderFromHistory('${clientId}', '${order.id}')" style="color:#d32f2f; background:none; border:none; cursor:pointer; font-size:11px; font-weight:bold;">üóëÔ∏è –£–î–ê–õ–ò–¢–¨</button>
                     ${photoBadge}
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

// 1. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ –æ–±–ª–∞–∫–∞
// 1. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ (–° LTV –∏ –ë–ï–ô–î–ñ–ê–ú–ò)
function renderClientsCloud() {
    const container = document.getElementById('clientsCloudList');
    if (!container) return;
    
    if (!clientsDataLocal || Object.keys(clientsDataLocal).length === 0) {
        container.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999; padding:20px;">–ë–∞–∑–∞ –ø—É—Å—Ç–∞ –∏–ª–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</td></tr>';
        return;
    }

    const searchInput = document.getElementById('clientSearch');
    const search = searchInput ? searchInput.value.toLowerCase() : "";
    const showOnlyUpcoming = document.getElementById('filterUpcoming') ? document.getElementById('filterUpcoming').checked : false;
    
    container.innerHTML = '';
    const today = new Date(); today.setHours(0,0,0,0);
    const DAYS_AHEAD = 7; 

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –°–Ω–∞—á–∞–ª–∞ –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É), –∏–ª–∏ –ø–æ –∏–º–µ–Ω–∏
    const sortedIds = Object.keys(clientsDataLocal).sort((a,b) => {
        const cA = clientsDataLocal[a], cB = clientsDataLocal[b];
        return (cB.created || "").localeCompare(cA.created || ""); // –ù–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É
    });

    sortedIds.forEach(id => {
        const c = clientsDataLocal[id];
        if (!c) return;

        // --- –õ–û–ì–ò–ö–ê LTV –ò –°–†–ï–î–ù–ï–ì–û –ß–ï–ö–ê ---
        // --- –õ–û–ì–ò–ö–ê LTV (–î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ï –°–¢–ê–¢–£–°–´) ---
        const history = c.history ? Object.values(c.history) : [];
        const ordersCount = history.length;
        const totalMoney = c.totalSpend || 0;
        const avgCheck = ordersCount > 0 ? Math.round(totalMoney / ordersCount) : 0;

        let badgeHtml = "";
        
        // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–∏–ª–∏ –±–µ—Ä–µ–º –¥–µ—Ñ–æ–ª—Ç)
        const rawStatuses = localStorage.getItem('cakeClientStatuses');
        const statuses = rawStatuses ? JSON.parse(rawStatuses) : DEFAULT_STATUSES;
        
        // 2. –°–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Å–∞–º—ã–π –≤—ã—Å–æ–∫–∏–π –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Å—Ç–∞—Ç—É—Å
        statuses.sort((a,b) => b.min - a.min);
        
        // 3. –ò—â–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Å—Ç–∞—Ç—É—Å
        const currentStatus = statuses.find(s => totalMoney >= s.min);

        // 4. –†–∏—Å—É–µ–º –±–µ–π–¥–∂ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—å 1 –∑–∞–∫–∞–∑)
        if (ordersCount > 0 && currentStatus) {
            // –ë–µ—Ä–µ–º —Ü–≤–µ—Ç–∞ –∏–∑ –ø–∞–ª–∏—Ç—Ä—ã
            const style = STATUS_COLORS[currentStatus.color] || STATUS_COLORS['bronze'];
            
            badgeHtml = `<span style="
                font-size:10px; padding:2px 8px; border-radius:12px; font-weight:bold; margin-right:5px;
                background:${style.bg}; color:${style.text}; border:1px solid ${style.border};
            " title="–ó–∞–∫–∞–∑–æ–≤: ${ordersCount}, –°—É–º–º–∞: ${totalMoney.toLocaleString()}">
                ${currentStatus.name}
            </span>`;
        }
        // ----------------------------------
        // ----------------------------------

        // --- –õ–û–ì–ò–ö–ê –ü–†–ê–ó–î–ù–ò–ö–û–í ---
        let hasUpcoming = false;
        let upcomingLabel = "";
        if (c.importantDates) {
            c.importantDates.forEach(evt => {
                if (!evt.date) return;
                const parts = evt.date.split('-');
                const checkDate = new Date(today.getFullYear(), parseInt(parts[1])-1, parseInt(parts[2]));
                if (checkDate < today) checkDate.setFullYear(today.getFullYear() + 1);
                const diffDays = Math.ceil((checkDate - today) / (1000 * 60 * 60 * 24));

                if (diffDays >= 0 && diffDays <= DAYS_AHEAD) {
                    hasUpcoming = true;
                    const dayText = (diffDays === 0) ? "–°–ï–ì–û–î–ù–Ø" : (diffDays === 1 ? "–ó–∞–≤—Ç—Ä–∞" : `—á–µ—Ä–µ–∑ ${diffDays} –¥–Ω.`);
                    upcomingLabel = `<div style="font-size:10px; color:#E65100; font-weight:bold; background:#fff; display:inline-block; padding:1px 5px; border-radius:4px; border:1px solid #FFCC80; margin-left:5px;">üéÅ ${dayText}: ${evt.comment}</div>`;
                }
            });
        }

        if (showOnlyUpcoming && !hasUpcoming) return;

        const nameMatch = c.name && c.name.toLowerCase().includes(search);
        const phoneMatch = c.phone && c.phone.includes(search);
        
        if (nameMatch || phoneMatch || (showOnlyUpcoming && hasUpcoming)) { 
            const warningSign = c.isProblem ? '<span title="–ü—Ä–æ–±–ª–µ–º–Ω—ã–π" style="cursor:help;">‚õî</span> ' : '';
            const rowClass = hasUpcoming ? "row-celebration" : "";
            const bgStyle = (!hasUpcoming && c.isProblem) ? "background:#ffebee;" : "";
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫ (12k)
            const avgDisplay = avgCheck > 0 ? `<div style="font-size:10px; color:#00695c; margin-top:2px;">–°—Ä.—á–µ–∫: <b>${(avgCheck/1000).toFixed(1)}k</b></div>` : '';

            container.innerHTML += `
                <tr onclick="openClientModal('${id}')" class="${rowClass}" style="cursor:pointer; ${bgStyle}">
                    <td>
                        <div style="display:flex; align-items:center;">
                            ${warningSign} 
                            <div>
                                <div><b>${c.name}</b></div>
                                ${badgeHtml}
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>${c.phone || '-'}</div>
                        ${avgDisplay}
                    </td>
                    <td style="font-size:12px; color:#666; vertical-align:middle;">
                        ${hasUpcoming ? upcomingLabel : ((c.importantDates && c.importantDates.length > 0) ? 'üìÖ ' + c.importantDates.length + ' –¥–∞—Ç' : '')}
                    </td>
                    <td style="text-align:right;">
                        <button class="del-btn" onclick="event.stopPropagation(); deleteClientCloud('${id}')">‚úï</button>
                    </td>
                </tr>`;
        }
    });
}

function deleteClientCloud(id) {
    const client = clientsDataLocal[id];
    if (!client) return;

    if(confirm(`–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –∫–ª–∏–µ–Ω—Ç–∞ "${client.name}"?\n\n‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –í—Å–µ –∑–∞–∫–∞–∑—ã —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ (${Object.keys(client.history || {}).length} —à—Ç) –±—É–¥—É—Ç —Ç–∞–∫–∂–µ —É–¥–∞–ª–µ–Ω—ã –∏–∑ –ê—Ä—Ö–∏–≤–∞!`)) {
        saveToHistory(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

        // 1. –ö–ê–°–ö–ê–î–ù–û–ï –£–î–ê–õ–ï–ù–ò–ï –ò–ó –ê–†–•–ò–í–ê
        // –ï—Å–ª–∏ —É –∫–ª–∏–µ–Ω—Ç–∞ –±—ã–ª–∞ –∏—Å—Ç–æ—Ä–∏—è, —É–¥–∞–ª—è–µ–º —ç—Ç–∏ –∑–∞–∫–∞–∑—ã –∏–∑ –æ–±—â–µ–≥–æ –∞—Ä—Ö–∏–≤–∞
        if (client.history) {
            const clientOrderIds = Object.keys(client.history);
            // –û—Å—Ç–∞–≤–ª—è–µ–º –≤ –∞—Ä—Ö–∏–≤–µ —Ç–æ–ª—å–∫–æ —Ç–µ –∑–∞–∫–∞–∑—ã, —á—å–∏—Ö ID –ù–ï–¢ —É —É–¥–∞–ª—è–µ–º–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
            archiveOrders = archiveOrders.filter(order => !clientOrderIds.includes(order.id));
        }

        // 2. –£–î–ê–õ–ï–ù–ò–ï –ö–õ–ò–ï–ù–¢–ê
        delete clientsDataLocal[id]; 

        // 3. –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê
        renderClientsCloud(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤
        renderArchive();      // –û–±–Ω–æ–≤–ª—è–µ–º –∞—Ä—Ö–∏–≤ (–∑–∞–∫–∞–∑—ã –∏—Å—á–µ–∑–Ω—É—Ç)

        // 4. –°–û–•–†–ê–ù–ï–ù–ò–ï
        saveToCloud('clients', clientsDataLocal);
        saveToCloud('archive', archiveOrders); 
    }
}
     let lastDeletedOrderData = null;

// --- 1. –£–î–ê–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê (–ú–ì–ù–û–í–ï–ù–ù–´–ô –ü–ï–†–ï–°–ß–ï–¢) ---
// --- 1. –£–î–ê–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê (–°–ò–ù–•–†–û–ù–ò–ó–ò–†–û–í–ê–ù–ù–û–ï) ---
async function deleteOrderFromHistory(clientId, orderId) {
    // 1. –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –∑–∞–∫–∞–∑ —Ö–æ—Ç—å –≥–¥–µ-–Ω–∏–±—É–¥—å, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫ –¥–ª—è Undo
    // –ò—â–µ–º —É –∫–ª–∏–µ–Ω—Ç–∞
    let orderData = clientsDataLocal[clientId]?.history?.[orderId];
    
    // –ï—Å–ª–∏ —É –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ—Ç (—Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω), –∏—â–µ–º –≤ –∞—Ä—Ö–∏–≤–µ
    if (!orderData) {
        orderData = archiveOrders.find(o => o.id === orderId);
    }

    if (!orderData) {
        console.error("–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∏ —É –∫–ª–∏–µ–Ω—Ç–∞, –Ω–∏ –≤ –∞—Ä—Ö–∏–≤–µ");
        return; 
    }

    // 2. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    if (!confirm(`‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑ "${orderData.reason || '–¢–æ—Ä—Ç'}" (${orderData.date})?\n\n–û–Ω –∏—Å—á–µ–∑–Ω–µ—Ç –∏ –∏–∑ –ê—Ä—Ö–∏–≤–∞, –∏ –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ –ö–ª–∏–µ–Ω—Ç–∞.`)) return;

    // 3. –í–æ–ø—Ä–æ—Å –ø—Ä–æ —Å–∫–ª–∞–¥ (–µ—Å–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω)
    let returnProducts = false;
    if (orderData.status === 'completed' && orderData.data?.shoppingList) {
        returnProducts = confirm(`üì¶ –í–ï–†–ù–£–¢–¨ –ø—Ä–æ–¥—É–∫—Ç—ã –Ω–∞ —Å–∫–ª–∞–¥?\n\n[–û–ö] - –î–∞, –≤–µ—Ä–Ω—É—Ç—å –æ—Å—Ç–∞—Ç–∫–∏\n[–û—Ç–º–µ–Ω–∞] - –ù–µ—Ç, –æ—Å—Ç–∞–≤–∏—Ç—å —Å–ø–∏—Å–∞–Ω–Ω—ã–º–∏`);
    }

    // --- –ü–û–î–ì–û–¢–û–í–ö–ê –ö UNDO ---
    const archiveIdx = archiveOrders.findIndex(o => o.id === orderId);
    
    lastDeletedOrderData = {
        order: JSON.parse(JSON.stringify(orderData)),
        clientId: clientId,
        archiveIndex: archiveIdx, // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ –∞—Ä—Ö–∏–≤–µ
        returnedProducts: returnProducts,
        oldStockState: JSON.parse(JSON.stringify(myIngredients)) 
    };

    // --- –£–î–ê–õ–ï–ù–ò–ï ---

    // –ê. –£–¥–∞–ª—è–µ–º –∏–∑ –ö–õ–ò–ï–ù–¢–ê (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å)
    if (clientsDataLocal[clientId] && clientsDataLocal[clientId].history) {
        delete clientsDataLocal[clientId].history[orderId];
        
        // –ü–µ—Ä–µ—Å—á–µ—Ç LTV –∫–ª–∏–µ–Ω—Ç–∞
        let newLocalTotal = 0;
        Object.values(clientsDataLocal[clientId].history).forEach(o => newLocalTotal += (parseFloat(o.price) || 0));
        clientsDataLocal[clientId].totalSpend = newLocalTotal;
    }

    // –ë. –£–¥–∞–ª—è–µ–º –∏–∑ –û–ë–©–ï–ì–û –ê–†–•–ò–í–ê (–µ—Å–ª–∏ –æ–Ω —Ç–∞–º –µ—Å—Ç—å)
    if (archiveIdx !== -1) {
        archiveOrders.splice(archiveIdx, 1);
    }

    // –í. –í–æ–∑–≤—Ä–∞—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–°–∫–ª–∞–¥) - –ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–ª–∞—Å—å –ø—Ä–µ–∂–Ω–µ–π
    if (returnProducts) {
        let returnedCount = 0;
        orderData.data.shoppingList.forEach(shopItem => {
            const ing = myIngredients.find(i => i.id === shopItem.id);
            if (ing) {
                ing.stock = (parseFloat(ing.stock) || 0) + parseFloat(shopItem.amount);
                returnedCount++;
                // –õ–æ–≥ –≤ –∏—Å—Ç–æ—Ä–∏—é —Å–∫–ª–∞–¥–∞... (–∫–æ–¥ —Å–æ–∫—Ä–∞—â–µ–Ω, –æ–Ω —Ç–∞–∫–æ–π –∂–µ –∫–∞–∫ –±—ã–ª)
                stockHistory.push({
                    id: 'log_' + Date.now(), date: new Date().toISOString(), type: 'procurement',
                    item: ing.name, diff: `+${shopItem.amount} ${ing.unit}`, balance: `${ing.stock} ${ing.unit}`, comment: `–í–æ–∑–≤—Ä–∞—Ç: –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞`
                });
            }
        });
        if (returnedCount > 0) alert(`‚úÖ –ù–∞ —Å–∫–ª–∞–¥ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ –ø–æ–∑–∏—Ü–∏–π: ${returnedCount}`);
        saveIngs();
        saveToCloud('history_stock', stockHistory);
    }

    // –ì. –£–¥–∞–ª—è–µ–º —Ñ–æ—Ç–æ (–õ–æ–∫–∞–ª—å–Ω–æ + –î–∏—Å–∫)
    imageDB.delete(orderId);
    if (orderData.refImage && orderData.refImage.startsWith('DRIVE:')) {
        apiDeleteFileFromDrive(orderData.refImage.split(':')[1]);
    }

    // –î. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–±–ª–∞–∫–æ
    saveToCloud('clients', clientsDataLocal);
    saveToCloud('archive', archiveOrders);

    // –ï. –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –≥–¥–µ –º—ã —Å–µ–π—á–∞—Å)
    // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –º–æ–¥–∞–ª–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ - –æ–±–Ω–æ–≤–ª—è–µ–º –µ—ë
    if (document.getElementById('clientModal').style.display === 'flex') {
        const spendDiv = document.getElementById('clientTotalSpend');
        const symbol = SYMBOLS[currentCurrency] || '';
        if (spendDiv && clientsDataLocal[clientId]) {
             spendDiv.innerHTML = `–ó–∞–∫–∞–∑–æ–≤ –Ω–∞: <b>${clientsDataLocal[clientId].totalSpend.toLocaleString()} ${symbol}</b>`;
        }
        renderClientOrdersHistory(clientId);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ (–µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å —Å—É–º–º–∞ LTV)
    renderClientsCloud();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ê—Ä—Ö–∏–≤ (–µ—Å–ª–∏ –º—ã —Ç–∞–º)
    renderArchive(); 

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–û—Ç–º–µ–Ω–∏—Ç—å"
    showUndoToast("–ó–∞–∫–∞–∑ —É–¥–∞–ª–µ–Ω –æ—Ç–æ–≤—Å—é–¥—É", undoDeleteOrder);
}
     let currentUndoFunction = null;

function showUndoToast(text, undoFn) {
    const toast = document.getElementById('undoToast');
    document.getElementById('undoToastText').innerText = text;
    currentUndoFunction = undoFn;
    
    toast.style.display = 'flex';
    
    // –°–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    setTimeout(() => {
        hideUndoToast();
    }, 5000);
}

function executeUndoAction() {
    if (currentUndoFunction) currentUndoFunction();
    hideUndoToast();
}

function hideUndoToast() {
    document.getElementById('undoToast').style.display = 'none';
    currentUndoFunction = null;
}

   async function undoDeleteOrder() {
    if (!lastDeletedOrderData) return;

    const { order, clientId, archiveIndex, returnedProducts, oldStockState } = lastDeletedOrderData;

    // 1. –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∫–ª–∞–¥ (–µ—Å–ª–∏ –±—ã–ª –≤–æ–∑–≤—Ä–∞—Ç)
    if (returnedProducts) {
        myIngredients = JSON.parse(JSON.stringify(oldStockState));
        saveIngs();
    }

    // 2. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ö–õ–ò–ï–ù–¢–£
    // –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∫–ª–∏–µ–Ω—Ç. –ï—Å–ª–∏ –≤–¥—Ä—É–≥ —É–¥–∞–ª–∏–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ–∫–∞ –≤–∏—Å–µ–ª Undo - –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ –µ–≥–æ (–ø—É—Å—Ç—ã—à–∫—É)
    if (!clientsDataLocal[clientId]) {
        clientsDataLocal[clientId] = { 
            name: order.name || "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç", 
            phone: order.phone, 
            history: {}, 
            totalSpend: 0 
        };
    }
    if (!clientsDataLocal[clientId].history) clientsDataLocal[clientId].history = {};
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑ –æ–±—Ä–∞—Ç–Ω–æ –∫–ª–∏–µ–Ω—Ç—É
    clientsDataLocal[clientId].history[order.id] = order;

    // –ü–µ—Ä–µ—Å—á–µ—Ç LTV
    let total = 0;
    Object.values(clientsDataLocal[clientId].history).forEach(o => total += (parseFloat(o.price) || 0));
    clientsDataLocal[clientId].totalSpend = total;

    // 3. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –ê–†–•–ò–í
    // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞ —Ç–æ –∂–µ –º–µ—Å—Ç–æ, –≥–¥–µ –±—ã–ª (–∏–ª–∏ –≤ –∫–æ–Ω–µ—Ü)
    if (archiveIndex !== -1 && archiveIndex <= archiveOrders.length) {
        archiveOrders.splice(archiveIndex, 0, order);
    } else {
        archiveOrders.push(order);
    }

    // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ–±–ª–∞–∫–æ
    saveToCloud('clients', clientsDataLocal);
    saveToCloud('archive', archiveOrders);

    // 5. –û–±–Ω–æ–≤–ª—è–µ–º UI
    renderArchive();
    renderClientsCloud();
    if (document.getElementById('clientModal').style.display === 'flex') {
        renderClientOrdersHistory(clientId);
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É–º–º—É –≤ –º–æ–¥–∞–ª–∫–µ
        const spendDiv = document.getElementById('clientTotalSpend');
        if(spendDiv) spendDiv.innerHTML = `–ó–∞–∫–∞–∑–æ–≤ –Ω–∞: <b>${total.toLocaleString()} ${SYMBOLS[currentCurrency] || ''}</b>`;
    }

    lastDeletedOrderData = null;
    hideUndoToast();
    alert("‚úÖ –ó–∞–∫–∞–∑ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–≤ –ê—Ä—Ö–∏–≤ –∏ –ö–ª–∏–µ–Ω—Ç—É)");
}
     
// 2. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (—á–µ—Ä–µ–∑ prompt –¥–ª—è –±—ã—Å—Ç—Ä–æ—Ç—ã –∏–ª–∏ –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –º–æ–¥–∞–ª–∫—É)
function editOrderInHistory(clientId, orderId) {
    const order = clientsDataLocal[clientId].history[orderId];
    if (!order) return;

    // –î–ª—è –Ω–∞—á–∞–ª–∞ —Å–¥–µ–ª–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –Ω–æ–≤–æ–µ –æ–∫–Ω–æ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ –∂–µ orderFinalizeModal)
    const modal = document.getElementById('orderFinalizeModal');
    modal.style.display = 'flex';
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ç–µ–∫—É—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    document.getElementById('orderClientId').value = clientId;
    document.getElementById('orderReason').value = order.reason || '';
    document.getElementById('orderForWhom').value = order.forWhom || '';
    document.getElementById('orderPayment').value = order.payment || '';
    document.getElementById('orderDelivery').value = order.delivery || '';
    document.getElementById('orderComment').value = order.comment || '';
    
    // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è, —á—Ç–æ–±—ã –æ–Ω–∞ –∑–Ω–∞–ª–∞, —á—Ç–æ —ç—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    const saveBtn = modal.querySelector('.main-btn');
    const originalOnclick = saveBtn.getAttribute('onclick');
    
    saveBtn.innerText = "–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ";
    saveBtn.onclick = function() {
        const updatedData = {
            reason: document.getElementById('orderReason').value,
            forWhom: document.getElementById('orderForWhom').value,
            payment: document.getElementById('orderPayment').value,
            delivery: document.getElementById('orderDelivery').value,
            comment: document.getElementById('orderComment').value
        };

        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
       const targetOrder = clientsDataLocal[clientId].history[orderId];
       if (targetOrder) {
           Object.assign(targetOrder, updatedData); // –°–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
           
           // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å—é –±–∞–∑—É –∫–ª–∏–µ–Ω—Ç–æ–≤
           saveToCloud('clients', clientsDataLocal);
           
           modal.style.display = 'none';
           saveBtn.innerText = "–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑";
           saveBtn.setAttribute('onclick', originalOnclick);
           renderClientOrdersHistory(clientId);
           alert("‚úÖ –ó–∞–∫–∞–∑ –æ–±–Ω–æ–≤–ª–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω.");
       }
    };
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –Ω–∞ –ª–µ—Ç—É
function formatPhoneNumber(input) {
    let val = input.value.replace(/\D/g, ''); // –¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
    if (val.startsWith('7')) val = val.substring(1);
    if (val.startsWith('8')) val = val.substring(1);
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 10 —Ü–∏—Ñ—Ä–∞–º–∏ (–ø–æ—Å–ª–µ +7)
    val = val.substring(0, 10);
    
    let formatted = '+7';
    if (val.length > 0) formatted += ' (' + val.substring(0, 3);
    if (val.length >= 4) formatted += ') ' + val.substring(3, 6);
    if (val.length >= 7) formatted += '-' + val.substring(6, 8);
    if (val.length >= 9) formatted += '-' + val.substring(8, 10);
    
    input.value = formatted;
    document.getElementById('messengerBtns').style.display = val.length === 10 ? 'flex' : 'none';
}

function openMessenger(type) {
    const phone = document.getElementById('clPhone').value.replace(/\D/g, '');
    if (type === 'wa') window.open(`https://wa.me/${phone}`, '_blank');
    if (type === 'tg') {
        const social = document.getElementById('clSocial').value.replace('@', '');
        if (social) window.open(`https://t.me/${social}`, '_blank');
        else alert("–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –≤ Instagram/TG –±–µ–∑ @");
    }
}

// 1. –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É—Å—Ç—ã)
const DEFAULT_BANKS = "–ü–µ—Ä–µ–≤–æ–¥ (Kaspi), –ü–µ—Ä–µ–≤–æ–¥ (Halyk), –ù–∞–ª–∏—á–Ω—ã–µ, –£–¥–∞–ª–µ–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞";
const DEFAULT_SOURCES = "Instagram, TikTok, Threads, 2GIS, –°–∞–º–∏ –Ω–∞—à–ª–∏, –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è, –†–µ–∫–ª–∞–º–∞";

// 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–ø–∏—Å–∫–æ–≤
function saveListSettings() {
    localStorage.setItem('cakeBanksList', document.getElementById('settingBanks').value);
    localStorage.setItem('cakeSourcesList', document.getElementById('settingSources').value);
    // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
    updateDropdownsFromSettings();
}

// 3. –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
function loadListSettings() {
    document.getElementById('settingBanks').value = localStorage.getItem('cakeBanksList') || DEFAULT_BANKS;
    document.getElementById('settingSources').value = localStorage.getItem('cakeSourcesList') || DEFAULT_SOURCES;
    updateDropdownsFromSettings();
}

// 4. –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö select –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
function updateDropdownsFromSettings() {
    const banks = document.getElementById('settingBanks').value.split(',').map(s => s.trim()).filter(s => s);
    const sources = document.getElementById('settingSources').value.split(',').map(s => s.trim()).filter(s => s);

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –±–∞–Ω–∫–æ–≤ –≤ –æ–∫–Ω–µ –∑–∞–∫–∞–∑–∞
    const paySelect = document.getElementById('orderPayment');
    if (paySelect) {
        const currentVal = paySelect.value;
        paySelect.innerHTML = '';
        banks.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.innerText = b;
            paySelect.appendChild(opt);
        });
        // –ü—ã—Ç–∞–µ–º—Å—è –≤–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å –≤ –Ω–æ–≤–æ–º —Å–ø–∏—Å–∫–µ
        if (banks.includes(currentVal)) paySelect.value = currentVal;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –∫–ª–∏–µ–Ω—Ç–∞
    const sourceSelect = document.getElementById('clSource');
    if (sourceSelect) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä (–≤–∞–∂–Ω–æ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏)
        const currentSource = sourceSelect.getAttribute('data-current') || ""; 
        
        sourceSelect.innerHTML = '<option value="">-- –ù–µ —É–∫–∞–∑–∞–Ω–æ --</option>';
        sources.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s;
            opt.innerText = s;
            if (s === currentSource) opt.selected = true;
            sourceSelect.appendChild(opt);
        });
    }
}

function forcePushClientsToCloud() {
    // 1. –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É—Ä–∞–∫–∞)
    const password = prompt("–í–ù–ò–ú–ê–ù–ò–ï! –û–ü–ê–°–ù–û–ï –î–ï–ô–°–¢–í–ò–ï.\n\n–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–ò–¢–¨ –æ–±–ª–∞—á–Ω—É—é –±–∞–∑—É –∫–ª–∏–µ–Ω—Ç–æ–≤ —Ç–µ–º–∏ –¥–∞–Ω–Ω—ã–º–∏, —á—Ç–æ —Å–µ–π—á–∞—Å –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É –≤–∞—Å –ª–æ–∫–∞–ª—å–Ω–æ (–∏–∑ —Ñ–∞–π–ª–∞).\n\n–í—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ–±–ª–∞–∫–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.\n\n–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ 'RESTORE':");
    
    if (password !== 'RESTORE') {
        alert("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.");
        return;
    }

    // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å
    if (!clientsDataLocal || Object.keys(clientsDataLocal).length === 0) {
        alert("–õ–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –ø—É—Å—Ç–∞. –ù–µ—á–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å.");
        return;
    }

    // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Google –¢–∞–±–ª–∏—Ü—É
    saveToCloud('clients', clientsDataLocal);
    alert("‚úÖ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ë–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –¢–∞–±–ª–∏—Ü—É.");
}

// 1. –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –∫—ç—à–∞ (–¥–ª—è –æ—Ñ–ª–∞–π–Ω–∞)
const cached = localStorage.getItem('cachedClients');
if (cached) {
    clientsDataLocal = JSON.parse(cached);
    // –ù–µ —Ä–∏—Å—É–µ–º —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –Ω–µ –º–æ—Ä–≥–∞–ª–æ, –Ω–æ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –µ—Å—Ç—å
}

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—É–º–º—ã –∫–ª–∏–µ–Ω—Ç–∞
function forceRecalcClient(id) {
    if (!confirm("–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –æ–±—â—É—é —Å—É–º–º—É –ø–æ–∫—É–ø–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–æ–≤?")) return;

    const client = clientsDataLocal[id];
    let newTotal = 0;

    // 1. –°—á–∏—Ç–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é —Å—É–º–º—É –ø–æ –∏—Å—Ç–æ—Ä–∏–∏
    if (client.history) {
        Object.values(client.history).forEach(order => {
            newTotal += parseFloat(order.price) || 0;
        });
    }

    // 2. –û–±–Ω–æ–≤–ª—è–µ–º –≤ –û–±–ª–∞–∫–µ
    db.ref(`clients/${id}/totalSpend`).set(newTotal);
    
    // 3. –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –∏ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
    if (clientsDataLocal[id]) {
        clientsDataLocal[id].totalSpend = newTotal;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ –º–æ–¥–∞–ª–∫–µ (–∫—Ä–∞—Å–∏–≤–æ, —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π)
    const symbol = SYMBOLS[currentCurrency] || '';
    const spendDiv = document.getElementById('clientTotalSpend');
    spendDiv.innerHTML = `–ó–∞–∫–∞–∑–æ–≤ –Ω–∞: <b>${newTotal.toLocaleString()} ${symbol}</b> <span style="color:green;">‚úî</span>`;
    
    // –ß–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É
    setTimeout(() => openClientModal(id), 1000);
}

function recalcAllClientsGlobal() {
    if (!confirm("–≠—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç –∏—Å—Ç–æ—Ä–∏—é –∑–∞–∫–∞–∑–æ–≤ –ö–ê–ñ–î–û–ì–û –∫–ª–∏–µ–Ω—Ç–∞ –∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É –ø–æ–∫—É–ø–æ–∫.\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?")) return;

    let updatedCount = 0;
    const updates = {}; // –û–±—ä–µ–∫—Ç –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Firebase

    // –ü—Ä–æ–±–µ–≥–∞–µ–º –ø–æ –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º
    Object.keys(clientsDataLocal).forEach(id => {
        const client = clientsDataLocal[id];
        let realTotal = 0;

        // –°—á–∏—Ç–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é —Å—É–º–º—É –ø–æ –∏—Å—Ç–æ—Ä–∏–∏
        if (client.history) {
            Object.values(client.history).forEach(order => {
                realTotal += parseFloat(order.price) || 0;
            });
        }

        // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è —Å—É–º–º–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Ä–µ–∞–ª—å–Ω–æ–π
        // (—Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é –¥–æ –∫–æ–ø–µ–µ–∫/—Ç–µ–Ω–≥–µ)
        if (Math.abs((client.totalSpend || 0) - realTotal) > 1) {
            updates['clients/' + id + '/totalSpend'] = realTotal;
            client.totalSpend = realTotal; // –û–±–Ω–æ–≤–ª—è–µ–º –∏ –ª–æ–∫–∞–ª—å–Ω–æ —Å—Ä–∞–∑—É
            updatedCount++;
        }
    });

    if (updatedCount > 0) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ —Ü–µ–ª–∏–∫–æ–º
        saveToCloud('clients', clientsDataLocal);
        renderClientsCloud();
        alert(`‚úÖ –ì–æ—Ç–æ–≤–æ!\n–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Å—É–º–º—ã —É ${updatedCount} –∫–ª–∏–µ–Ω—Ç–æ–≤ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –¢–∞–±–ª–∏—Ü—É).`);
    } else {
        alert("üëå –í—Å—ë –æ—Ç–ª–∏—á–Ω–æ. –û—à–∏–±–æ–∫ –≤ —Å—É–º–º–∞—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.");
    }
}

// --- –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° –ö–ê–õ–ï–ù–î–ê–†–Ø–ú–ò (–í–ï–†–°–ò–Ø 4: –§–ò–ù–ê–ù–°–´ –ò –î–ï–¢–ê–õ–ò) ---
function createCalendarLinks(item) {
    let title, details, location;
    const currency = SYMBOLS[currentCurrency] || '';
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç–∞–≤–∫—É —á–∞—Å–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç
    const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;

    // 1. –ï–°–õ–ò –≠–¢–û –ë–†–û–ù–¨
    if (item.type === 'booking') {
        title = `‚è≥ –ë–†–û–ù–¨: ${item.name}`;
        details = `–°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–µ—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è\n–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞: ${item.price} ${currency}\n–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${item.comment || '–ù–µ—Ç'}\n\n–°–æ–∑–¥–∞–Ω–æ –≤ –ö–æ–Ω–¥–∏—Ç–µ—ÄPRO`;
        location = '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ';
    } 
   
    // 2. –ï–°–õ–ò –≠–¢–û –ó–ê–ö–ê–ó
    else {
        // –î–æ—Å—Ç–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –≤—Å–µ—Ö –Ω–∞—á–∏–Ω–æ–∫ (—É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏)
        let fillingNames = [];
        if (item.data && item.data.tiers) {
            fillingNames = [...new Set(item.data.tiers.map(t => t.recipeName))];
        }
        const fillingStr = fillingNames.length > 0 ? fillingNames.join(' + ') : '–ë–µ–∑ –Ω–∞—á–∏–Ω–∫–∏';
        
        title = `üéÇ ${item.name}, ${fillingStr}, ${item.weight}–∫–≥`;
        
        // --- –ê. –°–û–°–¢–ê–í –¢–û–†–¢–ê (–ì–µ–æ–º–µ—Ç—Ä–∏—è) ---
        let cakeDesc = "";
        if (item.data && item.data.tiers) {
            const shape = item.data.geometry.shape;
            cakeDesc = item.data.tiers.map((t, i) => {
                const d = Math.round(t.d);
                const h = (t.h % 1 === 0) ? t.h : t.h.toFixed(1);
                const w = t.w ? Math.round(t.w) : d;
                let sizeStr = (shape === 'rectangle') ? `${d}x${w}` : ((shape === 'square') ? `${d}x${d}` : `D${d}`);
                return `${i + 1} —è—Ä—É—Å: ${t.recipeName} (${sizeStr}, H${h})`;
            }).join('\n');
        } else {
            cakeDesc = item.desc || '–°–æ—Å—Ç–∞–≤ –Ω–µ —É–∫–∞–∑–∞–Ω';
        }
        if (item.color) cakeDesc += `\nüé® –¶–≤–µ—Ç: ${item.color}`;

        
        // --- –ì. –°–ë–û–†–ö–ê –ò–¢–û–ì–û–í–û–ì–û –¢–ï–ö–°–¢–ê ---
      
        let headerInfo = "";
        if (item.reason) headerInfo += `–ü–æ–≤–æ–¥: ${item.reason}\n`;
        if (item.forWhom) headerInfo += `–ö–æ–º—É: ${item.forWhom}\n`;

        let paymentInfo = item.payment || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        if (item.prepayment) paymentInfo += ` | –ê–≤–∞–Ω—Å: ${parseFloat(item.prepayment).toLocaleString('ru-RU')} ${currency}`;
        if (item.balance) paymentInfo += ` | –û—Å—Ç–∞—Ç–æ–∫: ${parseFloat(item.balance).toLocaleString('ru-RU')} ${currency}`;

        let delivInfo = item.delivery || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        if (item.address) delivInfo += `\nüìç –ê–¥—Ä–µ—Å: ${item.address}`;

        let commentInfo = item.comment ? `\nüìù –ü–æ–∂–µ–ª–∞–Ω–∏–µ: ${item.comment}` : "";
        
        let waLink = "";
        if (item.phone) {
            const cleanPhone = item.phone.replace(/\D/g, ''); // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
            if (cleanPhone) waLink = `\n\nüí¨ –ù–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É –≤ WhatsApp:\nhttps://wa.me/${cleanPhone}`;
        }

       

details = `${headerInfo}\n--- –¢–û–†–¢ ---\n${cakeDesc}\n\n--- –ò–ù–§–û ---\nüí≥ –û–ø–ª–∞—Ç–∞: ${paymentInfo}\nüöö –î–æ—Å—Ç–∞–≤–∫–∞: ${delivInfo}${commentInfo}${waLink}`;        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–¥—Ä–µ—Å –≤ –≥–µ–æ-–º–µ—Ç–∫—É –∫–∞–ª–µ–Ω–¥–∞—Ä—è (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å)
        location = item.address ? item.address : ((item.delivery === '–°–∞–º–æ–≤—ã–≤–æ–∑') ? '–¶–µ—Ö (–î–æ–º–∞)' : '–î–æ—Å—Ç–∞–≤–∫–∞ –∫—É—Ä—å–µ—Ä–æ–º');
    }
    // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç
    let d = item.date;
    if (!d) { const tm = new Date(); tm.setDate(tm.getDate()+1); d = tm.toISOString().split('T')[0]; }
    const dateStr = d.replace(/-/g, ''); 
    const dates = `${dateStr}T100000/${dateStr}T110000`; 

    const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${dates}&details=${encodeURIComponent(details)}&location=${encodeURIComponent(location)}&sf=true&output=xml`;

    const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//CakerPRO//NONSGML v1.0//EN
BEGIN:VEVENT
UID:${item.id}@cakerpro.app
DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z
DTSTART:${dateStr}T100000
DTEND:${dateStr}T110000
SUMMARY:${title}
DESCRIPTION:${details.replace(/\n/g, '\\n')}
LOCATION:${location}
END:VEVENT
END:VCALENDAR`;

    return { googleUrl, icsContent };
}

// –§—É–Ω–∫—Ü–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è ICS (–¥–ª—è iPhone)
function downloadIcs(clientId, orderId) {
    const client = clientsDataLocal[clientId];
    if(!client || !client.history || !client.history[orderId]) return;
    const order = client.history[orderId];
    
    const links = createCalendarLinks(order);
    const blob = new Blob([links.icsContent], { type: 'text/calendar;charset=utf-8' });
    const link = document.createElement('a');
    link.href = window.URL.createObjectURL(blob);
    link.setAttribute('download', `order_${order.name}.ics`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è Google (–¥–ª—è Android/PC)
function openGoogleCal(clientId, orderId) {
    const client = clientsDataLocal[clientId];
    if(!client || !client.history || !client.history[orderId]) return;
    const order = client.history[orderId];
    
    const links = createCalendarLinks(order);
    window.open(links.googleUrl, '_blank');
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è, —á—Ç–æ–±—ã –ø–æ–º–Ω–∏—Ç—å, –∫–∞–∫—É—é –±—Ä–æ–Ω—å –º—ã —Å–µ–π—á–∞—Å "–ø—Ä–µ–≤—Ä–∞—â–∞–µ–º" –≤ –∑–∞–∫–∞–∑
let activeBookingId = null; 

// 1. –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –±—Ä–æ–Ω–∏
// 1. –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –±—Ä–æ–Ω–∏
function openBookingModal() {
    // –ß–∏—Å—Ç–∏–º –ø–æ–ª—è
    document.getElementById('bookingClientSearch').value = '';
    document.getElementById('bookingClientId').value = '';
    document.getElementById('bookingPrepayment').value = '';
    document.getElementById('bookingComment').value = '';
    
    // –î–∞—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –∑–∞–≤—Ç—Ä–∞
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('bookingDate').value = tomorrow.toISOString().split('T')[0];

    // --- –í–ê–ñ–ù–û: –ó–ê–ü–û–õ–ù–Ø–ï–ú –°–ü–ò–°–û–ö –ü–û–î–°–ö–ê–ó–û–ö –î–õ–Ø –ü–û–ò–°–ö–ê ---
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ datalist, —á—Ç–æ –∏ –≤ –∑–∞–∫–∞–∑–∞—Ö, —Ç–∞–∫ –∫–∞–∫ ID –≤ HTML —É –Ω–∏—Ö –æ–±—â–∏–π
    const datalist = document.getElementById('orderClientsDatalist');
    if (datalist) {
        datalist.innerHTML = '';
        Object.keys(clientsDataLocal).forEach(id => {
            const c = clientsDataLocal[id];
            const option = document.createElement('option');
            option.value = c.name;
            option.innerText = `${c.phone || ''} ${c.social || ''}`;
            datalist.appendChild(option);
        });
    }
    // -----------------------------------------------------

    document.getElementById('bookingModal').style.display = 'flex';
}

function handleBookingClientSelection() {
    const nameInput = document.getElementById('bookingClientSearch').value;
    const foundId = Object.keys(clientsDataLocal).find(id => clientsDataLocal[id].name === nameInput);
    document.getElementById('bookingClientId').value = foundId || "";
}

// 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ë—Ä–æ–Ω–∏
async function saveBooking() {
    let clientName = document.getElementById('bookingClientSearch').value.trim();
    let clientId = document.getElementById('bookingClientId').value;
    
    if (!clientName) { alert("–£–∫–∞–∂–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞!"); return; }
  saveToHistory();

    // –ê–≤—Ç–æ-—Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞, –µ—Å–ª–∏ –Ω–æ–≤—ã–π
    if (!clientId) {
        clientId = 'c' + Date.now();
        await db.ref('clients/' + clientId).set({
            name: clientName,
            created: new Date().toISOString(),
            totalSpend: 0
        });
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à –≤—Ä—É—á–Ω—É—é, —á—Ç–æ–±—ã –Ω–µ –∂–¥–∞—Ç—å firebase
        clientsDataLocal[clientId] = { name: clientName, totalSpend: 0 }; 
    }

    const bookingData = {
        id: 'book_' + Date.now(),
        type: 'booking', // –ú–ï–¢–ö–ê: –≠–¢–û –ù–ï –ó–ê–ö–ê–ó, –ê –ë–†–û–ù–¨
        clientId: clientId,
        name: clientName,
        date: document.getElementById('bookingDate').value,
        price: parseFloat(document.getElementById('bookingPrepayment').value) || 0,
        comment: document.getElementById('bookingComment').value,
        status: 'pending'
    };

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ü–ª–∞–Ω
    productionQueue.push(bookingData);
    saveQueue();

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ò—Å—Ç–æ—Ä–∏—é (–æ—Ç–¥–µ–ª—å–Ω–æ –ø–æ–º–µ—á–∞–µ–º)
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ò—Å—Ç–æ—Ä–∏—é –ª–æ–∫–∞–ª—å–Ω–æ + –≤ –æ–±–ª–∞–∫–æ
    if (clientsDataLocal[clientId]) {
        if (!clientsDataLocal[clientId].history) clientsDataLocal[clientId].history = {};
        clientsDataLocal[clientId].history[bookingData.id] = bookingData;
        saveToCloud('clients', clientsDataLocal);
    }

    // ... (–∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Firebase –∏ productionQueue –≤—ã—à–µ) ...

    document.getElementById('bookingModal').style.display = 'none';
    renderQueue();
    
    // --- –ù–û–í–û–ï: –ü–†–ï–î–õ–ê–ì–ê–ï–ú –ö–ê–õ–ï–ù–î–ê–†–¨ ---
    const links = createCalendarLinks(bookingData);
    if(confirm("‚è≥ –î–∞—Ç–∞ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞!\n\n–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ Google –ö–∞–ª–µ–Ω–¥–∞—Ä—å, —á—Ç–æ–±—ã –Ω–µ –∑–∞–±—ã—Ç—å?")) {
        window.open(links.googleUrl, '_blank');
    }
}

// 3. –§—É–Ω–∫—Ü–∏—è: –ü—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ –ë—Ä–æ–Ω–∏ –≤ –ó–∞–∫–∞–∑
function startConvertingBooking(id) {
    // –ù–∞—Ö–æ–¥–∏–º —Å–∞–º—É –±—Ä–æ–Ω—å –ø–æ ID
    const booking = productionQueue.find(item => item.id === id);
    if (!booking) return;

    activeBookingId = booking.id; // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º ID

    switchTab('calc');
    alert(`‚öôÔ∏è –†–µ–∂–∏–º —Å–±–æ—Ä–∫–∏ –∑–∞–∫–∞–∑–∞ –¥–ª—è: ${booking.name}\n\n1. –†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ —Ç–æ—Ä—Ç.\n2. –ù–∞–∂–º–∏—Ç–µ "–í –ø–ª–∞–Ω".\n3. –ë—Ä–æ–Ω—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–º–µ–Ω–∏—Ç—Å—è.`);
}

// --- –§–£–ù–ö–¶–ò–Ø: –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–û–õ–ò–ß–ï–°–¢–í–ê –ó–ê–ú–ï–°–û–í ---
function updateBatchCount(id, val) {
    const item = productionQueue.find(x => x.id === id);
    if (item) {
      saveToHistory();
        let count = parseInt(val);
        if (isNaN(count) || count < 1) count = 1; // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É—Ä–∞–∫–∞
        item.batchCount = count;
        saveQueue(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–º—è—Ç—å
        // –ù–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤–µ—Å—å —Å–ø–∏—Å–æ–∫, —á—Ç–æ–±—ã —Ñ–æ–∫—É—Å –Ω–µ —Å–ª–µ—Ç–µ–ª —Å –ø–æ–ª—è –≤–≤–æ–¥–∞
    }
}

// --- –§–£–ù–ö–¶–ò–Ø: –ó–ê–í–ï–†–®–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê (–°–î–ï–õ–ê–ù–û) ---
// ==========================================
// üèÅ –õ–û–ì–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ò–Ø –ó–ê–ö–ê–ó–ê (–° –§–û–¢–û)
// ==========================================

let finishPhotoBase64 = null;

// 1. –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
function finishOrder(id, clientName) {
    const orderIdx = productionQueue.findIndex(x => x.id === id);
    if (orderIdx === -1) return;

    // –°–±—Ä–æ—Å –ø–æ–ª–µ–π
    document.getElementById('finishOrderId').value = id;
    clearFinishPhoto();
    
    document.getElementById('finishOrderModal').style.display = 'flex';
}

// –•–µ–ª–ø–µ—Ä: –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ
function previewFinishPhoto(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            // –°–∂–∏–º–∞–µ–º —Ñ–æ—Ç–æ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É, —á—Ç–æ –∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏)
            // –£–ø—Ä–æ—â–µ–Ω–Ω–æ –∑–¥–µ—Å—å, –Ω–æ –ª—É—á—à–µ –≤—ã–Ω–µ—Å—Ç–∏ —Å–∂–∞—Ç–∏–µ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
            const img = new Image();
            img.src = e.target.result;
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const MAX_SIZE = 1000; // –ß—É—Ç—å –ª—É—á—à–µ –∫–∞—á–µ—Å—Ç–≤–æ –¥–ª—è –∞—Ä—Ö–∏–≤–∞
                let w = img.width; let h = img.height;
                
                if (w > h) { if (w > MAX_SIZE) { h *= MAX_SIZE/w; w = MAX_SIZE; } }
                else { if (h > MAX_SIZE) { w *= MAX_SIZE/h; h = MAX_SIZE; } }
                
                canvas.width = w; canvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                
                finishPhotoBase64 = canvas.toDataURL('image/jpeg', 0.7);
                
                document.getElementById('finishPhotoPreview').src = finishPhotoBase64;
                document.getElementById('finishPhotoPreview').style.display = 'block';
                document.getElementById('finishPhotoPlaceholder').style.display = 'none';
                document.getElementById('btnDelFinishPhoto').style.display = 'inline-block';
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function clearFinishPhoto() {
    finishPhotoBase64 = null;
    document.getElementById('finishPhotoInput').value = '';
    document.getElementById('finishPhotoPreview').style.display = 'none';
    document.getElementById('finishPhotoPlaceholder').style.display = 'flex';
    document.getElementById('btnDelFinishPhoto').style.display = 'none';
}

// 2. –§–ò–ù–ê–õ–¨–ù–û–ï –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï
async function confirmFinishOrder() {
    const id = document.getElementById('finishOrderId').value;
    const orderIdx = productionQueue.findIndex(x => x.id === id);
    if (orderIdx === -1) return;
    
    const order = productionQueue[orderIdx];
    const btn = document.querySelector('#finishOrderModal .main-btn');

    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
    btn.innerText = "‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
    btn.disabled = true;

    try {
        // –ê. –£–¥–∞–ª—è–µ–º –°–¢–ê–†–´–ô —Ä–µ—Ñ–µ—Ä–µ–Ω—Å —Å –î–∏—Å–∫–∞ (–µ—Å–ª–∏ –æ–Ω —Ç–∞–º –±—ã–ª)
        if (order.refImage && order.refImage.startsWith('DRIVE:')) {
            const oldFileId = order.refImage.split(':')[1];
            apiDeleteFileFromDrive(oldFileId); // –§–æ–Ω–æ–º, –Ω–µ –∂–¥–µ–º
        }
        // –£–¥–∞–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–µ–Ω—Å –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∞
        imageDB.delete(id);

        // –ë. –ó–∞–≥—Ä—É–∂–∞–µ–º –ù–û–í–û–ï —Ñ–æ—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        let resultImageLink = null;
        if (finishPhotoBase64) {
            const fileName = `Result_${order.name}_${order.date}.jpg`;
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞ –¥–∏—Å–∫
            const newFileId = await apiUploadPhotoToDrive(finishPhotoBase64, fileName);
            if (newFileId) {
                resultImageLink = 'DRIVE:' + newFileId;
            }
        }

        // –í. –°–ø–∏—Å–∞–Ω–∏–µ —Å–æ —Å–∫–ª–∞–¥–∞ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É)
        if (order.data && order.data.shoppingList) {
            order.data.shoppingList.forEach(shopItem => {
                const ing = myIngredients.find(i => i.id === shopItem.id);
                if (ing) {
                    const deduction = parseFloat(shopItem.amount);
                    ing.stock = (parseFloat(ing.stock) || 0) - deduction;
                    
                    stockHistory.push({
                        id: 'log_' + Date.now() + Math.random(),
                        date: new Date().toISOString(),
                        type: 'deduction',
                        item: ing.name,
                        diff: `-${deduction} ${ing.unit}`,
                        balance: `${parseFloat(ing.stock.toFixed(2))} ${ing.unit}`,
                        comment: `–ó–∞–∫–∞–∑: ${order.name}`
                    });
                }
            });
        }
        saveIngs();
        saveToCloud('history_stock', stockHistory);

        // –ì. –ê—Ä—Ö–∏–≤–∞—Ü–∏—è
        if (order.clientId && clientsDataLocal[order.clientId]) {
            const completedOrder = {
                ...order,
                completedAt: new Date().toISOString(),
                status: 'completed',
                refImage: resultImageLink // –¢–µ–ø–µ—Ä—å —Ç—É—Ç —Ñ–æ—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞!
            };

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª–∏–µ–Ω—Ç—É
            if (!clientsDataLocal[order.clientId].history) clientsDataLocal[order.clientId].history = {};
            clientsDataLocal[order.clientId].history[order.id] = completedOrder;
            
            // –ü–µ—Ä–µ—Å—á–µ—Ç LTV
            let total = 0;
            Object.values(clientsDataLocal[order.clientId].history).forEach(o => total += (parseFloat(o.price)||0));
            clientsDataLocal[order.clientId].totalSpend = total;

            saveToCloud('clients', clientsDataLocal);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ–±—â–∏–π –ê—Ä—Ö–∏–≤
            if (!Array.isArray(archiveOrders)) archiveOrders = [];
            archiveOrders.push(completedOrder);
            saveToCloud('archive', archiveOrders);
        }

        // –î. –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –æ—á–µ—Ä–µ–¥–∏
        productionQueue.splice(orderIdx, 1);
        saveQueue();
        updateQueueBadge();

        document.getElementById('finishOrderModal').style.display = 'none';
        alert("‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω –≤ –ê—Ä—Ö–∏–≤!");

    } catch (e) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: " + e.message);
    } finally {
        btn.innerText = "‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ê—Ä—Ö–∏–≤";
        btn.disabled = false;
    }
}
// ==========================================
// ü§ñ CRM –ê–°–°–ò–°–¢–ï–ù–¢ –ò –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
// ==========================================

let activeNotifications = [];

// 1. –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ)
function checkCRMEvents(forceUpdate = false) {
    if (!clientsDataLocal) return;

    const today = new Date();
    // –û–±–Ω—É–ª—è–µ–º –≤—Ä–µ–º—è, —á—Ç–æ–±—ã —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–∞—Ç—ã
    today.setHours(0,0,0,0);
    
    const notifs = [];
    const dismissed = JSON.parse(localStorage.getItem('dismissedNotifs') || '[]');

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏: –∑–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—Ç—å?
    const DAYS_AHEAD = 7; 

    Object.values(clientsDataLocal).forEach(client => {
        if (!client.importantDates) return;

        client.importantDates.forEach(evt => {
            if (!evt.date) return;
            
            // –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É —Å–æ–±—ã—Ç–∏—è (YYYY-MM-DD)
            const evtDateParts = evt.date.split('-');
            const evtMonth = parseInt(evtDateParts[1]) - 1; // –ú–µ—Å—è—Ü—ã –≤ JS —Å 0
            const evtDay = parseInt(evtDateParts[2]);

            // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É —Å–æ–±—ã—Ç–∏—è –≤ –¢–ï–ö–£–©–ï–ú –≥–æ–¥—É
            const currentYearEvent = new Date(today.getFullYear(), evtMonth, evtDay);
            
            // –ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ —É–∂–µ –ø—Ä–æ—à–ª–æ –≤ —ç—Ç–æ–º –≥–æ–¥—É, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ "–∑–∞–≤—Ç—Ä–∞" –ª–∏ –æ–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–º (—Ä–µ–¥–∫–∏–π –∫–µ–π—Å –¥–ª—è –¥–µ–∫–∞–±—Ä—è)
            if (currentYearEvent < today) {
                currentYearEvent.setFullYear(today.getFullYear() + 1);
            }

            // –°—á–∏—Ç–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É –≤ –¥–Ω—è—Ö
            const diffTime = currentYearEvent - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            // –õ–û–ì–ò–ö–ê: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å 7 –¥–Ω–µ–π, 3 –¥–Ω—è, 1 –¥–µ–Ω—å –∏–ª–∏ –°–µ–≥–æ–¥–Ω—è (0)
            // –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –¥–∏–∞–ø–∞–∑–æ–Ω "–º–µ–Ω—å—à–µ 8 –¥–Ω–µ–π"
            if (diffDays >= 0 && diffDays <= DAYS_AHEAD) {
                // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–∫—Ä—ã—Ç—å)
                // –°–æ—Å—Ç–æ–∏—Ç –∏–∑ ID –∫–ª–∏–µ–Ω—Ç–∞ + –î–∞—Ç—ã + –ì–æ–¥–∞ (—á—Ç–æ–±—ã –≤ —Å–ª–µ–¥. –≥–æ–¥—É —Å–Ω–æ–≤–∞ –ø–æ–∫–∞–∑–∞–ª–æ—Å—å)
                const notifId = `n_${client.name}_${evt.date}_${today.getFullYear()}`;

                // –ï—Å–ª–∏ —É–∂–µ —Å–∫—Ä—ã—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                if (dismissed.includes(notifId) && !forceUpdate) return;

                let timeText = (diffDays === 0) ? "üî• –°–ï–ì–û–î–ù–Ø!" : (diffDays === 1 ? "–ó–∞–≤—Ç—Ä–∞!" : `–ß–µ—Ä–µ–∑ ${diffDays} –¥–Ω.`);
                let colorClass = (diffDays <= 3) ? "border-left-color: #d32f2f;" : ""; // –ö—Ä–∞—Å–Ω—ã–π, –µ—Å–ª–∏ —Å—Ä–æ—á–Ω–æ

                // –¢–µ–∫—Å—Ç –¥–ª—è WhatsApp
                const waText = `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, ${client.name}! üéÇ\n–£–≤–∏–¥–µ–ª–∞ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ, —á—Ç–æ ${evt.date.split('-').reverse().join('.')} —É –≤–∞—Å –ø—Ä–∞–∑–¥–Ω–∏–∫ (${evt.comment}).\n\n–ú–æ–∂–µ—Ç –±—ã—Ç—å, –∑–∞–±—Ä–æ–Ω–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è —Ç–æ—Ä—Ç–∏–∫–∞, –ø–æ–∫–∞ –µ—Å—Ç—å –º–µ—Å—Ç–∞? üòä`;
                
                notifs.push({
                    id: notifId,
                    title: `üìÖ ${timeText} (${evt.date.split('-').reverse().join('.')})`,
                    text: `<b>${client.name}</b>: ${evt.comment}`,
                    phone: client.phone,
                    waLink: `https://wa.me/${(client.phone||'').replace(/\D/g,'')}?text=${encodeURIComponent(waText)}`,
                    style: colorClass
                });
            }
        });
    });

    activeNotifications = notifs;
    renderNotificationBadge();
    if (document.getElementById('notifPanel').style.display === 'flex') {
        renderNotificationList();
    }
}

// 2. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫—Ä–∞—Å–Ω–æ–≥–æ –∫—Ä—É–∂–æ—á–∫–∞
function renderNotificationBadge() {
    const badge = document.getElementById('notifBadge');
    if (activeNotifications.length > 0) {
        badge.innerText = activeNotifications.length;
        badge.classList.add('show');
    } else {
        badge.classList.remove('show');
    }
}

// 3. –û—Ç–∫—Ä—ã—Ç–∏–µ/–ó–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏
function toggleNotifPanel() {
    const panel = document.getElementById('notifPanel');
    if (panel.style.display === 'flex') {
        panel.style.display = 'none';
    } else {
        panel.style.display = 'flex';
        renderNotificationList();
    }
}

// 4. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –≤–Ω—É—Ç—Ä–∏ –ø–∞–Ω–µ–ª–∏
function renderNotificationList() {
    const c = document.getElementById('notifList');
    c.innerHTML = '';

    if (activeNotifications.length === 0) {
        c.innerHTML = '<div class="notif-empty">üì≠ –ù–µ—Ç –≤–∞–∂–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –Ω–∞ –±–ª–∏–∂–∞–π—à—É—é –Ω–µ–¥–µ–ª—é.<br>–ú–æ–∂–Ω–æ –æ—Ç–¥—ã—Ö–∞—Ç—å!</div>';
        return;
    }

    activeNotifications.forEach(n => {
        let waBtn = '';
        if (n.phone && n.phone.length > 5) {
            waBtn = `<a href="${n.waLink}" target="_blank" class="btn-wa">üìû –ù–∞–ø–∏—Å–∞—Ç—å</a>`;
        }

        c.innerHTML += `
        <div class="notif-card" style="${n.style}">
            <div class="notif-title">${n.title}</div>
            <div class="notif-text">${n.text}</div>
            <div class="notif-actions">
                ${waBtn}
                <div class="btn-dismiss" onclick="dismissNotif('${n.id}')">–û–∫, —Å–∫—Ä—ã—Ç</div>
            </div>
        </div>`;
    });
}

// 5. –°–∫—Ä—ã—Ç–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–≤ "–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ")
// 5. –°–∫—Ä—ã—Ç–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–≤ "–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ")
function dismissNotif(id) {
    const dismissed = JSON.parse(localStorage.getItem('dismissedNotifs') || '[]');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ ID, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
    if (!dismissed.includes(id)) {
        dismissed.push(id);
        localStorage.setItem('dismissedNotifs', JSON.stringify(dismissed));
    }
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í—ã–∑—ã–≤–∞–µ–º –ë–ï–ó –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (false),
    // —á—Ç–æ–±—ã —Å—Ä–∞–±–æ—Ç–∞–ª —Ñ–∏–ª—å—Ç—Ä –∏ —Å–∫—Ä—ã—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏—Å—á–µ–∑–ª–æ
    checkCRMEvents(false); 
}

// –ó–ê–ü–£–°–ö –ü–†–û–í–ï–†–ö–ò (–ß–µ—Ä–µ–∑ 3 —Å–µ–∫ –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞, —á—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ–ª–∏ –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å—Å—è)
setTimeout(checkCRMEvents, 3000);

// –ò –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 60 –º–∏–Ω—É—Ç (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –≤–∏—Å–∏—Ç –æ—Ç–∫—Ä—ã—Ç–æ–π –≤–µ—Å—å –¥–µ–Ω—å)
setInterval(checkCRMEvents, 3600000);

// --- –ó–ê–ö–†–´–¢–ò–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –ü–†–ò –ö–õ–ò–ö–ï –í –ü–£–°–¢–û–¢–£ ---
document.addEventListener('click', function(event) {
    const panel = document.getElementById('notifPanel');
    // –ò—â–µ–º –∫–Ω–æ–ø–∫—É –ø–æ –∫–ª–∞—Å—Å—É –∏–ª–∏ —Ç–µ–≥—É, —Ç–∞–∫ –∫–∞–∫ —É –Ω–µ–µ –Ω–µ—Ç ID, 
    // –Ω–æ –ª—É—á—à–µ –≤—Å–µ–≥–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å—Å—è –∫ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –∫–Ω–æ–ø–∫–∏, —á—Ç–æ–±—ã –Ω–∞–≤–µ—Ä–Ω—è–∫–∞
    const btnContainer = document.querySelector('.fab-container'); 

    // –ï—Å–ª–∏ –ø–∞–Ω–µ–ª—å —Å–µ–π—á–∞—Å –æ—Ç–∫—Ä—ã—Ç–∞
    if (panel && panel.style.display === 'flex') {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –±—ã–ª –ª–∏ –∫–ª–∏–∫ –í–ù–£–¢–†–ò –ø–∞–Ω–µ–ª–∏ –∏–ª–∏ –í–ù–£–¢–†–ò –∫–Ω–æ–ø–∫–∏?
        // –ï—Å–ª–∏ –ù–ï–¢ (–∫–ª–∏–∫—É–ª–∏ –º–∏–º–æ), —Ç–æ —Å–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
        if (!panel.contains(event.target) && !btnContainer.contains(event.target)) {
            panel.style.display = 'none';
        }
    }
});


// –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–∑–æ–≤ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–≤ –∫–æ–Ω–µ—Ü init –∏–ª–∏ updateUI)
loadListSettings();

// --- –ê–ù–ê–õ–ò–¢–ò–ö–ê: –ò–°–¢–û–ß–ù–ò–ö–ò –ö–õ–ò–ï–ù–¢–û–í ---

function openAnalyticsModal() {
    // –°—Ç–∞–≤–∏–º –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü)
    const date = new Date();
    const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
    const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0); // –ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å
    
    document.getElementById('reportStart').value = firstDay.toISOString().split('T')[0];
    document.getElementById('reportEnd').value = lastDay.toISOString().split('T')[0];
    
    document.getElementById('analyticsResults').innerHTML = '<div style="text-align:center; color:#999; padding:20px;">–ù–∞–∂–º–∏—Ç–µ "–ü–æ–∫–∞–∑–∞—Ç—å" –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞</div>';
    document.getElementById('analyticsModal').style.display = 'flex';
}

function generateSourceReport() {
    const startStr = document.getElementById('reportStart').value;
    const endStr = document.getElementById('reportEnd').value;
    
    if (!startStr || !endStr) { alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥!"); return; }

    const startDate = new Date(startStr); startDate.setHours(0,0,0,0);
    const endDate = new Date(endStr); endDate.setHours(23,59,59,999);

    const stats = {};
    let totalNewClients = 0;

    // 1. –ü—Ä–æ–±–µ–≥–∞–µ–º –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º
    Object.values(clientsDataLocal).forEach(c => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è (created)
        if (!c.created) return; // –ï—Å–ª–∏ —Å—Ç–∞—Ä—ã–π –∫–ª–∏–µ–Ω—Ç –±–µ–∑ –¥–∞—Ç—ã, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∏–ª–∏ —Å—á–∏—Ç–∞–µ–º –∫–∞–∫ —Å—Ç–∞—Ä–æ–≥–æ
        
        const createdDate = new Date(c.created);
        
        // –ü–æ–ø–∞–¥–∞–µ—Ç –ª–∏ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω?
        if (createdDate >= startDate && createdDate <= endDate) {
            const source = c.source || "–ù–µ —É–∫–∞–∑–∞–Ω–æ";
            
            if (!stats[source]) stats[source] = 0;
            stats[source]++;
            totalNewClients++;
        }
    });

    // 2. –†–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É
    const container = document.getElementById('analyticsResults');
    
    if (totalNewClients === 0) {
        container.innerHTML = `<div style="text-align:center; padding:20px;">
            <b>–ó–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥ –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</b><br>
            <small style="color:#666;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω.</small>
        </div>`;
        return;
    }

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–æ —É–±—ã–≤–∞–Ω–∏—é (–≥–¥–µ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ)
    const sortedSources = Object.keys(stats).sort((a,b) => stats[b] - stats[a]);

    let html = `<div style="margin-bottom:10px; font-weight:bold;">–í—Å–µ–≥–æ –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤: <span style="color:#FF5722; font-size:18px;">${totalNewClients}</span></div>`;
    
    html += `<table class="analytics-table">
                <thead><tr><th>–ò—Å—Ç–æ—á–Ω–∏–∫</th><th>–ö–æ–ª-–≤–æ</th><th>%</th></tr></thead>
                <tbody>`;
    
    sortedSources.forEach(src => {
        const count = stats[src];
        const percent = Math.round((count / totalNewClients) * 100);
        // –î–ª–∏–Ω–∞ –ø–æ–ª–æ—Å–∫–∏ (–º–∞–∫—Å–∏–º—É–º 100%)
        
        html += `<tr>
                    <td style="width:50%;">
                        <div>${src}</div>
                        <div class="analytics-bar" style="width:${percent}%;"></div>
                    </td>
                    <td style="font-weight:bold; font-size:14px;">${count}</td>
                    <td style="color:#666;">${percent}%</td>
                 </tr>`;
    });

    html += `</tbody></table>`;
    container.innerHTML = html;
}


// --- –ù–ê–°–¢–†–û–ô–ö–ê –°–¢–ê–¢–£–°–û–í ---

// 1. –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã (–µ—Å–ª–∏ –≤—ã –µ—â–µ –Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–ª–∏)
const DEFAULT_STATUSES = [
    { name: "üíé VIP", min: 100000, color: "gold" },
    { name: "ü•à –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π", min: 20000, color: "silver" },
    { name: "ü•â –ù–æ–≤–∏—á–æ–∫", min: 0, color: "bronze" }
];

// –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ü–≤–µ—Ç–∞ (–ø—Ä–µ—Å–µ—Ç—ã —Å—Ç–∏–ª–µ–π)
const STATUS_COLORS = {
    gold:   { bg: '#fff8e1', text: '#ff6f00', border: '#ffb74d' },
    silver: { bg: '#e0f7fa', text: '#006064', border: '#b2ebf2' },
    bronze: { bg: '#fbe9e7', text: '#d84315', border: '#ffccbc' },
    blue:   { bg: '#e3f2fd', text: '#1565C0', border: '#90CAF9' },
    green:  { bg: '#e8f5e9', text: '#2E7D32', border: '#A5D6A7' },
    purple: { bg: '#f3e5f5', text: '#7B1FA2', border: '#CE93D8' },
    red:    { bg: '#ffebee', text: '#c62828', border: '#ef9a9a' }
};

// 2. –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—Ç–∞—Ç—É—Å–æ–≤ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫)
function loadStatusSettings() {
    const raw = localStorage.getItem('cakeClientStatuses');
    const statuses = raw ? JSON.parse(raw) : DEFAULT_STATUSES;
    
    const container = document.getElementById('statusSettingsContainer');
    container.innerHTML = '';

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é —Å—É–º–º—ã, —á—Ç–æ–±—ã –±—ã–ª–æ –∫—Ä–∞—Å–∏–≤–æ
    statuses.sort((a,b) => b.min - a.min).forEach(s => {
        addStatusSettingRow(s.name, s.min, s.color);
    });
}

// 3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
function addStatusSettingRow(name = "", min = 0, color = "bronze") {
    const container = document.getElementById('statusSettingsContainer');
    const div = document.createElement('div');
    div.className = 'status-row';
    div.style.cssText = "display:flex; gap:5px; margin-bottom:5px; align-items:center;";
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–ø—Ü–∏–π —Ü–≤–µ—Ç–æ–≤
    let colorOptions = "";
    for (const [key, val] of Object.entries(STATUS_COLORS)) {
        const sel = (key === color) ? "selected" : "";
        // –ú–∞–ª–µ–Ω—å–∫–∏–π —Ö–∞–∫: –∫—Ä–∞—Å–∏–º —Ñ–æ–Ω –æ–ø—Ü–∏–π –≤ —Å–µ–ª–µ–∫—Ç–µ (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Chrome)
        colorOptions += `<option value="${key}" ${sel} style="background:${val.bg}; color:${val.text};">üé® ${key}</option>`;
    }

    div.innerHTML = `
        <input type="text" class="st-name" value="${name}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (VIP)" style="flex:2;">
        <input type="number" class="st-min" value="${min}" placeholder="–°—É–º–º–∞" style="flex:1;">
        <select class="st-color" style="flex:1.2;">${colorOptions}</select>
        <button class="del-btn" onclick="this.parentElement.remove()">‚úï</button>
    `;
    container.appendChild(div);
}

// 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏")
function saveStatusSettings() {
    const rows = document.querySelectorAll('#statusSettingsContainer .status-row');
    const newStatuses = [];
    
    rows.forEach(r => {
        const name = r.querySelector('.st-name').value.trim();
        const min = parseFloat(r.querySelector('.st-min').value) || 0;
        const color = r.querySelector('.st-color').value;
        
        if (name) {
            newStatuses.push({ name, min, color });
        }
    });
    
    localStorage.setItem('cakeClientStatuses', JSON.stringify(newStatuses));
}

// --- –§–£–ù–ö–¶–ò–Ø –ü–ï–†–í–ò–ß–ù–û–ô –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò ---
function syncAllToCloud() {
    if (!confirm("‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –í–°–ï –ª–∏—Å—Ç—ã –≤ –≤–∞—à–µ–π –ì—É–≥–ª –¢–∞–±–ª–∏—Ü–µ —Ç–µ–∫—É—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —Å —ç–∫—Ä–∞–Ω–∞.")) return;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ –æ—á–µ—Ä–µ–¥–∏
    saveToCloud('ingredients', myIngredients);
    saveToCloud('recipes', myRecipes);
    saveToCloud('labor', myLaborServices);
    saveToCloud('queue', productionQueue);
    saveToCloud('clients', clientsDataLocal);
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    const settingsObj = {
        tax: document.getElementById('finTax').value,
        bank: document.getElementById('finBank').value,
        overhead: document.getElementById('finOverhead').value,
        hourlyRate: document.getElementById('hourlyRate').value
    };
    saveToCloud('settings', settingsObj);

    alert("‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ –¢–∞–±–ª–∏—Ü—É (–ø–æ –ª–∏—Å—Ç–∞–º).");
}


     // ==========================================
// üé® –ú–û–î–£–õ–¨ –ö–û–õ–û–†–ò–°–¢–ò–ö–ò (–≠–¢–ê–ü 1: –ü–ò–ü–ï–¢–ö–ê)
// ==========================================

let colorState = {
    mode: null, 
    ctx: null,
    colors: {
        white: { r: 255, g: 255, b: 255 },       // –ú–æ–π —Å–≤–µ—Ç
        base: { r: 255, g: 250, b: 205 },        // –ú–æ—è –±–∞–∑–∞
        targetWhite: { r: 255, g: 255, b: 255 }, // –°–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ (–ù–û–í–û–ï)
        target: { r: 255, g: 64, b: 129 }        // –¶–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞
    }
};

     // –ü–∞–º—è—Ç—å –≤–∞—à–∏—Ö –∫—Ä–∞—Å–∏—Ç–µ–ª–µ–π
let myColorsPalette = JSON.parse(localStorage.getItem('myColorsPalette')) || [];

function renderPaletteUI() {
    const list = document.getElementById('myPaletteList');
    if (!list) return;
    list.innerHTML = '';
    myColorsPalette.forEach((c, index) => {
        list.innerHTML += `
            <div style="display:flex; align-items:center; background:#f5f5f5; padding:5px 10px; border-radius:20px; font-size:12px; border:1px solid #ddd; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                <div style="width:16px; height:16px; border-radius:50%; background:rgb(${c.rgb.r},${c.rgb.g},${c.rgb.b}); margin-right:8px; border:1px solid #aaa;"></div>
                ${c.name}
                <span style="margin-left:10px; color:#E53935; cursor:pointer; font-size:16px; line-height:1;" onclick="deletePaletteColor(${index})">√ó</span>
            </div>
        `;
    });
}

function deletePaletteColor(index) {
    if(confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫—Ä–∞—Å–∏—Ç–µ–ª—å –∏–∑ –≤–∞—à–∏—Ö –∑–∞–ø–∞—Å–æ–≤?')) {
      saveToHistory();
        myColorsPalette.splice(index, 1);
        localStorage.setItem('myColorsPalette', JSON.stringify(myColorsPalette));
        renderPaletteUI();
    }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç—Ä–∏—Å–æ–≤–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∫—Ä–∞—Å–∏—Ç–µ–ª–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', renderPaletteUI);

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –Ω–∞ —Ö–æ–ª—Å—Ç
function handleColorImage(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.getElementById('colorCanvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —Ö–æ–ª—Å—Ç–∞ –ø–æ–¥ –∫–∞—Ä—Ç–∏–Ω–∫—É, –Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É
            const maxWidth = 800; 
            let width = img.width;
            let height = img.height;

            if (width > maxWidth) {
                height = Math.round(height * (maxWidth / width));
                width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;

            // –†–∏—Å—É–µ–º
            ctx.drawImage(img, 0, 0, width, height);
            colorState.ctx = ctx;
            
            document.getElementById('canvasPlaceholder').style.display = 'none';
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}


// –ê–∫—Ç–∏–≤–∞—Ü–∏—è –Ω—É–∂–Ω–æ–π –ø–∏–ø–µ—Ç–∫–∏
function activatePicker(mode) {
    // –ó–∞—â–∏—Ç–∞: –µ—Å–ª–∏ —Ñ–æ—Ç–æ –µ—â–µ –Ω–µ—Ç, —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞!
    if (!colorState.ctx) {
        document.getElementById('colorImageInput').click();
        return;
    }

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏
    document.querySelectorAll('.color-step-box').forEach(b => b.classList.remove('active-picker'));
    
    colorState.mode = mode;
    
    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –±–ª–æ–∫
    let boxId = mode === 'white' ? 'boxWhite' : (mode === 'base' ? 'boxBase' : (mode === 'targetWhite' ? 'boxTargetWhite' : 'boxTarget'));
    document.getElementById(boxId).classList.add('active-picker');
}

// –°–Ω—è—Ç–∏–µ —Ü–≤–µ—Ç–∞ —Å —Ö–æ–ª—Å—Ç–∞ + –õ–û–ì–ò–ö–ê –õ–£–ü–´ (–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø 60FPS)
document.addEventListener('DOMContentLoaded', () => {
    const mainCanvas = document.getElementById('colorCanvas');
    const cursorDiv = document.getElementById('colorCursor');
    const loupeCanvas = document.getElementById('loupeCanvas');

    if (!mainCanvas || !cursorDiv || !loupeCanvas) return;

    // –£–±—Ä–∞–ª–∏ willReadFrequently, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ
    const loupeCtx = loupeCanvas.getContext('2d'); 
    loupeCtx.imageSmoothingEnabled = false; 

    let isDragging = false;
    let lastEvent = null;
    let rafId = null;
    let cachedRect = null; // –ö–µ—à —Ä–∞–∑–º–µ—Ä–æ–≤ –∫–∞—Ä—Ç–∏–Ω–∫–∏

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–ª–∞–≤–Ω–æ–π –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –ª—É–ø—ã (60 –∫–∞–¥—Ä–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É)
    function renderLoupe() {
        if (!isDragging || !lastEvent || !colorState.ctx || !colorState.mode) return;

        const e = lastEvent;
        const scaleX = mainCanvas.width / cachedRect.width;
        const scaleY = mainCanvas.height / cachedRect.height;
        
        const sourceX = (e.clientX - cachedRect.left) * scaleX;
        const sourceY = (e.clientY - cachedRect.top) * scaleY;

        const loupeWidth = cursorDiv.offsetWidth;
        const loupeHeight = cursorDiv.offsetHeight;
        
        let posX = e.clientX - cachedRect.left - (loupeWidth / 2);
        let posY = e.clientY - cachedRect.top - loupeHeight - 40; 

        // –ó–∞—â–∏—Ç–∞ –æ—Ç –≤—ã–ª–µ—Ç–∞ –∑–∞ –∫—Ä–∞—è
        if (posY < 0) posY = e.clientY - cachedRect.top + 40; 
        if (posX < 0) posX = 0;
        if (posX > cachedRect.width - loupeWidth) posX = cachedRect.width - loupeWidth;

        // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø 1: –î–≤–∏–≥–∞–µ–º –ª—É–ø—É —á–µ—Ä–µ–∑ –≤–∏–¥–µ–æ–∫–∞—Ä—Ç—É (transform), –∞ –Ω–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä (left/top)
        cursorDiv.style.transform = `translate3d(${posX}px, ${posY}px, 0)`;

        const zoomLevel = 5;
        const sourceSize = loupeCanvas.width / zoomLevel; 

        // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø 2: –†–∏—Å—É–µ–º –ª—É–ø—É
        loupeCtx.clearRect(0, 0, loupeCanvas.width, loupeCanvas.height);
        loupeCtx.drawImage(
            mainCanvas,                                     
            sourceX - sourceSize / 2, sourceY - sourceSize / 2, 
            sourceSize, sourceSize,                         
            0, 0,                                           
            loupeCanvas.width, loupeCanvas.height           
        );

        loupeCtx.fillStyle = 'rgba(255, 50, 50, 0.8)';
        const centerX = loupeCanvas.width / 2;
        const centerY = loupeCanvas.height / 2;
        loupeCtx.fillRect(centerX - 1, centerY - 4, 2, 8); 
        loupeCtx.fillRect(centerX - 4, centerY - 1, 8, 2); 

        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä —É –±—Ä–∞—É–∑–µ—Ä–∞
        rafId = requestAnimationFrame(renderLoupe);
    }

    // 1. –ö–ê–°–ê–ù–ò–ï –≠–ö–†–ê–ù–ê (–í–∫–ª—é—á–∞–µ–º –ª—É–ø—É)
    mainCanvas.addEventListener('pointerdown', function(e) {
        if (!colorState.ctx) {
            document.getElementById('colorImageInput').click();
            return;
        }
        if (!colorState.mode) return;
        
        // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø 3: –°—á–∏—Ç–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã —Ö–æ–ª—Å—Ç–∞ –û–î–ò–ù —Ä–∞–∑ –ø—Ä–∏ –∫–∞—Å–∞–Ω–∏–∏
        cachedRect = mainCanvas.getBoundingClientRect();
        
        isDragging = true;
        lastEvent = e;
        cursorDiv.style.display = 'block';
        
        // –û–±–Ω—É–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, —á—Ç–æ–±—ã transform —Ä–∞–±–æ—Ç–∞–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
        cursorDiv.style.left = '0px';
        cursorDiv.style.top = '0px';

        renderLoupe(); // –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ—Ç–æ—Ä—á–∏–∫ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
        mainCanvas.setPointerCapture(e.pointerId);
    });

    // 2. –í–ï–î–ï–ù–ò–ï –ü–ê–õ–¨–¶–ï–ú (–ü—Ä–æ—Å—Ç–æ –∑–∞–ø–æ–º–∏–Ω–∞–µ–º, –≥–¥–µ —Å–µ–π—á–∞—Å –ø–∞–ª–µ—Ü)
    mainCanvas.addEventListener('pointermove', function(e) {
        if (!isDragging) return;
        lastEvent = e; // –î–≤–∏–∂–æ–∫ renderLoupe —Å–∞–º –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç —ç—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Å–ª–µ–¥—É—é—â–µ–º –∫–∞–¥—Ä–µ
    });

    // 3. –û–¢–ü–£–°–ö–ê–ù–ò–ï –ü–ê–õ–¨–¶–ê (–°–Ω–∏–º–∞–µ–º —Ü–≤–µ—Ç)
    mainCanvas.addEventListener('pointerup', function(e) {
        if (!isDragging) return;
        
        isDragging = false;
        cancelAnimationFrame(rafId); // –ì–ª—É—à–∏–º –º–æ—Ç–æ—Ä—á–∏–∫ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏

        if (!colorState.ctx || !colorState.mode || !cachedRect) return;

        const scaleX = mainCanvas.width / cachedRect.width;
        const scaleY = mainCanvas.height / cachedRect.height;
        const sourceX = (e.clientX - cachedRect.left) * scaleX;
        const sourceY = (e.clientY - cachedRect.top) * scaleY;

        // –ë–µ—Ä–µ–º —Ü–≤–µ—Ç
        // --- –£–ú–ù–û–ï –£–°–†–ï–î–ù–ï–ù–ò–ï (5—Ö5 –ü–ò–ö–°–ï–õ–ï–ô) ---
        const sampleSize = 5; // –ö–≤–∞–¥—Ä–∞—Ç 5—Ö5 –ø–∏–∫—Å–µ–ª–µ–π –≤–æ–∫—Ä—É–≥ —Ü–µ–Ω—Ç—Ä–∞
        const halfSize = Math.floor(sampleSize / 2);
        
        // –í—ã—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —É–≥–ª–∞, –Ω–µ –¥–∞–≤–∞—è –∏–º –≤—ã–π—Ç–∏ –∑–∞ –∫—Ä–∞—è —Ñ–æ—Ç–æ
        const startX = Math.max(0, Math.floor(sourceX) - halfSize);
        const startY = Math.max(0, Math.floor(sourceY) - halfSize);
        
        // –ë–µ—Ä–µ–º —Å—Ä–∞–∑—É 25 –ø–∏–∫—Å–µ–ª–µ–π
        const imgData = colorState.ctx.getImageData(startX, startY, sampleSize, sampleSize).data;
        
        let sumR = 0, sumG = 0, sumB = 0, count = 0;
        
        // –°–∫–ª–∞–¥—ã–≤–∞–µ–º –∏—Ö —Ü–≤–µ—Ç–∞ –≤–º–µ—Å—Ç–µ
        for (let i = 0; i < imgData.length; i += 4) {
            sumR += imgData[i];
            sumG += imgData[i + 1];
            sumB += imgData[i + 2];
            count++;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º —Å—Ä–µ–¥–Ω–∏–π –∏–¥–µ–∞–ª—å–Ω—ã–π –æ—Ç—Ç–µ–Ω–æ–∫
        const rgb = { 
            r: Math.round(sumR / count), 
            g: Math.round(sumG / count), 
            b: Math.round(sumB / count) 
        };
        // ---------------------------------------

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º
        colorState.colors[colorState.mode] = rgb;

        // –ö—Ä–∞—Å–∏–º –ø–ª–∞—à–∫—É
        // --- –õ–û–ì–ò–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø –í –ü–ê–õ–ò–¢–†–£ ---
       // --- –õ–û–ì–ò–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø –í –ü–ê–õ–ò–¢–†–£ (–° –ë–ê–õ–ê–ù–°–û–ú –ë–ï–õ–û–ì–û) ---
        if (colorState.mode === 'palette') {
            cursorDiv.style.display = 'none';
            mainCanvas.releasePointerCapture(e.pointerId);
            
            // 1. –ë–µ—Ä–µ–º —Ç–µ–∫—É—â–∏–π —ç—Ç–∞–ª–æ–Ω –±–µ–ª–æ–≥–æ (–∫–æ—Ç–æ—Ä—ã–π –∑–∞–¥–∞–Ω –≤ –®–∞–≥–µ 1)
            const wb = colorState.colors.white || {r: 255, g: 255, b: 255};
            
            // 2. –°—á–∏—Ç–∞–µ–º, –∫–∞–∫ –æ—á–∏—Å—Ç–∏—Ç—å —Ü–≤–µ—Ç (–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏)
            const factor = {
                r: 255 / (wb.r || 255),
                g: 255 / (wb.g || 255),
                b: 255 / (wb.b || 255)
            };

            // 3. –ü–æ–ª—É—á–∞–µ–º "–ß–∏—Å—Ç—ã–π" —Ü–≤–µ—Ç (True Color)
            const cleanRgb = {
                r: Math.min(255, Math.round(rgb.r * factor.r)),
                g: Math.min(255, Math.round(rgb.g * factor.g)),
                b: Math.min(255, Math.round(rgb.b * factor.b))
            };

            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
            setTimeout(() => {
                let name = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫—Ä–∞—Å–∏—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'Kreda –ü—ã–ª—å–Ω–∞—è —Ä–æ–∑–∞'):");
                if (name && name.trim() !== '') {
                    saveToHistory(); 
                    // –°–û–•–†–ê–ù–Ø–ï–ú –ò–ú–ï–ù–ù–û cleanRgb, –ê –ù–ï –ü–†–û–°–¢–û rgb
                    myColorsPalette.push({ id: Date.now(), name: name.trim(), rgb: cleanRgb });
                    localStorage.setItem('myColorsPalette', JSON.stringify(myColorsPalette));
                    renderPaletteUI();
                }
                colorState.mode = null;
            }, 50);
            return; 
        }
saveToHistory();
        // --- –û–ë–´–ß–ù–ê–Ø –õ–û–ì–ò–ö–ê (–ï—Å–ª–∏ –≤—ã–±—Ä–∞–ª–∏ –°–≤–µ—Ç, –ë–∞–∑—É –∏–ª–∏ –¶–µ–ª—å) ---
        let patchId = colorState.mode === 'white' ? 'patchWhite' : (colorState.mode === 'base' ? 'patchBase' : (colorState.mode === 'targetWhite' ? 'patchTargetWhite' : 'patchTarget'));
        
        // –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ id –Ω–µ —Å–æ–≤–ø–∞–ª
        let patchEl = document.getElementById(patchId);
        if (patchEl) patchEl.style.background = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
        
        cursorDiv.style.display = 'none';
        colorState.mode = null;
        document.querySelectorAll('.color-step-box').forEach(b => b.classList.remove('active-picker'));
        
        mainCanvas.releasePointerCapture(e.pointerId);
    });

    // –ï—Å–ª–∏ –ø–∞–ª–µ—Ü —É—à–µ–ª –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —ç–∫—Ä–∞–Ω–∞
    mainCanvas.addEventListener('pointerleave', function() {
        if (isDragging) {
            isDragging = false;
            cancelAnimationFrame(rafId);
            cursorDiv.style.display = 'none';
        }
    });
});

// –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –≠—Ç–∞–ø–∞ 2
// ==========================================
// üß™ –ú–û–î–£–õ–¨ –ö–û–õ–û–†–ò–°–¢–ò–ö–ò (–≠–¢–ê–ü 2: –†–ê–°–ß–ï–¢ –ü–†–û–ü–û–†–¶–ò–ô)
// ==========================================
function calculateMix() {
    if (!colorState.colors.base || !colorState.colors.target) {
        alert("‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –ë–∞–∑—É (–≤–∞—à –∫—Ä–µ–º) –∏ –¶–µ–ª—å (—Ü–≤–µ—Ç –Ω–∞ —Ñ–æ—Ç–æ)!");
        return;
    }

    // –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –±–∞–ª–∞–Ω—Å—ã –±–µ–ª–æ–≥–æ
    let wbBase = colorState.colors.white || {r: 255, g: 255, b: 255};
    let wbTarget = colorState.colors.targetWhite || {r: 255, g: 255, b: 255};
    let base = colorState.colors.base;
    let target = colorState.colors.target;

    // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ —Å–≤–µ—Ç–∞
    const getWbFactor = (wb) => ({
        r: 255 / (wb.r || 255),
        g: 255 / (wb.g || 255),
        b: 255 / (wb.b || 255)
    });

    const factorBase = getWbFactor(wbBase);
    const factorTarget = getWbFactor(wbTarget);

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞
    const fixRGB = (c, factor) => ({
        r: Math.min(255, Math.round(c.r * factor.r)),
        g: Math.min(255, Math.round(c.g * factor.g)),
        b: Math.min(255, Math.round(c.b * factor.b))
    });

    // 1. –ö–û–†–†–ï–ö–¶–ò–Ø (–ö–∞–∂–¥—ã–π —Ü–≤–µ—Ç –ø—Ä–∞–≤–∏—Ç—Å—è –ø–æ –°–í–û–ï–ú–£ —Å–≤–µ—Ç—É)
    let fixedBase = fixRGB(base, factorBase);
    let fixedTarget = fixRGB(target, factorTarget);

   

    // 2. –ü–ï–†–ï–í–û–î RGB –í CMYK (–§–æ—Ä–º–∞—Ç –∫—Ä–∞—Å–æ–∫)
    const rgbToCmyk = (c) => {
        let r = c.r / 255, g = c.g / 255, b = c.b / 255;
        let k = 1 - Math.max(r, g, b);
        if (k === 1) return { c: 0, m: 0, y: 0, k: 1 };
        return {
            c: (1 - r - k) / (1 - k),
            m: (1 - g - k) / (1 - k),
            y: (1 - b - k) / (1 - k),
            k: k
        };
    };

    let baseCmyk = rgbToCmyk(fixedBase);
    let targetCmyk = rgbToCmyk(fixedTarget);

    // 3. –°–ß–ò–¢–ê–ï–ú –†–ê–ó–ù–ò–¶–£ (–ß—Ç–æ –Ω—É–∂–Ω–æ –î–û–ë–ê–í–ò–¢–¨)
    let diff = {
        c: targetCmyk.c - baseCmyk.c,
        m: targetCmyk.m - baseCmyk.m,
        y: targetCmyk.y - baseCmyk.y,
        k: targetCmyk.k - baseCmyk.k
    };

    // 4. –§–û–†–ú–ò–†–£–ï–ú –†–ï–¶–ï–ü–¢
    let recipe = [];
    let warnings = [];

    // –ë–∞–∑–æ–≤—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å –¥–ª—è "–∫–∞–ø–µ–ª—å –Ω–∞ 100–≥" (–ú–æ–∂–Ω–æ –∫–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å –ø–æ–¥ –≤–∞—à–∏ –∫—Ä–∞—Å–∏—Ç–µ–ª–∏)
    const intensity = 20; 

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ï—Å–ª–∏ —Ü–µ–ª—å —Å–≤–µ—Ç–ª–µ–µ/—á–∏—â–µ, —á–µ–º –Ω–∞—à–∞ –∂–∏—Ä–Ω–∞—è –±–∞–∑–∞
    if (targetCmyk.k < baseCmyk.k - 0.05 || (diff.c < 0 && diff.m < 0 && diff.y < 0)) {
        warnings.push("‚ö†Ô∏è <b>–¶–µ–ª—å —Å–≤–µ—Ç–ª–µ–µ –≤–∞—à–µ–π –±–∞–∑—ã!</b><br>–í–∞–º –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å <b>–î–∏–æ–∫—Å–∏–¥ —Ç–∏—Ç–∞–Ω–∞</b> (–±–µ–ª—ã–π), —á—Ç–æ–±—ã –≤—ã—Å–≤–µ—Ç–ª–∏—Ç—å –∫—Ä–µ–º, –∏–Ω–∞—á–µ –Ω—É–∂–Ω–æ–π —è—Ä–∫–æ—Å—Ç–∏ –Ω–µ –¥–æ–±–∏—Ç—å—Å—è.");
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –ï—Å–ª–∏ –±–∞–∑–∞ –∂–µ–ª—Ç–∏—Ç (–º–∞—Å–ª–æ), –∞ –Ω–∞–º –Ω—É–∂–µ–Ω —Ö–æ–ª–æ–¥–Ω—ã–π –æ—Ç—Ç–µ–Ω–æ–∫ (—Å–∏–Ω–∏–π/—Ä–æ–∑–æ–≤—ã–π)
    if (baseCmyk.y > 0.15 && targetCmyk.y < 0.1 && diff.b > 0) {
         warnings.push("‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∂–µ–ª—Ç–∏–∑–Ω—É!</b><br>–í–∞—à –∫—Ä–µ–º –∂–µ–ª—Ç–æ–≤–∞—Ç. –ü–µ—Ä–µ–¥ –æ–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ–º –¥–æ–±–∞–≤—å—Ç–µ 1-2 –∫–∞–ø–ª–∏ <b>–§–∏–æ–ª–µ—Ç–æ–≤–æ–≥–æ</b> (–ö—Ä–∞—Å–Ω—ã–π+–°–∏–Ω–∏–π), —á—Ç–æ–±—ã –µ–≥–æ –æ—Ç–±–µ–ª–∏—Ç—å (–Ω–µ–π—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å). –ò–Ω–∞—á–µ –≤–º–µ—Å—Ç–æ –≥–æ–ª—É–±–æ–≥–æ –ø–æ–ª—É—á–∏—Ç–µ –∑–µ–ª–µ–Ω—ã–π.");
    }

    // –°–æ—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –∫—Ä–∞—Å–∏—Ç–µ–ª–µ–π (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
    if (diff.c > 0.02) recipe.push(`üîµ <b>–°–∏–Ω–∏–π (–ì–æ–ª—É–±–æ–π):</b> ~${Math.ceil(diff.c * intensity)} —á.`);
    if (diff.m > 0.02) recipe.push(`üî¥ <b>–ö—Ä–∞—Å–Ω—ã–π (–ú–∞–ª–∏–Ω–æ–≤—ã–π):</b> ~${Math.ceil(diff.m * intensity)} —á.`);
    if (diff.y > 0.02) recipe.push(`üü° <b>–ñ–µ–ª—Ç—ã–π:</b> ~${Math.ceil(diff.y * intensity)} —á.`);
    if (diff.k > 0.02) recipe.push(`‚ö´ <b>–ß–µ—Ä–Ω—ã–π:</b> ~${Math.ceil(diff.k * intensity)} —á.`);

    // 5. –í–´–í–û–î –ù–ê –≠–ö–†–ê–ù
    let html = '';
    if (warnings.length > 0) {
        html += `<div style="background:#FFF3E0; padding:10px; border-left:4px solid #FF9800; border-radius:4px; margin-bottom:15px; font-size:13px; color:#E65100;">${warnings.join('<br><br>')}</div>`;
    }

    if (recipe.length > 0) {
        html += `<div style="font-size:15px; line-height:1.6; color:#333; background:#fff; padding:15px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                    <b>üé® –ù–∞ 100–≥ –∫—Ä–µ–º–∞:</b><br><br>
                    ${recipe.join('<br>')}
                 </div>`;
        html += `<div style="font-size:11px; color:#888; margin-top:10px; text-align:center;">* –î–æ–±–∞–≤–ª—è–π—Ç–µ –ø–æ –æ–¥–Ω–æ–π –º–∞–ª–µ–Ω—å–∫–æ–π –∫–∞–ø–µ–ª—å–∫–µ –∏ –≤—ã–º–µ—à–∏–≤–∞–π—Ç–µ. –°–∏–ª–∞ –ø–∏–≥–º–µ–Ω—Ç–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –±—Ä–µ–Ω–¥–∞ –∫—Ä–∞—Å–∏—Ç–µ–ª—è.</div>`;
    } else if (warnings.length === 0) {
        html += `<div style="color:#2E7D32; font-weight:bold; text-align:center; padding:10px;">–¶–≤–µ—Ç–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç! –ö—Ä–∞—Å–∏—Ç–µ–ª—å –Ω–µ –Ω—É–∂–µ–Ω.</div>`;
    }
// --- –ü–û–ò–°–ö –ü–û –ú–û–ï–ô –ü–ê–õ–ò–¢–†–ï (–£–ú–ù–´–ô –°–ö–ê–ù–ï–†) ---
    if (myColorsPalette.length > 0) {
        let bestMatch = null;
        let minDistance = Infinity;
        
        myColorsPalette.forEach(c => {
            // –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è –º–µ–∂–¥—É —Ü–≤–µ—Ç–∞–º–∏ –≤ 3D-–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ RGB
            // –ò—â–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å fixedTarget (—Ü–≤–µ—Ç–æ–º –∫–ª–∏–µ–Ω—Ç–∞, –æ—á–∏—â–µ–Ω–Ω—ã–º –æ—Ç –∏—Å–∫–∞–∂–µ–Ω–∏–π —Å–≤–µ—Ç–∞)
            let dist = Math.sqrt(Math.pow(c.rgb.r - fixedTarget.r, 2) + Math.pow(c.rgb.g - fixedTarget.g, 2) + Math.pow(c.rgb.b - fixedTarget.b, 2));
            if (dist < minDistance) {
                minDistance = dist;
                bestMatch = c;
            }
        });

        // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è –≤ RGB = 441.67. –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ –ø—Ä–æ—Ü–µ–Ω—Ç—ã —Å—Ö–æ–¥—Å—Ç–≤–∞
        let matchPercent = Math.max(0, 100 - (minDistance / 441.67 * 100)).toFixed(1);

        html += `
            <div style="margin-top:15px; padding:15px; background:#E3F2FD; border-radius:6px; border:1px solid #BBDEFB; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                <h4 style="margin:0 0 10px 0; color:#1565C0;">üì¶ –í –≤–∞—à–∏—Ö –∑–∞–ø–∞—Å–∞—Ö:</h4>
                <div style="display:flex; align-items:center; font-size:15px;">
                    <div style="width:30px; height:30px; border-radius:50%; background:rgb(${bestMatch.rgb.r},${bestMatch.rgb.g},${bestMatch.rgb.b}); margin-right:12px; border:2px solid #fff; box-shadow:0 0 3px rgba(0,0,0,0.3);"></div>
                    <div style="line-height:1.4;">–ë–ª–∏–∂–∞–π—à–∏–π —Ü–≤–µ—Ç: <b>${bestMatch.name}</b><br>
                    <span style="font-size:13px; color:#555;">–¢–æ—á–Ω–æ—Å—Ç—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è: <b>${matchPercent}%</b></span></div>
                </div>
            </div>
        `;
    }
    document.getElementById('colorResultText').innerHTML = html;
    document.getElementById('colorResultBlock').style.display = 'block';
    
    // –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
    document.getElementById('colorResultBlock').scrollIntoView({behavior: 'smooth', block: 'center'});
}

// --- –õ–û–ì–ò–ö–ê –°–ö–õ–ê–î–ê ---

// 1. –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏
function toggleInventoryMode() {
    isInventoryMode = !isInventoryMode;
    const btn = document.getElementById('btnInventoryToggle');
    
    if (isInventoryMode) {
        btn.innerText = "üî¥ –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è (–í–ö–õ)";
        btn.style.background = "#ffebee";
        btn.style.color = "#d32f2f";
        btn.style.borderColor = "#d32f2f";
        alert("‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ!\n\n–í—ã –≤–∫–ª—é—á–∏–ª–∏ —Ä–µ–∂–∏–º —Ä—É—á–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤.\n–õ—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–∏—Ñ—Ä—ã –≤ –∫–æ–ª–æ–Ω–∫–µ '–û—Å—Ç–∞—Ç–æ–∫' —Å—Ä–∞–∑—É –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –¥–∞–Ω–Ω—ã–µ.\n\n–ù–µ –∑–∞–±—É–¥—å—Ç–µ –≤—ã–∫–ª—é—á–∏—Ç—å —ç—Ç–æ—Ç —Ä–µ–∂–∏–º –ø–æ—Å–ª–µ –ø—Ä–∞–≤–∫–∏!");
    } else {
        btn.innerText = "üîò –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è (–í—ã–∫–ª)";
        btn.style.background = "#fff";
        btn.style.color = "#555";
        btn.style.borderColor = "#ccc";
    }
    renderStockTable();
}

// --- –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ú–û–î–£–õ–¨ –ó–ê–ö–£–ü–ê (–°–ü–ò–°–ö–û–ú) ---

// 1. –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞
function openProcurementModal() {
    procurementDraft = []; // –û—á–∏—â–∞–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏

    // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º HTML –º–æ–¥–∞–ª–∫–∏ (—á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É)
    const existingModal = document.getElementById('procurementModal');
    if (existingModal) existingModal.remove();

    const div = document.createElement('div');
    div.id = 'procurementModal';
    div.className = 'modal-overlay';
    div.innerHTML = `
    <div class="modal-box" style="width:600px; max-width:95%; height:80vh; display:flex; flex-direction:column;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">üõí –ü—Ä–∏—Ö–æ–¥ —Ç–æ–≤–∞—Ä–∞ (–ù–∞–∫–ª–∞–¥–Ω–∞—è)</h3>
            <button class="del-btn" onclick="document.getElementById('procurementModal').style.display='none'">√ó</button>
        </div>

        <div style="background:#e8f5e9; padding:15px; border-radius:8px; border:1px solid #c8e6c9; flex-shrink:0;">
            <div class="form-group" style="margin-bottom:10px;">
                <span class="form-label">üîç –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞</span>
                <input id="procureSearch" list="allIngsDatalist" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ..." style="font-weight:bold;" onchange="fillProcureInputs()">
            </div>
            
            <div class="form-row" style="align-items:flex-end;">
                <div class="form-group" style="flex:1;">
                    <span class="form-label">–ö–æ–ª-–≤–æ (<span id="procureUnitLabel">–µ–¥</span>)</span>
                    <input type="number" id="procureAmount" placeholder="–°–∫–æ–ª—å–∫–æ?">
                </div>
                <div class="form-group" style="flex:1;">
                    <span class="form-label">–¶–µ–Ω–∞ –∑–∞ –ø–∞—á–∫—É</span>
                    <input type="number" id="procurePrice" placeholder="–¶–µ–Ω–∞">
                </div>
                <button class="add-btn-small" onclick="addToProcurementDraft()" style="background:#2E7D32; height:36px; padding:0 20px;">‚¨áÔ∏è –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <div style="font-size:11px; color:#666; margin-top:5px;">
                –¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: <b id="procureCurrentStock">‚Äî</b>
            </div>
        </div>

        <div style="flex:1; overflow-y:auto; margin-top:15px; border:1px solid #eee; border-radius:6px;">
            <table class="stock-table">
                <thead style="position:sticky; top:0; background:#fff; z-index:1;">
                    <tr>
                        <th>–¢–æ–≤–∞—Ä</th>
                        <th>–ü—Ä–∏—Ö–æ–¥</th>
                        <th>–¶–µ–Ω–∞</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="procurementDraftList">
                    <tr><td colspan="4" style="text-align:center; color:#999; padding:20px;">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</td></tr>
                </tbody>
            </table>
        </div>

        <div class="modal-actions" style="margin-top:15px; border-top:1px solid #eee; padding-top:15px; justify-content:space-between; align-items:center;">
            <div style="font-size:14px; color:#555;">–ü–æ–∑–∏—Ü–∏–π: <b id="draftCount">0</b></div>
            <button class="main-btn" onclick="commitProcurement()" style="background:#FF9800; width:auto; padding:10px 30px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë –Ω–∞ —Å–∫–ª–∞–¥</button>
        </div>
    </div>`;
    
    document.body.appendChild(div);
    document.getElementById('procurementModal').style.display = 'flex';
    document.getElementById('procureSearch').focus();
}

// 2. –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–æ–≤–∞—Ä–∞
function fillProcureInputs() {
    const name = document.getElementById('procureSearch').value;
    const ing = myIngredients.find(i => i.name === name);
    
    if (ing) {
        document.getElementById('procureUnitLabel').innerText = ing.unit;
        document.getElementById('procurePrice').value = ing.packPrice; // –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Ü–µ–Ω—É
        document.getElementById('procureCurrentStock').innerText = `${ing.stock || 0} ${ing.unit}`;
        
        // –§–æ–∫—É—Å —Å—Ä–∞–∑—É –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤–≤–æ–¥–∞
        document.getElementById('procureAmount').focus();
    } else {
        document.getElementById('procureUnitLabel').innerText = '–µ–¥';
        document.getElementById('procureCurrentStock').innerText = '‚Äî';
    }
}

// 3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ —á–µ—Ä–Ω–æ–≤–∏–∫ (–í —Å–ø–∏—Å–æ–∫)
function addToProcurementDraft() {
    const nameInput = document.getElementById('procureSearch');
    const amountInput = document.getElementById('procureAmount');
    const priceInput = document.getElementById('procurePrice');

    const name = nameInput.value;
    const amount = parseFloat(amountInput.value);
    const price = parseFloat(priceInput.value);

    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    const ing = myIngredients.find(i => i.name === name);
    if (!ing) { alert("–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ! –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –Ω–∞ —Å–∫–ª–∞–¥–µ."); return; }
    if (isNaN(amount) || amount <= 0) { alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ!"); return; }

    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤
    procurementDraft.push({
        id: ing.id,
        name: ing.name,
        unit: ing.unit,
        addAmount: amount,
        newPrice: price,
        oldPrice: ing.packPrice,
        oldStock: ing.stock || 0
    });

    // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–≤–æ–¥–∞
    nameInput.value = '';
    amountInput.value = '';
    priceInput.value = '';
    document.getElementById('procureCurrentStock').innerText = '‚Äî';
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–∏—Å–∫ (—á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ —Å–æ —Å–∫–∞–Ω–µ—Ä–æ–º)
    nameInput.focus();

    renderProcurementDraft();
}

// 4. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–∞
function renderProcurementDraft() {
    const c = document.getElementById('procurementDraftList');
    c.innerHTML = '';

    if (procurementDraft.length === 0) {
        c.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999; padding:20px;">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</td></tr>';
        document.getElementById('draftCount').innerText = '0';
        return;
    }

    // –†–∏—Å—É–µ–º —Å—Ç—Ä–æ–∫–∏ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
    // .slice().reverse() –¥–µ–ª–∞–µ—Ç –∫–æ–ø–∏—é –∏ –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    procurementDraft.slice().reverse().forEach((item, idx) => {
        // –†–µ–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º –º–∞—Å—Å–∏–≤–µ (–¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è)
        const realIdx = procurementDraft.length - 1 - idx; 
        
        let priceInfo = item.newPrice;
        if (item.newPrice !== item.oldPrice) {
            priceInfo = `<span style="color:#d32f2f; text-decoration:line-through; font-size:11px;">${item.oldPrice}</span> <b>${item.newPrice}</b>`;
        }

        c.innerHTML += `
        <tr>
            <td>${item.name}</td>
            <td style="color:#2E7D32; font-weight:bold;">+${item.addAmount} ${item.unit}</td>
            <td>${priceInfo}</td>
            <td><button class="del-btn" onclick="removeFromDraft(${realIdx})">‚úï</button></td>
        </tr>`;
    });

    document.getElementById('draftCount').innerText = procurementDraft.length;
}

function removeFromDraft(idx) {
    procurementDraft.splice(idx, 1);
    renderProcurementDraft();
}

// 5. –§–ò–ù–ê–õ–¨–ù–û–ï –°–û–•–†–ê–ù–ï–ù–ò–ï (COMMIT)
function commitProcurement() {
    if (procurementDraft.length === 0) return;

    if (!confirm(`–ü—Ä–æ–≤–µ—Å—Ç–∏ –ø—Ä–∏—Ö–æ–¥ –ø–æ ${procurementDraft.length} –ø–æ–∑–∏—Ü–∏—è–º?`)) return;
  saveToHistory();

    // 1. –ü—Ä–æ–±–µ–≥–∞–µ–º –ø–æ —á–µ—Ä–Ω–æ–≤–∏–∫—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    procurementDraft.forEach(item => {
        const ing = myIngredients.find(i => i.id === item.id);
        if (ing) {
            // --- –°–õ–û–ñ–ï–ù–ò–ï –ß–ò–°–ï–õ (–∑–∞—â–∏—Ç–∞ –æ—Ç "10001000") ---
            const current = parseFloat(ing.stock) || 0; 
            const added = parseFloat(item.addAmount);   
            
            ing.stock = current + added; 
            // ------------------------------------------
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É (–µ—Å–ª–∏ –≤–≤–µ–ª–∏ –Ω–æ–≤—É—é)
            if (!isNaN(item.newPrice)) {
                ing.packPrice = item.newPrice;
            }

            // --- –ù–û–í–ê–Ø –ó–ê–ü–ò–°–¨ –í –ñ–£–†–ù–ê–õ (FIREBASE) ---
            const logId = 'log_' + Date.now() + Math.random().toString().substr(2, 5);
            const logEntry = {
                id: logId,
                date: new Date().toISOString(),
                type: 'procurement', // –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏
                item: ing.name,
                diff: `+${item.addAmount} ${item.unit}`,
                balance: `${parseFloat(ing.stock.toFixed(2))} ${ing.unit}`, // –û—Å—Ç–∞—Ç–æ–∫ –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
                comment: `–¶–µ–Ω–∞: ${ing.packPrice}`
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤
           stockHistory.push(logEntry);
            // ----------------------------------------
        }
    });

    // 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã (–°–∫–ª–∞–¥)
    saveIngs(); 
    saveToCloud('history_stock', stockHistory);
    
    // 3. –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ
    renderStockTable();

    // 4. –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
    document.getElementById('procurementModal').style.display = 'none';
    alert("‚úÖ –ù–∞–∫–ª–∞–¥–Ω–∞—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!");
}

function openStockHistory() {
    // –ï—Å–ª–∏ –º–æ–¥–∞–ª–∫–∏ –Ω–µ—Ç –≤ HTML, —Å–æ–∑–¥–∞–µ–º
    if (!document.getElementById('historyModal')) {
        const div = document.createElement('div');
        div.id = 'historyModal';
        div.className = 'modal-overlay';
        div.innerHTML = `
        <div class="modal-box" style="width:700px; max-height:85vh; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">üìú –ò—Å—Ç–æ—Ä–∏—è –¥–≤–∏–∂–µ–Ω–∏—è (–ü–æ—Å–ª–µ–¥–Ω–∏–µ 100)</h3>
                <button class="del-btn" onclick="document.getElementById('historyModal').style.display='none'">√ó</button>
            </div>
            <div style="flex:1; overflow-y:auto; border:1px solid #eee; border-radius:6px;">
                <table class="stock-table">
                    <thead style="position:sticky; top:0; background:#fff;">
                        <tr>
                            <th>–î–∞—Ç–∞</th>
                            <th>–¢–∏–ø</th>
                            <th>–¢–æ–≤–∞—Ä</th>
                            <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
                            <th>–ë–∞–ª–∞–Ω—Å</th>
                            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
        </div>`;
        document.body.appendChild(div);
    }

    const tbody = document.getElementById('historyTableBody');
    tbody.innerHTML = '';

    if (stockHistory.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#999;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</td></tr>';
    } else {
        stockHistory.forEach(h => {
            let typeIcon = '‚ùì';
            let rowColor = '';
            let diffStyle = 'font-weight:bold;';

            if (h.type === 'procurement') { 
                typeIcon = 'üõí –ó–∞–∫—É–ø'; 
                rowColor = '#f1f8e9'; 
                diffStyle += 'color:#2E7D32;'; 
            } else if (h.type === 'deduction') { 
                typeIcon = 'üìâ –°–ø–∏—Å–∞–Ω–∏–µ'; 
                diffStyle += 'color:#d32f2f;'; 
            } else if (h.type === 'inventory') {
                typeIcon = 'üìù –ò–Ω–≤–µ–Ω—Ç.';
                rowColor = '#fff8e1';
                diffStyle += 'color:#F57C00;';
            }

            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É (03.02 14:05)
            const dateObj = new Date(h.date);
            const dateStr = `${dateObj.getDate().toString().padStart(2,'0')}.${(dateObj.getMonth()+1).toString().padStart(2,'0')} ${dateObj.getHours()}:${dateObj.getMinutes().toString().padStart(2,'0')}`;

            tbody.innerHTML += `
            <tr style="background:${rowColor}; font-size:12px;">
                <td style="color:#666;">${dateStr}</td>
                <td>${typeIcon}</td>
                <td><b>${h.item}</b></td>
                <td style="${diffStyle}">${h.diff}</td>
                <td style="color:#555;">${h.balance || '-'}</td>
                <td style="color:#444;">${h.comment || ''}</td>
            </tr>`;
        });
    }

    document.getElementById('historyModal').style.display = 'flex';
}





// ==========================================
// üìä –ú–û–î–£–õ–¨ –û–¢–ß–ï–¢–ù–û–°–¢–ò (PDF/PRINT)
// ==========================================

function openReportsModal() {
    // –î–∞—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: —Å 1-–≥–æ —á–∏—Å–ª–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ –ø–æ —Å–µ–≥–æ–¥–Ω—è
    const date = new Date();
    const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).toISOString().split('T')[0];
    const today = date.toISOString().split('T')[0];

    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª–∫—É, –µ—Å–ª–∏ –Ω–µ—Ç
    if (!document.getElementById('reportsModal')) {
        const div = document.createElement('div');
        div.id = 'reportsModal';
        div.className = 'modal-overlay';
        div.innerHTML = `
        <div class="modal-box" style="width:400px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3 style="margin:0;">üìä –û—Ç—á–µ—Ç—ã —Å–∫–ª–∞–¥–∞</h3>
                <button class="del-btn" onclick="document.getElementById('reportsModal').style.display='none'">√ó</button>
            </div>

            <div style="background:#f5f5f5; padding:15px; border-radius:8px; margin-bottom:20px;">
                <h4 style="margin-top:0; color:#1565C0;">1. –¢–µ–∫—É—â–∏–µ –æ—Å—Ç–∞—Ç–∫–∏</h4>
                <div style="font-size:12px; color:#666; margin-bottom:10px;">
                    –í–µ–¥–æ–º–æ—Å—Ç—å —Ç–æ–≥–æ, —á—Ç–æ –ª–µ–∂–∏—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å, —Å –ø–æ–¥—Å—á–µ—Ç–æ–º –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏.
                </div>
                <button class="main-btn" onclick="printCurrentStockReport()" style="background:#1565C0;">üñ®Ô∏è –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å –æ—Å—Ç–∞—Ç–∫–∏</button>
            </div>

            <div style="background:#f5f5f5; padding:15px; border-radius:8px;">
                <h4 style="margin-top:0; color:#E65100;">2. –î–≤–∏–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤</h4>
                <div style="font-size:12px; color:#666; margin-bottom:10px;">
                    –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–∏—Ö–æ–¥–æ–≤ –∏ —Å–ø–∏—Å–∞–Ω–∏–π –∑–∞ –ø–µ—Ä–∏–æ–¥.
                </div>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <div style="flex:1;">
                        <span class="form-label">–° –¥–∞—Ç—ã:</span>
                        <input type="date" id="repStartDate">
                    </div>
                    <div style="flex:1;">
                        <span class="form-label">–ü–æ –¥–∞—Ç—É:</span>
                        <input type="date" id="repEndDate">
                    </div>
                </div>
                <button class="main-btn" onclick="printMovementReport()" style="background:#EF6C00;">üñ®Ô∏è –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ</button>
            </div>
        </div>`;
        document.body.appendChild(div);
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã
    document.getElementById('repStartDate').value = firstDay;
    document.getElementById('repEndDate').value = today;
    
    document.getElementById('reportsModal').style.display = 'flex';
}

// --- –û–¢–ß–ï–¢ 1: –¢–ï–ö–£–©–ò–ï –û–°–¢–ê–¢–ö–ò (–° –î–ï–ù–¨–ì–ê–ú–ò) ---
function printCurrentStockReport() {
    const currency = SYMBOLS[currentCurrency] || '';
    let totalValue = 0;
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
    const sortedIngs = [...myIngredients].sort((a,b) => a.name.localeCompare(b.name));

    let rows = '';
    sortedIngs.forEach(ing => {
        const stock = parseFloat(ing.stock) || 0;
        if (stock === 0) return; // (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –°–∫—Ä—ã–≤–∞–µ–º –Ω—É–ª–µ–≤—ã–µ –æ—Å—Ç–∞—Ç–∫–∏, —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—å –±—É–º–∞–≥—É? –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –≤–∏–¥–µ—Ç—å –Ω—É–ª–∏ - —É–±–µ—Ä–∏—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É.

        // –°—á–∏—Ç–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ—Å—Ç–∞—Ç–∫–∞
        // –¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É = –¶–µ–Ω–∞ –ø–∞—á–∫–∏ / –í–µ—Å –ø–∞—á–∫–∏
        const pricePerUnit = (ing.packPrice / ing.packWeight);
        const stockMoney = stock * pricePerUnit;
        
        totalValue += stockMoney;

        let displayStock = stock;
        // –ö—Ä–∞—Å–∏–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–µ—Å–ª–∏ —á–∏—Å–ª–æ –¥—Ä–æ–±–Ω–æ–µ, –æ–∫—Ä—É–≥–ª—è–µ–º, –µ—Å–ª–∏ —Ü–µ–ª–æ–µ - –æ—Å—Ç–∞–≤–ª—è–µ–º)
        if (ing.unit === '—à—Ç') displayStock = Math.round(stock);
        else displayStock = stock.toFixed(1);

        rows += `
        <tr>
            <td>${ing.name}</td>
            <td style="text-align:center;">${ing.unit}</td>
            <td style="text-align:right; font-weight:bold;">${displayStock}</td>
            <td style="text-align:right;">${Math.round(ing.packPrice).toLocaleString()}</td>
            <td style="text-align:right; font-weight:bold;">${Math.round(stockMoney).toLocaleString()}</td>
        </tr>`;
    });

    const html = `
        <h2 style="text-align:center; margin-bottom:5px;">üí∞ –û—Å—Ç–∞—Ç–∫–∏ —Å–∫–ª–∞–¥–∞</h2>
        <div style="text-align:center; font-size:12px; color:#666; margin-bottom:20px;">–ù–∞ –¥–∞—Ç—É: ${new Date().toLocaleString()}</div>
        
        <table style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead>
                <tr style="background:#eee; border-bottom:2px solid #ccc;">
                    <th style="text-align:left; padding:5px;">–¢–æ–≤–∞—Ä</th>
                    <th style="padding:5px;">–ï–¥.</th>
                    <th style="text-align:right; padding:5px;">–ö–æ–ª-–≤–æ</th>
                    <th style="text-align:right; padding:5px;">–¶–µ–Ω–∞ —É–ø–∞–∫.</th>
                    <th style="text-align:right; padding:5px;">–°—É–º–º–∞ (${currency})</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
            <tfoot>
                <tr style="background:#E3F2FD; font-size:14px;">
                    <td colspan="4" style="text-align:right; padding:10px; font-weight:bold;">–ò–¢–û–ì–û –°–¢–û–ò–ú–û–°–¢–¨ –°–ö–õ–ê–î–ê:</td>
                    <td style="text-align:right; padding:10px; font-weight:bold; color:#1565C0;">${Math.round(totalValue).toLocaleString()} ${currency}</td>
                </tr>
            </tfoot>
        </table>
    `;
    
    printWindow(html, '–û—Å—Ç–∞—Ç–∫–∏');
}

// --- –û–¢–ß–ï–¢ 2: –î–í–ò–ñ–ï–ù–ò–ï –ó–ê –ü–ï–†–ò–û–î ---
function printMovementReport() {
    const sStr = document.getElementById('repStartDate').value;
    const eStr = document.getElementById('repEndDate').value;
    
    if (!sStr || !eStr) { alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã!"); return; }

    const start = new Date(sStr); start.setHours(0,0,0,0);
    const end = new Date(eStr); end.setHours(23,59,59,999);

    // –§–∏–ª—å—Ç—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é (–æ–Ω–∞ —É –Ω–∞—Å —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –≤ stockHistory)
    const filtered = stockHistory.filter(h => {
        const d = new Date(h.date);
        return d >= start && d <= end;
    });

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º: —Å—Ç–∞—Ä—ã–µ —Å–≤–µ—Ä—Ö—É (—Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—è)
    filtered.sort((a,b) => new Date(a.date) - new Date(b.date));

    if (filtered.length === 0) { alert("–ó–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥ –¥–≤–∏–∂–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."); return; }

    let rows = '';
    filtered.forEach(h => {
        const dObj = new Date(h.date);
        const dateFmt = `${dObj.getDate().toString().padStart(2,'0')}.${(dObj.getMonth()+1).toString().padStart(2,'0')} ${dObj.getHours()}:${dObj.getMinutes().toString().padStart(2,'0')}`;
        
        let typeName = '–ü—Ä–æ—á–µ–µ';
        let color = '#333';
        if (h.type === 'procurement') { typeName = 'üõí –ü–†–ò–•–û–î'; color = '#2E7D32'; }
        if (h.type === 'deduction') { typeName = 'üìâ –†–ê–°–•–û–î'; color = '#d32f2f'; }
        if (h.type === 'inventory') { typeName = 'üìù –ö–û–†–†–ï–ö–¶.'; color = '#F57C00'; }

        rows += `
        <tr style="border-bottom:1px solid #eee;">
            <td style="padding:5px;">${dateFmt}</td>
            <td style="padding:5px; font-weight:bold; color:${color}; font-size:10px;">${typeName}</td>
            <td style="padding:5px;"><b>${h.item}</b></td>
            <td style="padding:5px; text-align:right;">${h.diff}</td>
            <td style="padding:5px; color:#666; font-size:11px;">${h.comment || ''}</td>
        </tr>`;
    });

    const html = `
        <h2 style="text-align:center; margin-bottom:5px;">üìú –ñ—É—Ä–Ω–∞–ª –¥–≤–∏–∂–µ–Ω–∏—è</h2>
        <div style="text-align:center; font-size:12px; color:#666; margin-bottom:20px;">
            –ü–µ—Ä–∏–æ–¥: ${sStr.split('-').reverse().join('.')} ‚Äî ${eStr.split('-').reverse().join('.')}
        </div>
        
        <table style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead>
                <tr style="background:#eee; border-bottom:2px solid #ccc;">
                    <th style="text-align:left; padding:5px;">–î–∞—Ç–∞</th>
                    <th style="text-align:left; padding:5px;">–û–ø–µ—Ä–∞—Ü–∏—è</th>
                    <th style="text-align:left; padding:5px;">–¢–æ–≤–∞—Ä</th>
                    <th style="text-align:right; padding:5px;">–ö–æ–ª-–≤–æ</th>
                    <th style="text-align:left; padding:5px;">–î–µ—Ç–∞–ª–∏</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
    `;

    printWindow(html, '–î–≤–∏–∂–µ–Ω–∏–µ');
}

// –•–µ–ª–ø–µ—Ä –¥–ª—è –ø–µ—á–∞—Ç–∏ (–°–¢–ò–õ–¨: –õ–ò–°–¢ –ë–£–ú–ê–ì–ò –ê4 + –°–ï–¢–ö–ê)
function printWindow(content, title) {
    const win = window.open('', '_blank');
    win.document.write(`
        <html>
        <head>
            <title>${title}</title>
            <style>
                /* –§–æ–Ω –≤–æ–∫—Ä—É–≥ –ª–∏—Å—Ç–∞ (–∫–∞–∫ –≤ Word) */
                body { 
                    font-family: 'Segoe UI', Arial, sans-serif; 
                    background-color: #555; /* –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π —Ñ–æ–Ω —ç–∫—Ä–∞–Ω–∞ */
                    margin: 0; 
                    padding: 20px; 
                    color: #000;
                }
                
                /* –°–∞–º –ª–∏—Å—Ç –±—É–º–∞–≥–∏ (–ê4) */
                .page {
                    background: white;
                    width: 210mm; /* –®–∏—Ä–∏–Ω–∞ –ê4 */
                    min-height: 297mm;
                    margin: 0 auto; /* –ü–æ —Ü–µ–Ω—Ç—Ä—É */
                    padding: 15mm; /* –ü–æ–ª—è –±—É–º–∞–≥–∏ */
                    box-shadow: 0 0 15px rgba(0,0,0,0.5); /* –¢–µ–Ω—å –ª–∏—Å—Ç–∞ */
                    box-sizing: border-box;
                }

                /* –¢–ê–ë–õ–ò–¶–ê: –°–µ—Ç–∫–∞ –∫–∞–∫ –≤ Excel */
                table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    font-size: 12px; /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —à—Ä–∏—Ñ—Ç */
                }
                
                /* –Ø—á–µ–π–∫–∏ —Å —Ä–∞–º–∫–∞–º–∏ */
                th, td {
                    border: 1px solid #ccc; /* –°–µ—Ç–∫–∞! */
                    padding: 4px 8px; /* –ü–ª–æ—Ç–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã */
                    vertical-align: middle;
                }

                /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ */
                th { 
                    background-color: #f0f0f0; 
                    font-weight: bold; 
                    text-align: center;
                }

                /* --- –≠–§–§–ï–ö–¢ –ù–ê–í–ï–î–ï–ù–ò–Ø (–ö–£–†–°–û–†) --- */
                /* –Ø—Ä–∫–æ-–≥–æ–ª—É–±–∞—è –ø–æ–ª–æ—Å–∫–∞, —á—Ç–æ–±—ã –≥–ª–∞–∑ –Ω–µ —Ç–µ—Ä—è–ª—Å—è */
                tr { transition: background 0.1s; }
                tbody tr:hover { 
                    background-color: #b3e5fc !important; 
                    cursor: crosshair; /* –ö—É—Ä—Å–æ—Ä-–ø—Ä–∏—Ü–µ–ª –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ */
                }

                /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–µ—á–∞—Ç–∏ (—É–±–∏—Ä–∞–µ–º —Ñ–æ–Ω, –æ—Å—Ç–∞–≤–ª—è–µ–º —á–∏—Å—Ç—ã–π –ª–∏—Å—Ç) */
                @media print { 
                    body { background: white; padding: 0; margin: 0; }
                    .page { box-shadow: none; margin: 0; width: 100%; padding: 10mm; }
                    .no-print { display: none; } 
                    /* –ü—Ä–∏ –ø–µ—á–∞—Ç–∏ —É–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É */
                    tbody tr:hover { background-color: transparent !important; }
                }

                /* –ö–Ω–æ–ø–∫–∞ */
                .no-print { 
                    position: fixed; top: 20px; right: 20px; 
                    background: #FF5722; color: white; border: none; padding: 10px 25px; 
                    font-weight: bold; cursor: pointer; border-radius: 30px; 
                    box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 100;
                }
                .no-print:hover { background: #E64A19; transform: scale(1.05); }
            </style>
        </head>
        <body>
            <button class="no-print" onclick="window.print()">üñ®Ô∏è –ü–µ—á–∞—Ç—å / PDF</button>
            <div class="page">
                ${content}
            </div>
        </body>
        </html>
    `);
    win.document.close();
}

// ==========================================
// üìà –û–¢–ß–ï–¢–´ –ü–û –ö–õ–ò–ï–ù–¢–ê–ú –ò –ü–†–û–î–ê–ñ–ê–ú
// ==========================================

function openClientReportsModal() {
    // –î–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
    const date = new Date();
    const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).toISOString().split('T')[0];
    const today = date.toISOString().split('T')[0];

    // –ï—Å–ª–∏ —Å—Ç–∞—Ä–∞—è –º–æ–¥–∞–ª–∫–∞ –µ—Å—Ç—å - —É–¥–∞–ª–∏–º, —Å–æ–∑–¥–∞–¥–∏–º –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
    const existing = document.getElementById('analyticsModal');
    if (existing) existing.remove();

    const div = document.createElement('div');
    div.id = 'analyticsModal';
    div.className = 'modal-overlay';
    div.innerHTML = `
    <div class="modal-box" style="width:450px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h3 style="margin:0;">üìä –û—Ç—á–µ—Ç—ã –ø–æ –±–∏–∑–Ω–µ—Å—É</h3>
            <button class="del-btn" onclick="document.getElementById('analyticsModal').style.display='none'">√ó</button>
        </div>

        <div style="background:#fff3e0; padding:10px; border-radius:6px; border:1px solid #ffe0b2; margin-bottom:20px;">
            <div style="font-size:12px; font-weight:bold; color:#E65100; margin-bottom:5px;">üìÖ –ü–µ—Ä–∏–æ–¥ –æ—Ç—á–µ—Ç–∞:</div>
            <div style="display:flex; gap:10px;">
                <input type="date" id="clRepStart" value="${firstDay}" style="flex:1;">
                <input type="date" id="clRepEnd" value="${today}" style="flex:1;">
            </div>
        </div>

        <div style="margin-bottom:20px; border-bottom:1px dashed #ccc; padding-bottom:20px;">
            <h4 style="margin:0 0 5px 0; color:#2E7D32;">üí∞ –§–∏–Ω–∞–Ω—Å—ã –∏ –ü—Ä–∏–±—ã–ª—å (P&L)</h4>
            <div style="font-size:12px; color:#666; margin-bottom:10px;">
                –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ —Å —Ä–∞—Å—á–µ—Ç–æ–º –≤—ã—Ä—É—á–∫–∏, —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ —á–∏—Å—Ç–æ–π –ø—Ä–∏–±—ã–ª–∏.
            </div>
            <button class="main-btn" onclick="printSalesProfitReport()" style="background:#2E7D32;">üñ®Ô∏è –û—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º</button>
        </div>

        <div>
            <h4 style="margin:0 0 5px 0; color:#1565C0;">üì¢ –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤</h4>
            <div style="font-size:12px; color:#666; margin-bottom:10px;">
                –û—Ç–∫—É–¥–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç –Ω–æ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.
            </div>
            <button class="main-btn" onclick="printMarketingReport()" style="background:#1565C0;">üñ®Ô∏è –û—Ç—á–µ—Ç –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º</button>
        </div>
    </div>`;
    
    document.body.appendChild(div);
    document.getElementById('analyticsModal').style.display = 'flex';
}

// --- –û–¢–ß–ï–¢ 1: –ü–†–û–î–ê–ñ–ò –ò –ü–†–ò–ë–´–õ–¨ (P&L) ---

// --- –û–¢–ß–ï–¢ 1: –§–ò–ù–ê–ù–°–´ (–í–°–Å –í –ö–ê–†–ú–ê–ù) ---
function printSalesProfitReport() {
    const sStr = document.getElementById('clRepStart').value;
    const eStr = document.getElementById('clRepEnd').value;
    if (!sStr || !eStr) { alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã!"); return; }

    const start = new Date(sStr); start.setHours(0,0,0,0);
    const end = new Date(eStr); end.setHours(23,59,59,999);

    const taxPct = parseFloat(document.getElementById('finTax').value) || 0;
    const bankPct = parseFloat(document.getElementById('finBank').value) || 0;
    const overheadPct = parseFloat(document.getElementById('finOverhead').value) || 0;
    const totalExpensePct = taxPct + bankPct + overheadPct;
    
    // –°—Ç–∞–≤–∫–∞ —á–∞—Å–∞ –Ω—É–∂–Ω–∞ —Ç–æ–ª—å–∫–æ —á—Ç–æ–±—ã –æ—Ç–¥–µ–ª–∏—Ç—å –ü–æ–º–æ—â–Ω–∏–∫–∞
    const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;

    let rows = '';
    let totalRevenue = 0;
    let totalExternalCosts = 0; // –ú–∞—Ç–µ—Ä–∏–∞–ª—ã + –ü–æ–º–æ—â–Ω–∏–∫ + –ù–∞–∫–ª–∞–¥–Ω—ã–µ
    let totalIncome = 0;        // –ß–∏—Å—Ç—ã–π –¥–æ—Ö–æ–¥ –∫–æ–Ω–¥–∏—Ç–µ—Ä–∞
    let ordersCount = 0;

    const sortedArchive = archiveOrders.sort((a,b) => new Date(a.completedAt) - new Date(b.completedAt));

    sortedArchive.forEach(ord => {
        if (!ord.completedAt) return;

        // –°–¢–†–û–ì–ò–ô –§–ò–õ–¨–¢–†:
        // 1. –ö–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
        // 2. –≠—Ç–æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∑–∞–∫–∞–∑ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É –Ω–µ–≥–æ –≤ –∏—Å—Ç–æ—Ä–∏–∏
        const client = clientsDataLocal[ord.clientId];
        if (!client) return; // –ö–ª–∏–µ–Ω—Ç —É–¥–∞–ª–µ–Ω
        if (!client.history || !client.history[ord.id]) return; // –ó–∞–∫–∞–∑ —É–¥–∞–ª–µ–Ω —É –∫–ª–∏–µ–Ω—Ç–∞, –Ω–æ –æ—Å—Ç–∞–ª—Å—è –≤ –∞—Ä—Ö–∏–≤–µ

        const finishDate = new Date(ord.completedAt);
        
        if (finishDate >= start && finishDate <= end) {
            
            const revenue = parseFloat(ord.price) || 0;
            
            // 1. –ú–∞—Ç–µ—Ä–∏–∞–ª—ã (–ü—Ä–æ–¥—É–∫—Ç—ã + –î–µ–∫–æ—Ä)
            let matCost = 0;
            if (ord.data && ord.data.costs) {
                matCost = ord.data.costs.totalProductionCost || 0;
            }
            
            // 2. –ü–æ–º–æ—â–Ω–∏–∫ (–≠—Ç–æ –í–ù–ï–®–ù–ò–ô —Ä–∞—Å—Ö–æ–¥)
            let hiredLaborCost = 0;
            const laborList = ord.labor || []; 
            if (laborList.length > 0) {
                laborList.forEach(l => {
                    if (l.isHelper) {
                        hiredLaborCost += l.realHours * l.coeff * hourlyRate;
                    }
                });
            }

            // 3. –ù–∞–∫–ª–∞–¥–Ω—ã–µ (–ù–∞–ª–æ–≥–∏, –ë–∞–Ω–∫, –°–≤–µ—Ç)
            const expenses = revenue * (totalExpensePct / 100);
            
            // 4. –°—á–∏—Ç–∞–µ–º –í–ù–ï–®–ù–ò–ï —Ä–∞—Å—Ö–æ–¥—ã
            const externalCosts = matCost + hiredLaborCost + expenses;

            // 5. –ò–¢–û–ì–û–í–´–ô –î–û–•–û–î (–ß–µ–∫ –º–∏–Ω—É—Å –≤—Å—ë, —á—Ç–æ –æ—Ç–¥–∞–ª–∏ "–Ω–∞ —Å—Ç–æ—Ä–æ–Ω—É")
            // –í–∞—à–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –∑–¥–µ—Å—å –ù–ï –≤—ã—á–∏—Ç–∞–µ—Ç—Å—è, –æ–Ω–∞ —Å–∏–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏ –¥–æ—Ö–æ–¥–∞.
            const income = revenue - externalCosts;

            // –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ–º –∏—Ç–æ–≥–∏
            totalRevenue += revenue;
            totalExternalCosts += externalCosts;
            totalIncome += income;
            ordersCount++;

            // –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å (–°–∫–æ–ª—å–∫–æ –∫–æ–ø–µ–µ–∫ —Å –∫–∞–∂–¥–æ–≥–æ —Ä—É–±–ª—è –æ—Å–µ–¥–∞–µ—Ç –≤ –∫–∞—Ä–º–∞–Ω–µ)
            const margin = revenue > 0 ? Math.round((income / revenue) * 100) : 0;
            let marginColor = margin < 30 ? 'color:#d32f2f;' : (margin > 50 ? 'color:#2E7D32;' : 'color:#F57C00;');

            const dateFmt = `${finishDate.getDate().toString().padStart(2,'0')}.${(finishDate.getMonth()+1).toString().padStart(2,'0')}`;

            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Ç–∞–±–ª–∏—Ü—ã
            const hiredCell = hiredLaborCost > 0 
                ? `<td style="text-align:right; color:#d32f2f;">-${Math.round(hiredLaborCost).toLocaleString()}</td>`
                : `<td style="text-align:center; color:#ccc;">-</td>`;

            rows += `
            <tr>
                <td>${dateFmt}</td>
                <td><b>${ord.name}</b><br><span style="font-size:10px; color:#666;">${ord.reason || '–ó–∞–∫–∞–∑'}</span></td>
                <td style="text-align:right;">${Math.round(revenue).toLocaleString()}</td>
                
                <td style="text-align:right; color:#d32f2f;">-${Math.round(matCost).toLocaleString()}</td>
                
                ${hiredCell}
                
                <td style="text-align:right; color:#d32f2f;">-${Math.round(expenses).toLocaleString()}</td>
                
                <td style="text-align:right; font-weight:bold; ${marginColor} background:#E8F5E9;">${Math.round(income).toLocaleString()}</td>
                <td style="text-align:center; font-size:11px;">${margin}%</td>
            </tr>`;
        }
    });

    if (ordersCount === 0) { alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥."); return; }

    const avgMargin = totalRevenue > 0 ? Math.round((totalIncome / totalRevenue) * 100) : 0;
    const currency = SYMBOLS[currentCurrency] || '';
    
    const html = `
        <h2 style="text-align:center; margin-bottom:5px;">üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç (–î–æ—Ö–æ–¥)</h2>
        <div style="text-align:center; font-size:12px; color:#666; margin-bottom:20px;">
            –ü–µ—Ä–∏–æ–¥: ${sStr.split('-').reverse().join('.')} ‚Äî ${eStr.split('-').reverse().join('.')}
        </div>

        <div style="display:flex; justify-content:space-between; margin-bottom:20px; gap:15px;">
            <div style="flex:1; background:#E3F2FD; padding:15px; border-radius:8px; text-align:center; border:1px solid #BBDEFB;">
                <div style="font-size:12px; color:#1565C0; font-weight:bold; text-transform:uppercase;">–í—ã—Ä—É—á–∫–∞</div>
                <div style="font-size:24px; font-weight:900; margin-top:5px;">${Math.round(totalRevenue).toLocaleString()} <span style="font-size:14px">${currency}</span></div>
            </div>
            
            <div style="flex:1; background:#ffebee; padding:15px; border-radius:8px; text-align:center; border:1px solid #ffcdd2;">
                <div style="font-size:12px; color:#d32f2f; font-weight:bold; text-transform:uppercase;">–í–Ω–µ—à–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</div>
                <div style="font-size:24px; font-weight:900; margin-top:5px;">-${Math.round(totalExternalCosts).toLocaleString()} <span style="font-size:14px">${currency}</span></div>
                <div style="font-size:10px; color:#d32f2f; margin-top:2px;">(–ü—Ä–æ–¥—É–∫—Ç—ã, –ü–æ–º–æ—â–Ω–∏–∫, –ù–∞–ª–æ–≥–∏)</div>
            </div>

            <div style="flex:1; background:#E8F5E9; padding:15px; border-radius:8px; text-align:center; border:1px solid #C8E6C9; box-shadow: 0 4px 10px rgba(76, 175, 80, 0.15);">
                <div style="font-size:12px; color:#2E7D32; font-weight:bold; text-transform:uppercase;">–í–ê–® –ß–ò–°–¢–´–ô –î–û–•–û–î</div>
                <div style="font-size:24px; font-weight:900; margin-top:5px; color:#2E7D32;">${Math.round(totalIncome).toLocaleString()} <span style="font-size:14px">${currency}</span></div>
                <div style="font-size:10px; color:#2E7D32; margin-top:2px;">(–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å: ${avgMargin}%)</div>
            </div>
        </div>
        
        <table style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead>
                <tr style="background:#eee; border-bottom:2px solid #ccc;">
                    <th style="text-align:left;">–î–∞—Ç–∞</th>
                    <th style="text-align:left;">–ó–∞–∫–∞–∑</th>
                    <th style="text-align:right;">–ß–µ–∫</th>
                    <th style="text-align:right; color:#d32f2f;">–ú–∞—Ç.</th>
                    <th style="text-align:right; color:#d32f2f;">–ü–æ–º.</th>
                    <th style="text-align:right; color:#d32f2f;">–ù–∞–∫–ª.</th>
                    <th style="text-align:right; color:#2E7D32; background:#DCEDC8;">–î–û–•–û–î</th>
                    <th style="text-align:center;">%</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
        
        <div style="margin-top:15px; font-size:11px; color:#555; border-top:1px solid #eee; padding-top:10px;">
            <b>–ö–∞–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è:</b><br>
            ‚Ä¢ <b>–ú–∞—Ç (–ú–∞—Ç–µ—Ä–∏–∞–ª—ã):</b> –ü—Ä–æ–¥—É–∫—Ç—ã + –î–µ–∫–æ—Ä + –£–ø–∞–∫–æ–≤–∫–∞.<br>
            ‚Ä¢ <b>–ü–æ–º (–ü–æ–º–æ—â–Ω–∏–∫):</b> –û–ø–ª–∞—Ç–∞ –Ω–∞–µ–º–Ω–æ–º—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É (–µ—Å–ª–∏ –±—ã–ª–∞).<br>
            ‚Ä¢ <b>–ù–∞–∫–ª (–ù–∞–∫–ª–∞–¥–Ω—ã–µ):</b> ${taxPct}% –ù–∞–ª–æ–≥ + ${bankPct}% –ë–∞–Ω–∫ + ${overheadPct}% –ê–º–æ—Ä—Ç–∏–∑–∞—Ü–∏—è.<br>
            ‚Ä¢ <b>–î–û–•–û–î:</b> –ß–µ–∫ –º–∏–Ω—É—Å –≤—Å–µ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã. (–í–∫–ª—é—á–∞–µ—Ç –≤–∞—à—É –æ–ø–ª–∞—Ç—É —Ç—Ä—É–¥–∞ –∏ –ø—Ä–∏–±—ã–ª—å).
        </div>
    `;

    printWindow(html, 'Report_Income');
}
// --- –û–¢–ß–ï–¢ 2: –ú–ê–†–ö–ï–¢–ò–ù–ì (–ò–°–¢–û–ß–ù–ò–ö–ò) ---
function printMarketingReport() {
    const sStr = document.getElementById('clRepStart').value;
    const eStr = document.getElementById('clRepEnd').value;
    
    if (!sStr || !eStr) { alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã!"); return; }

    const start = new Date(sStr); start.setHours(0,0,0,0);
    const end = new Date(eStr); end.setHours(23,59,59,999);

    const stats = {};
    let totalNew = 0;

    // –°—á–∏—Ç–∞–µ–º –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
    Object.values(clientsDataLocal).forEach(c => {
        if (!c.created) return;
        const regDate = new Date(c.created);
        
        if (regDate >= start && regDate <= end) {
            const src = c.source || "–ù–µ —É–∫–∞–∑–∞–Ω–æ";
            if (!stats[src]) stats[src] = { count: 0, revenue: 0 };
            
            stats[src].count++;
            // –ë–æ–Ω—É—Å: —Å—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ –¥–µ–Ω–µ–≥ –ø—Ä–∏–Ω–µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç—ã –∏–∑ —ç—Ç–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (LTV –∑–∞ –ø–µ—Ä–∏–æ–¥ –Ω–µ —Å–æ–≤—Å–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –Ω–æ —Å—É–º–º—É –∏—Ö –ø–æ–∫—É–ø–æ–∫ –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å)
            stats[src].revenue += (c.totalSpend || 0);
            
            totalNew++;
        }
    });

    if (totalNew === 0) { alert("–ù–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."); return; }

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É
    const sortedKeys = Object.keys(stats).sort((a,b) => stats[b].count - stats[a].count);
    const currency = SYMBOLS[currentCurrency] || '';

    let rows = '';
    sortedKeys.forEach(src => {
        const data = stats[src];
        const percent = Math.round((data.count / totalNew) * 100);
        
        // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–æ—Å–∫–∏
        const bar = `<div style="background:#E3F2FD; width:100px; height:6px; border-radius:3px; overflow:hidden;">
                        <div style="background:#1565C0; width:${percent}%; height:100%;"></div>
                     </div>`;

        rows += `
        <tr>
            <td><b>${src}</b></td>
            <td>${bar}</td>
            <td style="text-align:center; font-weight:bold;">${data.count}</td>
            <td style="text-align:center; color:#666;">${percent}%</td>
            <td style="text-align:right;">${Math.round(data.revenue).toLocaleString()} ${currency}</td>
        </tr>`;
    });

    const html = `
        <h2 style="text-align:center; margin-bottom:5px;">üì¢ –û—Ç—á–µ—Ç –ø–æ –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥—É</h2>
        <div style="text-align:center; font-size:12px; color:#666; margin-bottom:20px;">
            –ù–æ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã –∑–∞ –ø–µ—Ä–∏–æ–¥: ${sStr.split('-').reverse().join('.')} ‚Äî ${eStr.split('-').reverse().join('.')}
        </div>
        
        <div style="text-align:center; margin-bottom:20px; font-size:16px;">
            –í—Å–µ–≥–æ –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤: <b style="color:#1565C0; font-size:22px;">${totalNew}</b>
        </div>

        <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead>
                <tr style="background:#eee; border-bottom:2px solid #ccc;">
                    <th style="text-align:left;">–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                    <th style="width:100px;">–ì—Ä–∞—Ñ–∏–∫</th>
                    <th style="text-align:center;">–ö–æ–ª-–≤–æ</th>
                    <th style="text-align:center;">–î–æ–ª—è</th>
                    <th style="text-align:right;">–ü—Ä–∏–Ω–µ—Å–ª–∏ –¥–µ–Ω–µ–≥ (LTV)</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
        <div style="margin-top:10px; font-size:11px; color:#888;">
            * LTV - —Å—É–º–º–∞ –≤—Å–µ—Ö –ø–æ–∫—É–ø–æ–∫, —Å–¥–µ–ª–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞–º–∏, –ø—Ä–∏—à–µ–¥—à–∏–º–∏ –∏–∑ —ç—Ç–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞.
        </div>
    `;

    printWindow(html, '–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥');
}




// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ–±–Ω—É–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ä–∞–±–æ—Ç (–¥–ª—è –Ω–æ–≤–æ–≥–æ —Ç–æ—Ä—Ç–∞)
function resetLaborManual() {
    if (confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã –∏ —Å–±—Ä–æ—Å–∏—Ç—å —Ä—É—á–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ –≤—Ä–µ–º–µ–Ω–∏?")) {
        currentLaborList = [];
        renderLaborTasks();
        performAutoSave();
        // –ï—Å–ª–∏ —Ä–∞—Å—á–µ—Ç —É–∂–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ, –æ–±–Ω–æ–≤–∏–º —Ü–µ–Ω—É
        if (appState.results[appState.activeSide]) {
            updateLaborHours(0, 0); // —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –≤—ã–∑–æ–≤ –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—É–º–º—ã
        }
    }
}

// –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤
function resetExtrasManual() {
    if (confirm("–ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤?")) {
        extrasList = [];
        renderExtras();
        performAutoSave();
        if (appState.results[appState.activeSide]) {
            calculateSide(appState.activeSide);
        }
    }
}


// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ (–Ø / –ü–æ–º–æ—â–Ω–∏–∫)
function toggleLaborHelper(idx) {
    // 1. –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å
    currentLaborList[idx].isHelper = !currentLaborList[idx].isHelper;
    
    // 2. –í–ê–ñ–ù–û: –°—Ç–∞–≤–∏–º –º–µ—Ç–∫—É, —á—Ç–æ —ç—Ç–æ —Ä—É—á–Ω–∞—è –ø—Ä–∞–≤–∫–∞ (—á—Ç–æ–±—ã –Ω–µ —É–¥–∞–ª–∏–ª–æ—Å—å –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ)
    currentLaborList[idx].isManual = true; 
    
    // 3. –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
    renderLaborTasks();
    performAutoSave();
    
    // 4. –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É
    recalcLaborCost();
}

// –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –¥–µ–Ω–µ–≥ –∑–∞ —Ä–∞–±–æ—Ç—É (–±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É)
function recalcLaborCost() {
    if (appState.results[appState.activeSide]) {
        const side = appState.activeSide;
        const data = appState.results[side];
        
        // –°—á–∏—Ç–∞–µ–º –Ω–æ–≤—É—é –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç
        const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;
        let newLaborCost = 0;
        
        currentLaborList.forEach(l => {
            // –°—á–∏—Ç–∞–µ–º –≤—Å—ë –≤ –∫—É—á—É –¥–ª—è –æ–±—â–µ–π —Ü–µ–Ω—ã —Ç–æ—Ä—Ç–∞
            newLaborCost += (l.realHours * l.coeff * hourlyRate);
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ç–µ–∫—É—â–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
        data.costs.laborCost = newLaborCost;
        
        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Ü–µ–Ω—É (–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å + –†–∞–±–æ—Ç–∞) * –°—Ä–æ—á–Ω–æ—Å—Ç—å
        data.costs.finalPrice = Math.ceil((data.costs.totalProductionCost + newLaborCost) * (1 + (data.costs.urgency || 0) / 100));

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–∏—Ñ—Ä—ã –Ω–∞ —ç–∫—Ä–∞–Ω–µ
        updateStats(side);
    }
}

function toggleKbjuColumns() {
    const chk = document.getElementById('toggleKbju');
    const table = document.querySelector('#ingredientsStockBlock table');
    
    if (chk.checked) {
        table.classList.remove('hide-kbju'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º
    } else {
        table.classList.add('hide-kbju');    // –°–∫—Ä—ã–≤–∞–µ–º
    }
}


function setSort(type, field) {
    const target = (type === 'stock') ? stockSort : laborSort;
    
    // –ï—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ –Ω–∞ —Ç–æ –∂–µ –ø–æ–ª–µ - –º–µ–Ω—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    if (target.field === field) {
        target.dir = (target.dir === 'asc') ? 'desc' : 'asc';
    } else {
        target.field = field;
        target.dir = 'asc'; // –ù–æ–≤–æ–µ –ø–æ–ª–µ –≤—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ–º —Å –ê-–Ø
    }
    
    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
    if (type === 'stock') renderStockTable();
    else renderLaborTable();
}

// –•–µ–ª–ø–µ—Ä: –†–∏—Å—É–µ—Ç —Å—Ç—Ä–µ–ª–æ—á–∫—É –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
function getSortArrow(type, field) {
    const target = (type === 'stock') ? stockSort : laborSort;
    if (target.field !== field) return '';
    return target.dir === 'asc' ? '‚Üì' : '‚Üë'; // ‚Üì = –ê-–Ø (0-9), ‚Üë = –Ø-–ê (9-0)
}

function updateSortArrows(type) {
    const sortObj = (type === 'stock') ? stockSort : laborSort;
    
    // –°–ø–∏—Å–æ–∫ –ø–æ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Å–æ—Ä—Ç–∏—Ä—É–µ–º
    const fields = ['name', 'p', 'f', 'c', 'k', 'packWeight', 'packPrice', 'stock'];
    
    fields.forEach(f => {
        const el = document.getElementById(`sort_${type}_${f}`);
        if (el) {
            // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ–ª–µ —Å–µ–π—á–∞—Å –∞–∫—Ç–∏–≤–Ω–æ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ - —Ä–∏—Å—É–µ–º —Å—Ç—Ä–µ–ª–∫—É
            if (sortObj.field === f) {
                el.innerText = sortObj.dir === 'asc' ? '‚Üì' : '‚Üë';
            } else {
                el.innerText = ''; // –ò–Ω–∞—á–µ —Å—Ç–∏—Ä–∞–µ–º
            }
        }
    });
}

// --- –§–£–ù–ö–¶–ò–Ø –ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–Ø –†–ï–¶–ï–ü–¢–ê (–ü–û –í–ï–°–£ +/-) ---
// –í–ï–†–°–ò–Ø –ë–ï–ó –ü–†–û–¶–ï–ù–¢–û–í –í –°–û–û–ë–©–ï–ù–ò–ò
function applyRecipeAdjustment() {
    const input = document.getElementById('recAdjustWeight');
    const delta = parseFloat(input.value); 
    
    if (!delta || delta === 0) {
        alert("–í–≤–µ–¥–∏—Ç–µ –≤–µ—Å –≤ –≥—Ä–∞–º–º–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, -100 –∏–ª–∏ 200).");
        return;
    }

    const r = myRecipes.find(x => x.id === activeRecId);
    if (!r) return;

    // 1. –°–ß–ò–¢–ê–ï–ú –¢–ï–ö–£–©–ò–ô –í–ï–°
    let currentTotalWeight = 0;
    if (r.blocks) {
        r.blocks.forEach(b => {
            if (b.ingredients) {
                b.ingredients.forEach(i => {
                    const ing = myIngredients.find(x => x.id === i.id);
                    let w = parseFloat(i.weight)||0;
                    if (ing && ing.unit === '—à—Ç') {
                        const useWeightMode = ing.useWeightInRecipe === true || ing.useWeightInRecipe === "true";
                        if (!useWeightMode) {
                            w = w * (ing.singleWeight || 0);
                        }
                    }
                    currentTotalWeight += w;
                });
            }
        });
    }

    if (currentTotalWeight === 0) {
        alert("–†–µ—Ü–µ–ø—Ç –ø—É—Å—Ç–æ–π. –ù–µ—á–µ–≥–æ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å.");
        return;
    }

    // 2. –í–´–ß–ò–°–õ–Ø–ï–ú
    const newTotalWeight = currentTotalWeight + delta;
    
    if (newTotalWeight <= 0) {
        alert(`–û—à–∏–±–∫–∞! –í —Ä–µ—Ü–µ–ø—Ç–µ –≤—Å–µ–≥–æ ${Math.round(currentTotalWeight)} –≥.`);
        return;
    }

    const factor = newTotalWeight / currentTotalWeight;
    
    // –î–ª—è –∫—Ä–∞—Å–æ—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏—è: +100 –∏–ª–∏ -100
    const sign = delta > 0 ? "+" : ""; 

    // --- üõë –ü–†–ï–î–û–•–†–ê–ù–ò–¢–ï–õ–¨ (–û–ë–ù–û–í–õ–ï–ù–ù–´–ô –¢–ï–ö–°–¢) ---
    const isSure = confirm(
        `‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ü–ï–†–ï–°–ß–ï–¢!\n\n` +
        `–ë—ã–ª–æ: ${Math.round(currentTotalWeight)} –≥\n` +
        `–°—Ç–∞–Ω–µ—Ç: ${Math.round(newTotalWeight)} –≥\n` +
        `–†–∞–∑–Ω–∏—Ü–∞: ${sign}${delta} –≥\n\n` +
        `–í—Å–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –±—É–¥—É—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∏–∑–º–µ–Ω–µ–Ω—ã.\n` +
        `–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`
    );
    
    if (!isSure) return; 
    // -------------------------

    // 3. –ü–†–ò–ú–ï–ù–Ø–ï–ú
    if (r.blocks) {
        r.blocks.forEach(b => {
            if (b.ingredients) {
                b.ingredients.forEach(i => {
                    // –£–º–Ω–æ–∂–∞–µ–º –∏ –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 2 –∑–Ω–∞–∫–æ–≤ (–¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –º–∞–ª—ã—Ö –≤–µ—Å–æ–≤)
                    i.weight = parseFloat((i.weight * factor).toFixed(2));
                });
            }
        });
    }

    // 4. –ü–ï–†–ï–°–ß–ò–¢–´–í–ê–ï–ú "–í–´–•–û–î"
    if (r.outputWeight) {
        r.outputWeight = parseFloat((r.outputWeight * factor).toFixed(0));
    }

    // 5. –°–û–•–†–ê–ù–Ø–ï–ú
    saveRecs();
    loadRec(activeRecId); 
    
    document.getElementById('recAdjustWeight').value = ''; 
}


document.getElementById('toggleKbju').checked = false;
toggleKbjuColumns();
// --- –ó–ê–ú–ï–ù–ê FIREBASE (–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø) ---
// --- –ó–ê–ú–ï–ù–ê FIREBASE (–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø) ---
function saveToCloud(node, data) {
    // –ó–ê–©–ò–¢–ê: –ï—Å–ª–∏ ID –±–∞–∑—ã –µ—â–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω (–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏–¥–µ—Ç), –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º.
    // –î–∞–Ω–Ω—ã–µ –∏ —Ç–∞–∫ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ (LocalStorage).
    if (!USER_DB_ID) {
        console.log(`‚è≥ –ü—Ä–æ–ø—É—Å–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è '${node}': –±–∞–∑–∞ –µ—â–µ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞.`);
        return;
    }

    // node —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∏–º–µ–Ω–µ–º –ª–∏—Å—Ç–∞: 'ingredients', 'recipes' –∏ —Ç.–¥.
    google.script.run
      .withFailureHandler(err => console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è " + node, err))
      .apiSaveData(node, data);
}

// --- –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ò–ó –û–ë–õ–ê–ö–ê ---
function forceLoadFromCloud() {
    if (!confirm("‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –ó–ê–ú–ï–ù–ò–¢ –∏—Ö –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –≤–∞—à–µ–π Google –¢–∞–±–ª–∏—Ü—ã.\n\n–£–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –±–∞–∑—ã?")) return;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä—É—Ç–∏–ª–∫—É
    document.getElementById('loadingOverlay').style.display = 'flex';
    const statusEl = document.getElementById('dbStatus');
    if (statusEl) statusEl.innerText = "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...";

    google.script.run.withSuccessHandler(function(data) {
        // 1. –û–±–Ω–æ–≤–ª—è–µ–º –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
        if (data.ingredients) {
            myIngredients = data.ingredients;
            localStorage.setItem('myCakeIngredients', JSON.stringify(myIngredients));
        }

        // 2. –û–±–Ω–æ–≤–ª—è–µ–º –†–µ—Ü–µ–ø—Ç—ã
        if (data.recipes) {
            myRecipes = data.recipes;
            localStorage.setItem('myCakeRecipes', JSON.stringify(myRecipes));
        }

        // 3. –û–±–Ω–æ–≤–ª—è–µ–º –†–∞–±–æ—Ç—ã
        if (data.labor) {
            myLaborServices = data.labor;
            localStorage.setItem('myCakeLabor', JSON.stringify(myLaborServices));
        }

        // 4. –û–±–Ω–æ–≤–ª—è–µ–º –û—á–µ—Ä–µ–¥—å (–ü–ª–∞–Ω)
        if (data.queue) {
            productionQueue = data.queue;
            localStorage.setItem('cakeProductionQueue', JSON.stringify(productionQueue));
        }

        // 5. –û–±–Ω–æ–≤–ª—è–µ–º –ö–ª–∏–µ–Ω—Ç–æ–≤
        if (data.clients) {
            clientsDataLocal = data.clients;
            localStorage.setItem('cachedClients', JSON.stringify(clientsDataLocal));
        }

        // 6. –û–±–Ω–æ–≤–ª—è–µ–º –ê—Ä—Ö–∏–≤ –∏ –ò—Å—Ç–æ—Ä–∏—é
        if (data.archive) archiveOrders = data.archive;
        if (data.history_stock) stockHistory = data.history_stock;

        // 7. –û–±–Ω–æ–≤–ª—è–µ–º –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        if (data.settings) {
            if (data.settings.hourlyRate) document.getElementById('hourlyRate').value = data.settings.hourlyRate;
            if (data.settings.tax) document.getElementById('finTax').value = data.settings.tax;
            if (data.settings.bank) document.getElementById('finBank').value = data.settings.bank;
            if (data.settings.overhead) document.getElementById('finOverhead').value = data.settings.overhead;
            if (data.settings.currency) changeCurrency(data.settings.currency);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ
            saveHourlyRate();
            saveFinance();
        }

        // 8. –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –í–ï–°–¨ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        updateUI(); 
        renderRecipesList();
        renderLaborTable();
        renderQueue();
        updateQueueBadge();
        renderClientsCloud();

        // –§–∏–Ω–∞–ª
        document.getElementById('loadingOverlay').style.display = 'none';
        if (statusEl) {
            statusEl.innerText = "üü¢ –û–±–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ –æ–±–ª–∞–∫–∞";
            statusEl.style.color = "#2E7D32";
        }
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        document.getElementById('settingsModal').style.display = 'none';
        alert("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –¢–∞–±–ª–∏—Ü—ã!");

    }).withFailureHandler(function(err) {
        document.getElementById('loadingOverlay').style.display = 'none';
        alert("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + err);
    }).apiLoadAllData();
}
  

// --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–ï–†–°–û–ù–ê–õ–¨–ù–û–ô –ë–ê–ó–´ ---
function initializeApp() {
    const statusDiv = document.createElement('div');
    statusDiv.style.cssText = "position:fixed; bottom:10px; left:10px; font-size:11px; color:#444; z-index:9999; background:rgba(255,255,255,0.9); padding:4px 8px; border-radius:20px; box-shadow:0 2px 5px rgba(0,0,0,0.1); display:flex; align-items:center; gap:5px; font-weight:bold;";
    statusDiv.id = "dbStatus";
    statusDiv.innerText = "üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –æ–±–ª–∞–∫—É...";
    document.body.appendChild(statusDiv);

    google.script.run.withSuccessHandler(function(res) {
        if (res.success) {
            USER_DB_ID = res.id;
            document.getElementById('dbStatus').innerHTML = "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...";
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
            google.script.run.withSuccessHandler(function(data) {
                if(data.ingredients) { myIngredients = data.ingredients; localStorage.setItem('myCakeIngredients', JSON.stringify(myIngredients)); updateUI(); }
                if(data.recipes) { myRecipes = data.recipes; localStorage.setItem('myCakeRecipes', JSON.stringify(myRecipes)); renderRecipesList(); }
                if(data.labor) { myLaborServices = data.labor; localStorage.setItem('myCakeLabor', JSON.stringify(myLaborServices)); renderLaborTable(); }
                if(data.queue) { productionQueue = data.queue; localStorage.setItem('cakeProductionQueue', JSON.stringify(productionQueue)); renderQueue(); updateQueueBadge(); }
                if(data.clients) { clientsDataLocal = data.clients; localStorage.setItem('cachedClients', JSON.stringify(clientsDataLocal)); renderClientsCloud(); }
                if(data.archive) { archiveOrders = data.archive; }
                if(data.history_stock) { stockHistory = data.history_stock; }
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                if(data.settings) {
                   if(data.settings.hourlyRate) localStorage.setItem('cakeHourlyRate', data.settings.hourlyRate);
                   if(data.settings.tax) localStorage.setItem('cakeFinTax', data.settings.tax);
                   loadHourlyRate(); loadFinance();
                }

                document.getElementById('dbStatus').innerHTML = "üü¢ –û–±–ª–∞–∫–æ –∞–∫—Ç–∏–≤–Ω–æ";
            }).apiLoadAllData();

        } else {
            // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ "Email missing", –ø—Ä–æ—Å—Ç–æ –º–æ–ª—á–∏–º (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –≤–æ—à–µ–ª)
            if (res.error === "Email missing") return;
            
            alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ë–î: ' + res.error);
            document.getElementById('dbStatus').innerHTML = "üî¥ –û—à–∏–±–∫–∞ –æ–±–ª–∞–∫–∞";
            document.getElementById('dbStatus').style.color = "red";
        }
    }).apiInitDatabase();
    
    // --- –ú–û–ù–ò–¢–û–†–ò–ù–ì –û–§–§–õ–ê–ô–ù –†–ï–ñ–ò–ú–ê ---
    function updateOnlineStatus() {
        const statusEl = document.getElementById('dbStatus');
        if (!statusEl) return;
        
        if (navigator.onLine) {
            const dbId = typeof USER_DB_ID !== 'undefined' && USER_DB_ID ? "üü¢" : "‚è≥";
            statusEl.innerHTML = `${dbId} –í —Å–µ—Ç–∏`;
            statusEl.style.color = "#2E7D32";
        } else {
            statusEl.innerHTML = `‚ö†Ô∏è –û—Ñ—Ñ–ª–∞–π–Ω (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç—å)`;
            statusEl.style.color = "#d32f2f";
        }
    }

    window.addEventListener('online',  updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();
}

// --- –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø (–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø) ---
// --- –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø (–ì–õ–û–ë–ê–õ–¨–ù–ê–Ø) ---
document.addEventListener('focusin', function(e) {
    // –≠—Ç–æ—Ç –∫–æ–¥ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ö–ê–ñ–î–´–ô —Ä–∞–∑, –∫–æ–≥–¥–∞ –ª—é–±–æ–µ –ø–æ–ª–µ –ø–æ–ª—É—á–∞–µ—Ç —Ñ–æ–∫—É—Å
    if (e.target && e.target.tagName === 'INPUT') {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á–∏—Å–ª–æ–≤–æ–µ –ª–∏ —ç—Ç–æ –ø–æ–ª–µ (type="number" –∏–ª–∏ –∫–ª–∞—Å—Å money-input)
        if (e.target.type === 'number' || e.target.classList.contains('money-input')) {
            
            // 1. –í–∫–ª—é—á–∞–µ–º —Ü–∏—Ñ—Ä–æ–≤—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
            e.target.setAttribute('inputmode', 'decimal'); 
            
            // 2. –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π (—Ñ–∏–∫—Å –¥–ª—è iPhone/Android)
            setTimeout(() => {
                e.target.select();
                // –ù–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ê–Ω–¥—Ä–æ–∏–¥–∞—Ö select() –Ω–µ —Å–∫—Ä–æ–ª–ª–∏—Ç –∫ —ç–ª–µ–º–µ–Ω—Ç—É, –ø–æ–º–æ–∂–µ–º –µ–º—É
                // e.target.scrollIntoView({behavior: "smooth", block: "center"});
            }, 100); 
        }
    }
});

// –û—Ç–¥–µ–ª—å–Ω–æ –∑–∞—â–∏—Ç–∞ –∫–Ω–æ–ø–æ–∫ –æ—Ç –¥–≤–æ–π–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π (–ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ)
document.addEventListener('DOMContentLoaded', () => {
    // –ó–∞—â–∏—Ç–∞ –∫–Ω–æ–ø–æ–∫
    const protectButtons = () => {
        document.querySelectorAll('button').forEach(btn => {
            btn.style.userSelect = 'none';
            btn.style.touchAction = 'manipulation';
        });
    };
    
    protectButtons();
    
    // –°–ª–µ–¥–∏–º –∑–∞ –ø–æ—è–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫ (MutationObserver), —á—Ç–æ–±—ã –∑–∞—â–∏—Ç–∏—Ç—å –∏ –∏—Ö
    const observer = new MutationObserver(() => protectButtons());
    observer.observe(document.body, { childList: true, subtree: true });
});

function closeRecipeMobile() {
    // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å, –∫–æ—Ç–æ—Ä—ã–π —Å–∫—Ä—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫
    const layout = document.querySelector('.recipe-layout');
    if (layout) layout.classList.remove('mobile-view-active');
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π ID, —á—Ç–æ–±—ã –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –≤ —Å–ø–∏—Å–∫–µ –ø—Ä–æ–ø–∞–ª–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    // activeRecId = null; 
    // renderRecipesList(); 
}

// –§—É–Ω–∫—Ü–∏—è-–ø–∏–Ω–æ–∫ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
function forceRepaint() {
    // –ú—ã –ø—Ä–æ—Å–∏–º –±—Ä–∞—É–∑–µ—Ä –∏–∑–º–µ—Ä–∏—Ç—å –≤—ã—Å–æ—Ç—É body. 
    // –≠—Ç–æ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –µ–≥–æ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –≤–µ—Å—å —ç–∫—Ä–∞–Ω.
    // –ó–Ω–∞—á–µ–Ω–∏–µ –Ω–∏–∫—É–¥–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º, –≤–∞–∂–µ–Ω —Å–∞–º —Ñ–∞–∫—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è.
    const _ = document.body.offsetHeight;
    console.log('UI Repaint forced');
}

// --- –õ–ê–ô–¢–ë–û–ö–° –§–£–ù–ö–¶–ò–ò ---

function openLightbox(side) {
    const sourceSvgHTML = document.getElementById('svg' + side).innerHTML;
    if (!sourceSvgHTML) return;

    const container = document.getElementById('lightboxSvgContainer');
    container.innerHTML = sourceSvgHTML;
    
    const lb = document.getElementById('cakeLightbox');
    lb.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    // --- –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: ---
    // –ù–∞—Ö–æ–¥–∏–º —Ç–æ–ª—å–∫–æ —á—Ç–æ –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π SVG —ç–ª–µ–º–µ–Ω—Ç
    const svgElement = container.querySelector('svg');
    if (svgElement) {
        // –î–∞–µ–º –±—Ä–∞—É–∑–µ—Ä—É –º–≥–Ω–æ–≤–µ–Ω–∏–µ –Ω–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫—É, –ø–æ—Ç–æ–º –æ–±—Ä–µ–∑–∞–µ–º –ø—É—Å—Ç–æ—Ç—É
        // setTimeout(0) –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã getBBox() —Å—Ä–∞–±–æ—Ç–∞–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
        setTimeout(() => {
            fitSvgToContent(svgElement);
        }, 0);
    }
}

function closeLightbox() {
    const lb = document.getElementById('cakeLightbox');
    lb.style.display = 'none';
    document.getElementById('lightboxSvgContainer').innerHTML = ''; 
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    document.body.style.overflow = '';
    
    // (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞
    forceRepaint();
}

function toggleTierMode(side, tierIdx) {
    // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å –Ω–µ—Ç —Ä–µ–∂–∏–º–∞, —Å—Ç–∞–≤–∏–º 'weight'
    if (!appState.tierModes[side][tierIdx]) appState.tierModes[side][tierIdx] = 'weight';
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º
    const current = appState.tierModes[side][tierIdx];
    appState.tierModes[side][tierIdx] = (current === 'weight') ? 'size' : 'weight';
    
    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
    renderSideControls(side, appState.results[side]);
}


function toggleTierInputMode(idx, isGeo) {
    // 1. –ú–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –¥–∞–Ω–Ω—ã—Ö
    appState.tiers[idx].isGeometryMode = isGeo;
    
    // 2. –ï—Å–ª–∏ –≤–∫–ª—é—á–∏–ª–∏ "–ì–µ–æ–º–µ—Ç—Ä–∏—é" ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤–µ—Å –≤ –Ω–æ–ª—å (–ª–æ–≥–∏—á–µ—Å–∫–∏),
    // —á—Ç–æ–±—ã –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å" —Å—Ä–∞–±–æ—Ç–∞–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º, –∞ –Ω–µ –ø–æ –≤–µ—Å—É.
    if (isGeo) {
        appState.tiers[idx].weight = 0;
    }

    // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é (Undo/Redo)
    saveToHistory();

    // 4. –í–ê–ñ–ù–û: –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —è—Ä—É—Å–æ–≤.
    // –≠—Ç–æ –æ–±–Ω–æ–≤–∏—Ç –∫–ª–∞—Å—Å—ã –∏–∫–æ–Ω–æ–∫ (–∞–∫—Ç–∏–≤–Ω–∞—è —Å—Ç–∞–Ω–µ—Ç —è—Ä–∫–æ–π, –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è ‚Äî —Å–µ—Ä–æ–π)
    // –∏ –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç/—Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–ª–µ –≤–µ—Å–∞.
    renderTierRows();
}
// --- –õ–û–ì–ò–ö–ê –°–í–ê–ô–ü–ê –ú–ï–ñ–î–£ –í–ê–†–ò–ê–ù–¢–ê–ú–ò (–£–ú–ù–ê–Ø) ---
let touchstartX = 0;
let touchstartY = 0;
let isSwipeAction = false; // –§–ª–∞–≥: —ç—Ç–æ —Å–≤–∞–π–ø –∏–ª–∏ —Å–∫—Ä–æ–ª–ª?

document.addEventListener('DOMContentLoaded', () => {
    const wrapper = document.querySelector('.comparison-wrapper');
    if (wrapper) {
        
        wrapper.addEventListener('touchstart', e => {
            // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–Ω–æ–ø–æ–∫ (–Ω–µ —Ç—Ä–æ–≥–∞–µ–º, –µ—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ –Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
            if (e.target.closest('.tier-ctrl-group') || e.target.closest('.ctrl-btn')) {
                isSwipeAction = false;
                return;
            }

            // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ó–û–ù–´ (–¢–æ–ª—å–∫–æ —Ü–µ–Ω—Ç—Ä –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏)
            // –ú—ã –±–µ—Ä–µ–º –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π –∏ —Ä–∞–∑—Ä–µ—à–∞–µ–º —Å–≤–∞–π–ø —Ç–æ–ª—å–∫–æ –≤ —Å—Ä–µ–¥–Ω–∏—Ö 60%
            const rect = wrapper.getBoundingClientRect();
            const touchY_Relative = e.touches[0].clientY - rect.top;
            
            // –ï—Å–ª–∏ –∫–æ—Å–Ω—É–ª–∏—Å—å —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–æ (–≤–µ—Ä—Ö–Ω–∏–µ 20%) –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–æ (–Ω–∏–∂–Ω–∏–µ 20%) - —ç—Ç–æ –Ω–µ —Å–≤–∞–π–ø
            if (touchY_Relative < (rect.height * 0.2) || touchY_Relative > (rect.height * 0.8)) {
                isSwipeAction = false;
                return;
            }

            touchstartX = e.touches[0].screenX;
            touchstartY = e.touches[0].screenY;
            isSwipeAction = true;
        }, {passive: true});

        wrapper.addEventListener('touchend', e => {
            if (!isSwipeAction) return;

            const touchendX = e.changedTouches[0].screenX;
            const touchendY = e.changedTouches[0].screenY;
            
            handleSmartGesture(touchstartX, touchstartY, touchendX, touchendY);
            isSwipeAction = false; // –°–±—Ä–æ—Å
        }, {passive: true});
    }
});

function handleSmartGesture(sX, sY, eX, eY) {
    const minSwipeDistance = 70; // –£–≤–µ–ª–∏—á–∏–ª–∏ –ø–æ—Ä–æ–≥ (–Ω–∞–¥–æ —Ç—è–Ω—É—Ç—å —Å–∏–ª—å–Ω–µ–µ)
    const diffX = eX - sX;
    const diffY = eY - sY;

    // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ù–ê–ü–†–ê–í–õ–ï–ù–ò–Ø
    // –ï—Å–ª–∏ –¥–≤–∏–∂–µ–Ω–∏–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –±—ã–ª–æ —Å–∏–ª—å–Ω–µ–µ, —á–µ–º –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ -> —ç—Ç–æ —Å–∫—Ä–æ–ª–ª, –∞ –Ω–µ —Å–≤–∞–π–ø
    if (Math.abs(diffY) > Math.abs(diffX)) return;

    // –ï—Å–ª–∏ –¥–ª–∏–Ω–∞ –¥–≤–∏–∂–µ–Ω–∏—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞
    if (Math.abs(diffX) > minSwipeDistance) {
        if (diffX < 0) {
            setActiveSide('Right'); // –°–≤–∞–π–ø –≤–ª–µ–≤–æ
        } else {
            setActiveSide('Left');  // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ
        }
    }
}




let contextActiveId = null;

function showRecipeContextMenu(e, id) {
    e.preventDefault();
    contextActiveId = id;
    const menu = document.getElementById('recipeContextMenu');
    
    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–µ–Ω—é —Ç–∞–º, –≥–¥–µ –ø–∞–ª–µ—Ü
    const touch = e.touches[0];
    menu.style.top = touch.clientY + 'px';
    menu.style.left = Math.min(touch.clientX, window.innerWidth - 160) + 'px';
    menu.style.display = 'flex';

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤ –ª—é–±–æ–µ –º–µ—Å—Ç–æ
    const closeMenu = (evt) => {
        // –í–ê–ñ–ù–û: –ï—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ –í–ù–£–¢–†–ò –º–µ–Ω—é, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ —Å—Ä–∞–∑—É, –¥–∞–µ–º —Å—Ä–∞–±–æ—Ç–∞—Ç—å –∫–Ω–æ–ø–∫–µ
        if (menu.contains(evt.target)) return;
        
        menu.style.display = 'none';
        document.removeEventListener('touchstart', closeMenu);
    };
    
    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã —Ç–µ–∫—É—â–µ–µ –∫–∞—Å–∞–Ω–∏–µ –Ω–µ –∑–∞–∫—Ä—ã–ª–æ –º–µ–Ω—é —Å—Ä–∞–∑—É
    setTimeout(() => {
        document.addEventListener('touchstart', closeMenu);
    }, 100);
}

function handleContextAction(action) {
    if (!contextActiveId) return;
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ—Ü–µ–ø—Ç –∞–∫—Ç–∏–≤–Ω—ã–º –ø–µ—Ä–µ–¥ –¥–µ–π—Å—Ç–≤–∏–µ–º
    activeRecId = contextActiveId;
    
    if (action === 'duplicate') {
        duplicateRecipe();
    } else if (action === 'delete') {
        deleteCurrentRecipe();
    }
    
    document.getElementById('recipeContextMenu').style.display = 'none';
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —ç–∫—Ä–∞–Ω–∞
let screenLock = null;

async function toggleCookingMode() {
    const body = document.body;
    const btn = document.getElementById('btnToggleCookingMode');
    
    if (body.classList.contains('cooking-mode-active')) {
        // --- –í–´–ö–õ–Æ–ß–ê–ï–ú ---
        body.classList.remove('cooking-mode-active');
        btn.innerText = "üë®‚Äçüç≥ –†–µ–∂–∏–º –≥–æ—Ç–æ–≤–∫–∏: –í–´–ö–õ";
        btn.style.background = "#673AB7"; // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
        
        // –†–∞–∑—Ä–µ—à–∞–µ–º —ç–∫—Ä–∞–Ω—É –≥–∞—Å–Ω—É—Ç—å
        if (screenLock !== null) {
            await screenLock.release();
            screenLock = null;
            console.log('–≠–∫—Ä–∞–Ω —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
        }
    } else {
        // --- –í–ö–õ–Æ–ß–ê–ï–ú ---
        body.classList.add('cooking-mode-active');
        btn.innerText = "üí° –≠–∫—Ä–∞–Ω –Ω–µ –≥–∞—Å–Ω–µ—Ç: –í–ö–õ";
        btn.style.background = "#2E7D32"; // –ó–µ–ª–µ–Ω—ã–π
        
        // –ü—Ä–æ–∫—Ä—É—Ç–∏–º –∫ –Ω–∞—á–∞–ª—É —Å–ø–∏—Å–∫–∞
        document.getElementById('batchResultBlock').scrollIntoView({behavior: 'smooth'});

        // –ó–∞–ø—Ä–µ—â–∞–µ–º —ç–∫—Ä–∞–Ω—É –≥–∞—Å–Ω—É—Ç—å (Wake Lock API)
        try {
            if ('wakeLock' in navigator) {
                screenLock = await navigator.wakeLock.request('screen');
                console.log('–≠–∫—Ä–∞–Ω –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –æ—Ç –∑–∞—Ç—É—Ö–∞–Ω–∏—è');
            } else {
                alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É —ç–∫—Ä–∞–Ω–∞, –Ω–∞–∂–∏–º–∞–π—Ç–µ –Ω–∞ —ç–∫—Ä–∞–Ω –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏!");
            }
        } catch (err) {
            console.error(`${err.name}, ${err.message}`);
        }
    }
}

// --- –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û–ì–û –£–í–ï–õ–ò–ß–ï–ù–ò–Ø SVG (–û–ë–†–ï–ó–ö–ê –ü–£–°–¢–û–¢–´) ---
function fitSvgToContent(svgElement) {
    if (!svgElement) return;

    // 1. –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ SVG
    // (–ò—Å–∫–ª—é—á–∞–µ–º <defs>, <g> –∏ –ø—Ä–æ—á–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, —Å–º–æ—Ç—Ä–∏–º —Ç–æ–ª—å–∫–æ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫—É –∏ —Ç–µ–∫—Å—Ç)
    const graphics = svgElement.querySelectorAll('path, rect, circle, ellipse, line, polyline, polygon, text');
    
    if (graphics.length === 0) return;

    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;

    // 2. –ü—Ä–æ–±–µ–≥–∞–µ–º—Å—è –ø–æ –∫–∞–∂–¥–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É –∏ –Ω–∞—Ö–æ–¥–∏–º –µ–≥–æ –≥—Ä–∞–Ω–∏—Ü—ã
    graphics.forEach(el => {
        try {
            // getBBox() - –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –±—Ä–∞—É–∑–µ—Ä–∞, –¥–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ä–∞–º–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–∞
            const bbox = el.getBBox();
            if (bbox.width > 0 && bbox.height > 0) { // –£—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                minX = Math.min(minX, bbox.x);
                minY = Math.min(minY, bbox.y);
                maxX = Math.max(maxX, bbox.x + bbox.width);
                maxY = Math.max(maxY, bbox.y + bbox.height);
            }
        } catch (e) {
            // –ò–Ω–æ–≥–¥–∞ getBBox –º–æ–∂–µ—Ç —Å–±–æ–∏—Ç—å –Ω–∞ —Å–∫—Ä—ã—Ç—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–∞—Ö, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
            console.warn("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –≥—Ä–∞–Ω–∏—Ü —ç–ª–µ–º–µ–Ω—Ç–∞ SVG", e);
        }
    });

    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≥—Ä–∞—Ñ–∏–∫–∏ - –≤—ã—Ö–æ–¥–∏–º
    if (minX === Infinity) return;

    // 3. –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø (padding), —á—Ç–æ–±—ã –Ω–µ –ø—Ä–∏–ª–∏–ø–∞–ª–æ –∫ –∫—Ä–∞—è–º
    const padding = 20; // –ú–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –≤–æ–∑–¥—É—Ö–∞
    const finalX = minX - padding;
    const finalY = minY - padding;
    const finalWidth = (maxX - minX) + (padding * 2);
    const finalHeight = (maxY - minY) + (padding * 2);

    // 4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π viewBox —Å—Ç—Ä–æ–≥–æ –ø–æ —Ä–∞–∑–º–µ—Ä—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    svgElement.setAttribute('viewBox', `${finalX} ${finalY} ${finalWidth} ${finalHeight}`);
    
    // 5. –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ SVG —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –∏ –≤–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –±–µ–∑ –∏—Å–∫–∞–∂–µ–Ω–∏–π
    svgElement.setAttribute('preserveAspectRatio', 'xMidYMid meet');
}

// --- –í–ò–ë–†–û–û–¢–ö–õ–ò–ö (HAPTIC FEEDBACK) ---
function vibration(type = 'light') {
    if (!navigator.vibrate) return;

    // –†–∞–∑–Ω—ã–µ –≤–∏–¥—ã –≤–∏–±—Ä–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
    if (type === 'light') navigator.vibrate(5);   // –õ–µ–≥–∫–∏–π "—Ç—É–∫" (–∫–Ω–æ–ø–∫–∏)
    if (type === 'medium') navigator.vibrate(15); // –û–±—ã—á–Ω—ã–π (–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏)
    if (type === 'heavy') navigator.vibrate(30);  // –¢—è–∂–µ–ª—ã–π (—É–¥–∞–ª–µ–Ω–∏–µ)
    if (type === 'success') navigator.vibrate([10, 30, 10]); // "–¢—É-–¥—É–º" (—É—Å–ø–µ—Ö)
}

// –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–±—Ä–∞—Ü–∏—é –Ω–∞ –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
document.addEventListener('DOMContentLoaded', () => {
    document.body.addEventListener('click', (e) => {
        // –ï—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –∏–ª–∏ –∫—Ä–µ—Å—Ç–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è
        if (e.target.tagName === 'BUTTON' || e.target.classList.contains('del-btn')) {
            // –ï—Å–ª–∏ —ç—Ç–æ —É–¥–∞–ª–µ–Ω–∏–µ ‚Äî –≤–∏–±—Ä–∞—Ü–∏—è –ø–æ—Å–∏–ª—å–Ω–µ–µ
            if (e.target.classList.contains('del-btn') || e.target.innerText.includes('‚úï')) {
                vibration('heavy');
            } else {
                vibration('light');
            }
        }
        // –ï—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ –Ω–∞ —á–µ–∫–±–æ–∫—Å –∏–ª–∏ —Ä–∞–¥–∏–æ
        if (e.target.tagName === 'INPUT' && (e.target.type === 'checkbox' || e.target.type === 'radio')) {
            vibration('medium');
        }
    });
});

     // --- –§–£–ù–ö–¶–ò–ò –ó–ê–©–ò–¢–´ –†–ï–¶–ï–ü–¢–ê ---

function toggleRecipeLock() {
    const chk = document.getElementById('recLockToggle');
    setRecipeLockState(!chk.checked); // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω - –∑–Ω–∞—á–∏—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º (–Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω)
}

function setRecipeLockState(isLocked) {
    const editor = document.getElementById('recipeEditor');
    const chk = document.getElementById('recLockToggle');
    const label = document.getElementById('recLockStatus');

    if (isLocked) {
        // –†–ï–ñ–ò–ú: –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–û üîí
        editor.classList.add('recipe-locked');
        chk.checked = false; // –¢—É–º–±–ª–µ—Ä –≤—ã–∫–ª—é—á–µ–Ω
        label.innerHTML = "üîí –¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ";
        label.style.color = "#555";
    } else {
        // –†–ï–ñ–ò–ú: –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï ‚úèÔ∏è
        editor.classList.remove('recipe-locked');
        chk.checked = true; // –¢—É–º–±–ª–µ—Ä –≤–∫–ª—é—á–µ–Ω
        label.innerHTML = "‚úèÔ∏è –†–µ–∂–∏–º –ø—Ä–∞–≤–∫–∏";
        label.style.color = "#E65100";
    }
}

// --- –§–£–ù–ö–¶–ò–Ø: –£–ú–ù–´–ô –§–ò–õ–¨–¢–† –°–ü–ò–°–ö–ê –ü–û–ö–†–´–¢–ò–ô ---
function renderCoatingOptions() {
    const shapeSelect = document.getElementById('globalShape');
    const coatingSelect = document.getElementById('coatingIdSelect');
    
    if (!shapeSelect || !coatingSelect) return;

    // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ, —á—Ç–æ –≤—ã–±—Ä–∞–Ω–æ —Å–µ–π—á–∞—Å (—á—Ç–æ–±—ã –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å –±–µ–∑ –Ω—É–∂–¥—ã)
    const currentVal = coatingSelect.value;
    const shape = shapeSelect.value;

    // 2. –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
    coatingSelect.innerHTML = '<option value="">-- –ì–æ–ª—ã–π --</option>';

    // 3. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
    // –ò—â–µ–º —Ç–µ–∫—Å—Ç "–∫–æ—Ä–ø—É—Å –±–æ–º–±–∞" (–º–∞–ª–µ–Ω—å–∫–∏–º–∏ –±—É–∫–≤–∞–º–∏ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
    const searchKey = "–∫–æ—Ä–ø—É—Å –±–æ–º–±–∞"; 
    const isBombShape = (shape === 'sphere');

    // 4. –§–∏–ª—å—Ç—Ä—É–µ–º –º–∞—Å—Å–∏–≤ —Ä–µ—Ü–µ–ø—Ç–æ–≤
    const filteredRecipes = myRecipes.filter(r => {
        // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ —Ç–∏–ø "coating" (–ö—Ä–µ–º/–ü–æ–∫—Ä—ã—Ç–∏–µ)
        if (r.type !== 'coating') return false;

        const nameLower = r.name.toLowerCase();
        
        if (isBombShape) {
            // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –ë–û–ú–ë–ê -> –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û —Ç–æ, –≥–¥–µ –µ—Å—Ç—å "–∫–æ—Ä–ø—É—Å –±–æ–º–±–∞"
            return nameLower.includes(searchKey);
        } else {
            // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –¶–ò–õ–ò–ù–î–†/–ö–í–ê–î–†–ê–¢ -> –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –í–°–Å, –ö–†–û–ú–ï "–∫–æ—Ä–ø—É—Å –±–æ–º–±–∞"
            return !nameLower.includes(searchKey);
        }
    });

    // 5. –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–º
    filteredRecipes.forEach(r => {
        const o = document.createElement('option');
        o.value = r.id;
        o.innerText = r.name;
        coatingSelect.appendChild(o);
    });

    // 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º: –æ—Å—Ç–∞–ª—Å—è –ª–∏ —Å—Ç–∞—Ä—ã–π –≤—ã–±–æ—Ä –≤ –Ω–æ–≤–æ–º —Å–ø–∏—Å–∫–µ?
    // –ï—Å–ª–∏ –¥–∞ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ "–ì–æ–ª—ã–π".
    const stillExists = filteredRecipes.find(r => r.id === currentVal);
    if (stillExists) {
        coatingSelect.value = currentVal;
    } else {
        coatingSelect.value = "";
    }
}
          
  // --- –§–£–ù–ö–¶–ò–Ø –ê–í–¢–û–ü–û–î–ë–û–†–ê –£–ü–ê–ö–û–í–ö–ò ---
// --- –§–£–ù–ö–¶–ò–Ø –ê–í–¢–û–ü–û–î–ë–û–†–ê –£–ü–ê–ö–û–í–ö–ò (–ë–ï–ó –ë–ï–°–ö–û–ù–ï–ß–ù–û–ì–û –¶–ò–ö–õ–ê) ---
function autoAddPackaging(res) {
    const shape = res.geometry.shape;
    
    // 1. –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ (–¢–æ, —á—Ç–æ –î–û–õ–ñ–ù–û –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–æ)
    let candidates = [];

    if (shape !== 'rectangle') {
        const cakeD = res.geometry.d;
        const cakeH = res.geometry.h;

        // –ê. –ò—â–µ–º –ü–æ–¥–ª–æ–∂–∫—É (D + 4—Å–º)
        const neededBoardSize = cakeD + 4;
        let bestBoard = null;
        let bestBoardSize = Infinity;

        myIngredients.forEach(ing => {
            const name = ing.name.toLowerCase();
            if (name.includes('–ø–æ–¥–ª–æ–∂–∫–∞')) {
                const match = name.match(/–ø–æ–¥–ª–æ–∂–∫–∞\s*(\d+)/); 
                if (match) {
                    const size = parseInt(match[1]);
                    if (size >= neededBoardSize && size < bestBoardSize) {
                        bestBoardSize = size;
                        bestBoard = ing;
                    }
                }
            }
        });

        if (bestBoard) {
            candidates.push({
                id: bestBoard.id,
                name: bestBoard.name,
                amount: 1,
                unit: '—à—Ç',
                type: 'extra',
                isAutoPack: true
            });

            // –ë. –ò—â–µ–º –ö–æ—Ä–æ–±–∫—É (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥–ª–æ–∂–∫–∞)
            const minBoxD = bestBoardSize; 
            const minBoxH = cakeH + 2; 
            let bestBox = null;
            let minBoxWaste = Infinity; 

            myIngredients.forEach(ing => {
                const name = ing.name.toLowerCase();
                if (name.includes('–∫–æ—Ä–æ–±–∫–∞') && name.includes('—Ç—É–±—É—Å')) {
                    const match = name.match(/(\d+)[\/\\](\d+)/);
                    if (match) {
                        const boxD = parseInt(match[1]);
                        const boxH = parseInt(match[2]);

                        if (boxD >= minBoxD && boxH >= minBoxH) {
                            const wasteD = boxD - minBoxD;
                            const wasteH = boxH - minBoxH;
                            const currentWaste = (wasteD * 100) + wasteH;

                            if (currentWaste < minBoxWaste) {
                                minBoxWaste = currentWaste;
                                bestBox = { ing: ing, d: boxD, h: boxH };
                            }
                        }
                    }
                }
            });

            if (bestBox) {
                candidates.push({
                    id: bestBox.ing.id,
                    name: bestBox.ing.name,
                    amount: 1,
                    unit: '—à—Ç',
                    type: 'extra',
                    isAutoPack: true
                });

                // –í. –°—á–∏—Ç–∞–µ–º –õ–µ–Ω—Ç—É
                const ribbonCm = (4 * bestBox.h) + (2 * bestBox.d) + 50;
                const ribbonM = parseFloat((ribbonCm / 100).toFixed(2));
                
                const ribbonIng = myIngredients.find(i => i.name.toLowerCase().includes('–ª–µ–Ω—Ç–∞'));
                const ribbonId = ribbonIng ? ribbonIng.id : 'manual_ribbon';
                const ribbonName = ribbonIng ? ribbonIng.name : '–õ–µ–Ω—Ç–∞ –∞—Ç–ª–∞—Å–Ω–∞—è (–ê–≤—Ç–æ)';
                const ribbonUnit = ribbonIng ? ribbonIng.unit : '–º';
                let finalRibbonAmount = ribbonM;
                if (ribbonUnit === '—Å–º') finalRibbonAmount = ribbonCm;

                candidates.push({
                    id: ribbonId,
                    name: ribbonName,
                    amount: finalRibbonAmount,
                    unit: ribbonUnit,
                    type: 'extra',
                    isAutoPack: true
                });
            }
        }
    }

    // 2. –°–†–ê–í–ù–ï–ù–ò–ï: –û—Ç–ª–∏—á–∞–µ—Ç—Å—è –ª–∏ —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –æ—Ç —Ç–æ–≥–æ, —á—Ç–æ —É–∂–µ –µ—Å—Ç—å?
    const currentAutoItems = extrasList.filter(i => i.isAutoPack);

    // –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑–Ω–æ–µ - —Ç–æ—á–Ω–æ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
    let isDifferent = (candidates.length !== currentAutoItems.length);

    // –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–∞–≤ (ID –∏ –∫–æ–ª-–≤–æ)
    if (!isDifferent) {
        for (let i = 0; i < candidates.length; i++) {
            const newItem = candidates[i];
            const oldItem = currentAutoItems[i];
            
            // –ï—Å–ª–∏ —Ö–æ—Ç—å –æ–¥–Ω–æ –ø–æ–ª–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç - —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
            if (newItem.id !== oldItem.id || newItem.amount !== oldItem.amount) {
                isDifferent = true;
                break;
            }
        }
    }

    // 3. –§–ò–ù–ê–õ: –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    if (isDifferent) {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ
        extrasList = extrasList.filter(i => !i.isAutoPack);
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
        extrasList.push(...candidates);
        return true; // –°–∏–≥–Ω–∞–ª –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å—á–µ—Ç–∞
    } else {
        return false; // –ù–ò–ß–ï–ì–û –ù–ï –ú–ï–ù–Ø–ï–ú -> –¶–ò–ö–õ –û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–¢–°–Ø –ó–î–ï–°–¨
    }
}

// ==========================================
// üî¢ –ú–û–î–£–õ–¨ –§–ò–ì–£–†–ù–´–• –¢–û–†–¢–û–í 3.3 (Stable)
// ==========================================

let shapeState = {
    cleanImgUrl: null, 
    nativeRatio: 1,    // W / H
    kFactorRect: 1,    
    kFactorCircle: 1,  
    radiusToHeightRatio: 1, 
    currentShape: 'rect', // 'rect' | 'circle'
    current: { l: 0, w: 0, h: 0, d: 0, weight: 0 }
};

// 1. –ó–ê–ì–†–£–ó–ö–ê
function handleSvgUpload(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() { cropAndAnalyze(img); };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

// 2. –ê–ù–ê–õ–ò–ó (Smart Crop + White Filter)
function cropAndAnalyze(img) {
    const MAX_SIDE = 1000;
    let w = img.width; let h = img.height;
    if (w > MAX_SIDE || h > MAX_SIDE) {
        const ratio = w / h;
        if (w > h) { w = MAX_SIDE; h = w / ratio; } else { h = MAX_SIDE; w = h * ratio; }
    }
    w = Math.floor(w); h = Math.floor(h);

    const cvs = document.createElement('canvas');
    const ctx = cvs.getContext('2d');
    cvs.width = w; cvs.height = h;
    ctx.drawImage(img, 0, 0, w, h);
    
    const imgData = ctx.getImageData(0,0,w,h);
    const data = imgData.data;
    
    let minX=w, minY=h, maxX=0, maxY=0, solidCount=0;
    
    for(let y=0; y<h; y++) {
        for(let x=0; x<w; x++) {
            const i = (y*w+x)*4;
            const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3];
            
            // –§–∏–ª—å—Ç—Ä: –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –∏–ª–∏ –±–µ–ª—ã–π
            const isTransparent = (a < 50);
            const isWhite = (r > 230 && g > 230 && b > 230);
            
            if (isTransparent || isWhite) {
                data[i+3] = 0; 
            } else {
                if(x < minX) minX = x;
                if(x > maxX) maxX = x;
                if(y < minY) minY = y;
                if(y > maxY) maxY = y;
                solidCount++;
            }
        }
    }
    
    if(solidCount === 0) { alert("–§–∏–≥—É—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (–ø—É—Å—Ç–∞—è –∏–ª–∏ –±–µ–ª–∞—è)!"); return; }
    
    const realW = maxX - minX;
    const realH = maxY - minY;
    
    // –ö—Ä—É–≥
    const centerX = minX + realW / 2;
    const centerY = minY + realH / 2;
    let maxDistSq = 0;
    for(let y=minY; y<=maxY; y++) {
        for(let x=minX; x<=maxX; x++) {
            const i = (y*w+x)*4;
            if (data[i+3] > 0) { 
                const distSq = (x - centerX)**2 + (y - centerY)**2;
                if (distSq > maxDistSq) maxDistSq = distSq;
            }
        }
    }
    const maxRadius = Math.sqrt(maxDistSq);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º
    ctx.putImageData(imgData, 0, 0); 
    const pad = 2; 
    const cleanCvs = document.createElement('canvas');
    cleanCvs.width = realW + pad*2;
    cleanCvs.height = realH + pad*2;
    cleanCvs.getContext('2d').drawImage(cvs, minX, minY, realW, realH, pad, pad, realW, realH);
    
    shapeState.cleanImgUrl = cleanCvs.toDataURL();
    shapeState.nativeRatio = realW / realH; // –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–ø–æ—Ä—Ü–∏—è
    
    const areaRect = realW * realH;
    const areaCircle = Math.PI * maxRadius * maxRadius;
    
    shapeState.kFactorRect = solidCount / areaRect;
    shapeState.kFactorCircle = solidCount / areaCircle;
    shapeState.radiusToHeightRatio = (maxRadius * 2) / realH; 

    // –ê–≤—Ç–æ–≤—ã–±–æ—Ä
    let best = 'rect';
    let msg = "–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫.";
    if (shapeState.kFactorCircle > shapeState.kFactorRect) {
         best = 'circle';
         msg = "–ö—Ä—É–≥ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ!";
    }
    
    document.querySelector(`input[name="bakeShape"][value="${best}"]`).checked = true;
    toggleShapeType(); 
    
    document.getElementById('svgStatusText').innerText = `‚úÖ –ê–Ω–∞–ª–∏–∑: Rect ${Math.round(shapeState.kFactorRect*100)}% / Circle ${Math.round(shapeState.kFactorCircle*100)}%. ${msg}`;
    document.getElementById('shapeCalcBlock').style.display = 'block';
    
    updateShapeRecipes();
    generate3DLayers();
    document.getElementById('linkAspect').checked = true;
    recalcFromWeight();
}

function updateShapeRecipes() { 
    const sel = document.getElementById('shapeRecipeSelect');
    if (!sel) return;
    sel.innerHTML = '';
    const fillings = myRecipes.filter(r => r.type === 'filling');
    fillings.forEach(r => {
        const vol = Math.PI * Math.pow(r.calibrationD/2, 2) * r.calibrationH;
        const density = r.outputWeight / vol; 
        const opt = document.createElement('option');
        opt.value = r.id; 
        opt.dataset.density = density; 
        opt.innerText = `${r.name} (~${density.toFixed(2)} –≥/—Å–º¬≥)`;
        sel.appendChild(opt);
    });
}

function generate3DLayers() { 
    const stack = document.getElementById('cakeStack');
    if (!stack) return;
    stack.innerHTML = '';
    
    const layerCount = 60; // –ì–ª–∞–¥–∫–∏–π —Ç–æ—Ä—Ç (60 —Å–ª–æ–µ–≤)
    
    for(let i=0; i<layerCount; i++) {
        const div = document.createElement('div');
        div.className = (i === layerCount - 1) ? 'cake-layer cake-top' : 'cake-layer cake-side';
        div.style.backgroundImage = `url('${shapeState.cleanImgUrl}')`;
        div.dataset.layerIdx = i; 
        stack.appendChild(div);
    }
}

// 3. UI –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï
function toggleShapeType() {
    const shape = document.querySelector('input[name="bakeShape"]:checked').value;
    shapeState.currentShape = shape;
    
    const blockRect = document.getElementById('blockRect');
    const blockCircle = document.getElementById('blockCircle');
    const ghost = document.getElementById('ghostBox');
    
    if (shape === 'rect') {
        blockRect.style.display = 'contents';
        blockCircle.style.display = 'none';
        ghost.classList.remove('is-circle');
    } else {
        blockRect.style.display = 'none';
        blockCircle.style.display = 'block';
        ghost.classList.add('is-circle');
    }
    recalcFromWeight();
}

// 4. –†–ê–°–ß–ï–¢–´
function getDensity() {
    const sel = document.getElementById('shapeRecipeSelect');
    if (!sel) return 0.8;
    const selectedOpt = sel.options[sel.selectedIndex];
    return selectedOpt ? parseFloat(selectedOpt.dataset.density) : 0.8; 
}

function recalcFromWeight() {
    const weightKg = parseFloat(document.getElementById('inpWeight').value) || 2;
    const h = parseFloat(document.getElementById('inpH').value) || 10;
    const density = getDensity();
    
    const volSymbol = (weightKg * 1000) / density;
    const areaSymbol = volSymbol / h;
    
    if (shapeState.currentShape === 'rect') {
        const areaBox = areaSymbol / shapeState.kFactorRect;
        const ratio = shapeState.nativeRatio; 
        const L = Math.sqrt(areaBox / ratio);
        const W = L * ratio;
        
        updateInputNoTrigger('inpL', L);
        updateInputNoTrigger('inpW', W);
        finalizeCalc(L, W, h, 0, weightKg);
    } else {
        const areaBox = areaSymbol / shapeState.kFactorCircle; 
        const radius = Math.sqrt(areaBox / Math.PI);
        const D = radius * 2;
        
        const visualL = D / shapeState.radiusToHeightRatio;
        const visualW = visualL * shapeState.nativeRatio;

        updateInputNoTrigger('inpD', D);
        finalizeCalc(visualL, visualW, h, D, weightKg);
    }
}

function recalcFromDimensions(source) {
    const isLocked = document.getElementById('lockWeight').checked;
    const density = getDensity();
    let H = parseFloat(document.getElementById('inpH').value) || 10;
    let targetWeight = parseFloat(document.getElementById('inpWeight').value) || 2;
    const linkAspect = document.getElementById('linkAspect').checked;

    if (shapeState.currentShape === 'rect') {
        let L = parseFloat(document.getElementById('inpL').value) || 20;
        let W = parseFloat(document.getElementById('inpW').value) || 15;
        
        if (linkAspect) {
            if (source === 'L') { W = L * shapeState.nativeRatio; updateInputNoTrigger('inpW', W); }
            else if (source === 'W') { L = W / shapeState.nativeRatio; updateInputNoTrigger('inpL', L); }
        }

        if (isLocked) {
             const targetVol = (targetWeight * 1000) / density;
             if (source === 'H') {
                 const neededArea = (targetVol / H) / shapeState.kFactorRect;
                 const ratioToUse = linkAspect ? shapeState.nativeRatio : (W / L);
                 L = Math.sqrt(neededArea / ratioToUse); W = L * ratioToUse;
                 updateInputNoTrigger('inpL', L); updateInputNoTrigger('inpW', W);
             } else {
                 const areaBox = L * W;
                 H = targetVol / (areaBox * shapeState.kFactorRect);
                 updateInputNoTrigger('inpH', H);
             }
        } else {
            const areaSymbol = (L * W) * shapeState.kFactorRect;
            targetWeight = (areaSymbol * H * density) / 1000;
            updateInputNoTrigger('inpWeight', targetWeight);
        }
        finalizeCalc(L, W, H, 0, targetWeight);

    } else {
        // –ö–†–£–ì
        let D = parseFloat(document.getElementById('inpD').value) || 20;
        if (isLocked) {
            const targetVol = (targetWeight * 1000) / density;
            if (source === 'H') {
                const neededAreaSymbol = targetVol / H;
                const neededAreaCircle = neededAreaSymbol / shapeState.kFactorCircle;
                D = Math.sqrt(neededAreaCircle / Math.PI) * 2;
                updateInputNoTrigger('inpD', D);
            } else {
                const areaCircle = Math.PI * Math.pow(D/2, 2);
                const areaSymbol = areaCircle * shapeState.kFactorCircle;
                H = targetVol / areaSymbol;
                updateInputNoTrigger('inpH', H);
            }
        } else {
            const areaCircle = Math.PI * Math.pow(D/2, 2);
            const areaSymbol = areaCircle * shapeState.kFactorCircle;
            targetWeight = (areaSymbol * H * density) / 1000;
            updateInputNoTrigger('inpWeight', targetWeight);
        }
        const visualL = D / shapeState.radiusToHeightRatio;
        const visualW = visualL * shapeState.nativeRatio;
        finalizeCalc(visualL, visualW, H, D, targetWeight);
    }
}

function finalizeCalc(L, W, H, D, weight) {
    const density = getDensity();
    let totalVol = 0;
    
    if (shapeState.currentShape === 'rect') {
        totalVol = L * W * H;
    } else {
        totalVol = Math.PI * Math.pow(D/2, 2) * H;
    }
    
    const totalWeight = (totalVol * density) / 1000;
    const waste = totalWeight - weight;
    const wastePct = totalWeight > 0 ? (waste / totalWeight) * 100 : 0;
    
    document.getElementById('infoTotal').innerText = `${totalWeight.toFixed(2)} –∫–≥`;
    document.getElementById('infoWaste').innerText = `${waste.toFixed(2)} –∫–≥ (${Math.round(wastePct)}%)`;
    
    shapeState.current = { l: L, w: W, h: H, d: D, weight: weight };
    
    update3DScene(L, W, H, D);
}

// 5. –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –¶–ï–ù–¢–†–û–í–ö–ê)
function update3DScene(L, W, H, D) {
    const box = document.getElementById('ghostBox');
    const stack = document.getElementById('cakeStack');
    if (!box || !stack) return;

    // –ú–∞—Å—à—Ç–∞–±
    const maxDim = (shapeState.currentShape === 'circle') ? D : Math.max(L, W);
    const scale = 140 / maxDim; // –ß—Ç–æ–±—ã –≤–ª–µ–∑–∞–ª–æ –≤ —ç–∫—Ä–∞–Ω 350px
    const pxH = H * scale; 
    
    renderShapeControls(L, W, H, D || 0);

    // 1. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –†–ê–ú–ö–£ (Ghost) –∏ –µ–µ —Ä–∞–∑–º–µ—Ä—ã
    // –ú—ã –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º transform: translate –≤ CSS –¥–ª—è —Ä–∞–º–∫–∏, –¥–µ–ª–∞–µ–º –≤—Å—ë —Ç—É—Ç –º–∞—Ä–≥–∏–Ω–∞–º–∏
    let pxW, pxL;

    if (shapeState.currentShape === 'circle') {
        const pxD = D * scale;
        pxW = pxD; pxL = pxD;
        
        box.style.width = pxD + 'px';
        box.style.height = pxD + 'px';
        box.style.borderRadius = '50%';
        
        document.getElementById('lblL').innerText = ''; 
        const lblW = document.getElementById('lblW');
        lblW.innerText = `D ${Math.round(D)}`;
        lblW.style.left = '-10px'; lblW.style.top = '50%';
        document.getElementById('lblH').innerText = 'H ' + Math.round(H);
        
    } else {
        pxL = L * scale; pxW = W * scale;
        
        box.style.width = pxW + 'px';
        box.style.height = pxL + 'px';
        box.style.borderRadius = '0';
        
        const lblL = document.getElementById('lblL'); 
        lblL.innerText = Math.round(W) + ' (–®)';
        lblL.style.bottom = '-15px'; lblL.style.left = '50%';

        const lblW = document.getElementById('lblW');
        lblW.innerText = Math.round(L) + ' (–î)';
        lblW.style.left = '-35px'; lblW.style.top = '50%';
        document.getElementById('lblH').innerText = 'H ' + Math.round(H);
    }
    
    // –¶–ï–ù–¢–†–û–í–ö–ê –†–ê–ú–ö–ò (–°—Ç–∞–≤–∏–º –µ—ë –≤ —Ü–µ–Ω—Ç—Ä —Å—Ü–µ–Ω—ã 0,0)
    box.style.top = '50%'; 
    box.style.left = '50%';
    box.style.marginTop = (-pxL/2) + 'px';
    box.style.marginLeft = (-pxW/2) + 'px';

    // 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¢–û–†–¢ (–†–∞–∑–º–µ—Ä—ã –∫–∞—Ä—Ç–∏–Ω–∫–∏)
    // –ï—Å–ª–∏ —ç—Ç–æ –∫—Ä—É–≥, –∫–∞—Ä—Ç–∏–Ω–∫–∞ –≤–Ω—É—Ç—Ä–∏ –Ω–µ–≥–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–ø–∏—Å–∞–Ω–∞ (visualL/visualW)
    let imgL = pxL; 
    let imgW = pxW;
    
    if (shapeState.currentShape === 'circle') {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤–Ω—É—Ç—Ä–∏ –∫—Ä—É–≥–∞
        imgL = (D / shapeState.radiusToHeightRatio) * scale;
        imgW = imgL * shapeState.nativeRatio;
    }
    
    const layers = document.querySelectorAll('.cake-layer');
    const totalLayers = layers.length;
    
    layers.forEach(layer => {
        const idx = parseInt(layer.dataset.layerIdx);
        const zPos = (idx / (totalLayers - 1)) * pxH;
        
        layer.style.width = imgW + 'px';
        layer.style.height = imgL + 'px';
        
        // –¶–ï–ù–¢–†–û–í–ö–ê –¢–û–†–¢–ê (–≤ —Ç—É –∂–µ —Ç–æ—á–∫—É, —á—Ç–æ –∏ —Ä–∞–º–∫–∞)
        layer.style.top = '50%';
        layer.style.left = '50%';
        layer.style.marginTop = (-imgL/2) + 'px';
        layer.style.marginLeft = (-imgW/2) + 'px';
        
        layer.style.transform = `translateZ(${zPos}px)`;
    });
}

// 6. –£–ü–†–ê–í–õ–ï–ù–ò–ï
function toggleLockMode() {
    const isLocked = document.getElementById('lockWeight').checked;
    document.getElementById('lockStatusText').innerText = isLocked ? "üîí –í–ï–° –ó–ê–§–ò–ö–°–ò–†–û–í–ê–ù" : "üîì –í–ï–° –ú–ï–ù–Ø–ï–¢–°–Ø";
    document.getElementById('lockStatusText').style.color = isLocked ? "#2E7D32" : "#E65100";
}

function updateInputNoTrigger(id, val) {
    const el = document.getElementById(id);
    if(el) el.value = val < 10 ? val.toFixed(1) : Math.round(val);
}

// –°—Ç–µ–ø–ø–µ—Ä—ã
function renderShapeControls(L, W, H, D) {
    const c = document.getElementById('shapeControls');
    if (!c) return;
    const isRect = (shapeState.currentShape === 'rect');
    let html = '';
    
    const btn = (axis, dir, label) => `<button class="ctrl-btn" onmousedown="startChange(null, ${dir}, '${axis}')" ontouchstart="startChange(null, ${dir}, '${axis}')" onmouseup="stopChange()" onmouseleave="stopChange()" ontouchend="stopChange()">${label}</button>`;

    if (isRect) {
        html += `<div class="ctrl-row">${btn('L', -1, '-')} <span class="ctrl-label" style="width:auto; padding:0 5px;">–î: ${Math.round(L)}</span> ${btn('L', 1, '+')}</div>`;
        html += `<div class="ctrl-row">${btn('W', -1, '-')} <span class="ctrl-label" style="width:auto; padding:0 5px;">–®: ${Math.round(W)}</span> ${btn('W', 1, '+')}</div>`;
    } else {
        html += `<div class="ctrl-row">${btn('D', -1, '-')} <span class="ctrl-label" style="width:auto; padding:0 5px;">D: ${Math.round(D)}</span> ${btn('D', 1, '+')}</div>`;
    }
    html += `<div class="ctrl-row">${btn('H', -0.5, '-')} <span class="ctrl-label" style="width:auto; padding:0 5px;">H: ${Math.round(H)}</span> ${btn('H', 0.5, '+')}</div>`;
    c.innerHTML = html;
}

function stepShape(axis, delta) {
    let inputId = '';
    if (axis === 'L') inputId = 'inpL';
    else if (axis === 'W') inputId = 'inpW';
    else if (axis === 'H') inputId = 'inpH';
    else if (axis === 'D') inputId = 'inpD';
    
    const el = document.getElementById(inputId);
    if (!el) return;
    
    let val = parseFloat(el.value) || 0;
    val += delta;
    if (axis === 'H') val = Math.round(val * 2) / 2;
    else val = Math.round(val);
    
    if (val < 1) val = 1;
    el.value = val;
    recalcFromDimensions(axis);
    if (navigator.vibrate) navigator.vibrate(5);
}

let holdTimer = null, holdInterval = null;
function startChange(id, delta, axis) {
    saveToHistory(); // <--- –°–û–•–†–ê–ù–Ø–ï–ú –ü–ï–†–ï–î –ù–ê–ß–ê–õ–û–ú –ò–ó–ú–ï–ù–ï–ù–ò–Ø
    stepShape(axis, delta);
    holdTimer = setTimeout(() => {
        holdInterval = setInterval(() => stepShape(axis, delta), 100); 
    }, 400); 
}
function stopChange() { clearTimeout(holdTimer); clearInterval(holdInterval); }

function stepWeight(delta) {
  saveToHistory(); 
    const el = document.getElementById('inpWeight');
    let val = parseFloat(el.value) || 0;
    val += delta;
    if (val < 0.1) val = 0.1;
    el.value = val.toFixed(1);
    recalcFromWeight();
}

function transferShapeToMain() {
    const { l, w, h, d } = shapeState.current;
    if (h === 0) return;
    
    const recId = document.getElementById('shapeRecipeSelect').value;
    const isCircle = (shapeState.currentShape === 'circle');
    
    const newTier = {
        id: Date.now(),
        weight: 0, 
        recipeId: recId,
        isGeometryMode: true,
        fixedDiameter: isCircle ? parseFloat(d.toFixed(1)) : parseFloat(l.toFixed(1)), 
        fixedWidth: isCircle ? null : parseFloat(w.toFixed(1)),
        fixedHeight: parseFloat(h.toFixed(1)) 
    };

    document.getElementById('globalShape').value = isCircle ? 'cylinder' : 'rectangle';
    updateTierUI();
    
    appState.tiers = [newTier];
    switchTab('calc');
    renderTierRows();
    
    setTimeout(() => {
        calculateInitial(); 
        const shapeName = isCircle ? `–ö—Ä—É–≥ D${Math.round(d)}` : `–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ ${Math.round(l)}x${Math.round(w)}`;
        alert(`‚úÖ –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ!\n–§–æ—Ä–º–∞: ${shapeName} —Å–º.\n–í—ã—Å–æ—Ç–∞: ${h} —Å–º.`);
    }, 200);
}

     // --- –§–£–ù–ö–¶–ò–Ø –õ–£–ü–´ –î–õ–Ø –§–ò–ì–£–† ---
function openShapeLightbox() {
    const sceneHtml = document.getElementById('sceneStage').outerHTML;
    const container = document.getElementById('lightboxSvgContainer');
    
    // –û—á–∏—â–∞–µ–º –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ü–µ–Ω—É
    container.innerHTML = '';
    
    // –°–æ–∑–¥–∞–µ–º –æ–±–µ—Ä—Ç–∫—É, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—É –∏ —Ü–µ–Ω—Ç—Ä–æ–≤–∫—É
    const wrapper = document.createElement('div');
    wrapper.style.cssText = `
        width: 100%; height: 100%; 
        display: flex; align-items: center; justify-content: center; 
        perspective: 1200px; overflow: visible;
    `;
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º —Å—Ü–µ–Ω—É –≤–Ω—É—Ç—Ä—å
    wrapper.innerHTML = sceneHtml;
    container.appendChild(wrapper);
    
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é —Å—Ü–µ–Ω—É –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –µ—ë (Zoom)
    const stage = wrapper.querySelector('.scene-stage');
    if (stage) {
        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–∞—Å—à—Ç–∞–± –≤ 1.5 —Ä–∞–∑–∞ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        stage.style.transform = "scale(1.8) rotateX(60deg) rotateZ(-45deg)";
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–∞–π—Ç–±–æ–∫—Å
    document.getElementById('cakeLightbox').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

  // --- –õ–û–ö–ê–õ–¨–ù–ê–Ø –ë–ê–ó–ê –§–û–¢–û (IndexedDB) ---
const dbName = "CakeProImages";
const storeName = "images";

const imageDB = {
    db: null,
    init: function() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(dbName, 1);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(storeName)) {
                    db.createObjectStore(storeName);
                }
            };
            request.onsuccess = (event) => {
                this.db = event.target.result;
                resolve(this.db);
            };
            request.onerror = (event) => reject("DB Error: " + event.target.errorCode);
        });
    },
    save: async function(id, base64) {
        if (!this.db) await this.init();
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction([storeName], "readwrite");
            const request = tx.objectStore(storeName).put(base64, id); // id –∑–∞–∫–∞–∑–∞ = –∫–ª—é—á
            request.onsuccess = () => resolve(true);
            request.onerror = () => reject(false);
        });
    },
    get: async function(id) {
        if (!this.db) await this.init();
        return new Promise((resolve) => {
            const tx = this.db.transaction([storeName], "readonly");
            const request = tx.objectStore(storeName).get(id);
            request.onsuccess = (event) => resolve(event.target.result);
            request.onerror = () => resolve(null);
        });
    },
    delete: async function(id) {
        if (!this.db) await this.init();
        const tx = this.db.transaction([storeName], "readwrite");
        tx.objectStore(storeName).delete(id);
    }
};

// –ó–∞–ø—É—Å–∫–∞–µ–º –±–∞–∑—É —Å—Ä–∞–∑—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
imageDB.init().then(() => console.log("üì∏ –ë–∞–∑–∞ —Ñ–æ—Ç–æ –≥–æ—Ç–æ–≤–∞"));

// ==========================================
// üïπÔ∏è –õ–û–ì–ò–ö–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ò –î–û–õ–ì–û–ì–û –ù–ê–ñ–ê–¢–ò–Ø
// ==========================================

let longPressTimer = null;
let editingOrderId = null; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø—Ä–∞–≤–∫–∏

function startLongPress(id) {
    // –ñ–¥–µ–º 800–º—Å. –ï—Å–ª–∏ –ø–∞–ª–µ—Ü –Ω–µ —É–±—Ä–∞–ª–∏ - –∑–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    longPressTimer = setTimeout(() => {
        // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–û—Ç–ø—É—Å–∫–∞–π—Ç–µ")
        const hint = document.getElementById('edit-hint-' + id);
        if(hint) hint.style.display = 'flex';
        
        // –í–∏–±—Ä–∞—Ü–∏—è
        if(navigator.vibrate) navigator.vibrate(50);
        
        // –ß–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –ø–∞—É–∑—É –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
        setTimeout(() => {
            if(hint) hint.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
            editOrderFromQueue(id);
        }, 300);
        
    }, 800);
}

function cancelLongPress() {
    if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
    }
    // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ —É—Å–ø–µ–ª–∏ –ø–æ—è–≤–∏—Ç—å—Å—è
    document.querySelectorAll('[id^="edit-hint-"]').forEach(el => el.style.display = 'none');
}

// --- –§–£–ù–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò –î–ê–ù–ù–´–• –í –û–ö–ù–û (–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï) ---
async function editOrderFromQueue(id) {
    const order = productionQueue.find(o => o.id === id);
    if (!order) return;

    editingOrderId = id; // –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

    // 1. –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
    const setVal = (elmId, val) => {
        const el = document.getElementById(elmId);
        if(el) el.value = val || '';
    };

    setVal('orderClientSearch', order.name);
    setVal('orderClientId', order.clientId); // –°–∫—Ä—ã—Ç—ã–π ID –∫–ª–∏–µ–Ω—Ç–∞
    
    setVal('orderReason', order.reason);
    setVal('orderForWhom', order.forWhom);
    setVal('orderPhone', order.phone);
    setVal('orderSocial', order.social);
    setVal('orderAddress', order.address);
    setVal('orderPrepayment', order.prepayment);
    setVal('orderBalance', order.balance);
    setVal('orderColor', order.color);
    setVal('orderDeadline', order.date);
    setVal('orderComment', order.comment);
    
    // –°–ø–∏—Å–∫–∏ (Select)
    const paySel = document.getElementById('orderPayment');
    if(paySel) paySel.value = order.payment || paySel.options[0].value;

    const delSel = document.getElementById('orderDelivery');
    if(delSel) delSel.value = order.delivery || delSel.options[0].value;

    // 2. –§–æ—Ç–æ (–†–µ—Ñ–µ—Ä–µ–Ω—Å) - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –¥–æ—Å—Ç–∞–µ–º –∏–∑ –±–∞–∑—ã —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    clearOrderImage(); 
    if (order.refImage === 'LOCAL_DB') {
        try {
            const base64 = await imageDB.get(id);
            if (base64) {
                currentOrderImageBase64 = base64;
                const img = document.getElementById('orderRefImg');
                const box = document.getElementById('orderRefPreviewBox');
                const btn = document.getElementById('btnDelRef');
                
                if(img) { img.src = base64; img.style.display = 'block'; }
                if(box) { 
                    const span = box.querySelector('span');
                    if(span) span.style.display = 'none';
                }
                if(btn) btn.style.display = 'inline-block';
            }
        } catch(e) { console.log('–ù–µ—Ç —Ñ–æ—Ç–æ –ª–æ–∫–∞–ª—å–Ω–æ', e); }
    }

    // 3. –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    const btn = document.querySelector('#orderFinalizeModal .main-btn');
    if(btn) {
        btn.innerText = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è";
        btn.style.background = "#1976D2"; // –°–∏–Ω–∏–π —Ü–≤–µ—Ç
    }

    // 4. –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
    document.getElementById('orderFinalizeModal').style.display = 'flex';
  checkDateLoad();
}
// ==========================================
// üîô –ù–ê–í–ò–ì–ê–¶–ò–Ø –ö–ù–û–ü–ö–û–ô "–ù–ê–ó–ê–î" (–°–¢–ê–ù–î–ê–†–¢–ù–ê–Ø)
// ==========================================

// –î–æ–±–∞–≤–ª—è–µ–º –æ–¥–Ω—É –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
// –Ω–µ –∑–∞–∫—Ä—ã–ª–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∂–µ –Ω–∞–∂–∞—Ç–∏–∏.
window.addEventListener('load', () => {
     window.history.pushState({ page: 'home' }, '', '');
});

window.addEventListener('popstate', (e) => {
    
    // 1. –ü–†–û–í–ï–†–ö–ê –û–ö–û–ù: –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, —Ñ–æ—Ç–æ –∏–ª–∏ —Ä–µ—Ü–µ–ø—Ç
    if (closeAnyOpenWindow()) {
        // –ú—ã –∑–∞–∫—Ä—ã–ª–∏ –æ–∫–Ω–æ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ, –Ω–æ –Ω–∞–∂–∞—Ç–∏–µ "–ù–∞–∑–∞–¥" —É–¥–∞–ª–∏–ª–æ –∑–∞–ø–∏—Å—å –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏.
        // –ß—Ç–æ–±—ã —Å–ª–µ–¥—É—é—â–µ–µ –Ω–∞–∂–∞—Ç–∏–µ —Å–Ω–æ–≤–∞ —Å—Ä–∞–±–æ—Ç–∞–ª–æ –≤–Ω—É—Ç—Ä–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, 
        // –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å.
        window.history.pushState({ page: 'modal_closed' }, '', '');
        return;
    }

    // 2. –ü–†–û–í–ï–†–ö–ê –í–ö–õ–ê–î–ö–ò: –ï—Å–ª–∏ –º—ã –Ω–µ –Ω–∞ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ
    const currentTab = document.querySelector('.nav-btn.active');
    if (currentTab && currentTab.id !== 'nav-tab1') {
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
        const calcBtn = document.getElementById('nav-tab1');
        if (calcBtn) calcBtn.click();
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–ª—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
        window.history.pushState({ page: 'home' }, '', '');
        return;
    }

    // 3. –§–ò–ù–ê–õ: –ú—ã –Ω–∞ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ –∏ –æ–∫–æ–Ω –Ω–µ—Ç.
    // –ú—ã –ù–ï –¥–µ–ª–∞–µ–º pushState.
    // –ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞ -> –ë—Ä–∞—É–∑–µ—Ä –∑–∞–∫—Ä–æ–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–ª–∏ —Å–≤–µ—Ä–Ω–µ—Ç –µ–≥–æ.
    // –≠—Ç–æ –æ–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
});

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –±—ã–ª–∞, –æ–Ω–∞ –Ω—É–∂–Ω–∞)
function closeAnyOpenWindow() {
    // –õ–∞–π—Ç–±–æ–∫—Å
    const lightbox = document.getElementById('cakeLightbox');
    if (lightbox && getComputedStyle(lightbox).display === 'flex') {
        closeLightbox();
        return true;
    }
    // –ú–æ–¥–∞–ª–∫–∏
    const visibleModal = Array.from(document.querySelectorAll('.modal-overlay')).find(el => {
        const style = getComputedStyle(el);
        return el.id !== 'loadingOverlay' && 
               (style.display === 'flex' || style.display === 'block') &&
               style.opacity !== '0' && style.visibility !== 'hidden';
    });
    if (visibleModal) {
        visibleModal.style.display = 'none';
        if (visibleModal.id === 'orderFinalizeModal') {
            if (typeof clearOrderImage === 'function') clearOrderImage();
            editingOrderId = null;
        }
        return true;
    }
    // –†–µ—Ü–µ–ø—Ç (–º–æ–±)
    const recipeLayout = document.querySelector('.recipe-layout.mobile-view-active');
    if (recipeLayout) {
        closeRecipeMobile();
        return true;
    }
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const notifPanel = document.getElementById('notifPanel');
    if (notifPanel && getComputedStyle(notifPanel).display === 'flex') {
        notifPanel.style.display = 'none';
        return true;
    }
    return false;
}

     // ==========================================
// üóÑÔ∏è –õ–û–ì–ò–ö–ê –ê–†–•–ò–í–ê
// ==========================================

function initArchiveDates() {
    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—Ç–∞–≤–∏–º: –ù–∞—á–∞–ª–æ –º–µ—Å—è—Ü–∞ - –°–µ–≥–æ–¥–Ω—è
    const date = new Date();
    const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º YYYY-MM-DD
    const toIso = (d) => d.toISOString().split('T')[0];
    
    const startEl = document.getElementById('archiveDateStart');
    const endEl = document.getElementById('archiveDateEnd');
    
    if (startEl && endEl) {
        startEl.value = toIso(firstDay);
        endEl.value = toIso(date);
    }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É –¥–∞—Ç –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
document.addEventListener('DOMContentLoaded', initArchiveDates);


function renderArchive() {
    const container = document.getElementById('archiveContainer');
    const countEl = document.getElementById('archiveTotalCount');
    if (!container) return;

    container.innerHTML = '';

    // –§–∏–ª—å—Ç—Ä—ã (–¥–∞—Ç—ã –∏ –ø–æ–∏—Å–∫)
    const startStr = document.getElementById('archiveDateStart').value;
    const endStr = document.getElementById('archiveDateEnd').value;
    const search = document.getElementById('archiveSearch').value.toLowerCase().trim();

    const startDate = startStr ? new Date(startStr) : new Date('2020-01-01');
    const endDate = endStr ? new Date(endStr) : new Date();
    endDate.setHours(23, 59, 59);

    let filtered = archiveOrders.filter(ord => {
        const dStr = ord.completedAt || ord.date;
        if (!dStr) return false;
        const d = new Date(dStr);
        if (d < startDate || d > endDate) return false;

        if (search) {
            const text = (ord.name + ' ' + (ord.reason || '') + ' ' + (ord.comment || '')).toLowerCase();
            let tiersText = "";
            if (ord.data && ord.data.tiers) {
                tiersText = ord.data.tiers.map(t => t.recipeName).join(' ').toLowerCase();
            }
            return text.includes(search) || tiersText.includes(search);
        }
        return true;
    });

    filtered.sort((a, b) => new Date(b.completedAt || b.date) - new Date(a.completedAt || a.date));
    countEl.innerText = filtered.length;

    if (filtered.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:30px; color:#999;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ü§∑‚Äç‚ôÇÔ∏è</div>';
        return;
    }

    filtered.forEach(item => {
        const dateStr = item.completedAt ? new Date(item.completedAt).toLocaleDateString() : item.date;
        const price = Math.round(item.price).toLocaleString();
        const currency = SYMBOLS[currentCurrency] || '';

        // 1. –§–∏–∑–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        let paramsHtml = "";
        if (item.data && item.data.tiers) {
            paramsHtml = item.data.tiers.map((t, i) => {
                const shape = item.data.geometry.shape;
                const size = (shape === 'rectangle') ? `${Math.round(t.d)}x${Math.round(t.w)}` : `D${Math.round(t.d)}`;
                return `<div style="font-size:12px; color:#444;">‚Ä¢ ${t.recipeName} (${size} —Å–º, H${Math.round(t.h)} —Å–º)</div>`;
            }).join('');
            paramsHtml += `<div style="font-size:12px; font-weight:bold; margin-top:3px; color:#555;">–í–µ—Å: ${item.weight} –∫–≥</div>`;
        }

        // 2. –î–µ–∫–æ—Ä
        let decorHtml = "";
        if (item.comment) {
            decorHtml = `<div style="margin-top:8px; padding:6px; background:#fff8e1; border-radius:4px; font-size:12px; color:#795548; font-style:italic;">üé® ${item.comment}</div>`;
        }

        // 3. –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
        const clientLink = `<span onclick="openClientModal('${item.clientId}'); event.stopPropagation();" style="color:#1976D2; cursor:pointer; text-decoration:underline;">${item.name}</span>`;

        // 4. –ö–Ω–æ–ø–∫–∞ —Ñ–æ—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        let photoBtn = '';
        if (item.refImage) {
            photoBtn = `<button onclick="viewOrderRef('${item.id}')" style="background:#E8F5E9; color:#2E7D32; border:1px solid #C8E6C9; padding:5px 12px; border-radius:20px; font-size:12px; cursor:pointer; font-weight:bold; display:flex; align-items:center; gap:5px;">üì∑ –ò—Ç–æ–≥</button>`;
        } else {
            photoBtn = `<span style="font-size:11px; color:#ccc;">–ë–µ–∑ —Ñ–æ—Ç–æ</span>`;
        }

        container.innerHTML += `
        <div style="background:white; border:1px solid #eee; border-left:4px solid #607D8B; border-radius:8px; padding:12px; margin-bottom:12px; box-shadow:0 2px 5px rgba(0,0,0,0.03);">
            <div style="display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px dashed #eee; padding-bottom:5px;">
                <div style="font-size:12px; color:#666;">üìÖ ${dateStr}</div>
                <div style="font-weight:bold; color:#333;">${price} ${currency}</div>
            </div>
            
            <div style="font-size:15px; font-weight:bold; margin-bottom:5px; color:#000;">
                ${clientLink} 
                <span style="font-weight:normal; color:#888; font-size:13px;">(${item.reason || '–ó–∞–∫–∞–∑'})</span>
            </div>
            
            <div style="background:#fafafa; padding:8px; border-radius:6px; margin-bottom:5px;">
                ${paramsHtml || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–æ—Å—Ç–∞–≤–µ'}
            </div>

            ${decorHtml}

            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; gap:10px;">
                <div>${photoBtn}</div>
                
                <div style="display:flex; gap:8px;">
                    <button onclick="repeatOrder('${item.id}')" 
                            style="background:#f5f5f5; color:#555; border:1px solid #ddd; padding:5px 10px; border-radius:4px; font-size:12px; cursor:pointer; font-weight:bold;">
                        üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                    </button>
                    
                    <button onclick="deleteOrderFromHistory('${item.clientId}', '${item.id}')" 
                            style="background:#fff; color:#d32f2f; border:1px solid #ffcdd2; padding:5px 10px; border-radius:4px; font-size:12px; cursor:pointer; font-weight:bold;"
                            title="–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –∏ –∞—Ä—Ö–∏–≤–∞">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
        </div>`;
    });
}
// –§—É–Ω–∫—Ü–∏—è –ø–æ–≤—Ç–æ—Ä–∞ –∑–∞–∫–∞–∑–∞ (–ö–æ–ø–∏—Ä—É–µ—Ç –∏–∑ –∞—Ä—Ö–∏–≤–∞ –≤ –ü–ª–∞–Ω)
function repeatOrder(id) {
    const oldOrder = archiveOrders.find(o => o.id === id);
    if (!oldOrder) return;

    if (!confirm(`–°–æ–∑–¥–∞—Ç—å –∫–æ–ø–∏—é –∑–∞–∫–∞–∑–∞ "${oldOrder.reason}" –¥–ª—è ${oldOrder.name} –≤ –ü–ª–∞–Ω?`)) return;

    // –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é
    const newOrder = JSON.parse(JSON.stringify(oldOrder));
    
    newOrder.id = 'ord_' + Date.now(); // –ù–æ–≤—ã–π ID
    newOrder.date = new Date().toISOString().split('T')[0]; // –î–∞—Ç–∞ - —Å–µ–≥–æ–¥–Ω—è
    newOrder.status = 'pending'; // –°—Ç–∞—Ç—É—Å - –≤ –æ–∂–∏–¥–∞–Ω–∏–∏
    delete newOrder.completedAt; // –£–±–∏—Ä–∞–µ–º –¥–∞—Ç—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    newOrder.progress = { bake: false, assemble: false, decor: false, pack: false };

    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –ø–ª–∞–Ω
    productionQueue.push(newOrder);
    saveQueue();
    
    alert("‚úÖ –ó–∞–∫–∞–∑ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –ü–ª–∞–Ω! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –µ–≥–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (–¥–∞—Ç—É –∏ –¥–µ—Ç–∞–ª–∏).");
    switchTab('production'); // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–ª–∞–Ω
}

// ==========================================
// üî¢ SHAPE CALCULATOR 2.0 (–§–ò–ì–£–†–´) - NEW CORE
// ==========================================

let shapeCalcState = {
    imgData: null,
    fillRate: 0,      // –î–æ–ª—è –ø–ª–æ—â–∞–¥–∏ —Ñ–∏–≥—É—Ä—ã –≤ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–µ (0.0 - 1.0)
    perimeterRatio: 0,// –û—Ç–Ω–æ—à–µ–Ω–∏–µ –ø–µ—Ä–∏–º–µ—Ç—Ä–∞ –∫ (W+H)*2
    aspectRatio: 1,   // W / H
    
    // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
    lastResult: null
};

// 1. –ê–ù–ê–õ–ò–ó –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø (Canvas)
function analyzeShapeImage(input) {
    const file = input.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            processShapeCanvas(img);
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function processShapeCanvas(img) {
    const cvs = document.getElementById('shapeAnalysisCanvas');
    const ctx = cvs.getContext('2d');
    
    // –§–∏–∫—Å–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    const w = 400; 
    const h = Math.round(w * (img.height / img.width));
    cvs.width = w;
    cvs.height = h;
    
    ctx.drawImage(img, 0, 0, w, h);
    
    const imgData = ctx.getImageData(0,0,w,h);
    const data = imgData.data;
    
    let solidPixels = 0;
    let edgePixels = 0; // –†–µ–∞–ª—å–Ω—ã–µ –ø–∏–∫—Å–µ–ª–∏ –≥—Ä–∞–Ω–∏—Ü—ã
    let minX=w, maxX=0, minY=h, maxY=0;
    
    // –•–µ–ª–ø–µ—Ä: –ø—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–∫—Ä–∞—à–µ–Ω –ª–∏ –ø–∏–∫—Å–µ–ª—å
    const isSolid = (x, y) => {
        if (x<0 || x>=w || y<0 || y>=h) return false;
        const i = (y*w+x)*4;
        const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3];
        // –°—á–∏—Ç–∞–µ–º —Ç–≤–µ—Ä–¥—ã–º –≤—Å—ë, —á—Ç–æ –Ω–µ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–µ –∏ –Ω–µ —á–∏—Å—Ç–æ –±–µ–ª–æ–µ
        return (a > 50 && !(r>230 && g>230 && b>230));
    };

    // –ü—Ä–æ—Ö–æ–¥ –ø–æ –≤—Å–µ–º –ø–∏–∫—Å–µ–ª—è–º
    for(let y=0; y<h; y++) {
        for(let x=0; x<w; x++) {
            if (isSolid(x, y)) {
                solidPixels++;
                
                // –ï—Å–ª–∏ —Ö–æ—Ç—å –æ–¥–∏–Ω —Å–æ—Å–µ–¥ –ø—É—Å—Ç–æ–π ‚Äî —ç—Ç–æ –≥—Ä–∞–Ω–∏—Ü–∞
                if (!isSolid(x+1, y) || !isSolid(x-1, y) || !isSolid(x, y+1) || !isSolid(x, y-1)) {
                    edgePixels++;
                }

                if(x < minX) minX = x;
                if(x > maxX) maxX = x;
                if(y < minY) minY = y;
                if(y > maxY) maxY = y;
            } else {
                const i = (y*w+x)*4;
                data[i+3] = 0; 
            }
        }
    }
    
    const realW = maxX - minX;
    const realH = maxY - minY;
    
    if (realW <= 0 || realH <= 0) { alert("–§–∏–≥—É—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"); return; }
    
    // –í–∏–∑—É–∞–ª—å–Ω—ã–π –∫—Ä–æ–ø
    const tempCvs = document.createElement('canvas');
    tempCvs.width = realW;
    tempCvs.height = realH;
    const tempCtx = tempCvs.getContext('2d');
    tempCtx.putImageData(imgData, -minX, -minY); 
    
    cvs.width = realW;
    cvs.height = realH;
    ctx.drawImage(tempCvs, 0, 0);
    shapeState.cleanImgUrl = cvs.toDataURL();

    // --- –ß–ò–°–¢–ê–Ø –ú–ê–¢–ï–ú–ê–¢–ò–ö–ê ---
    // 1. –ü–ª–æ—â–∞–¥—å —Ä–∞–º–∫–∏ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
    const boundingAreaPx = realW * realH;
    // 2. –ü—Ä–æ—Ü–µ–Ω—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è (–¥–ª—è –ø–ª–æ—â–∞–¥–∏ –≤–µ—Ä—Ö–∞)
    const fillRate = solidPixels / boundingAreaPx;
    
    // 3. –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–µ—Ä–∏–º–µ—Ç—Ä–∞ (–Ω–∞—Å–∫–æ–ª—å–∫–æ –ø–µ—Ä–∏–º–µ—Ç—Ä —Ñ–∏–≥—É—Ä—ã –±–æ–ª—å—à–µ –ø–µ—Ä–∏–º–µ—Ç—Ä–∞ —Ä–∞–º–∫–∏)
    // –ü–µ—Ä–∏–º–µ—Ç—Ä —Ä–∞–º–∫–∏ –≤ –ø–∏–∫—Å–µ–ª—è—Ö:
    const boundingPerimPx = 2 * (realW + realH);
    // –û—Ç–Ω–æ—à–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç—É—Ä–∞ –∫ —Ä–∞–º–∫–µ:
    // (–ò—Å–ø–æ–ª—å–∑—É–µ–º edgePixels –∫–∞–∫ –¥–ª–∏–Ω—É)
    let perimeterRatio = edgePixels / boundingPerimPx;
    
    // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞ "–ø–∏–∫—Å–µ–ª—å–Ω—É—é –ª–µ—Å–µ–Ω–∫—É" (–≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–π —Ñ–∞–∫—Ç: –ª–∏–Ω–∏—è –∏–∑ –ø–∏–∫—Å–µ–ª–µ–π –≤—Å–µ–≥–¥–∞ –∫–æ—Ä–æ—á–µ —Ä–µ–∞–ª—å–Ω–æ–π –∫—Ä–∏–≤–æ–π –ø—Ä–∏–º–µ—Ä–Ω–æ –≤ 1.2 —Ä–∞–∑–∞)
    // –ù–æ –Ω–∏–∫–∞–∫–∏—Ö "1.5 –∑–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç—å". –¢–æ–ª—å–∫–æ –≥–µ–æ–º–µ—Ç—Ä–∏—è.
    perimeterRatio = perimeterRatio * 1.15; 

    if (perimeterRatio < 1.0) perimeterRatio = 1.0;

    shapeCalcState.fillRate = fillRate;
    shapeCalcState.aspectRatio = realW / realH;
    shapeCalcState.perimeterRatio = perimeterRatio;
    
    // UI
    document.getElementById('lblFillRate').innerText = Math.round(fillRate * 100) + '%';
    document.getElementById('lblAspectRatio').innerText = (realW / realH).toFixed(2);
    document.getElementById('lblPerimFactor').innerText = perimeterRatio.toFixed(2);
    
    document.getElementById('shapeAnalysisBlock').style.display = 'block';
    
    if(typeof generateShapeLayers === 'function') generateShapeLayers(shapeState.cleanImgUrl);
    fillShapeRecipes();
    setTimeout(calculateShapeOrder, 100);
}
  
function fillShapeRecipes() {
    const selMain = document.getElementById('shapeRecipeSelectMain');
    const selCoat = document.getElementById('shapeCoatingSelect');
    if(selMain.options.length > 0) return;
    
    // –ù–∞—á–∏–Ω–∫–∏
    myRecipes.filter(r => r.type === 'filling').forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.id;
        opt.innerText = r.name;
        selMain.appendChild(opt);
    });
    
    // –ü–æ–∫—Ä—ã—Ç–∏—è
    selCoat.innerHTML = '<option value="">-- –ë–µ–∑ –ø–æ–∫—Ä—ã—Ç–∏—è --</option>';
    myRecipes.filter(r => r.type === 'coating').forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.id;
        opt.innerText = r.name;
        selCoat.appendChild(opt);
    });
}


     function calculateShapeOrder() {
    if(!shapeCalcState.fillRate) { alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ!"); return; }
    
    const targetWeight = parseFloat(document.getElementById('shapeTargetWeight').value) * 1000;
    const targetH = parseFloat(document.getElementById('shapeTargetHeight').value);
    const coatingThickCm = (parseFloat(document.getElementById('shapeCoatingThick').value) || 0) / 10;
    
    const recId = document.getElementById('shapeRecipeSelectMain').value;
    const coatId = document.getElementById('shapeCoatingSelect').value;
    
    const recipe = myRecipes.find(r => r.id === recId);
    const coating = myRecipes.find(r => r.id === coatId);
    
    if (!recipe) return; // –ó–∞—â–∏—Ç–∞ –µ—Å–ª–∏ —Ä–µ—Ü–µ–ø—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω

    // 1. –ê–ù–ê–õ–ò–ó –ü–†–û–ü–û–†–¶–ò–ô (–ë–∏—Å–∫–≤–∏—Ç vs –ù–∞—á–∏–Ω–∫–∞)
    let spongeRatio = 0; 
    let totalRecW = parseFloat(recipe.outputWeight) || 0;
    
    if (recipe.blocks) {
        let spongeW = 0;
        let calculatedTotalW = 0;

        recipe.blocks.forEach(b => {
            const bName = b.name.toLowerCase();
            let blockW = 0;
            
            b.ingredients.forEach(i => {
                 // –ß–∏—Å—Ç–∏–º –≤–µ—Å –æ—Ç –º—É—Å–æ—Ä–∞
                 let w = parseFloat(String(i.weight).replace(',','.'));
                 if (isNaN(w)) w = 0;
                 
                 // –ï—Å–ª–∏ —è–π—Ü–∞ –≤ —à—Ç, –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ –≥—Ä–∞–º–º—ã –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
                 const ing = myIngredients.find(mi => mi.id === i.id);
                 if (ing && ing.unit === '—à—Ç' && (!i.outputWeight && w < 50)) {
                     w = w * (ing.singleWeight || 55); 
                 }
                 blockW += w;
            });
            
            calculatedTotalW += blockW;

            // –ò—â–µ–º –±–∏—Å–∫–≤–∏—Ç
            if (bName.includes('–±–∏—Å–∫–≤–∏—Ç') || bName.includes('–∫–æ—Ä–∂') || bName.includes('—Ç–µ—Å—Ç–æ') || bName.includes('–≤—ã–ø–µ—á–∫–∞')) {
                spongeW += blockW;
            }
        });

        // –ï—Å–ª–∏ –æ–±—â–∏–π –≤–µ—Å –≤ —Ä–µ—Ü–µ–ø—Ç–µ –Ω–µ –∑–∞–¥–∞–Ω, –±–µ—Ä–µ–º —Å—É–º–º—É –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
        if (totalRecW === 0) totalRecW = calculatedTotalW;
        
        if (totalRecW > 0) {
            spongeRatio = spongeW / totalRecW;
        }
    }

    // –ó–ê–©–ò–¢–ê: –ï—Å–ª–∏ –±–∏—Å–∫–≤–∏—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω (–Ω–∞–∑–≤–∞–ª–∏ "–û—Å–Ω–æ–≤–∞") –∏–ª–∏ —Ä–∞–≤–µ–Ω 0,
    // —Å—Ç–∞–≤–∏–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ 40% (0.4), –∏–Ω–∞—á–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å–ª–æ–º–∞–µ—Ç—Å—è.
    if (spongeRatio < 0.1 || spongeRatio > 0.9) {
        console.log("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–µ—Å –±–∏—Å–∫–≤–∏—Ç–∞, –±–µ—Ä–µ–º —Å—Ä–µ–¥–Ω–µ–µ 40%");
        spongeRatio = 0.4;
    }
    const fillingRatio = 1 - spongeRatio;

    // –ü–ª–æ—Ç–Ω–æ—Å—Ç–∏
    const recDensity = analyzeRecipeDensity(recipe).density || 0.8;
    let coatDensity = 1.2; 
    if(coating) {
        coatDensity = analyzeRecipeDensity(coating).density || 1.2;
    }
    
    // 2. –ü–û–î–ë–û–† –†–ê–ó–ú–ï–†–ê
    let W = 10; 
    let finalData = { L:0, W:0, H:0, weightCoat:0, weightInner:0, weightTotal:0, grossSponge:0 };
    
    for(let i=0; i<50; i++) {
        const L = W * shapeCalcState.aspectRatio;
        
        // –ì–µ–æ–º–µ—Ç—Ä–∏—è —Ä–∞–º–∫–∏
        const rectPerim = 2 * (L + W);
        const rectArea = L * W;
        
        // –ì–µ–æ–º–µ—Ç—Ä–∏—è —Ñ–∏–≥—É—Ä—ã
        const shapeTopArea = rectArea * shapeCalcState.fillRate;
        const shapePerim = rectPerim * shapeCalcState.perimeterRatio;
        
        // –ü–æ–∫—Ä—ã—Ç–∏–µ
        const sideArea = shapePerim * targetH;
        const totalSurfaceArea = shapeTopArea + sideArea;
        
        const coatVol = totalSurfaceArea * coatingThickCm;
        const weightCoat = (coatId) ? (coatVol * coatDensity) : 0;
        
        // –í–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏
        const weightInnerTarget = targetWeight - weightCoat;
        
        if (weightInnerTarget <= 0) { W *= 1.1; continue; }

        // –û–±—ä–µ–º –∏ –≤—ã—Å–æ—Ç–∞
        const volNeeded = weightInnerTarget / recDensity;
        // const calcH = volNeeded / shapeTopArea; // (–Ω–∞–º H –∑–∞–¥–∞–Ω–∞, –ø–æ–¥–≥–æ–Ω—è–µ–º W)
        
        const weightInnerCalc = (shapeTopArea * targetH) * recDensity;
        const totalCalc = weightInnerCalc + weightCoat;
        
        if (Math.abs(totalCalc - targetWeight) < 10) {
            // --- –§–ò–ù–ê–õ ---
            const netInnerWeight = weightInnerCalc;
            
            // –ß–∏—Å—Ç—ã–π –≤–µ—Å –±–∏—Å–∫–≤–∏—Ç–∞ (–≤ —Ñ–∏–≥—É—Ä–µ)
            const netSpongeWeight = netInnerWeight * spongeRatio;
            
            // –ì—Ä—è–∑–Ω—ã–π –≤–µ—Å –±–∏—Å–∫–≤–∏—Ç–∞ (–Ω–∞ –ª–∏—Å—Ç)
            let grossSpongeWeight = netSpongeWeight / shapeCalcState.fillRate;
            
            if (!isFinite(grossSpongeWeight) || isNaN(grossSpongeWeight)) grossSpongeWeight = 0;

            finalData = {
                L: L, W: W, H: targetH,
                weightCoat: weightCoat,
                weightInner: netInnerWeight, 
                weightTotal: totalCalc,
                grossSponge: grossSpongeWeight, 
                netFilling: netInnerWeight * fillingRatio 
            };
            break;
        }
        
        const ratio = targetWeight / totalCalc;
        W = W * Math.sqrt(ratio);
    }
    
    shapeCalcState.lastResult = finalData;
    renderShapeResult(finalData, recipe, coating);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º 3D (–µ—Å–ª–∏ —Ä–∞–∑–º–µ—Ä—ã –≤–∞–ª–∏–¥–Ω—ã)
    if (finalData.L > 0 && finalData.W > 0) {
        updateShape3DScene(finalData.L, finalData.W, finalData.H);
    }
}
     
// –•–µ–ª–ø–µ—Ä: –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏
function analyzeRecipeDensity(r) {
    if(!r) return { density: 0.8 }; // –î–µ—Ñ–æ–ª—Ç, –µ—Å–ª–∏ —Ä–µ—Ü–µ–ø—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω
    
    // –ë–µ—Ä–µ–º –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    const d = parseFloat(r.calibrationD) || 16;
    const h = parseFloat(r.calibrationH) || 10;
    const w = parseFloat(r.outputWeight) || 1000;
    
    // –û–±—ä–µ–º —Ü–∏–ª–∏–Ω–¥—Ä–∞: Pi * r^2 * h
    const vol = Math.PI * Math.pow(d/2, 2) * h;
    
    if (vol <= 0) return { density: 0.8 }; // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å
    
    return { density: w / vol };
}
// 3. –í–´–í–û–î –†–ï–ó–£–õ–¨–¢–ê–¢–ê
function renderShapeResult(d, rec, coat) {
    document.getElementById('resShapeDims').innerText = `${Math.round(d.L)} x ${Math.round(d.W)} x ${d.H} —Å–º`;
    
    // –ó–∞—â–∏—Ç–∞ –æ—Ç NaN –ø—Ä–∏ –≤—ã–≤–æ–¥–µ
    const safe = (val) => (!isFinite(val) || isNaN(val)) ? 0 : Math.round(val);
    
    document.getElementById('resSpongeWeight').innerText = safe(d.grossSponge) + ' –≥';
    document.getElementById('resFillingWeight').innerText = safe(d.weightInner) + ' –≥'; // –≠—Ç–æ –æ–±—â–∏–π –≤–µ—Å, –Ω–æ –ª–æ–≥–∏—á–µ—Å–∫–∏ —ç—Ç–æ "–≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏"
    document.getElementById('resCoatingWeight').innerText = safe(d.weightCoat) + ' –≥';
    
    // –û–±—Ä–µ–∑–∫–∏ = –ì—Ä—è–∑–Ω—ã–π –ë–∏—Å–∫–≤–∏—Ç - –ß–∏—Å—Ç—ã–π –ë–∏—Å–∫–≤–∏—Ç
    // –ß–∏—Å—Ç—ã–π –±–∏—Å–∫–≤–∏—Ç = –ì—Ä—è–∑–Ω—ã–π * FillRate
    const netSponge = d.grossSponge * shapeCalcState.fillRate;
    const waste = d.grossSponge - netSponge;
    
    document.getElementById('resWasteWeight').innerText = safe(waste);
    
    // –¶–µ–Ω—É –ø–æ–∫–∞ –Ω–µ —Å—á–∏—Ç–∞–µ–º —Ç—É—Ç, –æ–Ω–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –ø–ª–∞–Ω
    document.getElementById('resFinalPrice').innerText = '---'; 
    
    document.getElementById('shapeResultBlock').style.display = 'block';
    document.getElementById('shapeResultBlock').scrollIntoView({behavior:'smooth'});
}

// 4. –î–û–ë–ê–í–õ–ï–ù–ò–ï –í –ü–õ–ê–ù (–°–ê–ú–û–ï –í–ê–ñ–ù–û–ï)
function addShapeToQueue() {
    const res = shapeCalcState.lastResult;
    if(!res) { alert("–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞!"); return; }
    
    const recId = document.getElementById('shapeRecipeSelectMain').value;
    const coatId = document.getElementById('shapeCoatingSelect').value;
    const recipe = myRecipes.find(r => r.id === recId);
    const coating = myRecipes.find(r => r.id === coatId);
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ (—Å—É–º–º–∏—Ä—É–µ–º –≤—Å—ë —Å—é–¥–∞)
    const shoppingList = [];
    let totalPrice = 0;

    // –ú–∞—Å—Å–∏–≤ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ (–±–ª–æ–∫–æ–≤)
    const detailedBlocks = [];

    // --- –§–ê–ó–ê 1: –û–ë–†–ê–ë–û–¢–ö–ê –û–°–ù–û–í–ù–û–ì–û –†–ï–¶–ï–ü–¢–ê ---
    if(recipe.blocks) {
        recipe.blocks.forEach(b => {
            const bName = b.name.toLowerCase();
            
            // 1. –û–ü–†–ï–î–ï–õ–Ø–ï–ú –¢–ò–ü –ë–õ–û–ö–ê (–ë–∏—Å–∫–≤–∏—Ç –∏–ª–∏ –ù–∞—á–∏–Ω–∫–∞?)
            const isSponge = bName.includes('–±–∏—Å–∫–≤–∏—Ç') || bName.includes('–∫–æ—Ä–∂') || bName.includes('—Ç–µ—Å—Ç–æ') || bName.includes('–≤—ã–ø–µ—á–∫–∞');
            
            // 2. –°–ß–ò–¢–ê–ï–ú –í–ï–° –≠–¢–û–ì–û –ë–õ–û–ö–ê –í –†–ï–¶–ï–ü–¢–ï (–î–ª—è –º–∞—Å—à—Ç–∞–±–∞)
            let blockWeightInRecipe = 0;
            b.ingredients.forEach(i => {
                let w = parseFloat(String(i.weight).replace(',', '.')) || 0;
                // –ï—Å–ª–∏ —è–π—Ü–∞ –≤ —à—Ç, —Å—á–∏—Ç–∞–µ–º –∏—Ö –≤–µ—Å ~55–≥ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
                const ingDb = myIngredients.find(x => x.id === i.id);
                if (ingDb && ingDb.unit === '—à—Ç' && (!i.outputWeight && w < 50)) {
                    w = w * 55;
                }
                blockWeightInRecipe += w;
            });

            // –ï—Å–ª–∏ –≤–µ—Å –±–ª–æ–∫–∞ 0 (–æ—à–∏–±–∫–∞ –≤ —Ä–µ—Ü–µ–ø—Ç–µ), –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            if (blockWeightInRecipe <= 0) return;

            // 3. –í–´–ß–ò–°–õ–Ø–ï–ú –ú–ê–°–®–¢–ê–ë (Scale)
            let scale = 0;
            if (isSponge) {
                // –ë–ò–°–ö–í–ò–¢: –ù–∞–º –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å res.grossSponge (–≤–µ—Å –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞)
                // –ó–Ω–∞—á–∏—Ç: (–í–µ—Å_–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞) / (–í–µ—Å_–≠—Ç–æ–≥–æ_–ë–ª–æ–∫–∞_–í_–†–µ—Ü–µ–ø—Ç–µ)
                // –ù–û! res.grossSponge - —ç—Ç–æ –≤–µ—Å –í–°–ï–• –±–∏—Å–∫–≤–∏—Ç–Ω—ã—Ö —á–∞—Å—Ç–µ–π. 
                // –ï—Å–ª–∏ –≤ —Ä–µ—Ü–µ–ø—Ç–µ 2 –±–∏—Å–∫–≤–∏—Ç–∞, –Ω–∞–¥–æ –¥–µ–ª–∏—Ç—å –Ω–∞ –∏—Ö –°–£–ú–ú–£.
                // –£–ø—Ä–æ—Å—Ç–∏–º: –°—á–∏—Ç–∞–µ–º –¥–æ–ª—é —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞ –≤ "–æ–±—â–µ–º –±–∏—Å–∫–≤–∏—Ç–µ —Ä–µ—Ü–µ–ø—Ç–∞".
                // –ù–æ –µ—â–µ –ø—Ä–æ—â–µ –∏ –Ω–∞–¥–µ–∂–Ω–µ–µ:
                // –ú—ã –∑–Ω–∞–µ–º, —á—Ç–æ res.grossSponge - —ç—Ç–æ –≤–µ—Å –í–°–ï–ì–û —Ç–µ—Å—Ç–∞ –Ω–∞ –ª–∏—Å—Ç.
                // –ú—ã –∑–Ω–∞–µ–º spongeRatio (–¥–æ–ª—é —Ç–µ—Å—Ç–∞ –≤ —Ä–µ—Ü–µ–ø—Ç–µ).
                // Scale = res.grossSponge / (recipe.outputWeight * spongeRatio)
                // –ò–ª–∏ –µ—â–µ –ø—Ä–æ—â–µ:
                // Scale = (–í–µ—Å –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞) / (–í–µ—Å –±–∏—Å–∫–≤–∏—Ç–∞ –≤ –æ–¥–Ω–æ–π –ø–æ—Ä—Ü–∏–∏ —Ä–µ—Ü–µ–ø—Ç–∞)
                
                // –ß—Ç–æ–±—ã –Ω–µ —Å—á–∏—Ç–∞—Ç—å spongeRatio –∑–∞–Ω–æ–≤–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—É—é –ª–æ–≥–∏–∫—É:
                // Scale = (–í–µ—Å –ß–∏—Å—Ç–æ–≥–æ –ë–∏—Å–∫–≤–∏—Ç–∞ –≤ —Ñ–∏–≥—É—Ä–µ) / (–í–µ—Å —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞) / FillRate
                
                // –°—á–∏—Ç–∞–µ–º —á–∏—Å—Ç—ã–π –≤–µ—Å —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞ –≤–Ω—É—Ç—Ä–∏ —Ñ–∏–≥—É—Ä—ã (–ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
                const blockShareInNet = blockWeightInRecipe / parseFloat(recipe.outputWeight);
                const netWeightOfBlock = res.weightInner * blockShareInNet; // –í–µ—Å —ç—Ç–æ–≥–æ –∫—Ä–µ–º–∞/–±–∏—Å–∫–≤–∏—Ç–∞ –≤–Ω—É—Ç—Ä–∏ —Ñ–∏–≥—É—Ä—ã
                
                // –ê —Ç–µ–ø–µ—Ä—å –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ –≥—Ä—è–∑–Ω—ã–π (–¥–µ–ª–∏–º –Ω–∞ FillRate)
                scale = (netWeightOfBlock / shapeCalcState.fillRate) / blockWeightInRecipe;
                
            } else {
                // –ù–ê–ß–ò–ù–ö–ê: –ü—Ä–æ—Å—Ç–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –ø–æ–¥ –≤–µ—Å "–≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π" —Ñ–∏–≥—É—Ä—ã
                const blockShare = blockWeightInRecipe / parseFloat(recipe.outputWeight);
                const targetBlockWeight = res.weightInner * blockShare;
                scale = targetBlockWeight / blockWeightInRecipe;
            }

            // 4. –°–û–ë–ò–†–ê–ï–ú –ò–ù–ì–†–ï–î–ò–ï–ù–¢–´ –ë–õ–û–ö–ê
            const blockIngs = [];
            let blockCost = 0;

            b.ingredients.forEach(i => {
                const ing = myIngredients.find(x => x.id === i.id);
                if(ing) {
                    // –§–∏–∫—Å —è–∏—Ü (–≥—Ä–∞–º–º -> —à—Ç –¥–ª—è –∑–∞–∫—É–ø–∞)
                    let rawWeight = parseFloat(String(i.weight).replace(',', '.')) || 0;
                    if (ing.unit === '—à—Ç' && (ing.useWeightInRecipe || rawWeight > 30)) {
                        rawWeight = rawWeight / (ing.singleWeight || 55);
                    }

                    const amount = rawWeight * scale;
                    const price = amount * (ing.packPrice / ing.packWeight);
                    
                    // –í –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ (—Å—É–º–º–∏—Ä—É–µ–º)
                    const existing = shoppingList.find(x => x.id === ing.id);
                    if (existing) { existing.amount += amount; existing.cost += price; }
                    else { shoppingList.push({ id: ing.id, name: ing.name, amount: amount, unit: ing.unit, cost: price }); }
                    
                    totalPrice += price;

                    // –í –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é –±–ª–æ–∫–∞
                    blockIngs.push({
                        name: ing.name,
                        amount: Math.round(amount*100)/100,
                        unit: ing.unit,
                        cost: Math.ceil(price)
                    });
                    blockCost += price;
                }
            });

            // 5. –î–û–ë–ê–í–õ–Ø–ï–ú –ë–õ–û–ö –í –û–¢–ß–ï–¢ (–ö–ê–ö –ï–°–¢–¨, –ù–ï –°–ú–ï–®–ò–í–ê–Ø)
            detailedBlocks.push({
                name: isSponge ? `üç∞ ${b.name} (–í—ã–ø–µ—á–∫–∞ –Ω–∞ –ª–∏—Å—Ç)` : `ü•£ ${b.name} (–í —Ñ–∏–≥—É—Ä—É)`,
                type: isSponge ? 'filling' : 'filling',
                totalCost: Math.ceil(blockCost),
                ingredients: blockIngs
            });
        });
    }
    
    // --- –§–ê–ó–ê 2: –û–ë–†–ê–ë–û–¢–ö–ê –ü–û–ö–†–´–¢–ò–Ø ---
    if(coating && coating.blocks) {
        const coatOutput = parseFloat(coating.outputWeight) || 500;
        const scaleCoating = res.weightCoat / coatOutput; // –ú–∞—Å—à—Ç–∞–± –æ—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–æ–≥–æ –≤–µ—Å–∞ –ø–æ–∫—Ä—ã—Ç–∏—è

        coating.blocks.forEach(b => {
            const blockIngs = [];
            let blockCost = 0;
            
            b.ingredients.forEach(i => {
                const ing = myIngredients.find(x => x.id === i.id);
                if(ing) {
                    let rawWeight = parseFloat(i.weight) || 0;
                    if (ing.unit === '—à—Ç' && (ing.useWeightInRecipe || rawWeight > 30)) rawWeight /= (ing.singleWeight || 55);

                    const amount = rawWeight * scaleCoating;
                    const price = amount * (ing.packPrice / ing.packWeight);
                    
                    const existing = shoppingList.find(x => x.id === ing.id);
                    if (existing) { existing.amount += amount; existing.cost += price; }
                    else { shoppingList.push({ id: ing.id, name: ing.name, amount: amount, unit: ing.unit, cost: price }); }
                    
                    totalPrice += price;
                    
                    blockIngs.push({ name: ing.name, amount: Math.round(amount*100)/100, unit: ing.unit, cost: Math.ceil(price) });
                    blockCost += price;
                }
            });
            
            detailedBlocks.push({
                name: `üé® ${coating.name} (–ü–æ–∫—Ä—ã—Ç–∏–µ)`,
                type: 'coating',
                totalCost: Math.ceil(blockCost),
                ingredients: blockIngs
            });
        });
    }
    
    // –û–∫—Ä—É–≥–ª—è–µ–º –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫
    shoppingList.forEach(i => { i.amount = Math.round(i.amount*100)/100; i.cost = Math.ceil(i.cost); });

    // –§–∏–Ω–∞–Ω—Å—ã
    const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;
    const laborCost = (currentLaborList || []).reduce((s,l) => s + (l.realHours*l.coeff*hourlyRate), 0);
    const totalCost = totalPrice + laborCost;
    
    // –°–±–æ—Ä–∫–∞ –æ–±—ä–µ–∫—Ç–∞
    const shapeData = {
        isShapeCake: true, 
        geometry: { shape: 'custom_shape', d: Math.round(res.L), w: Math.round(res.W), h: res.H },
        weights: { total: res.weightTotal, filling: res.weightInner, coating: res.weightCoat, grossSponge: res.grossSponge },
        costs: { totalProductionCost: Math.ceil(totalPrice), laborCost: laborCost, finalPrice: Math.ceil(totalCost * 3), urgency: 0 },
        tiers: [{ id: 1, recipeName: "–§–∏–≥—É—Ä–∞: " + recipe.name, d: res.L, w: res.W, h: res.H, weight: res.weightTotal, totalCost: Math.ceil(totalPrice) }],
        shoppingList: shoppingList,
        detailedBlocks: detailedBlocks // –¢–µ–ø–µ—Ä—å —Ç—É—Ç –∫–∞–∂–¥—ã–π —Å–ª–æ–π –æ—Ç–¥–µ–ª—å–Ω–æ
    };

    appState.results[appState.activeSide] = shapeData;
    addToQueue();
}
// 1. –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–õ–û–ï–í (–í—ã–∑—ã–≤–∞–µ—Ç—Å—è 1 —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏)
function generateShapeLayers(imgUrl) {
    const stack = document.getElementById('shape3DStack');
    if (!stack) return;
    
    // –ï—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Ç–∞ –∂–µ, –Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º DOM (–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
    if (shape3DState.currentImg === imgUrl && shape3DState.layersCreated) return;
    
    stack.innerHTML = '';
    const layerCount = 40; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–µ–≤ (—á–µ–º –±–æ–ª—å—à–µ, —Ç–µ–º –≥–ª–∞–∂–µ, –Ω–æ —Ç—è–∂–µ–ª–µ–µ)
    
    for(let i=0; i<layerCount; i++) {
        const div = document.createElement('div');
        // –í–µ—Ä—Ö–Ω–∏–π —Å–ª–æ–π —Å–≤–µ—Ç–ª–µ–µ, –æ—Å—Ç–∞–ª—å–Ω—ã–µ - –±–æ–∫–æ–≤–∏–Ω—ã
        div.className = (i === layerCount - 1) ? 'shape-layer top' : 'shape-layer side';
        div.style.backgroundImage = `url('${imgUrl}')`;
        // –í–∞–∂–Ω–æ: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –¥–≤–∏–≥–∞—Ç—å
        div.dataset.zIdx = i; 
        div.dataset.total = layerCount;
        stack.appendChild(div);
    }
    
    shape3DState.currentImg = imgUrl;
    shape3DState.layersCreated = true;
}

// 2. –û–ë–ù–û–í–õ–ï–ù–ò–ï –ì–ï–û–ú–ï–¢–†–ò–ò (–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤–µ—Å–∞/—Ä–∞–∑–º–µ—Ä–∞)
function updateShape3DScene(L, W, H) {
    const ghost = document.getElementById('shapeGhostBox');
    const layers = document.querySelectorAll('.shape-layer');
    const stage = document.getElementById('shapeStage');
    const dimL = document.getElementById('dimLabelL');
    const dimW = document.getElementById('dimLabelW');
    
    if (!ghost || layers.length === 0) return;

    // --- –ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–ï ---
    // –ù–∞–º –Ω—É–∂–Ω–æ –≤–ø–∏—Å–∞—Ç—å —Ç–æ—Ä—Ç –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä 300x300px
    // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É
    const maxDim = Math.max(L, W);
    // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–∏–∫—Å–µ–ª–µ–π –Ω–∞ —Å–º (—á—Ç–æ–±—ã –≤–ª–µ–∑–∞–ª–æ —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏)
    const pxScale = 180 / maxDim; 
    
    const pxW = W * pxScale; // –®–∏—Ä–∏–Ω–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
    const pxL = L * pxScale; // –î–ª–∏–Ω–∞ (–≥–ª—É–±–∏–Ω–∞) –≤ –ø–∏–∫—Å–µ–ª—è—Ö
    const pxH = H * pxScale; // –í—ã—Å–æ—Ç–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
    
    // 1. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –†–ê–ú–ö–£ (Ghost Box)
    ghost.style.width = pxW + 'px';
    ghost.style.height = pxL + 'px';
    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Ä–∞–º–∫—É –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–æ—á–∫–∏ –≤—Ä–∞—â–µ–Ω–∏—è (0,0)
    ghost.style.top = (-pxL / 2) + 'px';
    ghost.style.left = (-pxW / 2) + 'px';
    // –ü–æ–¥–Ω–∏–º–∞–µ–º —Ä–∞–º–∫—É –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –¥–Ω–∞ (–∏–ª–∏ –≤–µ—Ä—Ö–∞, –∫–∞–∫ —É–¥–æ–±–Ω–µ–µ, –ø—É—Å—Ç—å –±—É–¥–µ—Ç –¥–Ω–æ)
    ghost.style.transform = `translateZ(0px)`;

    // 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –°–õ–û–ò (–¢–æ—Ä—Ç)
    layers.forEach(layer => {
        const idx = parseInt(layer.dataset.zIdx);
        const total = parseInt(layer.dataset.total);
        
        // –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º —Å–ª–æ–π –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —Ä–∞–º–∫–∏
        layer.style.width = pxW + 'px';
        layer.style.height = pxL + 'px';
        
        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å–ª–æ–π —Ç–∞–∫ –∂–µ, –∫–∞–∫ —Ä–∞–º–∫—É
        layer.style.top = (-pxL / 2) + 'px';
        layer.style.left = (-pxW / 2) + 'px';
        
        // –°—á–∏—Ç–∞–µ–º Z-–ø–æ–∑–∏—Ü–∏—é (–≤—ã—Å–æ—Ç—É)
        // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–æ–∏ –æ—Ç 0 –¥–æ pxH
        const zPos = (idx / (total - 1)) * pxH;
        
        layer.style.transform = `translateZ(${zPos}px)`;
    });
    
    // 3. –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∏ —Ä–∞–∑–º–µ—Ä–æ–≤ (–¥–≤–∏–≥–∞–µ–º –∏—Ö –∑–∞ —Ä–∞–º–∫–æ–π)
    if(dimW) {
        dimW.innerText = `‚Üî ${Math.round(W)} —Å–º`;
        // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å—å —à–∏—Ä–∏–Ω—ã (–≤–Ω–∏–∑—É —Ä–∞–º–∫–∏)
        // transform —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ 2D –ø–ª–æ—Å–∫–æ—Å—Ç–∏ —ç–∫—Ä–∞–Ω–∞, –Ω–æ –º—ã –≤–Ω—É—Ç—Ä–∏ 3D.
        // –ü—Ä–æ—â–µ –≤—Å–µ–≥–æ –∑–∞–¥–∞—Ç—å —Å—Ç–∞—Ç–∏—á–Ω–æ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CSS 3D –¥–ª—è –ø–æ–¥–ø–∏—Å–µ–π, –Ω–æ —ç—Ç–æ —Å–ª–æ–∂–Ω–æ —á–∏—Ç–∞—Ç—å.
        // –û—Å—Ç–∞–≤–∏–º –∏—Ö —Å—Ç–∞—Ç–∏—á–Ω—ã–º–∏ –ø–æ –∫—Ä–∞—è–º —ç–∫—Ä–∞–Ω–∞, —Ç–∞–∫ —á–∏—â–µ.
        dimW.innerText = `–®–∏—Ä–∏–Ω–∞: ${Math.round(W)} —Å–º`;
        dimW.style.bottom = "10px";
        dimW.style.left = "50%";
        dimW.style.transform = "translateX(-50%)";
    }
    
    if(dimL) {
        dimL.innerText = `‚Üï ${Math.round(L)} —Å–º`;
        dimL.style.top = "50%";
        dimL.style.right = "10px";
        dimL.style.transform = "translateY(-50%)";
    }
}
     
    </script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js')
      .then(() => console.log('Service Worker Registered'))
      .catch((err) => console.log('SW Error:', err));
  }
</script>
    
  </body>

</html>














































































